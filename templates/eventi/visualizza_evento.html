{% extends "shared/_base.html" %}

{% block title %}{{ (evento.tipologia_descrizione or evento.tipologia_nome or 'Evento')[:50] }}{% if (evento.tipologia_descrizione or evento.tipologia_nome or '')|length > 50 %}...{% endif %} - TALON{% endblock %}

{% block additional_css %}
<!-- CSS per visualizzazione evento (stile coerente con form eventi) -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/advanced-table.css') }}?v=1.0">
<style>
/* STILI VISUALIZZAZIONE EVENTO */
.form-container {
    display: block !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
    padding: 20px !important;
    margin: 0 auto !important;
    width: 100% !important;
    max-width: 1000px !important;
    box-sizing: border-box !important;
    background: transparent !important;
    min-height: calc(100vh - 120px) !important;
}

.form-section {
    background: white !important;
    border-radius: 10px !important;
    padding: 25px !important;
    margin-bottom: 20px !important;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08) !important;
    display: block !important;
    overflow: visible !important;
}

.form-row {
    display: flex;
    gap: 20px;
    margin-bottom: 1rem;
}

.form-row .form-group {
    flex: 1;
    margin-bottom: 0;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 5px;
    color: #495057;
}

.section-title {
    color: #333;
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: 20px;
    padding-bottom: 8px;
    border-bottom: 2px solid #667eea;
}

.form-group p {
    margin-bottom: 0.5rem;
    font-size: 0.95rem;
    color: #495057;
    line-height: 1.4;
}

.details-text {
    background: #f8f9fa;
    border-left: 3px solid #667eea;
    padding: 15px;
    border-radius: 5px;
    white-space: pre-wrap;
    font-size: 0.95rem;
    line-height: 1.5;
}

.metadata-info {
    font-size: 0.9rem;
    color: #6c757d;
}

/* STILI PER SEGUITI EVENTI - TABELLARE SEMPLICE */
.seguiti-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    font-size: 0.9rem;
}

.seguiti-table th {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    padding: 10px 12px;
    text-align: left;
    font-weight: 600;
    color: #495057;
}

.seguiti-table td {
    border: 1px solid #dee2e6;
    padding: 10px 12px;
    vertical-align: middle;
}

.seguiti-table tbody tr {
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
}

.seguiti-table tbody tr:hover {
    background-color: #e3f2fd;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
}

.seguiti-table tbody tr:active {
    transform: translateY(0);
    box-shadow: 0 1px 3px rgba(102, 126, 234, 0.2);
}

/* Icona di link per seguiti eventi */
.seguiti-link-icon {
    float: right;
    margin-left: 10px;
    color: #667eea;
    font-size: 0.8rem;
    opacity: 0.5;
    transition: all 0.2s ease;
}

.seguiti-table tbody tr:hover .seguiti-link-icon {
    opacity: 1;
    transform: scale(1.1);
    color: #1565c0;
}

/* Miglioramento del cursore e dell'aspetto generale */
.seguiti-table tbody tr td {
    position: relative;
}

.seguiti-table tbody tr:hover td {
    color: #1565c0;
}

/* Rimosse animazioni icone non pi√π utilizzate */

.seguiti-count {
    display: inline-block;
    background: #667eea;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
    margin-left: 10px;
}

.dettagli-troncati {
    max-width: 300px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: inline-block;
}
</style>
{% endblock %}

{% block page_title %}{{ (evento.tipologia_descrizione or evento.tipologia_nome or 'Visualizza Evento')[:80] }}{% if (evento.tipologia_descrizione or evento.tipologia_nome or '')|length > 80 %}...{% endif %}{% endblock %}

{% block page_controls %}
<button type="button" class="btn btn-secondary" onclick="history.back()">
    <i class="fas fa-arrow-left"></i> Indietro
</button>
{% if user_role in ['ADMIN', 'OPERATORE'] %}
<a href="{{ url_for('eventi.modifica_evento_form', id=evento.id) }}" class="btn btn-warning">
    <i class="fas fa-edit"></i> Modifica Evento
</a>
{% endif %}
{% endblock %}

{% block content %}
<main class="dashboard__content-wrapper" role="main">
    <section class="dashboard__scroll-content" aria-label="Visualizzazione evento">
        
        <div class="form-container">
            
            <!-- Sezione Dati Principali -->
            <div class="form-section">
                <h4 class="section-title">DATI EVENTO</h4>
                
                <div class="form-group">
                    <label>Ente Militare</label>
                    <p><strong>{{ evento.ente_nome or 'N/D' }}</strong></p>
                </div>

                <!-- Protocollo e Data Messaggio Evento sotto ente militare -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Protocollo Messaggio Evento</label>
                        <p><strong>{{ evento.prot_msg_evento or 'Non specificato' }}</strong></p>
                    </div>
                    
                    <div class="form-group">
                        <label>Data Messaggio Evento</label>
                        <p><strong>{{ evento.data_msg_evento.strftime('%d/%m/%Y') if evento.data_msg_evento else 'Non specificata' }}</strong></p>
                    </div>
                </div>

                <!-- Data Evento, Carattere e Tipo Evento allineati su una riga -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Data Evento</label>
                        <p>{{ evento.data_evento.strftime('%d/%m/%Y') if evento.data_evento else 'N/D' }}</p>
                    </div>
                    
                    <div class="form-group">
                        <label>Carattere Evento</label>
                        <p>{{ evento.carattere.upper() if evento.carattere else 'N/D' }}</p>
                    </div>
                    
                    <div class="form-group">
                        <label>Tipo Evento</label>
                        <p>{{ evento.tipo_evento.upper().replace('_', ' ') if evento.tipo_evento else 'N/D' }}</p>
                    </div>
                </div>

                <!-- Tipologia Evento e Note integrate nella sezione DATI EVENTO -->
                <div class="form-group">
                    <label>Tipologia Evento</label>
                    <p><strong>{{ (evento.tipologia_nome or 'N/D') | upper }}</strong></p>
                    {% if evento.tipologia_descrizione %}
                    <p class="details-text">{{ evento.tipologia_descrizione | upper }}</p>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label>Note Aggiuntive</label>
                    <p class="details-text">{{ evento.note or 'Nessuna nota aggiuntiva' }}</p>
                </div>

                <!-- Sezione Seguiti Eventi (JSONB) -->
                {% if prot_data and prot_data.seguiti_eventi %}
                <div class="form-group">
                    <label>Eventi Seguiti Collegati 
                        <span class="seguiti-count">{{ prot_data.seguiti_eventi|length }}</span>
                        <small class="text-muted" style="font-weight: normal; margin-left: 10px;">
                            (clicca su una riga per visualizzare l'evento)
                        </small>
                    </label>
                    <table class="seguiti-table">
                        <thead>
                            <tr>
                                <th>Protocollo</th>
                                <th>Data Messaggio</th>
                                <th>Tipologia Evento</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for seguito in prot_data.seguiti_eventi %}
                            <tr onclick="window.location.href='{{ url_for('eventi.visualizza_evento', id=seguito.evento_id) }}'">
                                <td>{{ seguito.prot_msg_evento or seguito.protocollo or 'N/D' }}</td>
                                <td>{{ seguito.data_msg_evento or 'N/D' }}</td>
                                <td>
                                    <span class="dettagli-troncati" title="{{ (seguito.tipologia_nome or seguito.tipologia_descrizione or 'N/D') | upper }}">
                                        {{ (seguito.tipologia_nome or seguito.tipologia_descrizione or 'N/D') | upper }}
                                    </span>
                                    <i class="fas fa-external-link-alt seguiti-link-icon" title="Clicca per visualizzare"></i>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% elif evento.rife_evento %}
                <div class="form-group">
                    <label>Eventi Seguiti Collegati</label>
                    <div class="seguiti-container">
                        <div class="no-seguiti">
                            <i class="fas fa-info-circle"></i> Dati seguiti presenti ma in formato non standard
                            <br><small class="text-muted">Contenuto raw: {{ evento.rife_evento }}</small>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>


        </div>
        
    </section>
</main>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('[Visualizza Evento] Evento caricato');
    
    // Inizializza gestione seguiti eventi JSONB
    initSeguiti();
    
    // Log informazioni sui seguiti per debug
    {% if prot_data and prot_data.seguiti_eventi %}
    console.log('[SEGUITI] Trovati {{ prot_data.seguiti_eventi|length }} eventi seguiti collegati');
    console.log('[SEGUITI] Dati prot_data:', {{ prot_data|tojson|safe }});
    {% elif prot_data %}
    console.log('[SEGUITI] prot_data presente ma senza seguiti_eventi:', {{ prot_data|tojson|safe }});
    {% elif evento.rife_evento %}
    console.log('[SEGUITI] rife_evento raw presente:', {{ evento.rife_evento|tojson|safe }});
    {% else %}
    console.log('[SEGUITI] Nessun dato seguiti disponibile');
    {% endif %}
    
});

// Funzione per inizializzare la gestione dei seguiti eventi
function initSeguiti() {
    const seguitiRows = document.querySelectorAll('.seguiti-table tbody tr');
    
    if (seguitiRows.length > 0) {
        console.log(`[SEGUITI] Inizializzazione tabella seguiti per ${seguitiRows.length} eventi collegati`);
        console.log('[SEGUITI] Navigazione diretta abilitata - click su riga per visualizzare evento');
        
        seguitiRows.forEach(function(row, index) {
            console.log(`[SEGUITI] Riga ${index + 1}: navigazione diretta abilitata`);
        });
    }
}

// Funzione utility per formattare i dati JSONB (per debug)
function debugRifeEvento(data) {
    if (!data) return;
    
    console.group('[SEGUITI] Debug JSONB rife_evento');
    console.log('Tipo:', typeof data);
    console.log('Contenuto:', data);
    
    if (typeof data === 'string') {
        try {
            const parsed = JSON.parse(data);
            console.log('Parsed:', parsed);
            
            if (parsed.seguiti_eventi && Array.isArray(parsed.seguiti_eventi)) {
                console.log(`Eventi seguiti trovati: ${parsed.seguiti_eventi.length}`);
            }
        } catch (e) {
            console.error('Errore parsing JSON:', e);
        }
    } else if (typeof data === 'object') {
        if (data.seguiti_eventi && Array.isArray(data.seguiti_eventi)) {
            console.log(`Eventi seguiti trovati: ${data.seguiti_eventi.length}`);
        }
    }
    
    console.groupEnd();
}

// Chiama debug se abbiamo dati
{% if evento.rife_evento %}
debugRifeEvento({{ evento.rife_evento|tojson|safe }});
{% endif %}
</script>
{% endblock %}