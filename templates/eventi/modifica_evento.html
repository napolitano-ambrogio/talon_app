{% extends "shared/_base.html" %}

{% block title %}Modifica Evento - TALON{% endblock %}

{% block additional_css %}
<!-- CSS per form eventi -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/advanced-table.css') }}?v=1.0">
<style>
/* STILI FORM EVENTO */
.form-container {
    display: block !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
    padding: 20px !important;
    margin: 0 auto !important;
    width: 100% !important;
    max-width: 1000px !important;
    box-sizing: border-box !important;
    background: transparent !important;
    min-height: calc(100vh - 120px) !important;
}

.form-section {
    background: white !important;
    border-radius: 10px !important;
    padding: 25px !important;
    margin-bottom: 20px !important;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08) !important;
    display: block !important;
    overflow: visible !important;
}

.form-control {
    height: 42px !important;
    min-height: 42px !important;
    padding: 10px 12px !important;
    width: 100% !important;
    box-sizing: border-box !important;
    border: 1px solid #ced4da !important;
    border-radius: 5px !important;
    font-size: 0.95rem !important;
}

textarea.form-control {
    height: auto !important;
    min-height: 100px !important;
}

.searchable-select-input {
    height: 42px !important;
    min-height: 42px !important;
    padding: 10px 35px 10px 12px !important;
}

.searchable-select-dropdown {
    max-height: 300px !important;
    overflow-y: auto !important;
    background: white !important;
    border: 1px solid #667eea !important;
    z-index: 1001 !important;
}

.form-row {
    display: flex;
    gap: 20px;
    margin-bottom: 1rem;
}

.form-row .form-group {
    flex: 1;
    margin-bottom: 0;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 5px;
    color: #495057;
}

.required {
    color: #dc3545;
}

.section-title {
    color: #333;
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: 20px;
    padding-bottom: 8px;
    border-bottom: 2px solid #667eea;
}

.form-actions {
    display: flex;
    gap: 15px;
    justify-content: flex-start;
    margin-top: 30px;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 5px;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-primary {
    background: #667eea;
    color: white;
}

.btn-primary:hover {
    background: #5a6fd8;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn-danger:hover {
    background: #c82333;
}

.cancel-link {
    display: inline-block;
    margin-top: 15px;
    color: #6c757d;
    text-decoration: none;
}

.cancel-link:hover {
    color: #495057;
    text-decoration: underline;
}


/* Stili per evidenziare campi obbligatori */
.form-control:required {
    border-left: 3px solid #667eea;
}

/* ============================================
   SEARCHABLE SELECT MIGLIORATO PER ENTI MILITARI
   ============================================ */

/* SearchableSelect migliorato - stili base */
.searchable-select-display {
    min-height: 50px !important;
    padding: 12px 40px 12px 16px !important;
    border: 2px solid #ced4da;
    border-radius: 8px;
    background: #fff;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.searchable-select-display:hover {
    border-color: #667eea;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
}

.searchable-select-dropdown {
    border: 2px solid #667eea;
    border-radius: 8px;
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
    max-height: 400px;
}

.searchable-select-option {
    padding: 12px 16px;
    transition: all 0.2s ease;
    border-left: 4px solid transparent;
}

.searchable-select-option:hover {
    background: #f8f9fa;
    border-left-color: #667eea;
}

/* Form readonly fields */
.form-readonly {
    background-color: #f8f9fa !important;
    cursor: not-allowed;
}

/* Sezione eliminazione */
.danger-section {
    border-left: 4px solid #dc3545 !important;
    background: #fff5f5 !important;
}

.danger-section .section-title {
    color: #dc3545;
    border-bottom-color: #dc3545;
}

.danger-warning {
    background: #f8d7da;
    color: #721c24;
    padding: 12px;
    border-radius: 5px;
    margin-bottom: 15px;
    border: 1px solid #f5c6cb;
}

/* === CSS MODAL SEGUITI - COPIATO DA INSERISCI EVENTO === */

/* Backdrop fix - QUESTA √à LA CHIAVE DEL PROBLEMA */
#modalSeguiti + .modal-backdrop,
.modal-backdrop.show,
body.modal-open .modal-backdrop {
    z-index: 1000 !important;
    opacity: 0.3 !important;
    pointer-events: none !important;
}

/* Modal dialog con z-index altissimo */
.modal-dialog {
    z-index: 100000 !important;
    position: relative !important;
}

/* Modal specifico con z-index estremo */
#modalSeguiti {
    z-index: 99999 !important;
}

#modalSeguiti .modal-dialog {
    z-index: 100000 !important;
}

/* Stili del modal */
#modalSeguiti .modal-dialog {
    max-width: 90% !important;
    width: 1000px !important;
    margin: 80px auto 1.75rem auto !important;
    padding-top: 20px !important;
}

#modalSeguiti .modal-content {
    border-radius: 10px !important;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3) !important;
    z-index: 10001 !important;
    position: relative !important;
    pointer-events: all !important;
}

/* Fix per rendere interattivo il contenuto del modal */
#modalSeguiti .modal-body,
#modalSeguiti .modal-header,
#modalSeguiti .modal-footer {
    pointer-events: all !important;
    z-index: 10002 !important;
    position: relative !important;
}

/* Fix specifico per tutti gli elementi interattivi */
#modalSeguiti input,
#modalSeguiti button,
#modalSeguiti select,
#modalSeguiti textarea,
#modalSeguiti .table,
#modalSeguiti .btn-close,
#modalSeguiti tr,
#modalSeguiti td,
#modalSeguiti th,
#modalSeguiti .form-control,
#modalSeguiti .btn,
#modalSeguiti .alert {
    pointer-events: all !important;
    z-index: 10003 !important;
    position: relative !important;
}

/* Assicura che tutto il contenuto del modal sia interattivo */
#modalSeguiti * {
    pointer-events: all !important;
}

/* Disabilita completamente il backdrop per l'interazione */
body.modal-open .modal-backdrop {
    pointer-events: none !important;
}

/* Soluzione drastica: nasconde il backdrop di Bootstrap - FONDAMENTALE! */
#modalSeguiti + .modal-backdrop,
.modal-backdrop {
    display: none !important;
}

/* Assicura che il modal sia sempre visibile sopra tutto */
#modalSeguiti.show {
    display: block !important;
    z-index: 99999 !important;
}

#modalSeguiti.show .modal-dialog {
    z-index: 100000 !important;
}

#modalSeguiti .modal-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    color: white !important;
    border-top-left-radius: 10px !important;
    border-top-right-radius: 10px !important;
}

#modalSeguiti .modal-title {
    font-weight: 600 !important;
}

#modalSeguiti .btn-close {
    filter: invert(1) !important;
}

/* Tabella risultati nel modal */
#modalSeguiti .table-responsive {
    max-height: 400px !important;
    overflow-y: auto !important;
    border: 1px solid #dee2e6 !important;
    border-radius: 5px !important;
}

#modalSeguiti .table {
    margin-bottom: 0 !important;
    font-size: 0.9rem !important;
}

#modalSeguiti .table th {
    background-color: #f8f9fa !important;
    position: sticky !important;
    top: 0 !important;
    z-index: 10 !important;
    border-bottom: 2px solid #dee2e6 !important;
}

#modalSeguiti .table td {
    vertical-align: middle !important;
    padding: 8px !important;
}

/* Pulsanti nel modal */
#modalSeguiti .btn-sm {
    padding: 4px 8px !important;
    font-size: 0.8rem !important;
}

/* Seguiti selezionati nel modal */
#seguiti-selezionati {
    max-height: 200px !important;
    overflow-y: auto !important;
}

/* Form di ricerca nel modal */
#modalSeguiti .form-control {
    border-radius: 5px !important;
    border: 1px solid #ced4da !important;
}

#modalSeguiti .form-control:focus {
    border-color: #667eea !important;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25) !important;
}

/* Alert nel modal */
#modalSeguiti .alert {
    margin-bottom: 1rem !important;
    padding: 10px 15px !important;
}

/* Footer modal */
#modalSeguiti .modal-footer {
    background-color: #f8f9fa !important;
    border-bottom-left-radius: 10px !important;
    border-bottom-right-radius: 10px !important;
}

/* Badge nel modal */
#modalSeguiti .badge {
    font-size: 0.75em !important;
}

/* Assicura che il modal sia sempre visibile */
.modal.show {
    display: block !important;
}

.modal.fade .modal-dialog {
    transform: translateY(-50px) !important;
    transition: transform 0.3s ease-out !important;
}

.modal.show .modal-dialog {
    transform: translateY(0) !important;
}

/* === STILI PER VISUALIZZAZIONE SEGUITI ESISTENTI === */

.seguiti-count {
    display: inline-block;
    background: #667eea;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
}

/* Tabella seguiti esistenti */
#seguiti-table-display {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    font-size: 0.9rem;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

#seguiti-table-display th {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    padding: 12px;
    text-align: left;
    font-weight: 600;
    color: #495057;
}

#seguiti-table-display td {
    border: 1px solid #dee2e6;
    padding: 12px;
    vertical-align: middle;
}

#seguiti-table-display tbody tr:hover {
    background-color: #f8f9ff;
}

.dettagli-troncati {
    max-width: 300px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: inline-block;
}

/* Pulsanti azioni nella tabella */
#seguiti-table-display .btn-sm {
    padding: 4px 8px;
    font-size: 0.75rem;
    border-radius: 4px;
}

#seguiti-table-display .btn-outline-primary:hover {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

#seguiti-table-display .btn-outline-danger:hover {
    background-color: #dc3545;
    border-color: #dc3545;
}

/* Alert per nessun seguito */
#no-seguiti-message {
    margin: 10px 0;
    padding: 12px 15px;
    background-color: #d1ecf1;
    border-color: #bee5eb;
    color: #0c5460;
    border-radius: 6px;
}

#no-seguiti-message i {
    margin-right: 8px;
}

/* Animazioni per rimozione seguiti */
.seguiti-removing {
    opacity: 0.5;
    transform: scale(0.95);
    transition: all 0.3s ease;
}

.seguiti-removed {
    opacity: 0;
    transform: translateX(-100%);
    transition: all 0.3s ease;
}
</style>
{% endblock %}

{% block page_title %}Modifica Evento{% endblock %}

{% block page_controls %}
<button type="button" class="btn btn-secondary" onclick="history.back()">
    <i class="fas fa-arrow-left"></i> Indietro
</button>
<button type="submit" form="form-modifica-evento" class="btn btn-primary">
    <i class="fas fa-save"></i> Aggiorna Evento
</button>
<button type="button" class="btn btn-danger" onclick="confermaEliminazione()">
    <i class="fas fa-trash"></i> Elimina Evento
</button>
{% endblock %}

{% block content %}
<main class="dashboard__content-wrapper" role="main">
    <section class="dashboard__scroll-content" aria-label="Form modifica evento">
        
        <div class="form-container">
            <form action="{{ url_for('eventi.aggiorna_evento', id=evento.id) }}" method="POST" id="form-modifica-evento">
                
                <!-- Sezione Dati Principali -->
                <div class="form-section">
                    <h4 class="section-title">DATI EVENTO</h4>
                    
                    <div class="form-group">
                        <label for="ente_id">Ente Militare <span class="required">*</span></label>
                        <div class="searchable-select" data-select-id="ente_id"></div>
                        <select name="ente_id" id="ente_id" style="display: none;" required>
                            <option value="" disabled>-- Seleziona ente militare --</option>
                            {% for ente in enti_militari %}
                                <option value="{{ ente.id }}"
                                        {% if ente.id == evento.ente_id %}selected{% endif %}
                                        data-codice="{{ ente.codice or '' }}"
                                        data-indirizzo="{{ ente.indirizzo or '' }}"
                                        data-details="{% if ente.codice %}[{{ ente.codice }}] {% endif %}{{ ente.indirizzo or '' }}">
                                    {{ ente.nome }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Protocollo e Data Messaggio Evento sotto ente militare -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="prot_msg_evento">Protocollo Messaggio Evento <span class="required">*</span></label>
                            <input type="text" id="prot_msg_evento" name="prot_msg_evento" class="form-control" required
                                   value="{{ evento.prot_msg_evento or '' }}"
                                   placeholder="Numero protocollo del messaggio evento">
                        </div>
                        
                        <div class="form-group">
                            <label for="data_msg_evento">Data Messaggio Evento <span class="required">*</span></label>
                            <input type="date" id="data_msg_evento" name="data_msg_evento" class="form-control" required
                                   value="{{ evento.data_msg_evento.strftime('%Y-%m-%d') if evento.data_msg_evento else '' }}">
                        </div>
                    </div>

                    <!-- Data Evento, Carattere e Tipo Evento allineati su una riga -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="data_evento">Data Evento</label>
                            <input type="date" id="data_evento" name="data_evento" class="form-control" 
                                   value="{{ evento.data_evento.strftime('%Y-%m-%d') if evento.data_evento else '' }}">
                        </div>
                        
                        <div class="form-group">
                            <label for="carattere">Carattere Evento <span class="required">*</span></label>
                            <select name="carattere" id="carattere" class="form-control" required>
                                <option value="" disabled>-- Seleziona carattere --</option>
                                <option value="positivo" {% if evento.carattere == 'positivo' %}selected{% endif %}>POSITIVO</option>
                                <option value="negativo" {% if evento.carattere == 'negativo' %}selected{% endif %}>NEGATIVO</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="tipo_evento">Tipo Evento <span class="required">*</span></label>
                            <select name="tipo_evento" id="tipo_evento" class="form-control" required>
                                <option value="" disabled>-- Seleziona tipo --</option>
                                <option value="tipo_a" {% if evento.tipo_evento == 'tipo_a' %}selected{% endif %}>TIPO A</option>
                                <option value="tipo_b" {% if evento.tipo_evento == 'tipo_b' %}selected{% endif %}>TIPO B</option>
                                <option value="tipo_c" {% if evento.tipo_evento == 'tipo_c' %}selected{% endif %}>TIPO C</option>
                                <option value="tipo_d" {% if evento.tipo_evento == 'tipo_d' %}selected{% endif %}>TIPO D</option>
                                <option value="tipo_e" {% if evento.tipo_evento == 'tipo_e' %}selected{% endif %}>TIPO E</option>
                            </select>
                        </div>
                    </div>

                    <!-- Tipologia Evento - SELECT HTML PURO per Slim Select -->
                    <div class="form-group">
                        <label for="tipologia_evento_id">Tipologia Evento <span class="required">*</span></label>
                        <select name="tipologia_evento_id" id="tipologia_evento_id" class="form-control" required>
                            <option value="" disabled>-- Seleziona tipologia evento --</option>
                            {% for tipologia in tipologie_evento %}
                                <option value="{{ tipologia.id }}"
                                        {% if tipologia.id == evento.tipologia_evento_id %}selected{% endif %}
                                        data-descrizione="{{ tipologia.descrizione or '' }}">
                                    {{ tipologia.nome }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="note">Note Aggiuntive</label>
                        <textarea id="note" name="note" class="form-control" 
                                  placeholder="Eventuali note aggiuntive (MAIUSCOLO)">{{ evento.note or '' }}</textarea>
                    </div>

                    <!-- Sezione Seguiti Eventi - Visualizzazione e Gestione -->
                    <div class="form-group" style="margin-top: 20px;">
                        <div style="display: flex; align-items: center; margin-bottom: 15px;">
                            <label style="font-weight: 600; color: #495057; margin: 0; flex-grow: 1;">
                                Eventi Seguiti Collegati
                                {% if prot_data and prot_data.seguiti_eventi %}
                                <span class="seguiti-count" style="margin-left: 10px;">{{ prot_data.seguiti_eventi|length }}</span>
                                {% endif %}
                            </label>
                            <!-- PULSANTE PROTETTO - Al di fuori del label -->
                            <button type="button" class="btn btn-secondary btn-sm" onclick="aprirModalSeguiti()" 
                                    id="btn-gestisci-seguiti" style="margin-left: auto;">
                                <i class="fas fa-plus"></i> Aggiungi seguiti
                            </button>
                        </div>
                        
                        <!-- Campo nascosto per i dati JSONB dei seguiti -->
                        <input type="hidden" name="seguiti_eventi" id="seguiti_eventi" value="{{ prot_data_json if prot_data_json else '' }}">
                        
                        <!-- Visualizzazione seguiti esistenti -->
                        {% if prot_data and prot_data.seguiti_eventi %}
                        <table class="seguiti-table" id="seguiti-table-display">
                            <thead>
                                <tr>
                                    <th>Protocollo</th>
                                    <th>Data Messaggio</th>
                                    <th>Tipologia Evento</th>
                                    <th style="width: 120px; text-align: center;">Azioni</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for seguito in prot_data.seguiti_eventi %}
                                <tr data-evento-id="{{ seguito.evento_id }}">
                                    <td>{{ seguito.prot_msg_evento or seguito.protocollo or 'N/D' }}</td>
                                    <td>{{ seguito.data_msg_evento or 'N/D' }}</td>
                                    <td>
                                        <span class="dettagli-troncati" title="{{ seguito.tipologia_descrizione or seguito.tipologia_nome or 'N/D' }}">
                                            {{ seguito.tipologia_descrizione or seguito.tipologia_nome or 'N/D' }}
                                        </span>
                                    </td>
                                    <td style="text-align: center;">
                                        <button type="button" class="btn btn-sm btn-outline-primary me-1" 
                                                onclick="visualizzaEvento({{ seguito.evento_id }})" 
                                                title="Visualizza evento">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                                onclick="rimuoviSeguito({{ seguito.evento_id }})" 
                                                title="Rimuovi seguito">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <div id="no-seguiti-message" class="alert alert-info">
                            <i class="fas fa-info-circle"></i> Nessun evento seguito collegato. 
                            Clicca su "Aggiungi seguiti" per aggiungerne.
                        </div>
                        {% endif %}
                        
                    </div>
                </div>


                <!-- Campo nascosto per ID evento -->
                <input type="hidden" name="evento_id" value="{{ evento.id }}">

            </form>
        </div>
        
    </section>
</main>

<!-- Modal per gestire i seguiti eventi -->
<div class="modal fade" id="modalSeguiti" tabindex="-1" aria-labelledby="modalSeguitiLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalSeguitiLabel">
                    <i class="fas fa-search"></i> Gestisci Eventi Seguiti
                </h5>
                <button type="button" class="btn-close" onclick="chiudiModalSeguiti()" aria-label="Close" style="background-color: white; opacity: 1;"></button>
            </div>
            <div class="modal-body">
                <!-- Form di ricerca -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="search-protocollo" class="form-label">Protocollo Messaggio</label>
                        <input type="text" class="form-control" id="search-protocollo" 
                               placeholder="Es. 0085506" style="text-transform: uppercase;">
                    </div>
                    <div class="col-md-6">
                        <label for="search-data" class="form-label">Data Messaggio</label>
                        <input type="date" class="form-control" id="search-data">
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-12">
                        <button type="button" class="btn btn-primary" onclick="cercaEventi()">
                            <i class="fas fa-search"></i> Cerca Eventi
                        </button>
                        <button type="button" class="btn btn-secondary ms-2" onclick="resetRicerca()">
                            <i class="fas fa-eraser"></i> Reset
                        </button>
                    </div>
                </div>
                
                <!-- Risultati ricerca -->
                <div id="risultati-ricerca">
                    <div class="alert alert-info" id="info-ricerca">
                        <i class="fas fa-info-circle"></i> Inserisci i criteri di ricerca e premi "Cerca Eventi"
                        <br><small><strong>üí° Suggerimento:</strong> Puoi selezionare <strong>pi√π eventi</strong> cliccando sui pulsanti "Seleziona" e poi confermare tutti insieme</small>
                    </div>
                </div>
                
                <!-- Seguiti selezionati nel modal -->
                <div id="seguiti-selezionati" style="display: none;">
                    <hr>
                    <h6>Eventi selezionati come seguiti:</h6>
                    <div id="lista-seguiti-modal" class="border rounded p-2 bg-light">
                        <!-- Eventi seguiti selezionati nel modal -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="chiudiModalSeguiti()">
                    <i class="fas fa-times"></i> Annulla
                </button>
                <button type="button" class="btn btn-success" onclick="confermaSeguitiSelezionati()" id="btn-conferma-seguiti">
                    <i class="fas fa-check"></i> Conferma Selezione <span id="count-seguiti-selezionati" class="badge bg-light text-dark ms-1" style="display: none;">0</span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* CSS minimo per Slim Select - lasciamo che funzioni naturalmente */
#tipologia_evento_id + .ss-main {
    width: 100%;
    z-index: 1050;
}
</style>
{% endblock %}

{% block extra_js %}
<!-- Advanced Table Component JS per searchable select -->
<script src="{{ url_for('static', filename='js/components/advanced-table.js') }}?v={{ cache_buster }}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('[Modifica Evento] DOM caricato, inizializzazione form...');
    
    // Salva valori originali per reset
    const originalValues = {
        ente_id: '{{ evento.ente_id }}',
        carattere: '{{ evento.carattere }}',
        tipo_evento: '{{ evento.tipo_evento }}',
        data_evento: '{{ evento.data_evento.strftime("%Y-%m-%d") if evento.data_evento else "" }}',
        tipologia_evento_id: '{{ evento.tipologia_evento_id or '' }}',
        note: `{{ (evento.note or '') | e }}`,
        prot_numero: '{{ prot_data.numero or "" }}',
        prot_data: '{{ prot_data.data or "" }}'
    };
    
    // Inizializzazione CORRETTA basata su debug results
    setTimeout(function() {
        console.log('[Modifica Evento] Inizializzazione corretta Slim Select...');
        
        const selectElement = document.getElementById('ente_id');
        const containerElement = document.querySelector('[data-select-id="ente_id"]');
        
        if (selectElement && !selectElement.hasAttribute('data-slim-working')) {
            try {
                // Nascondi il container wrapper
                if (containerElement) {
                    containerElement.style.display = 'none';
                }
                
                // IMPORTANTE: Renderlo visibile PRIMA di Slim Select, poi Slim Select gestisce tutto
                selectElement.style.display = 'block';
                selectElement.style.visibility = 'visible';
                
                // Costruisci l'array data per Slim Select con HTML personalizzato
                const dataArray = [];
                
                // Aggiungi placeholder
                dataArray.push({
                    text: 'Seleziona ente militare...',
                    value: '',
                    placeholder: true
                });
                
                // Costruisci opzioni dai dati HTML esistenti
                const options = selectElement.querySelectorAll('option:not(:disabled):not([value=""])');
                options.forEach(option => {
                    const nomeEnte = option.textContent.trim();
                    const value = option.value;
                    const codice = option.getAttribute('data-codice') || '';
                    const indirizzo = option.getAttribute('data-indirizzo') || '';
                    
                    // Crea HTML personalizzato per nome + indirizzo
                    const customHtml = indirizzo ? 
                        `<div style="font-size: 15px; font-weight: 500; text-transform: uppercase; line-height: 1.3; margin-bottom: 4px; color: #343a40;">
                            ${nomeEnte}
                        </div>
                        <div style="font-size: 11px; font-weight: 400; font-style: italic; line-height: 1.2; color: #6c757d; opacity: 0.85;">
                            ${indirizzo}
                        </div>` : 
                        nomeEnte;
                    
                    dataArray.push({
                        text: nomeEnte,
                        value: value,
                        html: customHtml,
                        selected: option.selected, // Mantieni la selezione esistente
                        data: {
                            codice: codice,
                            indirizzo: indirizzo
                        }
                    });
                });
                
                console.log(`[Modifica Evento] Costruito array data con ${dataArray.length} elementi`);
                
                // Configurazione Slim Select ottimizzata per TALON con data array
                const slimInstance = new SlimSelect({
                    select: selectElement,
                    data: dataArray,
                    settings: {
                        // Search configuration
                        showSearch: true,
                        searchPlaceholder: 'Cerca ente militare...',
                        searchText: 'Nessun ente trovato',
                        searchingText: 'Ricerca in corso...',
                        searchHighlight: true,
                        
                        // Display configuration
                        placeholderText: 'Seleziona ente militare...',
                        closeOnSelect: true,
                        allowDeselect: false,
                        showOptionTooltips: true,
                        
                        // Performance settings
                        maxValuesShown: 200,
                        timeoutDelay: 150,
                        
                        // Position settings
                        openPosition: 'auto',
                        contentPosition: 'absolute'
                    },
                    events: {
                        afterChange: (newVal) => {
                            console.log('[Modifica Evento] Ente selezionato:', newVal);
                            if (typeof validateEnteSelection === 'function') {
                                validateEnteSelection();
                            }
                        },
                        searchFilter: (option, search) => {
                            // Custom search che include text, codice, e indirizzo
                            const searchLower = search.toLowerCase();
                            const text = option.text.toLowerCase();
                            const codice = (option.data && option.data.codice) ? option.data.codice.toLowerCase() : '';
                            const indirizzo = (option.data && option.data.indirizzo) ? option.data.indirizzo.toLowerCase() : '';
                            
                            return text.includes(searchLower) || 
                                   codice.includes(searchLower) || 
                                   indirizzo.includes(searchLower);
                        }
                    }
                });
                
                // Marca come inizializzato
                selectElement.setAttribute('data-slim-working', 'true');
                
                // Applica stili TALON e assicura funzionalit√† complete
                setTimeout(() => {
                    const slimContainer = selectElement.nextElementSibling;
                    if (slimContainer && slimContainer.classList.contains('ss-main')) {
                        // Crea wrapper per applicare gli stili TALON
                        const wrapper = document.createElement('div');
                        wrapper.className = 'talon-slim-select';
                        wrapper.style.width = '100%';
                        
                        // Inserisci il wrapper e sposta il container Slim Select dentro
                        slimContainer.parentNode.insertBefore(wrapper, slimContainer);
                        wrapper.appendChild(slimContainer);
                        
                        // Forza la scrollbar sulle liste dopo l'inizializzazione
                        setTimeout(() => {
                            const ssLists = wrapper.querySelectorAll('.ss-list');
                            ssLists.forEach(list => {
                                list.style.maxHeight = '320px';
                                list.style.overflowY = 'auto';
                                list.style.overflowX = 'hidden';
                                list.style.scrollbarWidth = 'thin';
                                list.style.scrollbarColor = '#ced4da #f1f3f4';
                                
                                // Webkit scrollbar
                                list.style.setProperty('--webkit-scrollbar-width', '8px');
                                list.style.setProperty('--webkit-scrollbar-track-background', '#f1f3f4');
                                list.style.setProperty('--webkit-scrollbar-thumb-background', '#ced4da');
                            });
                            
                            console.log(`[Modifica Evento] üìú Scrollbar forzata su ${ssLists.length} liste`);
                        }, 200);
                        
                        console.log('[Modifica Evento] ‚úÖ Wrapper TALON + Slim Select + data attributes applicati');
                    } else {
                        console.error('[Modifica Evento] ‚ùå Container Slim Select non trovato');
                    }
                }, 200);
                
                console.log('[Modifica Evento] ‚úÖ Slim Select Enti inizializzato correttamente');
                
            } catch (error) {
                console.error('[Modifica Evento] ‚ùå Errore Slim Select Enti:', error);
                // Ripristina stato in caso di errore
                if (containerElement) {
                    containerElement.style.display = '';
                }
            }
        }
        
        // === INIZIALIZZAZIONE SLIM SELECT PER TIPOLOGIA EVENTO - PULITO ===
        
        const selectTipologiaElement = document.getElementById('tipologia_evento_id');
        
        if (selectTipologiaElement && !selectTipologiaElement.hasAttribute('data-slim-working')) {
            try {
                console.log('[Modifica Evento] Inizializzazione Slim Select Tipologie - ALLINEATO AGLI ENTI...');
                console.log(`[Modifica Evento] Select tipologie ha ${selectTipologiaElement.options.length} opzioni`);
                
                // Costruisci data array COME NEGLI ENTI per avere search funzionante
                const tipologieDataArray = [];
                
                // Aggiungi placeholder
                tipologieDataArray.push({
                    text: 'Seleziona tipologia evento...',
                    value: '',
                    placeholder: true
                });
                
                // Costruisci array dai dati HTML ESATTAMENTE come negli enti
                const tipologieOptions = selectTipologiaElement.querySelectorAll('option:not(:disabled):not([value=""])');
                tipologieOptions.forEach(option => {
                    const nomeTipologia = option.textContent.trim();
                    const value = option.value;
                    const descrizione = option.getAttribute('data-descrizione') || '';
                    
                    // Crea HTML personalizzato per visualizzazione
                    const customHtml = descrizione ? 
                        `<div style="font-size: 15px; font-weight: 500; line-height: 1.3; margin-bottom: 4px; color: #343a40;">
                            ${nomeTipologia}
                        </div>
                        <div style="font-size: 11px; font-style: italic; line-height: 1.2; color: #6c757d; opacity: 0.85;">
                            ${descrizione.length > 100 ? descrizione.substring(0, 100) + '...' : descrizione}
                        </div>` : 
                        nomeTipologia;
                    
                    tipologieDataArray.push({
                        text: nomeTipologia,
                        value: value,
                        html: customHtml,
                        selected: option.selected, // IMPORTANTE per modifica evento
                        data: {
                            descrizione: descrizione
                        }
                    });
                });
                
                console.log(`[Modifica Evento] Costruito array tipologie con ${tipologieDataArray.length} elementi`);
                
                // Configurazione IDENTICA AGLI ENTI per garantire funzionamento
                const slimTipologieInstance = new SlimSelect({
                    select: selectTipologiaElement,
                    data: tipologieDataArray,  // ‚ú® KEY DIFFERENCE - usa data array come enti
                    settings: {
                        // Search configuration - IDENTICO AGLI ENTI
                        showSearch: true,
                        searchPlaceholder: 'Cerca tipologia evento...',
                        searchText: 'Nessuna tipologia trovata',
                        searchingText: 'Ricerca in corso...',
                        searchHighlight: true,
                        
                        // Display configuration - IDENTICO AGLI ENTI
                        placeholderText: 'Seleziona tipologia evento...',
                        closeOnSelect: true,
                        allowDeselect: false,
                        showOptionTooltips: true,
                        
                        // Performance settings - IDENTICO AGLI ENTI
                        maxValuesShown: 200,
                        timeoutDelay: 150,
                        
                        // Position settings - IDENTICO AGLI ENTI
                        openPosition: 'auto',
                        contentPosition: 'absolute'
                    },
                    events: {
                        afterChange: (newVal) => {
                            console.log('[Modifica Evento] Tipologia selezionata:', newVal);
                        },
                        searchFilter: (option, search) => {
                            // Custom search COME NEGLI ENTI - include nome e descrizione
                            const searchLower = search.toLowerCase();
                            const text = option.text.toLowerCase();
                            const descrizione = (option.data && option.data.descrizione) ? option.data.descrizione.toLowerCase() : '';
                            
                            return text.includes(searchLower) || 
                                   descrizione.includes(searchLower);
                        }
                    }
                });
                
                console.log('[Modifica Evento] ‚úÖ Slim Select Tipologie inizializzato COME ENTI');
                
                // Marca come inizializzato
                selectTipologiaElement.setAttribute('data-slim-working', 'true');
                
            } catch (error) {
                console.error('[Modifica Evento] ‚ùå Errore Slim Select Tipologie:', error);
                console.error('Stack trace:', error.stack);
            }
        }
        
    }, 600);
    
    
    // Forza tutti i campi di testo in MAIUSCOLO
    const textInputs = document.querySelectorAll('input[type="text"], textarea');
    textInputs.forEach(function(input) {
        // Escludi campi numerici o di data
        if (input.type === 'number' || input.type === 'date') {
            return;
        }
        
        input.style.textTransform = 'uppercase';
        
        input.addEventListener('input', function() {
            const start = this.selectionStart;
            const end = this.selectionEnd;
            this.value = this.value.toUpperCase();
            this.setSelectionRange(start, end);
        });
        
        // Converti il valore corrente in maiuscolo
        if (input.value) {
            input.value = input.value.toUpperCase();
        }
    });
    
    
    // Validazione form prima del submit
    document.getElementById('form-modifica-evento').addEventListener('submit', function(e) {
        const tipologiaEvento = document.getElementById('tipologia_evento_id').value;
        const enteId = document.getElementById('ente_id').value;
        
        // Validazione tipologia evento
        if (!tipologiaEvento) {
            e.preventDefault();
            alert('La tipologia evento √® obbligatoria!');
            
            // Focus semplice - Slim Select gestisce tutto
            const slimContainer = document.getElementById('tipologia_evento_id').nextElementSibling;
            if (slimContainer && slimContainer.classList.contains('ss-main')) {
                slimContainer.click(); // Apri il dropdown Slim Select
            } else {
                document.getElementById('tipologia_evento_id').focus(); // Fallback
            }
            return false;
        }
        
        // Validazione ente militare
        if (!enteId) {
            e.preventDefault();
            alert('L\'ente militare √® obbligatorio!');
            
            // Prova a trovare l'istanza Slim Select per focus
            const slimEnteContainer = document.querySelector('[data-select-id="ente_id"]').nextElementSibling;
            if (slimEnteContainer && slimEnteContainer.classList.contains('ss-main')) {
                const searchInput = slimEnteContainer.querySelector('.ss-search input');
                if (searchInput) {
                    searchInput.focus();
                } else {
                    slimEnteContainer.click(); // Apri il dropdown
                }
            } else {
                document.getElementById('ente_id').focus();
            }
            return false;
        }
        
        console.log('[Modifica Evento] Form validato, invio in corso...', {
            ente_id: enteId,
            tipologia_evento_id: tipologiaEvento
        });
        return true;
    });
    
    console.log('[Modifica Evento] Inizializzazione completata');
});

// Funzione per confermare eliminazione
function confermaEliminazione() {
    const eventoId = {{ evento.id }};
    const conferma = prompt(
        'ATTENZIONE: Stai per eliminare definitivamente questo evento.\n\n' +
        'Questa operazione √® IRREVERSIBILE!\n\n' +
        'Per confermare, digita il numero ID dell\'evento: ' + eventoId
    );
    
    if (conferma === null) {
        return false; // Utente ha annullato
    }
    
    if (conferma !== eventoId.toString()) {
        alert('ID non corretto. Eliminazione annullata.');
        return false;
    }
    
    const confermaFinale = confirm(
        'Ultima conferma:\n\n' +
        'Sei ASSOLUTAMENTE SICURO di voler eliminare questo evento?\n\n' +
        'Questa azione NON pu√≤ essere annullata!'
    );
    
    if (confermaFinale) {
        // Crea e invia form per eliminazione
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("eventi.elimina_evento", id=evento.id) }}';
        
        // Aggiungi token CSRF se necessario
        const csrfToken = document.querySelector('meta[name="csrf-token"]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfToken.getAttribute('content');
            form.appendChild(csrfInput);
        }
        
        document.body.appendChild(form);
        form.submit();
    }
}

// === GESTIONE SEGUITI EVENTI ===

// Array per memorizzare i seguiti selezionati temporaneamente nel modal
let seguitiSelezionati = [];


// Funzione per aprire il modal di gestione seguiti
function aprirModalSeguiti() {
    console.log('[SEGUITI] Apertura modal seguiti');
    
    // Reset campi ricerca
    document.getElementById('search-protocollo').value = '';
    document.getElementById('search-data').value = '';
    
    // Reset risultati
    document.getElementById('risultati-ricerca').innerHTML = `
        <div class="alert alert-info" id="info-ricerca">
            <i class="fas fa-info-circle"></i> Inserisci i criteri di ricerca e premi "Cerca Eventi"
        </div>`;
    
    // Reset seguiti temporanei
    seguitiSelezionati = [];
    document.getElementById('seguiti-selezionati').style.display = 'none';
    
    // Reset pulsante di conferma
    const btnConferma = document.getElementById('btn-conferma-seguiti');
    const countBadge = document.getElementById('count-seguiti-selezionati');
    if (btnConferma) {
        btnConferma.disabled = true;
        countBadge.style.display = 'none';
    }
    
    try {
        // Prova prima con Bootstrap 5
        if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
            console.log('[SEGUITI] Usando Bootstrap 5');
            const modalElement = document.getElementById('modalSeguiti');
            const modal = new bootstrap.Modal(modalElement, {
                backdrop: 'static',
                keyboard: false,
                focus: true
            });
            modal.show();
            
            // Fix aggressivo: forza z-index a runtime dopo apertura
            setTimeout(() => {
                const modalElement = document.getElementById('modalSeguiti');
                const backdrop = document.querySelector('.modal-backdrop');
                
                modalElement.style.zIndex = '99999';
                modalElement.style.position = 'fixed';
                
                if (backdrop) {
                    backdrop.style.zIndex = '1000';
                    backdrop.style.pointerEvents = 'none'; // QUESTO √à FONDAMENTALE!
                }
                
                const dialog = modalElement.querySelector('.modal-dialog');
                if (dialog) {
                    dialog.style.zIndex = '100000';
                    dialog.style.position = 'relative';
                }
                
                console.log('[SEGUITI] Z-index e pointer events configurati');
            }, 100);
            
            return;
        }
        
        // Fallback jQuery se Bootstrap 5 non √® disponibile
        if (typeof $ !== 'undefined') {
            console.log('[SEGUITI] Usando jQuery fallback');
            $('#modalSeguiti').modal({
                backdrop: 'static',
                keyboard: false,
                show: true
            });
            return;
        }
        
        console.error('[SEGUITI] N√© Bootstrap 5 n√© jQuery disponibili');
        
    } catch (error) {
        console.error('[SEGUITI] Errore apertura modal:', error);
        alert('Errore nell\'apertura del modal di ricerca seguiti');
    }
}

// Funzione per chiudere il modal manualmente
function chiudiModalSeguiti() {
    console.log('[SEGUITI] Chiusura modal...');
    
    try {
        const modalElement = document.getElementById('modalSeguiti');
        
        // Metodo 1: Prova con Bootstrap Modal API
        if (typeof bootstrap !== 'undefined') {
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                console.log('[SEGUITI] Usando Bootstrap API per chiusura');
                modal.hide();
                // Forza rimozione classi dopo chiusura Bootstrap
                setTimeout(() => {
                    modalElement.style.display = 'none';
                    modalElement.classList.remove('show');
                    document.body.classList.remove('modal-open');
                }, 300);
                return;
            }
        }
        
        // Metodo 2: Fallback jQuery
        if (typeof $ !== 'undefined') {
            console.log('[SEGUITI] Usando jQuery per chiusura');
            $('#modalSeguiti').modal('hide');
            return;
        }
        
        // Metodo 3: Chiusura manuale completa
        console.log('[SEGUITI] Usando chiusura manuale');
        modalElement.style.display = 'none';
        modalElement.classList.remove('show');
        modalElement.classList.remove('fade');
        document.body.classList.remove('modal-open');
        
        // Rimuovi tutti i backdrop
        const allBackdrops = document.querySelectorAll('.modal-backdrop');
        allBackdrops.forEach(backdrop => backdrop.remove());
        
        // Reset stili body
        document.body.style.paddingRight = '';
        document.body.style.overflow = '';
        
        console.log('[SEGUITI] Modal chiuso manualmente');
        
    } catch (error) {
        console.error('[SEGUITI] Errore chiusura modal:', error);
        
        // Ultimo tentativo di pulizia forzata
        const modalElement = document.getElementById('modalSeguiti');
        modalElement.style.display = 'none';
        modalElement.classList.remove('show');
        document.body.classList.remove('modal-open');
        
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
    }
}

// Funzione per cercare eventi seguiti via API
async function cercaEventi() {
    const protocollo = document.getElementById('search-protocollo').value.trim();
    const data = document.getElementById('search-data').value;
    
    console.log('[SEGUITI] Parametri ricerca:', {protocollo, data});
    
    if (!protocollo && !data) {
        alert('Inserire almeno un criterio di ricerca (Protocollo o Data)');
        return;
    }
    
    console.log('[SEGUITI] Ricerca eventi:', {protocollo, data});
    
    try {
        // Costruisci URL API
        const params = new URLSearchParams();
        if (protocollo) params.append('protocollo', protocollo);
        if (data) params.append('data', data);
        
        const response = await fetch(`/eventi/api/cerca-seguiti?${params.toString()}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const risultati = await response.json();
        console.log('[SEGUITI] Risultati ricerca:', risultati);
        
        mostraRisultatiRicerca(risultati);
        
    } catch (error) {
        console.error('[SEGUITI] Errore ricerca:', error);
        document.getElementById('risultati-ricerca').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> Errore durante la ricerca: ${error.message}
            </div>`;
    }
}

// Funzione per mostrare i risultati della ricerca
function mostraRisultatiRicerca(risultati) {
    const container = document.getElementById('risultati-ricerca');
    
    if (!risultati || risultati.length === 0) {
        container.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-search"></i> Nessun evento trovato con i criteri specificati
            </div>`;
        return;
    }
    
    let html = `
        <div class="alert alert-success">
            <i class="fas fa-check-circle"></i> Trovati ${risultati.length} eventi
        </div>
        <div class="table-responsive">
            <table class="table table-hover table-sm">
                <thead class="table-primary">
                    <tr>
                        <th width="50px">Azione</th>
                        <th>ID</th>
                        <th>Protocollo</th>
                        <th>Data Msg</th>
                        <th>Ente</th>
                        <th>Carattere</th>
                        <th>Tipo</th>
                        <th>Tipologia</th>
                    </tr>
                </thead>
                <tbody>`;
    
    risultati.forEach(evento => {
        const isSelezionato = seguitiSelezionati.some(s => s.id === evento.id);
        const buttonClass = isSelezionato ? 'btn-warning' : 'btn-outline-primary';
        const buttonIcon = isSelezionato ? 'fa-check' : 'fa-plus';
        const buttonText = isSelezionato ? 'Selezionato' : 'Seleziona';
        
        html += `
            <tr class="${isSelezionato ? 'table-warning' : ''}">
                <td>
                    <button type="button" class="btn ${buttonClass} btn-sm" 
                            onclick="toggleSeguitoEvento(${evento.id})" 
                            id="btn-seguito-${evento.id}">
                        <i class="fas ${buttonIcon}"></i>
                    </button>
                </td>
                <td><strong>#${evento.id}</strong></td>
                <td><code>${evento.prot_msg_evento || 'N/D'}</code></td>
                <td>${evento.data_msg_evento ? new Date(evento.data_msg_evento).toLocaleDateString('it-IT') : 'N/D'}</td>
                <td><small>${evento.ente_nome || 'N/D'}</small></td>
                <td><span class="badge ${evento.carattere === 'positivo' ? 'bg-success' : 'bg-danger'}">${evento.carattere ? evento.carattere.toUpperCase() : 'N/D'}</span></td>
                <td><span class="badge bg-secondary">${evento.tipo_evento ? evento.tipo_evento.replace('tipo_', 'TIPO ').toUpperCase() : 'N/D'}</span></td>
                <td><small>${evento.tipologia_nome ? evento.tipologia_nome.substring(0, 50) + (evento.tipologia_nome.length > 50 ? '...' : '') : 'N/D'}</small></td>
            </tr>`;
    });
    
    html += `
                </tbody>
            </table>
        </div>`;
    
    container.innerHTML = html;
}

// Funzione per selezionare/deselezionare un evento seguito
function toggleSeguitoEvento(eventoId) {
    console.log('[SEGUITI] Toggle evento:', eventoId);
    
    // Cerca l'evento nella tabella risultati per ottenere i dettagli
    const risultati = Array.from(document.querySelectorAll('#risultati-ricerca tbody tr')).map(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length > 0) {
            const id = parseInt(cells[1].textContent.replace('#', ''));
            if (id === eventoId) {
                return {
                    id: id,
                    protocollo: cells[2].textContent,
                    data_msg: cells[3].textContent,
                    ente: cells[4].textContent,
                    carattere: cells[5].textContent,
                    tipo: cells[6].textContent,
                    dettagli: cells[7].textContent
                };
            }
        }
        return null;
    }).filter(item => item !== null);
    
    const evento = risultati[0];
    if (!evento) {
        console.error('[SEGUITI] Evento non trovato nei risultati:', eventoId);
        return;
    }
    
    // Controlla se √® gi√† selezionato
    const index = seguitiSelezionati.findIndex(s => s.id === eventoId);
    
    if (index === -1) {
        // Aggiungi alla selezione
        seguitiSelezionati.push(evento);
        console.log('[SEGUITI] Evento aggiunto:', evento);
    } else {
        // Rimuovi dalla selezione
        seguitiSelezionati.splice(index, 1);
        console.log('[SEGUITI] Evento rimosso:', eventoId);
    }
    
    // Aggiorna UI
    aggiornaUISeguitiModal();
    mostraRisultatiRicerca(Array.from(document.querySelectorAll('#risultati-ricerca tbody tr')).map(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length > 0) {
            return {
                id: parseInt(cells[1].textContent.replace('#', '')),
                prot_msg_evento: cells[2].textContent,
                data_msg_evento: cells[3].textContent,
                ente_nome: cells[4].textContent,
                carattere: cells[5].textContent,
                tipo_evento: cells[6].textContent,
                tipologia_nome: cells[7].textContent
            };
        }
        return null;
    }).filter(item => item !== null));
}

// Funzione per aggiornare l'UI dei seguiti nel modal
function aggiornaUISeguitiModal() {
    const container = document.getElementById('lista-seguiti-modal');
    const section = document.getElementById('seguiti-selezionati');
    const countBadge = document.getElementById('count-seguiti-selezionati');
    const btnConferma = document.getElementById('btn-conferma-seguiti');
    
    // Aggiorna contatore nel pulsante
    if (seguitiSelezionati.length > 0) {
        countBadge.textContent = seguitiSelezionati.length;
        countBadge.style.display = 'inline-block';
        btnConferma.disabled = false;
    } else {
        countBadge.style.display = 'none';
        btnConferma.disabled = true;
    }
    
    if (seguitiSelezionati.length === 0) {
        section.style.display = 'none';
        return;
    }
    
    section.style.display = 'block';
    
    let html = '';
    seguitiSelezionati.forEach((seguito, index) => {
        html += `
            <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-white rounded border">
                <div>
                    <strong>Evento #${seguito.id}</strong> - ${seguito.protocollo}
                    <br><small class="text-muted">Collegato a evento #${seguito.id}</small>
                </div>
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="rimuoviSeguitoModalTemp(${index})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>`;
    });
    
    container.innerHTML = html;
}

// Funzione per rimuovere un seguito dalla selezione temporanea nel modal
function rimuoviSeguitoModalTemp(index) {
    if (seguitiSelezionati[index]) {
        console.log('[SEGUITI] Rimozione seguito temporaneo:', seguitiSelezionati[index]);
        seguitiSelezionati.splice(index, 1);
        aggiornaUISeguitiModal();
        // Aggiorna anche i risultati di ricerca se visibili
        if (document.querySelector('#risultati-ricerca table')) {
            cercaEventi(); // Ricarica i risultati per aggiornare i pulsanti
        }
    }
}

// Funzione per confermare i seguiti selezionati
function confermaSeguitiSelezionati() {
    console.log('[SEGUITI] Conferma seguiti selezionati:', seguitiSelezionati);
    
    // Ottieni i seguiti esistenti dal campo nascosto
    const campoNascosto = document.getElementById('seguiti_eventi');
    let seguitiEsistenti = [];
    
    try {
        const valoreEsistente = campoNascosto.value.trim();
        if (valoreEsistente) {
            const datiEsistenti = JSON.parse(valoreEsistente);
            if (datiEsistenti.seguiti_eventi && Array.isArray(datiEsistenti.seguiti_eventi)) {
                seguitiEsistenti = datiEsistenti.seguiti_eventi;
            }
        }
    } catch (e) {
        console.log('[SEGUITI] Errore parsing seguiti esistenti:', e);
        seguitiEsistenti = [];
    }
    
    console.log('[SEGUITI] Seguiti esistenti:', seguitiEsistenti);
    
    // Converti i nuovi seguiti nel formato corretto
    const nuoviSeguiti = seguitiSelezionati.map(s => ({
        evento_id: s.id,
        protocollo: s.protocollo,
        data_msg_evento: s.data_msg,
        note: `Collegato a evento #${s.id}`
    }));
    
    // UNISCI i seguiti esistenti con quelli nuovi (evitando duplicati)
    const seguitiEsistentiIds = seguitiEsistenti.map(s => s.evento_id);
    const seguitiFiltrati = nuoviSeguiti.filter(nuovo => 
        !seguitiEsistentiIds.includes(nuovo.evento_id)
    );
    
    const seguitiFinali = [...seguitiEsistenti, ...seguitiFiltrati];
    
    console.log('[SEGUITI] Seguiti finali (esistenti + nuovi):', seguitiFinali);
    
    // Aggiorna il campo nascosto con TUTTI i seguiti (esistenti + nuovi)
    const seguitiData = {
        seguiti_eventi: seguitiFinali
    };
    
    document.getElementById('seguiti_eventi').value = JSON.stringify(seguitiData);
    
    // Aggiorna la visualizzazione principale tabella
    aggiornaTabellaSeguiti();
    
    // Chiudi il modal
    chiudiModalSeguiti();
    
    console.log('[SEGUITI] Seguiti confermati e salvati (totale:', seguitiFinali.length, ')');
}


// Funzione per resettare la ricerca
function resetRicerca() {
    document.getElementById('search-protocollo').value = '';
    document.getElementById('search-data').value = '';
    document.getElementById('risultati-ricerca').innerHTML = `
        <div class="alert alert-info" id="info-ricerca">
            <i class="fas fa-info-circle"></i> Inserisci i criteri di ricerca e premi "Cerca Eventi"
        </div>`;
    
    seguitiSelezionati = [];
    document.getElementById('seguiti-selezionati').style.display = 'none';
}

// === FUNZIONI PER GESTIONE SEGUITI ESISTENTI ===

// Funzione per visualizzare un evento collegato
function visualizzaEvento(eventoId) {
    console.log('[SEGUITI] Visualizzazione evento:', eventoId);
    
    // Apri l'evento in una nuova scheda/finestra
    const url = `/eventi/visualizza/${eventoId}`;
    window.open(url, '_blank');
}

// Funzione per rimuovere un seguito dalla lista esistente
function rimuoviSeguito(eventoId) {
    console.log('[SEGUITI] Rimozione seguito evento:', eventoId);
    
    if (confirm('Sei sicuro di voler rimuovere questo evento seguito? Questa azione sar√† permanente quando salvi le modifiche.')) {
        const row = document.querySelector(`tr[data-evento-id="${eventoId}"]`);
        if (row) {
            // Animazione di rimozione
            row.classList.add('seguiti-removing');
            
            setTimeout(() => {
                row.classList.add('seguiti-removed');
                
                setTimeout(() => {
                    // Rimuovi dal DOM
                    row.remove();
                    
                    // Aggiorna il campo nascosto
                    aggiornaSeguitiNascosti();
                    
                    // Aggiorna la visualizzazione
                    aggiornaContatoreSeguiti();
                    
                    console.log('[SEGUITI] Seguito rimosso con successo');
                }, 300);
            }, 150);
        }
    }
}

// Funzione per aggiornare i dati nascosti dopo rimozione
function aggiornaSeguitiNascosti() {
    try {
        // Ottieni tutti i seguiti rimanenti dalla tabella
        const rows = document.querySelectorAll('#seguiti-table-display tbody tr');
        const seguiti = [];
        
        rows.forEach(row => {
            const eventoId = row.getAttribute('data-evento-id');
            const protocollo = row.cells[0].textContent.trim();
            const dataMsg = row.cells[1].textContent.trim();
            const dettagli = row.cells[2].querySelector('.dettagli-troncati').textContent.trim();
            
            seguiti.push({
                evento_id: parseInt(eventoId),
                protocollo: protocollo !== 'N/D' ? protocollo : '',
                data_msg_evento: dataMsg !== 'N/D' ? dataMsg : '',
                tipologia_nome: dettagli !== 'N/D' ? dettagli : '',
                note: `Collegato a evento #${eventoId}`
            });
        });
        
        // Aggiorna il campo nascosto
        const seguitiData = { seguiti_eventi: seguiti };
        document.getElementById('seguiti_eventi').value = JSON.stringify(seguitiData);
        
        console.log('[SEGUITI] Dati nascosti aggiornati:', seguitiData);
        
    } catch (error) {
        console.error('[SEGUITI] Errore aggiornamento dati nascosti:', error);
    }
}

// Funzione per aggiornare il contatore dei seguiti
function aggiornaContatoreSeguiti() {
    const table = document.getElementById('seguiti-table-display');
    const noSeguitiMessage = document.getElementById('no-seguiti-message');
    const contatore = document.querySelector('.seguiti-count');
    
    if (table) {
        const rows = table.querySelectorAll('tbody tr');
        const count = rows.length;
        
        if (count === 0) {
            // Nascondi tabella e mostra messaggio
            table.style.display = 'none';
            if (noSeguitiMessage) {
                noSeguitiMessage.style.display = 'block';
            }
            if (contatore) {
                contatore.style.display = 'none';
            }
        } else {
            // Aggiorna contatore
            if (contatore) {
                contatore.textContent = count;
                contatore.style.display = 'inline-block';
            }
            if (noSeguitiMessage) {
                noSeguitiMessage.style.display = 'none';
            }
        }
    }
}

// Funzione per aggiornare la visualizzazione dopo l'aggiunta di nuovi seguiti dal modal
function aggiornaTabellaSeguiti() {
    const seguitiData = document.getElementById('seguiti_eventi').value;
    if (!seguitiData) return;
    
    // Verifica che siamo nella pagina corretta - deve esistere almeno il messaggio "no seguiti" o la tabella
    const table = document.getElementById('seguiti-table-display');
    const noSeguitiMessage = document.getElementById('no-seguiti-message');
    
    if (!table && !noSeguitiMessage) {
        console.log('[SEGUITI] Aggiornamento tabella saltato - elementi non presenti in questa pagina');
        return;
    }
    
    try {
        const data = JSON.parse(seguitiData);
        if (!data.seguiti_eventi || data.seguiti_eventi.length === 0) {
            // Nessun seguito - mostra messaggio
            const noSeguitiMessage = document.getElementById('no-seguiti-message');
            
            if (table) table.style.display = 'none';
            if (noSeguitiMessage) noSeguitiMessage.style.display = 'block';
            
            const contatore = document.querySelector('.seguiti-count');
            if (contatore) contatore.style.display = 'none';
            
            return;
        }
        
        // Ricostruisci la tabella
        ricostruisciTabellaSeguitƒ±(data.seguiti_eventi);
        aggiornaContatoreSeguiti();
        
    } catch (error) {
        console.error('[SEGUITI] Errore aggiornamento tabella:', error);
    }
}

// Funzione per ricostruire completamente la tabella dei seguiti
function ricostruisciTabellaSeguitƒ±(seguiti) {
    let table = document.getElementById('seguiti-table-display');
    const noSeguitiMessage = document.getElementById('no-seguiti-message');
    
    // Se la tabella non esiste, creala dinamicamente
    if (!table && noSeguitiMessage) {
        console.log('[SEGUITI] Creazione dinamica tabella seguiti');
        
        // Nascondi il messaggio "nessun seguito"
        noSeguitiMessage.style.display = 'none';
        
        // Crea la tabella HTML
        const tableHTML = `
            <table class="seguiti-table" id="seguiti-table-display">
                <thead>
                    <tr>
                        <th>Protocollo</th>
                        <th>Data Messaggio</th>
                        <th>Dettagli Evento</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        `;
        
        // Inserisci la tabella dopo il messaggio "no seguiti"
        noSeguitiMessage.insertAdjacentHTML('afterend', tableHTML);
        table = document.getElementById('seguiti-table-display');
    }
    
    // Verifica finale che la tabella esista
    if (!table) {
        console.log('[SEGUITI] Impossibile creare o trovare tabella seguiti');
        return;
    }
    
    if (seguiti.length === 0) {
        if (table) table.style.display = 'none';
        if (noSeguitiMessage) noSeguitiMessage.style.display = 'block';
        return;
    }
    
    // Nascondi messaggio e mostra tabella
    if (noSeguitiMessage) noSeguitiMessage.style.display = 'none';
    if (table) table.style.display = 'table';
    
    // Ricostruisci il tbody
    const tbody = table.querySelector('tbody');
    if (tbody) {
        tbody.innerHTML = '';
        
        seguiti.forEach(seguito => {
            const row = document.createElement('tr');
            row.setAttribute('data-evento-id', seguito.evento_id);
            
            row.innerHTML = `
                <td>${seguito.prot_msg_evento || seguito.protocollo || 'N/D'}</td>
                <td>${seguito.data_msg_evento || 'N/D'}</td>
                <td>
                    <span class="dettagli-troncati" title="${seguito.tipologia_nome || 'N/D'}">
                        ${seguito.tipologia_nome || 'N/D'}
                    </span>
                </td>
                <td style="text-align: center;">
                    <button type="button" class="btn btn-sm btn-outline-primary me-1" 
                            onclick="visualizzaEvento(${seguito.evento_id})" 
                            title="Visualizza evento">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-danger" 
                            onclick="rimuoviSeguito(${seguito.evento_id})" 
                            title="Rimuovi seguito">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            
            tbody.appendChild(row);
        });
    }
}

// Inizializza i seguiti al caricamento della pagina
document.addEventListener('DOMContentLoaded', function() {
    console.log('[INIT] Avvio inizializzazione modifica evento');
    
    // Pulizia immediata
    pulisciModalEBackdrop();
    
    // Pulizia ritardata per catturare eventuali conflitti tardivi
    setTimeout(() => {
        console.log('[INIT] Seconda pulizia di sicurezza - DISABILITATA per preservare modalSeguiti');
        // NON chiamare pulisciModalEBackdrop() qui perch√© potrebbe distruggere il modal appena inizializzato
        // pulisciModalEBackdrop();
    }, 500);
    
    // Inizializzazione event listeners con ritardo
    setTimeout(function() {
        console.log('[INIT] Inizializzazione event listeners per modal seguiti');
        
        
        // Configura il pulsante di chiusura del modal
        const closeButton = document.querySelector('#modalSeguiti .btn-close');
        if (closeButton) {
            closeButton.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('[SEGUITI] Click su pulsante chiusura');
                chiudiModalSeguiti();
            });
        }
        
        // Gestione anche per eventuali pulsanti Annulla
        const cancelButtons = document.querySelectorAll('#modalSeguiti [onclick="chiudiModalSeguiti()"]');
        cancelButtons.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('[SEGUITI] Click su pulsante annulla');
                chiudiModalSeguiti();
            });
        });
        
        console.log('[INIT] Inizializzazione completata');
        
    }, 100);
    
    // Pulizia periodica per catturare problemi durante la navigazione
    setInterval(() => {
        const backdrops = document.querySelectorAll('.modal-backdrop');
        const modalSeguiti = document.getElementById('modalSeguiti');
        const modalSeguitiVisible = modalSeguiti && (modalSeguiti.classList.contains('show') || modalSeguiti.style.display === 'block');
        
        if (backdrops.length > 0 && !document.querySelector('.modal.show') && !modalSeguitiVisible) {
            console.log('[MAINTENANCE] Pulizia backdrop orfani');
            backdrops.forEach(backdrop => backdrop.remove());
            document.body.classList.remove('modal-open');
            document.body.removeAttribute('style');
        }
    }, 2000);
});

// Funzione per pulire modal e backdrop che potrebbero essere rimasti aperti
function pulisciModalEBackdrop() {
    console.log('[MODAL-CLEANUP] Pulizia aggressiva modal e backdrop residui');
    
    try {
        // Step 1: Rimuovi TUTTI i backdrop
        const backdrops = document.querySelectorAll('.modal-backdrop, [class*="backdrop"], [style*="backdrop"]');
        console.log(`[MODAL-CLEANUP] Trovati ${backdrops.length} backdrop da rimuovere`);
        backdrops.forEach((backdrop, index) => {
            console.log(`[MODAL-CLEANUP] Rimozione backdrop ${index + 1}:`, backdrop.className);
            backdrop.remove();
        });
        
        // Step 2: Reset completo del body
        document.body.classList.remove('modal-open');
        document.body.style.paddingRight = '';
        document.body.style.overflow = '';
        document.body.style.position = '';
        document.body.removeAttribute('style');
        console.log('[MODAL-CLEANUP] Body reset completato');
        
        // Step 3: Gestisci tutti i modal esistenti (ESCLUSO modalSeguiti)
        const modals = document.querySelectorAll('.modal');
        console.log(`[MODAL-CLEANUP] Trovati ${modals.length} modal da verificare`);
        
        modals.forEach((modalElement, index) => {
            try {
                console.log(`[MODAL-CLEANUP] Processamento modal ${index + 1}: ${modalElement.id}`);
                
                // IMPORTANTE: Non toccare il nostro modal seguiti
                if (modalElement.id === 'modalSeguiti') {
                    console.log('[MODAL-CLEANUP] Saltando modalSeguiti per preservarlo');
                    // Solo reset minimo per modalSeguiti
                    modalElement.style.display = 'none';
                    modalElement.classList.remove('show');
                    modalElement.setAttribute('aria-hidden', 'true');
                    return;
                }
                
                // Per altri modal, pulizia completa
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                if (modalInstance) {
                    console.log(`[MODAL-CLEANUP] Chiusura istanza Bootstrap per: ${modalElement.id}`);
                    modalInstance.dispose();
                }
                
                // Reset manuale completo per altri modal
                modalElement.style.display = 'none';
                modalElement.style.zIndex = '';
                modalElement.classList.remove('show', 'fade');
                modalElement.setAttribute('aria-hidden', 'true');
                modalElement.removeAttribute('aria-modal');
                modalElement.removeAttribute('role');
                modalElement.removeAttribute('tabindex');
                
            } catch (modalError) {
                console.error(`[MODAL-CLEANUP] Errore processamento modal ${modalElement.id}:`, modalError);
            }
        });
        
        // Step 4: Rimuovi eventuali overlay nascosti o problematici
        const overlays = document.querySelectorAll('[style*="z-index"], [class*="overlay"]');
        overlays.forEach(overlay => {
            if (overlay.style.zIndex && parseInt(overlay.style.zIndex) > 1000) {
                console.log('[MODAL-CLEANUP] Rimozione overlay problematico:', overlay);
                overlay.remove();
            }
        });
        
        // Step 5: Force enable di tutti gli input/button che potrebbero essere disabilitati
        document.querySelectorAll('input, button, select, textarea').forEach(element => {
            if (element.hasAttribute('disabled') && !element.dataset.originalDisabled) {
                element.removeAttribute('disabled');
            }
            element.style.pointerEvents = '';
        });
        
        console.log('[MODAL-CLEANUP] Pulizia aggressiva completata con successo');
        
    } catch (error) {
        console.error('[MODAL-CLEANUP] Errore durante pulizia:', error);
        // Fallback estremo
        document.body.className = document.body.className.replace(/modal-open/g, '');
        document.body.removeAttribute('style');
    }
}

// Funzione di emergenza per sbloccare la pagina (accessibile dalla console)
window.sbloccaPagina = function() {
    console.log('[EMERGENZA] SBLOCCO FORZATO DELLA PAGINA');
    
    try {
        // STEP 1: Distruzione aggressiva di tutti i backdrop
        const allBackdrops = document.querySelectorAll('.modal-backdrop, [class*="backdrop"], div[style*="backdrop"]');
        console.log(`[EMERGENZA] Rimozione di ${allBackdrops.length} backdrop`);
        allBackdrops.forEach(el => el.parentNode.removeChild(el));
        
        // STEP 2: Reset brutale del body
        document.body.className = document.body.className.replace(/modal-open/g, '');
        document.body.removeAttribute('style');
        document.body.style.cssText = '';
        document.body.style.overflow = 'visible';
        document.body.style.position = 'static';
        document.body.style.paddingRight = '0';
        
        // STEP 3: Distruzione di tutti i modal Bootstrap
        document.querySelectorAll('.modal').forEach(modal => {
            try {
                const instance = bootstrap.Modal.getInstance(modal);
                if (instance) {
                    instance.dispose();
                }
            } catch (e) { /* ignore */ }
            
            modal.style.display = 'none';
            modal.style.zIndex = '';
            modal.classList.remove('show', 'fade');
            modal.setAttribute('aria-hidden', 'true');
            modal.removeAttribute('aria-modal');
            modal.removeAttribute('role');
            modal.removeAttribute('tabindex');
        });
        
        // STEP 4: Rimozione elementi con z-index elevato
        document.querySelectorAll('*').forEach(el => {
            const zIndex = parseInt(window.getComputedStyle(el).zIndex);
            if (zIndex > 999) {
                console.log(`[EMERGENZA] Reset z-index per elemento:`, el);
                el.style.zIndex = '';
                el.style.position = '';
            }
        });
        
        // STEP 5: Riabilitazione forzata di tutti gli elementi
        document.querySelectorAll('input, button, select, textarea, a').forEach(el => {
            el.style.pointerEvents = '';
            el.removeAttribute('disabled');
        });
        
        // STEP 6: Reset eventi globali problematici
        document.onclick = null;
        document.onkeydown = null;
        window.onclick = null;
        
        console.log('[EMERGENZA] ‚úÖ SBLOCCO COMPLETATO CON SUCCESSO');
        
        // Notifica visiva
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed; top: 20px; right: 20px; z-index: 99999;
            background: #28a745; color: white; padding: 15px;
            border-radius: 5px; font-weight: bold;
        `;
        notification.textContent = 'PAGINA SBLOCCATA! ‚úÖ';
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 3000);
        
    } catch (error) {
        console.error('[EMERGENZA] Errore durante sblocco:', error);
        alert('Errore durante lo sblocco. Prova a ricaricare la pagina (F5).');
    }
};

// Scorciatoia da tastiera di emergenza: Ctrl+Alt+U
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.altKey && e.key === 'u') {
        e.preventDefault();
        console.log('[EMERGENZA] Scorciatoia da tastiera attivata');
        window.sbloccaPagina();
    }
});
</script>
{% endblock %}