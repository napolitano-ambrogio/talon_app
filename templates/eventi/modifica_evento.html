{% extends "shared/_base.html" %}

{% block title %}Modifica Evento - TALON{% endblock %}

{% block additional_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/advanced-table.css') }}?v=1.0">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/slim-searchable-select.css') }}?v=1.0">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/eventi-inserisci-styles.css') }}?v={{ cache_buster }}">
{% endblock %}

{% block page_title %}Modifica Evento{% endblock %}

{% block page_controls %}
<button type="button" class="btn btn-secondary" onclick="history.back()">
    <i class="fas fa-arrow-left"></i> Indietro
</button>
<button type="submit" form="form-modifica-evento" class="btn btn-primary">
    <i class="fas fa-save"></i> Aggiorna Evento
</button>
<button type="button" class="btn btn-danger" onclick="confermaEliminazione()">
    <i class="fas fa-trash"></i> Elimina Evento
</button>
{% endblock %}

{% block content %}
<main class="dashboard__content-wrapper" role="main">
    <section class="dashboard__scroll-content" aria-label="Form modifica evento">
        
        <div class="form-container">
            <form action="{{ url_for('eventi.aggiorna_evento', id=evento.id) }}" method="POST" id="form-modifica-evento">
                
                <!-- Sezione Dati Principali -->
                <div class="form-section">
                    <h4 class="section-title">DATI EVENTO</h4>
                    
                    <div class="form-group">
                        <label for="ente_id">Ente Militare <span class="required">*</span></label>
                        <select name="ente_id" id="ente_id" required 
                                aria-label="Seleziona ente militare" autocomplete="organization">
                            <option value="" disabled>-- Seleziona ente militare --</option>
                            {% for ente in enti_militari %}
                                <option value="{{ ente.id }}"
                                        {% if ente.id == evento.ente_id %}selected{% endif %}
                                        data-codice="{{ ente.codice or '' }}"
                                        data-indirizzo="{{ ente.indirizzo or '' }}"
                                        data-details="{% if ente.codice %}[{{ ente.codice }}] {% endif %}{% if ente.indirizzo %}{{ ente.indirizzo }}{% endif %}"
                                        data-html="{{ ente.nome }}{% if ente.indirizzo %}<br><small style='font-size: 0.85em; font-style: italic; color: #666;'>{{ ente.indirizzo }}</small>{% endif %}">
                                    {{ ente.nome }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Protocollo e Data Messaggio Evento sotto ente militare -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="prot_msg_evento">Protocollo Messaggio Evento <span class="required">*</span></label>
                            <input type="text" id="prot_msg_evento" name="prot_msg_evento" class="form-control" required
                                   value="{% if evento.prot_msg_evento %}{{ evento.prot_msg_evento }}{% else %}0000000{% endif %}"
                                   pattern="[0-9]{7}"
                                   placeholder="0000000" 
                                   aria-label="Protocollo messaggio evento (7 cifre)" 
                                   autocomplete="off"
                                   title="Inserire un numero di protocollo. VerrÃ  automaticamente formattato a 7 cifre (es: 5734 diventa 0005734)">
                        </div>
                        
                        <div class="form-group">
                            <label for="data_msg_evento">Data Messaggio Evento <span class="required">*</span></label>
                            <input type="date" id="data_msg_evento" name="data_msg_evento" class="form-control" required
                                   value="{{ evento.data_msg_evento.strftime('%Y-%m-%d') if evento.data_msg_evento else '' }}">
                        </div>
                    </div>

                    <!-- Data Evento, Carattere e Tipo Evento allineati su una riga -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="data_evento">Data Evento</label>
                            <input type="date" id="data_evento" name="data_evento" class="form-control" 
                                   value="{{ evento.data_evento.strftime('%Y-%m-%d') if evento.data_evento else '' }}">
                        </div>
                        
                        <div class="form-group">
                            <label for="carattere">Carattere Evento <span class="required">*</span></label>
                            <select name="carattere" id="carattere" class="form-control" required>
                                <option value="" disabled>-- Seleziona carattere --</option>
                                <option value="positivo" {% if evento.carattere == 'positivo' %}selected{% endif %}>POSITIVO</option>
                                <option value="negativo" {% if evento.carattere == 'negativo' %}selected{% endif %}>NEGATIVO</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="tipo_evento">Tipo Evento <span class="required">*</span></label>
                            <select name="tipo_evento" id="tipo_evento" class="form-control" required>
                                <option value="" disabled>-- Seleziona tipo --</option>
                                <option value="tipo_a" {% if evento.tipo_evento == 'tipo_a' %}selected{% endif %}>TIPO A</option>
                                <option value="tipo_b" {% if evento.tipo_evento == 'tipo_b' %}selected{% endif %}>TIPO B</option>
                                <option value="tipo_c" {% if evento.tipo_evento == 'tipo_c' %}selected{% endif %}>TIPO C</option>
                                <option value="tipo_d" {% if evento.tipo_evento == 'tipo_d' %}selected{% endif %}>TIPO D</option>
                                <option value="tipo_e" {% if evento.tipo_evento == 'tipo_e' %}selected{% endif %}>TIPO E</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="tipologia_evento_id">Tipologia Evento <span class="required">*</span></label>
                        <select name="tipologia_evento_id" id="tipologia_evento_id" required aria-label="Seleziona tipologia evento" autocomplete="off">
                            <option value="" disabled {% if not evento.tipologia_evento_id %}selected{% endif %}>-- Seleziona tipologia evento --</option>
                            {% for tipologia in tipologie_evento %}
                                <option value="{{ tipologia.id }}"
                                        {% if tipologia.id == evento.tipologia_evento_id %}selected{% endif %}
                                        data-descrizione="{{ (tipologia.descrizione or '') | upper }}">
                                    {{ tipologia.nome | upper }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="note">Note Aggiuntive</label>
                        <textarea id="note" name="note" class="form-control" 
                                  placeholder="Eventuali note aggiuntive (MAIUSCOLO)">{{ evento.note or '' }}</textarea>
                    </div>

                    <div class="form-group eventi-seguiti-section">
                        <button type="button" class="btn btn-secondary btn-aggiungi-seguiti" onclick="aprirModalSeguiti()" 
                                aria-label="Apri modal per aggiungere eventi seguiti">
                            <i class="fas fa-plus"></i> Aggiungi seguiti
                        </button>
                        
                        <input type="hidden" name="seguiti_eventi" id="seguiti_eventi" value="{{ prot_data_json if prot_data_json else '' }}">
                        
                        {% if prot_data and prot_data.seguiti_eventi %}
                        <div class="form-group" style="margin-top: 15px;">
                            <label>Eventi Seguiti Collegati 
                                <span class="seguiti-count">{{ prot_data.seguiti_eventi|length }}</span>
                                <small class="text-muted" style="font-weight: normal; margin-left: 10px;">
                                    (gestisci eventi seguiti)
                                </small>
                            </label>
                            <table class="seguiti-table" id="seguiti-table-display">
                                <thead>
                                    <tr>
                                        <th>Protocollo</th>
                                        <th>Data Messaggio</th>
                                        <th>Tipologia Evento</th>
                                        <th style="width: 120px; text-align: center;">Azioni</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for seguito in prot_data.seguiti_eventi %}
                                    <tr data-evento-id="{{ seguito.evento_id }}">
                                        <td>{{ seguito.prot_msg_evento or seguito.protocollo or 'N/D' }}</td>
                                        <td>{{ seguito.data_msg_evento or 'N/D' }}</td>
                                        <td>
                                            <span class="dettagli-troncati" title="{{ (seguito.tipologia_nome or seguito.tipologia_descrizione or 'N/D') | upper }}">
                                                {{ (seguito.tipologia_nome or seguito.tipologia_descrizione or 'N/D') | upper }}
                                            </span>
                                        </td>
                                        <td style="text-align: center;">
                                            <button type="button" class="btn btn-sm btn-outline-primary me-1" 
                                                    onclick="visualizzaEvento({{ seguito.evento_id }})" 
                                                    title="Visualizza evento">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger" 
                                                    onclick="rimuoviSeguito({{ seguito.evento_id }})" 
                                                    title="Rimuovi seguito">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div id="no-seguiti-message" class="alert alert-info" style="margin-top: 15px;">
                            <i class="fas fa-info-circle"></i> Nessun evento seguito collegato. 
                            Clicca su "Aggiungi seguiti" per aggiungerne.
                        </div>
                        {% endif %}
                    </div>
                </div>


                <!-- Campo nascosto per ID evento -->
                <input type="hidden" name="evento_id" value="{{ evento.id }}">

            </form>
        </div>
        
    </section>
</main>

<!-- Modal per gestire i seguiti eventi -->
<div class="modal fade" id="modalSeguiti" tabindex="-1" aria-labelledby="modalSeguitiLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-ricerca-seguiti">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalSeguitiLabel">
                    <i class="fas fa-search"></i> Ricerca Eventi Seguiti
                </h5>
                <button type="button" class="btn-close btn-close-custom" onclick="chiudiModalSeguiti()" data-close-modal aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Form di ricerca -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="search-protocollo" class="form-label">Protocollo Messaggio</label>
                        <input type="text" class="form-control eventi-search-protocollo" id="search-protocollo" 
                               name="search-protocollo" placeholder="Es. 0085506" 
                               aria-label="Ricerca per protocollo" autocomplete="off">
                    </div>
                    <div class="col-md-6">
                        <label for="search-data" class="form-label">Data Messaggio</label>
                        <input type="date" class="form-control eventi-search-data" id="search-data" 
                               name="search-data" aria-label="Ricerca per data messaggio" 
                               autocomplete="off">
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-12">
                        <button type="button" class="btn btn-primary" onclick="cercaEventi()" 
                                aria-label="Avvia ricerca eventi">
                            <i class="fas fa-search"></i> Cerca Eventi
                        </button>
                        <button type="button" class="btn btn-secondary ms-2" onclick="resetRicerca()" 
                                aria-label="Reimposta campi di ricerca">
                            <i class="fas fa-eraser"></i> Reset
                        </button>
                    </div>
                </div>
                
                <!-- Risultati ricerca -->
                <div id="risultati-ricerca">
                    <div class="alert alert-info" id="info-ricerca">
                        <i class="fas fa-info-circle"></i> Inserisci i criteri di ricerca e premi "Cerca Eventi"
                        <br><small><strong>ðŸ’¡ Suggerimento:</strong> Puoi selezionare <strong>piÃ¹ eventi</strong> cliccando sui pulsanti "Seleziona" e poi confermare tutti insieme</small>
                    </div>
                </div>
                
                <div id="seguiti-selezionati" class="eventi-seguiti-selezionati">
                    <hr>
                    <h6>Eventi selezionati come seguiti:</h6>
                    <div id="lista-seguiti-modal" class="border rounded p-2 bg-light">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="chiudiModalSeguiti()" 
                        data-close-modal aria-label="Chiudi modal senza salvare">
                    <i class="fas fa-times"></i> Annulla
                </button>
                <button type="button" class="btn btn-success" onclick="confermaSeguitiSelezionati()" 
                        aria-label="Conferma selezione eventi seguiti">
                    <i class="fas fa-check"></i> Conferma Selezione
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* STILI PER SEGUITI EVENTI - TABELLARE SEMPLICE - COPIATO DA VISUALIZZA_EVENTO */
.seguiti-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    font-size: 0.9rem;
}

.seguiti-table th {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    padding: 10px 12px;
    text-align: left;
    font-weight: 600;
    color: #495057;
}

.seguiti-table td {
    border: 1px solid #dee2e6;
    padding: 10px 12px;
    vertical-align: middle;
}

.seguiti-table tbody tr {
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
}

.seguiti-table tbody tr:hover {
    background-color: #e3f2fd;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
}

.seguiti-table tbody tr:active {
    transform: translateY(0);
    box-shadow: 0 1px 3px rgba(102, 126, 234, 0.2);
}

/* Miglioramento del cursore e dell'aspetto generale */
.seguiti-table tbody tr td {
    position: relative;
}

.seguiti-table tbody tr:hover td {
    color: #1565c0;
}

.seguiti-count {
    display: inline-block;
    background: #667eea;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
    margin-left: 10px;
}

.dettagli-troncati {
    max-width: 300px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: inline-block;
}

/* Animazioni per rimozione seguiti */
.seguiti-removing {
    opacity: 0.5;
    transform: scale(0.95);
    transition: all 0.3s ease;
}

.seguiti-removed {
    opacity: 0;
    transform: translateX(-100%);
    transition: all 0.3s ease;
}

</style>
{% endblock %}

{% block extra_js %}
<!-- Core Dependencies -->
<script src="{{ url_for('static', filename='js/components/advanced-table.js') }}?v={{ cache_buster }}"></script>
<script src="{{ url_for('static', filename='js/components/slim-searchable-select.js') }}?v={{ cache_buster }}"></script>

<!-- Eventi Bundle - carica tutti i componenti eventi in ordine corretto -->
<script>window.EVENTI_CACHE_VERSION = '{{ cache_buster }}';</script>
<script src="{{ url_for('static', filename='js/components/eventi-bundle.js') }}?v={{ cache_buster }}"></script>

<!-- Script specifici per modifica evento -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('[Modifica Evento] DOM caricato, inizializzazione form...');
    
    // Forza tutti i campi di testo in MAIUSCOLO
    const textInputs = document.querySelectorAll('input[type="text"], textarea');
    textInputs.forEach(function(input) {
        // Escludi campi numerici o di data
        if (input.type === 'number' || input.type === 'date') {
            return;
        }
        
        input.style.textTransform = 'uppercase';
        
        input.addEventListener('input', function() {
            const start = this.selectionStart;
            const end = this.selectionEnd;
            this.value = this.value.toUpperCase();
            this.setSelectionRange(start, end);
        });
        
        // Converti il valore corrente in maiuscolo
        if (input.value) {
            input.value = input.value.toUpperCase();
        }
    });
    
    
    // Log di debug per valore ente selezionato
    const enteSelect = document.getElementById('ente_id');
    if (enteSelect) {
        console.log('[Modifica Evento] Valore ente al caricamento:', enteSelect.value);
        console.log('[Modifica Evento] Opzione selezionata:', enteSelect.options[enteSelect.selectedIndex]?.text);
    }
    
    console.log('[Modifica Evento] Inizializzazione completata');
});

// Funzione per confermare eliminazione
function confermaEliminazione() {
    const eventoId = {{ evento.id }};
    const conferma = prompt(
        'ATTENZIONE: Stai per eliminare definitivamente questo evento.\n\n' +
        'Questa operazione Ã¨ IRREVERSIBILE!\n\n' +
        'Per confermare, digita il numero ID dell\'evento: ' + eventoId
    );
    
    if (conferma === null) {
        return false; // Utente ha annullato
    }
    
    if (conferma !== eventoId.toString()) {
        alert('ID non corretto. Eliminazione annullata.');
        return false;
    }
    
    const confermaFinale = confirm(
        'Ultima conferma:\n\n' +
        'Sei ASSOLUTAMENTE SICURO di voler eliminare questo evento?\n\n' +
        'Questa azione NON puÃ² essere annullata!'
    );
    
    if (confermaFinale) {
        // Crea e invia form per eliminazione
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("eventi.elimina_evento", id=evento.id) }}';
        
        // Aggiungi token CSRF se necessario
        const csrfToken = document.querySelector('meta[name="csrf-token"]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfToken.getAttribute('content');
            form.appendChild(csrfInput);
        }
        
        document.body.appendChild(form);
        form.submit();
    }
}

// Funzione per visualizzare un evento collegato
function visualizzaEvento(eventoId) {
    console.log('[SEGUITI] Visualizzazione evento:', eventoId);
    
    // Apri l'evento in una nuova scheda/finestra
    const url = `/eventi/visualizza/${eventoId}`;
    window.open(url, '_blank');
}

// Funzione per rimuovere un seguito dalla lista esistente
function rimuoviSeguito(eventoId) {
    console.log('[SEGUITI] Rimozione seguito evento:', eventoId);
    
    if (confirm('Sei sicuro di voler rimuovere questo evento seguito? Questa azione sarÃ  permanente quando salvi le modifiche.')) {
        const row = document.querySelector(`tr[data-evento-id="${eventoId}"]`);
        if (row) {
            // Animazione di rimozione
            row.classList.add('seguiti-removing');
            
            setTimeout(() => {
                row.classList.add('seguiti-removed');
                
                setTimeout(() => {
                    // Rimuovi dal DOM
                    row.remove();
                    
                    // Aggiorna il campo nascosto
                    aggiornaSeguitiNascosti();
                    
                    // Aggiorna la visualizzazione
                    aggiornaContatoreSeguiti();
                    
                    console.log('[SEGUITI] Seguito rimosso con successo');
                }, 300);
            }, 150);
        }
    }
}

// Funzione per aggiornare i dati nascosti dopo rimozione
function aggiornaSeguitiNascosti() {
    try {
        // Ottieni tutti i seguiti rimanenti dalla tabella
        const rows = document.querySelectorAll('#seguiti-table-display tbody tr');
        const seguiti = [];
        
        rows.forEach(row => {
            const eventoId = row.getAttribute('data-evento-id');
            const protocollo = row.cells[0].textContent.trim();
            const dataMsg = row.cells[1].textContent.trim();
            const dettagli = row.cells[2].querySelector('.dettagli-troncati').textContent.trim();
            
            seguiti.push({
                evento_id: parseInt(eventoId),
                prot_msg_evento: protocollo !== 'N/D' ? protocollo : '',
                data_msg_evento: dataMsg !== 'N/D' ? dataMsg : '',
                tipologia_nome: dettagli !== 'N/D' ? dettagli : '',
                note: `Collegato a evento #${eventoId}`
            });
        });
        
        // Aggiorna il campo nascosto
        const seguitiData = { seguiti_eventi: seguiti };
        document.getElementById('seguiti_eventi').value = JSON.stringify(seguitiData);
        
        console.log('[SEGUITI] Dati nascosti aggiornati:', seguitiData);
        
    } catch (error) {
        console.error('[SEGUITI] Errore aggiornamento dati nascosti:', error);
    }
}

// Funzione per aggiornare il contatore dei seguiti
function aggiornaContatoreSeguiti() {
    const table = document.getElementById('seguiti-table-display');
    const noSeguitiMessage = document.getElementById('no-seguiti-message');
    const contatore = document.querySelector('.seguiti-count');
    
    if (table) {
        const rows = table.querySelectorAll('tbody tr');
        const count = rows.length;
        
        if (count === 0) {
            // Nascondi tabella e mostra messaggio
            table.closest('.form-group').style.display = 'none';
            if (noSeguitiMessage) {
                noSeguitiMessage.style.display = 'block';
            }
        } else {
            // Aggiorna contatore
            if (contatore) {
                contatore.textContent = count;
            }
        }
    }
}

// Script per formattazione automatica protocollo
document.addEventListener('DOMContentLoaded', function() {
    const protInput = document.getElementById('prot_msg_evento');
    
    if (protInput) {
        let isFirstEdit = true; // Flag per gestire il primo edit
        
        // Durante la digitazione: gestisci la transizione da formato paddato a numero naturale
        protInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, ''); // Rimuovi caratteri non numerici
            
            // Se Ã¨ il primo edit e il valore era "0000000", resetta
            if (isFirstEdit && e.target.value.length > 0 && value !== '0000000') {
                isFirstEdit = false;
                value = value.replace(/^0+/, ''); // Rimuovi zeri iniziali
                if (value === '') value = '0'; // Mantieni almeno uno zero se tutto zeri
            }
            
            if (value.length > 7) {
                value = value.slice(0, 7); // Limita a massimo 7 cifre
            }
            e.target.value = value; // Mostra solo il numero senza padding durante la digitazione
        });
        
        // Applica formattazione quando il campo perde il focus
        protInput.addEventListener('blur', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 0) {
                e.target.value = value.padStart(7, '0'); // Applica padding
            } else {
                e.target.value = '0000000'; // Valore di default se vuoto
            }
            isFirstEdit = false; // Reset del flag
        });
        
        // Seleziona tutto quando riceve focus per facilitare sovrascrittura
        protInput.addEventListener('focus', function(e) {
            e.target.select();
        });
        
        console.log('[Modifica Evento] Auto-formattazione protocollo inizializzata');
    }
});
</script>
{% endblock %}