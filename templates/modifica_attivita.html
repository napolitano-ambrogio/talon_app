{% extends "_base.html" %}

{% block title %}Modifica Attività - TALON{% endblock %}

{% block content %}
<div class="form-container">
    <h1>Modifica Attività</h1>
    
    <form action="{{ url_for('attivita.aggiorna_attivita', id=attivita.id) }}" method="POST">
        
        <h3>Dati Principali</h3>
        <div class="form-group">
            <label for="ente_svolgimento_id">Ente che svolge l'attività:</label>
            <div class="searchable-select" data-select-id="ente_svolgimento_id"></div>
            <select name="ente_svolgimento_id" id="ente_svolgimento_id" style="display: none;" required>
                <option value="" disabled>-- Seleziona un ente --</option>
                {% for ente in enti_militari %}
                    <option value="{{ ente.id }}"
                            data-codice="{{ ente.codice or '' }}"
                            data-indirizzo="{{ ente.indirizzo or '' }}"
                            data-civico="{{ ente.civico or '' }}"
                            data-citta="{{ ente.citta or '' }}"
                            data-provincia="{{ ente.provincia or '' }}"
                            data-cap="{{ ente.cap or '' }}"
                            data-details="{% if ente.codice %}[{{ ente.codice }}] {% endif %}{{ ente.indirizzo or '' }} {{ ente.civico or '' }} - {{ ente.cap or '' }} {{ ente.citta or '' }} ({{ ente.provincia or '' }})"
                            {% if ente.id == attivita.ente_svolgimento_id %}selected{% endif %}>
                        {{ ente.nome }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="tipologia_id">Tipo di Attività:</label>
            <div class="searchable-select" data-select-id="tipologia_id"></div>
            <select name="tipologia_id" id="tipologia_id" style="display: none;" required>
                <option value="" disabled>-- Seleziona una tipologia --</option>
                {% for categoria, sottocategorie in tipologie.items() %}
                    <optgroup label="{{ categoria }}">
                        {% for sub in sottocategorie %}
                            <option value="{{ sub.id }}" {% if sub.id == attivita.tipologia_id %}selected{% endif %}>
                                {{ sub.nome }}
                            </option>
                        {% endfor %}
                    </optgroup>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="operazione_id">Operazione:</label>
            <div class="searchable-select" data-select-id="operazione_id"></div>
            <select name="operazione_id" id="operazione_id" style="display: none;">
                <option value="">-- Seleziona un'operazione (se applicabile) --</option>
                {% for op in operazioni %}
                    <option value="{{ op.id }}"
                            data-nome-missione="{{ op.nome_missione }}"
                            data-nome-breve="{{ op.nome_breve or '' }}"
                            data-teatro-operativo="{{ op.teatro_operativo or '' }}"
                            data-nazione="{{ op.nazione or '' }}"
                            data-details="{% if op.nome_breve %}{{ op.nome_breve }} • {% endif %}{% if op.teatro_operativo %}{{ op.teatro_operativo }}{% endif %}{% if op.nazione %} • {{ op.nazione }}{% endif %}"
                            {% if op.id == attivita.operazione_id %}selected{% endif %}>
                        {{ op.nome_missione }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="data_inizio">Data Inizio / Data Unica:</label>
            <input type="date" id="data_inizio" name="data_inizio" value="{{ attivita.data_inizio.strftime('%Y-%m-%d') if attivita.data_inizio else '' }}" required>
        </div>
        <div class="form-group">
            <label for="data_fine">Data Fine (opzionale):</label>
            <input type="date" id="data_fine" name="data_fine" value="{{ attivita.data_fine.strftime('%Y-%m-%d') if attivita.data_fine else '' }}">
        </div>
        <div class="form-group">
            <label for="descrizione">Descrizione Generica:</label>
            <textarea id="descrizione" name="descrizione" rows="3">{{ attivita.descrizione or '' }}</textarea>
        </div>

        <!-- SEZIONE DETTAGLI TRASPORTI -->
        <div id="dettagli-trasporti" style="display: none;">
            <hr>
            <h3>Dettagli Movimenti e Trasporti</h3>
            <div class="form-group">
                <label for="tipologia_carico">Tipologia di Carico:</label>
                <input type="text" id="tipologia_carico" name="tipologia_carico" value="{{ dettagli_trasporti.tipologia_carico or '' }}">
            </div>
            <div class="form-group" style="display: flex; gap: 10px;">
                <div style="flex-grow: 1;">
                    <label for="quantita">Quantità:</label>
                    <input type="number" step="any" id="quantita" name="quantita" value="{{ dettagli_trasporti.quantita or '' }}">
                </div>
                <div>
                    <label for="unita_di_misura">Unità di Misura:</label>
                    <select id="unita_di_misura" name="unita_di_misura">
                        <option value="" {% if not dettagli_trasporti.unita_di_misura %}selected{% endif %}>-- Seleziona --</option>
                        <option value="UNITÀ" {% if dettagli_trasporti.unita_di_misura == 'UNITÀ' %}selected{% endif %}>unità</option>
                        <option value="LITRI" {% if dettagli_trasporti.unita_di_misura == 'LITRI' %}selected{% endif %}>litri</option>
                        <option value="KG" {% if dettagli_trasporti.unita_di_misura == 'KG' %}selected{% endif %}>kg</option>
                        <option value="M3" {% if dettagli_trasporti.unita_di_misura == 'M3' %}selected{% endif %}>m³</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="mezzo_impiegato">Mezzo Impiegato (Targa/Matricola):</label>
                <input type="text" id="mezzo_impiegato" name="mezzo_impiegato" value="{{ dettagli_trasporti.mezzo_impiegato or '' }}">
            </div>
        </div>
        
        <!-- SEZIONE DETTAGLI MANTENIMENTO -->
        <div id="dettagli-mantenimento" style="display: none;">
            <hr>
            <h3>Dettagli Mantenimento e Squadre a Contatto</h3>
            <div class="form-group">
                <label for="tipo_intervento">Tipo Intervento:</label>
                <select id="tipo_intervento" name="tipo_intervento">
                    <option value="" {% if not dettagli_mantenimento.tipo_intervento %}selected{% endif %}>-- Seleziona --</option>
                    <option value="INTERVENTO PRESSO LA FASCIA LOGISTICA DEL SOSTEGNO" {% if dettagli_mantenimento.tipo_intervento == 'INTERVENTO PRESSO LA FASCIA LOGISTICA DEL SOSTEGNO' %}selected{% endif %}>INTERVENTO PRESSO LA FASCIA LOGISTICA DEL SOSTEGNO</option>
                    <option value="SQUADRA A CONTATTO SUL TERRITORIO NAZIONALE" {% if dettagli_mantenimento.tipo_intervento == 'SQUADRA A CONTATTO SUL TERRITORIO NAZIONALE' %}selected{% endif %}>SQUADRA A CONTATTO SUL TERRITORIO NAZIONALE</option>
                    <option value="SQUADRA A CONTATTO IN TE.OP." {% if dettagli_mantenimento.tipo_intervento == 'SQUADRA A CONTATTO IN TE.OP.' %}selected{% endif %}>SQUADRA A CONTATTO IN TE.OP.</option>
                </select>
            </div>
            <div class="form-group">
                <label for="attivita_svolta">Attività Svolta:</label>
                <select id="attivita_svolta" name="attivita_svolta">
                    <option value="" {% if not dettagli_mantenimento.attivita_svolta %}selected{% endif %}>-- Seleziona --</option>
                    <option value="CONTROLLI E VERIFICHE TECNICHE" {% if dettagli_mantenimento.attivita_svolta == 'CONTROLLI E VERIFICHE TECNICHE' %}selected{% endif %}>CONTROLLI E VERIFICHE TECNICHE</option>
                    <option value="MANUTENZIONE PREVENTIVA" {% if dettagli_mantenimento.attivita_svolta == 'MANUTENZIONE PREVENTIVA' %}selected{% endif %}>MANUTENZIONE PREVENTIVA</option>
                    <option value="MANUTENZIONE CORRETTIVA" {% if dettagli_mantenimento.attivita_svolta == 'MANUTENZIONE CORRETTIVA' %}selected{% endif %}>MANUTENZIONE CORRETTIVA</option>
                </select>
            </div>
            <div class="form-group">
                <label for="piattaforma_materiale">Piattaforma/Sistema/Materiale su cui si è intervenuti:</label>
                <input type="text" id="piattaforma_materiale" name="piattaforma_materiale" value="{{ dettagli_mantenimento.piattaforma_materiale or '' }}">
            </div>
        </div>

        <!-- SEZIONE DETTAGLI RIFORNIMENTI -->
        <div id="dettagli-rifornimenti" style="display: none;">
            <hr>
            <h3>Dettagli Rifornimenti</h3>
            <div class="form-group">
                <label for="tipologia_rifornimento">Tipologia di Rifornimento:</label>
                <select id="tipologia_rifornimento" name="tipologia_rifornimento">
                    <option value="" {% if not dettagli_rifornimenti.tipologia_rifornimento %}selected{% endif %}>-- Seleziona --</option>
                    <option value="CARBURANTE" {% if dettagli_rifornimenti.tipologia_rifornimento == 'CARBURANTE' %}selected{% endif %}>CARBURANTE</option>
                    <option value="ASSEGNAZIONE MEZZI" {% if dettagli_rifornimenti.tipologia_rifornimento == 'ASSEGNAZIONE MEZZI' %}selected{% endif %}>ASSEGNAZIONE MEZZI</option>
                    <option value="ASSEGNAZIONE MATERIALE" {% if dettagli_rifornimenti.tipologia_rifornimento == 'ASSEGNAZIONE MATERIALE' %}selected{% endif %}>ASSEGNAZIONE MATERIALE</option>
                    <option value="RAZIONI VIVERI DA COMBATTIMENTO" {% if dettagli_rifornimenti.tipologia_rifornimento == 'RAZIONI VIVERI DA COMBATTIMENTO' %}selected{% endif %}>RAZIONI VIVERI DA COMBATTIMENTO</option>
                    <option value="ALTRO" {% if dettagli_rifornimenti.tipologia_rifornimento == 'ALTRO' %}selected{% endif %}>ALTRO</option>
                </select>
            </div>
            <div class="form-group">
                <label for="dettaglio_materiale">Dettaglio (Tipo carburante, mezzo, materiale, altro):</label>
                <input type="text" id="dettaglio_materiale" name="dettaglio_materiale" value="{{ dettagli_rifornimenti.dettaglio_materiale or '' }}">
            </div>
            <div class="form-group" style="display: flex; gap: 10px;">
                <div style="flex-grow: 1;">
                    <label for="quantita_rifornimento">Quantità:</label>
                    <input type="number" step="any" id="quantita_rifornimento" name="quantita_rifornimento" value="{{ dettagli_rifornimenti.quantita or '' }}">
                </div>
                <div>
                    <label for="unita_di_misura_rifornimento">Unità di Misura:</label>
                    <select id="unita_di_misura_rifornimento" name="unita_di_misura_rifornimento">
                        <option value="" {% if not dettagli_rifornimenti.unita_di_misura %}selected{% endif %}>-- Seleziona --</option>
                        <option value="UNITÀ" {% if dettagli_rifornimenti.unita_di_misura == 'UNITÀ' %}selected{% endif %}>unità</option>
                        <option value="LITRI" {% if dettagli_rifornimenti.unita_di_misura == 'LITRI' %}selected{% endif %}>litri</option>
                        <option value="KG" {% if dettagli_rifornimenti.unita_di_misura == 'KG' %}selected{% endif %}>kg</option>
                        <option value="M3" {% if dettagli_rifornimenti.unita_di_misura == 'M3' %}selected{% endif %}>m³</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- SEZIONE DETTAGLI GETRA -->
        <div id="dettagli-getra" style="display: none;">
            <hr>
            <h3>Dettagli Gestione Transito (GETRA)</h3>

            <div class="form-group">
                <label for="tipo_vettore">Tipo Vettore:</label>
                <div class="searchable-select" data-select-id="tipo_vettore"></div>
                <select id="tipo_vettore" name="tipo_vettore" style="display: none;">
                    <option value="">-- Seleziona Vettore --</option>
                    <option value="SAFOPS">SAFOPS - SOURCED AIR FORCE OPERATIONS</option>
                    <option value="SAFCER">SAFCER - SOURCED AIR FORCE CEREMONY</option>
                    <option value="SAFPK">SAFPK - SOURCED AIR FORCE PEACE KEEPING</option>
                    <option value="SAFHA">SAFHA - SOURCED AIR FORCE HUMANITARIAN AID</option>
                    <option value="SAFEXE">SAFEXE - SOURCED AIR FORCE EXERCISES</option>
                    <option value="SCCOPS">SCCOPS - SOURCED COMMERCIAL CARGO OPERATIONS</option>
                    <option value="SCCCER">SCCCER - SOURCED COMMERCIAL CARGO CEREMONY</option>
                    <option value="SCCPK">SCCPK - SOURCED COMMERCIAL CARGO PEACE KEEPING</option>
                    <option value="SCCHA">SCCHA - SOURCED COMMERCIAL CARGO HUMANITARIAN AID</option>
                    <option value="SCCEXE">SCCEXE - SOURCED COMMERCIAL CARGO EXERCISES</option>
                    <option value="SCPOPS">SCPOPS - SOURCED COMMERCIAL PAX OPERATIONS</option>
                    <option value="SCPCER">SCPCER - SOURCED COMMERCIAL PAX CEREMONY</option>
                    <option value="SCPPK">SCPPK - SOURCED COMMERCIAL PAX PEACE KEEPING</option>
                    <option value="SCPHA">SCPHA - SOURCED COMMERCIAL PAX HUMANITARIAN AID</option>
                    <option value="SCPEXE">SCPEXE - SOURCED COMMERCIAL PAX EXERCISES</option>
                    <option value="SCSOPS">SCSOPS - SOURCED COMMERCIAL SHIP OPERATIONS</option>
                    <option value="SCSCER">SCSCER - SOURCED COMMERCIAL SHIP CEREMONY</option>
                    <option value="SCSPK">SCSPK - SOURCED COMMERCIAL SHIP PEACE KEEPING</option>
                    <option value="SCSHA">SCSHA - SOURCED COMMERCIAL SHIP HUMANITARIAN AID</option>
                    <option value="SCSEXE">SCSEXE - SOURCED COMMERCIAL SHIP EXERCISES</option>
                    <option value="SCTOPS">SCTOPS - SOURCED COMMERCIAL TRAIN OPERATIONS</option>
                    <option value="SCTCER">SCTCER - SOURCED COMMERCIAL TRAIN CEREMONY</option>
                    <option value="SCTPK">SCTPK - SOURCED COMMERCIAL TRAIN PEACE KEEPING</option>
                    <option value="SCTHA">SCTHA - SOURCED COMMERCIAL TRAIN HUMANITARIAN AID</option>
                    <option value="SCTEXE">SCTEXE - SOURCED COMMERCIAL TRAIN EXERCISES</option>
                    <option value="SCTROPS">SCTROPS - SOURCED COMMERCIAL TRUCK OPERATIONS</option>
                    <option value="SCTRCER">SCTRCER - SOURCED COMMERCIAL TRUCK CEREMONY</option>
                    <option value="SCTRPK">SCTRPK - SOURCED COMMERCIAL TRUCK PEACE KEEPING</option>
                    <option value="SCTRHA">SCTRHA - SOURCED COMMERCIAL TRUCK HUMANITARIAN AID</option>
                    <option value="SCTREXE">SCTREXE - SOURCED COMMERCIAL TRUCK EXERCISES</option>
                    <option value="SAOPS">SAOPS - SOURCED ARMY OPERATIONS</option>
                    <option value="SACER">SACER - SOURCED ARMY CEREMONY</option>
                    <option value="SAPK">SAPK - SOURCED ARMY PEACE KEEPING</option>
                    <option value="SAHA">SAHA - SOURCED ARMY HUMANITARIAN AID</option>
                    <option value="SAEXE">SAEXE - SOURCED ARMY EXERCISES</option>
                    <option value="SNOPS">SNOPS - SOURCED NAVY OPERATIONS</option>
                    <option value="SNCER">SNCER - SOURCED NAVY CEREMONY</option>
                    <option value="SNPK">SNPK - SOURCED NAVY PEACE KEEPING</option>
                    <option value="SNHA">SNHA - SOURCED NAVY HUMANITARIAN AID</option>
                    <option value="SNEXE">SNEXE - SOURCED NAVY EXERCISES</option>
                    <option value="SUSAFOPS">SUSAFOPS - SOURCED USAF OPERATIONS</option>
                    <option value="SUSAFCER">SUSAFCER - SOURCED USAF CEREMONY</option>
                    <option value="SUSAFPK">SUSAFPK - SOURCED USAF PEACE KEEPING</option>
                    <option value="SUSAFHA">SUSAFHA - SOURCED USAF HUMANITARIAN AID</option>
                    <option value="SUSAFEXE">SUSAFEXE - SOURCED USAF EXERCISES</option>
                    <option value="SNATOOPS">SNATOOPS - SOURCED NATO OPERATIONS</option>
                    <option value="SNATOCER">SNATOCER - SOURCED NATO CEREMONY</option>
                    <option value="SNATOPK">SNATOPK - SOURCED NATO PEACE KEEPING</option>
                    <option value="SNATOHA">SNATOHA - SOURCED NATO HUMANITARIAN AID</option>
                    <option value="SNATOEXE">SNATOEXE - SOURCED NATO EXERCISES</option>
                    <option value="UAFOPS">UAFOPS - UNSOURCED AIR FORCE OPERATIONS</option>
                    <option value="UAFCER">UAFCER - UNSOURCED AIR FORCE CEREMONY</option>
                    <option value="UAFPK">UAFPK - UNSOURCED AIR FORCE PEACE KEEPING</option>
                    <option value="UAFHA">UAFHA - UNSOURCED AIR FORCE HUMANITARIAN AID</option>
                    <option value="UAFEXE">UAFEXE - UNSOURCED AIR FORCE EXERCISES</option>
                    <option value="UCCOPS">UCCOPS - UNSOURCED COMMERCIAL CARGO OPERATIONS</option>
                    <option value="UCCCER">UCCCER - UNSOURCED COMMERCIAL CARGO CEREMONY</option>
                    <option value="UCCPK">UCCPK - UNSOURCED COMMERCIAL CARGO PEACE KEEPING</option>
                    <option value="UCCHA">UCCHA - UNSOURCED COMMERCIAL CARGO HUMANITARIAN AID</option>
                    <option value="UCCEXE">UCCEXE - UNSOURCED COMMERCIAL CARGO EXERCISES</option>
                    <option value="UCPOPS">UCPOPS - UNSOURCED COMMERCIAL PAX OPERATIONS</option>
                    <option value="UCPCER">UCPCER - UNSOURCED COMMERCIAL PAX CEREMONY</option>
                    <option value="UCPPK">UCPPK - UNSOURCED COMMERCIAL PAX PEACE KEEPING</option>
                    <option value="UCPHA">UCPHA - UNSOURCED COMMERCIAL PAX HUMANITARIAN AID</option>
                    <option value="UCPEXE">UCPEXE - UNSOURCED COMMERCIAL PAX EXERCISES</option>
                    <option value="UCSOPS">UCSOPS - UNSOURCED COMMERCIAL SHIP OPERATIONS</option>
                    <option value="UCSCER">UCSCER - UNSOURCED COMMERCIAL SHIP CEREMONY</option>
                    <option value="UCSPK">UCSPK - UNSOURCED COMMERCIAL SHIP PEACE KEEPING</option>
                    <option value="UCSHA">UCSHA - UNSOURCED COMMERCIAL SHIP HUMANITARIAN AID</option>
                    <option value="UCSEXE">UCSEXE - UNSOURCED COMMERCIAL SHIP EXERCISES</option>
                    <option value="UCTOPS">UCTOPS - UNSOURCED COMMERCIAL TRAIN OPERATIONS</option>
                    <option value="UCTCER">UCTCER - UNSOURCED COMMERCIAL TRAIN CEREMONY</option>
                    <option value="UCTPK">UCTPK - UNSOURCED COMMERCIAL TRAIN PEACE KEEPING</option>
                    <option value="UCTHA">UCTHA - UNSOURCED COMMERCIAL TRAIN HUMANITARIAN AID</option>
                    <option value="UCTEXE">UCTEXE - UNSOURCED COMMERCIAL TRAIN EXERCISES</option>
                    <option value="UCTROPS">UCTROPS - UNSOURCED COMMERCIAL TRUCK OPERATIONS</option>
                    <option value="UCTRCER">UCTRCER - UNSOURCED COMMERCIAL TRUCK CEREMONY</option>
                    <option value="UCTRPK">UCTRPK - UNSOURCED COMMERCIAL TRUCK PEACE KEEPING</option>
                    <option value="UCTRHA">UCTRHA - UNSOURCED COMMERCIAL TRUCK HUMANITARIAN AID</option>
                    <option value="UCTREXE">UCTREXE - UNSOURCED COMMERCIAL TRUCK EXERCISES</option>
                    <option value="UAOPS">UAOPS - UNSOURCED ARMY OPERATIONS</option>
                    <option value="UACER">UACER - UNSOURCED ARMY CEREMONY</option>
                    <option value="UAPK">UAPK - UNSOURCED ARMY PEACE KEEPING</option>
                    <option value="UAHA">UAHA - UNSOURCED ARMY HUMANITARIAN AID</option>
                    <option value="UAEXE">UAEXE - UNSOURCED ARMY EXERCISES</option>
                    <option value="UNOPS">UNOPS - UNSOURCED NAVY OPERATIONS</option>
                    <option value="UNCER">UNCER - UNSOURCED NAVY CEREMONY</option>
                    <option value="UNPK">UNPK - UNSOURCED NAVY PEACE KEEPING</option>
                    <option value="UNHA">UNHA - UNSOURCED NAVY HUMANITARIAN AID</option>
                    <option value="UNEXE">UNEXE - UNSOURCED NAVY EXERCISES</option>
                    <option value="UUSAFOPS">UUSAFOPS - UNSOURCED USAF OPERATIONS</option>
                    <option value="UUSAFCER">UUSAFCER - UNSOURCED USAF CEREMONY</option>
                    <option value="UUSAFPK">UUSAFPK - UNSOURCED USAF PEACE KEEPING</option>
                    <option value="UUSAFHA">UUSAFHA - UNSOURCED USAF HUMANITARIAN AID</option>
                    <option value="UUSAFEXE">UUSAFEXE - UNSOURCED USAF EXERCISES</option>
                    <option value="UNATOOPS">UNATOOPS - UNSOURCED NATO OPERATIONS</option>
                    <option value="UNATOCER">UNATOCER - UNSOURCED NATO CEREMONY</option>
                    <option value="UNATOPK">UNATOPK - UNSOURCED NATO PEACE KEEPING</option>
                    <option value="UNATOHA">UNATOHA - UNSOURCED NATO HUMANITARIAN AID</option>
                    <option value="UNATOEXE">UNATOEXE - UNSOURCED NATO EXERCISES</option>
                </select>
            </div>

            <div class="form-group">
                <label for="seriale_vettore">Seriale / targa / nominativo:</label>
                <input type="text" id="seriale_vettore" name="seriale_vettore" value="{{ dettagli_getra.seriale_vettore or '' }}">
            </div>

            <!-- Riga GETRA a 4 colonne perfettamente allineata -->
            <div class="form-group getra-row" style="display:flex; gap:10px; flex-wrap:wrap;">

                <!-- Personale movimentato -->
                <div style="flex:1">
                    <label for="numero_personale">Personale<br>movimentato:</label>
                    <input type="number" id="numero_personale" name="numero_personale"
                        value="{{ dettagli_getra.numero_personale or '' }}"
                        min="0" class="form-control">
                </div>

                <!-- Mezzi movimentati -->
                <div style="flex:1">
                    <label for="numero_mezzi">Mezzi<br>movimentati:</label>
                    <input type="number" id="numero_mezzi" name="numero_mezzi"
                        value="{{ dettagli_getra.numero_mezzi or '' }}"
                        min="0" class="form-control">
                </div>

                <!-- Quantità -->
                <div style="flex:1">
                    <label for="volume">Quantità o<br>volume:</label>
                    <input type="number" id="volume" name="volume"
                        value="{{ dettagli_getra.volume or '' }}"
                        min="0" step="any" class="form-control">
                </div>

                <!-- Unità di misura -->
                <div style="flex:1">
                    <label for="unita_di_misura_getra">Unità di<br>misura:</label>
                    <select id="unita_di_misura_getra" name="unita_di_misura_getra" class="form-select">
                        <option value="" {% if not dettagli_getra.unita_di_misura %}selected{% endif %}>--</option>
                        <option value="KG" {% if dettagli_getra.unita_di_misura == 'KG' %}selected{% endif %}>Kg</option>
                        <option value="M_LIN" {% if dettagli_getra.unita_di_misura == 'M_LIN' %}selected{% endif %}>Metri lineari</option>
                        <option value="M3" {% if dettagli_getra.unita_di_misura == 'M3' %}selected{% endif %}>Metri cubi</option>
                    </select>
                </div>
            </div>
        </div>

        <hr>
        <h3>Località</h3>
        <div class="form-group">
            <label for="partenza_id">Luogo Partenza:</label>
            <div class="searchable-select" data-select-id="partenza_id"></div>
            <select name="partenza_id" id="partenza_id" style="display: none;">
                <option value="">-- Seleziona (se applicabile) --</option>
                <optgroup label="ENTI MILITARI">
                    {% for ente in enti_militari %}
                        <option value="militare-{{ ente.id }}"
                                data-tipo="militare"
                                data-codice="{{ ente.codice or '' }}"
                                data-indirizzo="{{ ente.indirizzo or '' }}"
                                data-civico="{{ ente.civico or '' }}"
                                data-cap="{{ ente.cap or '' }}"
                                data-citta="{{ ente.citta or '' }}"
                                data-provincia="{{ ente.provincia or '' }}"
                                data-details="{% if ente.codice %}[{{ ente.codice }}] {% endif %}{{ ente.indirizzo or '' }} {{ ente.civico or '' }} - {{ ente.cap or '' }} {{ ente.citta or '' }} ({{ ente.provincia or '' }})"
                                {% if ente.id == attivita.partenza_militare_id %}selected{% endif %}>
                            {{ ente.nome }}
                        </option>
                    {% endfor %}
                </optgroup>
                <optgroup label="ENTI CIVILI">
                    {% for ente in enti_civili %}
                        <option value="civile-{{ ente.id }}"
                                data-tipo="civile"
                                data-indirizzo="{{ ente.indirizzo or '' }}"
                                data-civico="{{ ente.civico or '' }}"
                                data-cap="{{ ente.cap or '' }}"
                                data-citta="{{ ente.citta or '' }}"
                                data-provincia="{{ ente.provincia or '' }}"
                                data-nazione="{{ ente.nazione or 'ITALIA' }}"
                                data-details="{{ ente.indirizzo or '' }} {{ ente.civico or '' }} - {{ ente.cap or '' }} {{ ente.citta or '' }} ({{ ente.provincia or '' }}){% if ente.nazione and ente.nazione != 'ITALIA' %} - {{ ente.nazione }}{% endif %}"
                                {% if ente.id == attivita.partenza_civile_id %}selected{% endif %}>
                            {{ ente.nome }}
                        </option>
                    {% endfor %}
                </optgroup>
            </select>
        </div>
        
        <div class="form-group">
            <label for="destinazione_id">Luogo Destinazione:</label>
            <div class="searchable-select" data-select-id="destinazione_id"></div>
            <select name="destinazione_id" id="destinazione_id" style="display: none;">
                <option value="">-- Seleziona (se applicabile) --</option>
                <optgroup label="ENTI MILITARI">
                    {% for ente in enti_militari %}
                        <option value="militare-{{ ente.id }}"
                                data-tipo="militare"
                                data-codice="{{ ente.codice or '' }}"
                                data-indirizzo="{{ ente.indirizzo or '' }}"
                                data-civico="{{ ente.civico or '' }}"
                                data-cap="{{ ente.cap or '' }}"
                                data-citta="{{ ente.citta or '' }}"
                                data-provincia="{{ ente.provincia or '' }}"
                                data-details="{% if ente.codice %}[{{ ente.codice }}] {% endif %}{{ ente.indirizzo or '' }} {{ ente.civico or '' }} - {{ ente.cap or '' }} {{ ente.citta or '' }} ({{ ente.provincia or '' }})"
                                {% if ente.id == attivita.destinazione_militare_id %}selected{% endif %}>
                            {{ ente.nome }}
                        </option>
                    {% endfor %}
                </optgroup>
                <optgroup label="ENTI CIVILI">
                    {% for ente in enti_civili %}
                        <option value="civile-{{ ente.id }}"
                                data-tipo="civile"
                                data-indirizzo="{{ ente.indirizzo or '' }}"
                                data-civico="{{ ente.civico or '' }}"
                                data-cap="{{ ente.cap or '' }}"
                                data-citta="{{ ente.citta or '' }}"
                                data-provincia="{{ ente.provincia or '' }}"
                                data-nazione="{{ ente.nazione or 'ITALIA' }}"
                                data-details="{{ ente.indirizzo or '' }} {{ ente.civico or '' }} - {{ ente.cap or '' }} {{ ente.citta or '' }} ({{ ente.provincia or '' }}){% if ente.nazione and ente.nazione != 'ITALIA' %} - {{ ente.nazione }}{% endif %}"
                                {% if ente.id == attivita.destinazione_civile_id %}selected{% endif %}>
                            {{ ente.nome }}
                        </option>
                    {% endfor %}
                </optgroup>
            </select>
        </div>

        <hr>
        <h3>Risorse e Note</h3>
        <div class="form-group" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
            <div>
                <label for="personale_ufficiali">Ufficiali:</label>
                <input type="number" id="personale_ufficiali" name="personale_ufficiali" value="{{ attivita.personale_ufficiali or 0 }}" min="0">
            </div>
            <div>
                <label for="personale_sottufficiali">Sottufficiali:</label>
                <input type="number" id="personale_sottufficiali" name="personale_sottufficiali" value="{{ attivita.personale_sottufficiali or 0 }}" min="0">
            </div>
            <div>
                <label for="personale_graduati">Graduati/VFP:</label>
                <input type="number" id="personale_graduati" name="personale_graduati" value="{{ attivita.personale_graduati or 0 }}" min="0">
            </div>
            <div>
                <label for="personale_civili">Civili:</label>
                <input type="number" id="personale_civili" name="personale_civili" value="{{ attivita.personale_civili or 0 }}" min="0">
            </div>
        </div>
        
        <div class="form-group">
            <label for="note">Note:</label>
            <textarea id="note" name="note" rows="3">{{ attivita.note or '' }}</textarea>
        </div>

        <button type="submit">Aggiorna Attività</button>
    </form>
    <br>
    <a href="{{ url_for('attivita.visualizza_attivita', id=attivita.id) }}" class="cancel-link">Annulla</a>
</div>
{% endblock %}

{% block extra_js %}
<!-- Script condiviso per form attività -->
<script src="{{ url_for('static', filename='js/attivita_forms.js') }}?v={{ cache_buster }}"></script>
<!-- Script specifico per modifica -->
<script src="{{ url_for('static', filename='js/modifica_attivita.js') }}?v={{ cache_buster }}"></script>
{% endblock %}