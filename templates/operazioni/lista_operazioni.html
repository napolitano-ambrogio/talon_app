{% extends "shared/_base.html" %}

{% block title %}Elenco Operazioni - TALON{% endblock %}

{% block additional_css %}
<!-- CSS Advanced Table Component -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/advanced-table.css') }}?v=1.0">
{% endblock %}

{% block page_title %}Operazioni Estere e Missioni{% endblock %}

{% block page_controls %}
{% if user_role in ['ADMIN', 'OPERATORE'] %}
<a href="{{ url_for('operazioni.inserisci_operazione_form') }}" class="btn btn-success">
    <i class="fas fa-plus"></i> Nuova Operazione
</a>
{% endif %}
{% endblock %}

{% block content %}
<main class="dashboard__content-wrapper" role="main">
    <section class="dashboard__scroll-content" aria-label="Contenuto principale lista operazioni">
        <!-- Barra di ricerca -->
        <div class="search-bar">
            <input type="search" 
                   id="searchInput" 
                   class="form-control search-input" 
                   placeholder="CERCA PER NOME, TEATRO, NAZIONE O MISSIONE..."
                   aria-label="Cerca operazioni">
        </div>

        <!-- Paginazione superiore -->
        <div class="pagination-wrapper top-pagination" id="topPagination">
            <div class="pagination-info">
                <span id="topPageInfo">Pagina 1 di 1 ({{ operazioni|length }} operazioni totali)</span>
            </div>
            <div class="pagination-controls" id="topPaginationControls">
                <!-- Controlli generati dinamicamente -->
            </div>
        </div>

        <!-- Tabella operazioni -->
        <div class="table-responsive">
            <table class="advanced-table" id="operazioniTable">
                <thead>
                    <tr>
                        <th class="sortable" data-column="0" data-sort-type="text">
                            <span class="th-label">Nome Breve</span>
                        </th>
                        <th class="sortable" data-column="1" data-sort-type="text">
                            <span class="th-label">Nome Missione</span>
                        </th>
                        <th class="sortable" data-column="2" data-sort-type="text">
                            <span class="th-label">Teatro Operativo</span>
                        </th>
                        <th class="sortable" data-column="3" data-sort-type="text">
                            <span class="th-label">Nazione</span>
                        </th>
                        <th class="sortable" data-column="4" data-sort-type="date">
                            <span class="th-label">Data Inizio</span>
                        </th>
                        <th class="sortable" data-column="5" data-sort-type="status">
                            <span class="th-label">Stato</span>
                        </th>
                        <th>
                            <span class="th-label">Immagine</span>
                        </th>
                    </tr>
                </thead>
                <tbody id="operazioniTableBody" class="operazioni-tbody">
                    {% for op in operazioni %}
                    <tr class="clickable-row" 
                        data-href="{{ url_for('operazioni.visualizza_operazione', id=op.id) }}"
                        data-operazione-id="{{ op.id }}">
                        <td title="{{ op.nome_breve or 'N/D' }}">
                            <strong>{{ op.nome_breve or 'N/D' }}</strong>
                        </td>
                        <td title="{{ op.nome_missione }}">
                            {{ op.nome_missione }}
                        </td>
                        <td title="{{ op.teatro_operativo or 'N/D' }}">
                            {{ op.teatro_operativo or 'N/D' }}
                        </td>
                        <td title="{{ op.nazione or 'N/D' }}">
                            {{ op.nazione or 'N/D' }}
                        </td>
                        <td data-sort="{{ op.data_inizio.isoformat() if op.data_inizio else '' }}" title="{{ op.data_inizio.strftime('%d/%m/%Y') if op.data_inizio else 'N/D' }}">
                            {{ op.data_inizio.strftime('%d/%m/%Y') if op.data_inizio else 'N/D' }}
                        </td>
                        <td>
                            {% if op.stato == 'attiva' %}
                                <span class="badge success">IN CORSO</span>
                            {% elif op.stato == 'conclusa' %}
                                <span class="badge error">CONCLUSA</span>
                            {% elif op.stato == 'pianificata' %}
                                <span class="badge warning">PIANIFICATA</span>
                            {% else %}
                                <span class="badge">N/D</span>
                            {% endif %}
                        </td>
                        <td class="image-column">
                            {% if op.immagine_path %}
                                <img src="{{ op.immagine_path }}" alt="Preview operazione" 
                                     class="operation-thumb"
                                     title="{{ op.immagine_nome }}">
                            {% else %}
                                <span class="no-image">—</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr class="no-data-row">
                        <td colspan="7" style="text-align: center;">Nessuna operazione inserita.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Paginazione inferiore -->
        <div class="pagination-wrapper bottom-pagination" id="bottomPagination">
            <div class="pagination-info">
                <span id="bottomPageInfo">Pagina 1 di 1 ({{ operazioni|length }} operazioni totali)</span>
            </div>
            <div class="pagination-controls" id="bottomPaginationControls">
                <!-- Controlli generati dinamicamente -->
            </div>
        </div>
        
    </section>
</main>

{% endblock %}

{% block extra_js %}
<!-- Advanced Table Component JS -->
<script src="{{ url_for('static', filename='js/components/advanced-table.js') }}?v={{ cache_buster }}"></script>

<script>
// Inizializzazione operazioni con AdvancedTable
document.addEventListener('DOMContentLoaded', function() {
    console.log('[Lista Operazioni] DOM caricato, inizializzazione tabella...');
    
    // Aspetta che AdvancedTable sia disponibile
    setTimeout(function() {
        if (typeof AdvancedTable !== 'undefined') {
            console.log('[Lista Operazioni] AdvancedTable disponibile, inizializzazione...');
            
            // Verifica che la tabella esista
            const tableElement = document.querySelector('#operazioniTable');
            if (tableElement) {
                console.log('[Lista Operazioni] Tabella trovata:', tableElement);
                
                // Inizializza la Advanced Table con tutte le funzionalità
                try {
                    window.operazioniTable = new AdvancedTable({
                        tableSelector: '#operazioniTable',
                        searchInputSelector: '#searchInput',
                        itemsPerPage: 50,
                        enableSorting: true,
                        enableDragDrop: true,
                        enablePagination: true,
                        enableColumnResize: true,
                        topControlsSelector: '#topPaginationControls',
                        bottomControlsSelector: '#bottomPaginationControls',
                        topInfoSelector: '#topPageInfo',
                        bottomInfoSelector: '#bottomPageInfo',
                        persistConfig: true,
                        configKey: 'talon-operazioni-table-config',
                        customSortFunctions: {
                            'status': function(a, b, order) {
                                const stateOrder = {
                                    'In corso': 1,
                                    'Pianificata': 2,
                                    'Conclusa': 3,
                                    'N/D': 4
                                };
                                
                                const valueA = a.textContent.trim();
                                const valueB = b.textContent.trim();
                                
                                const orderA = stateOrder[valueA] || 999;
                                const orderB = stateOrder[valueB] || 999;
                                
                                return order === 'asc' ? orderA - orderB : orderB - orderA;
                            },
                            'date': function(a, b, order) {
                                const dateA = new Date(a.getAttribute('data-sort') || a.textContent);
                                const dateB = new Date(b.getAttribute('data-sort') || b.textContent);
                                
                                return order === 'asc' ? dateA - dateB : dateB - dateA;
                            }
                        },
                        onRowClick: function(row) {
                            const href = row.getAttribute('data-href');
                            if (href) {
                                window.location.href = href;
                            }
                        }
                    });
                    
                    console.log('[Lista Operazioni] Tabella avanzata inizializzata:', window.operazioniTable);
                    
                } catch (error) {
                    console.error('[Lista Operazioni] Errore durante inizializzazione:', error);
                }
            } else {
                console.error('[Lista Operazioni] Tabella #operazioniTable non trovata nel DOM!');
            }
        } else {
            console.error('[Lista Operazioni] AdvancedTable non disponibile!');
        }
        
        // Event listener alternativo per il click sulle righe (fallback)
        const clickableRows = document.querySelectorAll('#operazioniTable .clickable-row');
        clickableRows.forEach(function(row) {
            row.addEventListener('click', function(e) {
                // Evita il click se si clicca su un link o bottone
                if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') {
                    return;
                }
                
                const href = row.getAttribute('data-href');
                if (href) {
                    console.log('[Lista Operazioni] Click su riga, reindirizzamento a:', href);
                    window.location.href = href;
                } else {
                    console.warn('[Lista Operazioni] Nessun href trovato per la riga');
                }
            });
        });
        
    }, 100);
});
</script>
{% endblock %}