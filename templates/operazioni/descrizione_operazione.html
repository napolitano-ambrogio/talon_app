{% extends "shared/_base.html" %}
{% block title %}Dettaglio Operazione - TALON{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS (locale) -->
<link rel="stylesheet" href="/external/leaflet/leaflet.css" />
<style>
    .main-content-wrapper {
        display: flex;
        gap: 0;
        align-items: stretch;
        width: 100%;
        max-height: calc(100vh - 160px);
        min-height: 500px;
    }
    
    .operazione-details {
        flex: 0 0 500px;
        min-width: 500px;
        max-width: 600px;
    }
    
    .operazione-map-container {
        flex: 1;
        min-width: 400px;
        border: 1px solid #ddd;
        border-left: none;
        border-radius: 0 8px 8px 0;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    
    .detail-card {
        border-radius: 8px 0 0 8px;
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    
    .detail-content {
        flex: 1;
        min-height: 0;
        display: flex;
        flex-direction: column;
    }
    
    .detail-buttons {
        flex: 0 0 auto;
        margin-top: auto;
        padding-top: 20px;
        border-top: 1px solid #eee;
    }
    
    .description-field {
        height: calc(100% - 40px);
        min-height: 100px;
        overflow-y: auto;
        padding: 8px;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        background-color: #f8f9fa;
        word-wrap: break-word;
    }
    
    .description-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
        overflow: hidden;
    }
    
    #operazione-map {
        width: 100%;
        flex: 1;
        min-height: 0;
    }
    
    .map-info {
        background: #f8f9fa;
        padding: 10px;
        border-bottom: 1px solid #ddd;
        font-size: 0.9em;
        text-align: center;
    }
    
    .no-coordinates {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        background: #f8f9fa;
        color: #6c757d;
        text-align: center;
        font-style: italic;
    }
    
    .leaflet-marker-red {
        filter: invert(17%) sepia(92%) saturate(6340%) hue-rotate(355deg) brightness(98%) contrast(114%);
    }
    
    @media (max-width: 1024px) {
        .main-content-wrapper {
            flex-direction: column;
            gap: 20px;
            min-height: auto;
        }
        
        .operazione-details {
            flex: none;
            min-width: auto;
            max-width: none;
        }
        
        .operazione-map-container {
            flex: none;
            min-width: auto;
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .detail-card {
            border-radius: 8px;
        }
    }
    
    @media (max-width: 768px) {
        .operazione-map-container {
            height: 300px;
        }
        
        .operazione-details .detail-card > div[style*="display: flex"] {
            flex-direction: column !important;
            align-items: center !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div style="margin-bottom: 40px;">
    <div class="main-content-wrapper">
        <div class="operazione-details">
    <div class="detail-card">
        <div class="detail-header">
            <h3>Dettaglio Operazione</h3>
            <a href="{{ url_for('operazioni.lista_operazioni') }}" class="cancel-link" style="font-size: 0.9em;">&larr; Torna all'elenco</a>
        </div>
        <div class="detail-content">
            <div style="display: flex; gap: 20px; align-items: flex-start; margin-bottom: 20px; flex-shrink: 0;">
                <div style="flex: 1;">
                    <dl class="detail-grid">
                        <div>
                            <div class="detail-item"><dt>Nome Breve (Acronimo)</dt><dd>{{ operazione.nome_breve or 'N/D' }}</dd></div>
                            <div class="detail-item"><dt>Nome Missione</dt><dd>{{ operazione.nome_missione }}</dd></div>
                            <div class="detail-item"><dt>Teatro Operativo</dt><dd>{{ operazione.teatro_operativo or 'N/D' }}</dd></div>
                            <div class="detail-item"><dt>Nazione</dt><dd>{{ operazione.nazione or 'N/D' }}</dd></div>
                        </div>
                        <div>
                            <div class="detail-item"><dt>Periodo Mandato</dt><dd>Dal: {{ operazione.data_inizio.strftime('%d/%m/%Y') if operazione.data_inizio else 'N/D' }}<br>Al: {{ operazione.data_fine.strftime('%d/%m/%Y') if operazione.data_fine else 'In corso' }}</dd></div>
                        </div>
                    </dl>
                </div>
                {% if operazione.immagine_path %}
                <div style="flex: 0 0 120px;">
                    <img src="{{ operazione.immagine_path }}" alt="Immagine operazione {{ operazione.nome_missione }}" 
                         style="width: 120px; height: 120px; object-fit: cover; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                </div>
                {% endif %}
            </div>
            <!-- Campo descrizione che occupa tutto lo spazio disponibile -->
            <div class="description-container">
                <div class="detail-item" style="margin-bottom: 10px;">
                    <dt>Descrizione</dt>
                </div>
                <div class="description-field">{{ operazione.descrizione or 'Nessuna' }}</div>
                <div style="margin-top: 8px; padding: 6px 8px; background-color: #e9f7ff; border-left: 3px solid #007bff; font-size: 0.85em; color: #0056b3;">
                    <i class="fas fa-info-circle" style="margin-right: 5px;"></i>
                    La mappa mostra l'area operativa con un raggio di 50 km dal punto centrale dell'operazione.
                </div>
            </div>
        </div>
        <div class="detail-buttons">
            <div style="display: flex; justify-content: flex-end; align-items: center; gap: 10px;">
                <a href="{{ url_for('operazioni.modifica_operazione_form', id=operazione.id) }}" class="btn-modifica">Modifica</a>
                <form action="{{ url_for('operazioni.elimina_operazione', id=operazione.id) }}" method="POST" onsubmit="return confirm('Sei sicuro di voler eliminare questa operazione?') && confirm('ATTENZIONE: Confermi definitivamente l\'eliminazione?');" style="margin: 0;">
                    <button type="submit" style="background-color: #d9534f; color: white; padding: 10px 20px; border: none; cursor: pointer; border-radius: 5px; text-transform: uppercase; font-weight: bold; font-size: 0.9em;">Elimina</button>
                </form>
            </div>
        </div>
    </div>
    </div>
        
        <!-- Mappa dell'operazione -->
        <div class="operazione-map-container">
            <div id="operazione-map"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS (locale) -->
<script src="/external/leaflet/leaflet.js"></script>
<script>
// Inizializza mappa operazione
function initOperazioneMap() {
    // Configura icona marker personalizzata rossa per operazioni
    const customIcon = L.icon({
        iconUrl: '/external/fontawesome/svgs/solid/location-dot.svg',
        iconSize: [30, 40],
        iconAnchor: [15, 40],
        popupAnchor: [0, -40],
        className: 'leaflet-marker-red'
    });
    
    // Dati dell'operazione con coordinate dirette dal backend
    const operazioneData = {
        id: {{ operazione.id }},
        nome: '{{ operazione.nome_missione|e }}',
        indirizzo: '{{ operazione.teatro_operativo|e }}, {{ operazione.nazione|e }}',
        {% if operazione.coordinate_formatted %}
        // Parse coordinate dal campo formattato "lat, lng"
        coordinate_str: '{{ operazione.coordinate_formatted }}',
        ha_coordinate: true
        {% else %}
        ha_coordinate: false
        {% endif %}
    };
    
    // Parse delle coordinate se disponibili
    if (operazioneData.ha_coordinate && operazioneData.coordinate_str) {
        const coords = operazioneData.coordinate_str.split(', ');
        if (coords.length === 2) {
            operazioneData.lat = parseFloat(coords[0]);
            operazioneData.lng = parseFloat(coords[1]);
        } else {
            operazioneData.ha_coordinate = false;
        }
    }
    
    console.log('Dati operazione (caricamento veloce):', operazioneData);
    
    // Caricamento immediato senza chiamata AJAX
    if (operazioneData.ha_coordinate && operazioneData.lat && operazioneData.lng) {
        // Coordinate trovate, mostra la mappa immediatamente
        showOperationMap(operazioneData);
    } else {
        console.log('Nessuna coordinata per operazione:', operazioneData.id);
        // Nessuna coordinata, mostra messaggio
        showNoCoordinatesMessage();
    }
}

function showOperationMap(operazione) {
    // Configura icona marker personalizzata rossa per operazioni
    const customIcon = L.icon({
        iconUrl: '/external/fontawesome/svgs/solid/location-dot.svg',
        iconSize: [30, 40],
        iconAnchor: [15, 40],
        popupAnchor: [0, -40],
        className: 'leaflet-marker-red'
    });
    
    const map = L.map('operazione-map').setView([operazione.lat, operazione.lng], 10);
    
    // Aggiungi tile layer con caricamento ottimizzato
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 18,
        loading: 'lazy',
        crossOrigin: true,
        updateWhenIdle: true,
        keepBuffer: 2
    }).addTo(map);
    
    // Aggiungi marker per l'operazione con icona personalizzata
    const marker = L.marker([operazione.lat, operazione.lng], {icon: customIcon})
        .addTo(map)
        .bindPopup(`
            <strong>${operazione.nome}</strong><br>
            ${operazione.indirizzo}<br>
            <small>Operazione militare</small>
        `)
        .openPopup();
        
    // Eventualmente aggiungi cerchio per area di operazione
    const operationCircle = L.circle([operazione.lat, operazione.lng], {
        color: '#dc3545',
        fillColor: '#dc3545',
        fillOpacity: 0.1,
        radius: 50000 // 50km radius
    }).addTo(map);
}

function showNoCoordinatesMessage() {
    document.getElementById('operazione-map').innerHTML = `
        <div class="no-coordinates">
            <div>
                <i class="fas fa-map-marker-alt" style="font-size: 2em; margin-bottom: 10px; color: #ccc;"></i><br>
                Questa operazione non è stata ancora georeferenziata.<br>
                <small>Le coordinate non sono disponibili.</small>
            </div>
        </div>
    `;
}

// Inizializza quando il DOM è pronto
document.addEventListener('DOMContentLoaded', initOperazioneMap);
</script>
{% endblock %}
