{% extends "shared/_base.html" %}

{% block title %}Dettaglio {{ operazione.nome_breve or operazione.nome_missione }} - TALON{% endblock %}

{% block additional_css %}
<!-- CSS specifico per visualizzazione operazioni -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/attivita/visualizza_attivita.css') }}?v={{ cache_buster }}">
<!-- CSS Advanced Table Component per i badge -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/advanced-table.css') }}?v={{ cache_buster }}">
<!-- Leaflet CSS (locale) -->
<link rel="stylesheet" href="/external/leaflet/leaflet.css" />
<style>
/* Layout a due colonne per operazioni */
.operazione-layout {
    display: flex;
    gap: 0;
    height: calc(100vh - 200px);
    min-height: 500px;
}

.operazione-details {
    overflow-y: auto;
}

.operazione-map-container {
    flex: 0 0 68.5%;
    border: 1px solid #ddd;
    border-radius: 8px;
    overflow: hidden;
    background: #f8f9fa;
}

#operazione-map {
    width: 100%;
    height: 100%;
    min-height: 500px;
}

.no-coordinates {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    background: #f8f9fa;
    color: #6c757d;
    text-align: center;
    font-style: italic;
}

.leaflet-marker-red {
    filter: invert(17%) sepia(92%) saturate(6340%) hue-rotate(355deg) brightness(98%) contrast(114%);
}

/* Responsive per schermi piccoli */
@media (max-width: 1024px) {
    .operazione-layout {
        flex-direction: column;
        height: auto;
        min-height: auto;
    }
    
    .operazione-details {
        flex: none;
    }
    
    .operazione-map-container {
        height: 400px;
        flex: none;
    }
    
    #operazione-map {
        min-height: 400px;
    }
}

@media (max-width: 768px) {
    .operazione-map-container {
        height: 300px;
    }
    
    #operazione-map {
        min-height: 300px;
    }
}
</style>
{% endblock %}

{% block page_title %}
{{ operazione.nome_missione }}
{# Calcolo dello status per l'header basato su stato operazione #}
{% if stato == 'attiva' %}
    {% set header_status_text = 'IN CORSO' %}
    {% set header_status_class = 'header-status-attiva' %}
{% elif stato == 'conclusa' %}
    {% set header_status_text = 'CONCLUSA' %}
    {% set header_status_class = 'header-status-conclusa' %}
{% elif stato == 'pianificata' %}
    {% set header_status_text = 'PIANIFICATA' %}
    {% set header_status_class = 'header-status-pianificata' %}
{% else %}
    {% set header_status_text = 'N/D' %}
    {% set header_status_class = 'header-status-attiva' %}
{% endif %}
<span class="header-status-badge {{ header_status_class }}">{{ header_status_text }}</span>
{% endblock %}

{% block page_controls %}
<a href="{{ url_for('operazioni.lista_operazioni') }}" class="btn btn-secondary">
    <i class="fas fa-arrow-left"></i> Torna all'Elenco
</a>
{% if user_role in ['ADMIN', 'OPERATORE'] %}
<a href="{{ url_for('operazioni.modifica_operazione_form', id=operazione.id) }}" class="btn btn-primary">
    <i class="fas fa-edit"></i> Modifica
</a>
{% endif %}
{% if user_role == 'ADMIN' %}
<form action="{{ url_for('operazioni.elimina_operazione', id=operazione.id) }}" method="POST" onsubmit="return confirm('Confermare l\'eliminazione dell\'operazione?');" style="display: inline;">
    <button type="submit" class="btn btn-danger">
        <i class="fas fa-trash"></i> Elimina
    </button>
</form>
{% endif %}
{% endblock %}

{% block content %}
<main class="dashboard__content-wrapper" role="main">
    <section class="dashboard__scroll-content" aria-label="Contenuto principale dettaglio operazione">
        
        <!-- Layout a due colonne: dati + mappa -->
        <div class="operazione-layout">
            
            <!-- Colonna sinistra: Dati operazione -->
            <div class="operazione-details" style="height: 100%; display: flex; flex-direction: column; flex: 0 0 31.5%;">
                <div class="detail-card" style="flex: 1; height: 100%;">

                    <!-- Informazioni generali con immagine integrata -->
                    <div class="info-section" style="height: 100%; display: flex; flex-direction: column; padding: 25px;">
                        
                        <!-- Layout due colonne: Foto + Tutti i campi -->
                        {% if operazione.immagine_path %}
                        <div style="display: flex; gap: 20px; margin-bottom: 20px; align-items: flex-start;">
                            <!-- Colonna 1: Foto (altezza aumentata) -->
                            <div style="flex: 0 0 calc(50% - 10px);">
                                <div style="width: 100%; height: 300px; border-radius: 8px; border: 1px solid #ddd; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden; background: #f8f9fa; display: flex; align-items: center; justify-content: center;">
                                    <img src="{{ operazione.immagine_path }}" 
                                         alt="Immagine operazione {{ operazione.nome_missione }}" 
                                         style="max-width: 100%; max-height: 100%; object-fit: contain;"
                                         title="{{ operazione.immagine_nome or 'Immagine operazione' }}">
                                </div>
                            </div>
                            
                            <!-- Colonna 2: Tutti i campi impilati -->
                            <div style="flex: 0 0 calc(50% - 10px); display: flex; flex-direction: column; gap: 15px;">
                                
                                <!-- Nome Breve -->
                                {% if operazione.nome_breve %}
                                <div>
                                    <dt style="font-weight: bold; color: #4a5568; margin-bottom: 3px;">Nome Breve</dt>
                                    <dd style="margin: 0; font-size: 1.1em; font-weight: 600; color: #2d3748;">{{ operazione.nome_breve }}</dd>
                                </div>
                                {% endif %}
                                
                                <!-- Teatro Operativo -->
                                <div>
                                    <dt style="font-weight: bold; color: #4a5568; margin-bottom: 3px;">Teatro Operativo</dt>
                                    <dd style="margin: 0;">{{ operazione.teatro_operativo or 'N/D' }}</dd>
                                </div>
                                
                                <!-- Nazione -->
                                <div>
                                    <dt style="font-weight: bold; color: #4a5568; margin-bottom: 3px;">Nazione</dt>
                                    <dd style="margin: 0;">{{ operazione.nazione or 'N/D' }}</dd>
                                </div>
                                
                                <!-- Data Inizio -->
                                <div>
                                    <dt style="font-weight: bold; color: #4a5568; margin-bottom: 3px;">Data Inizio</dt>
                                    <dd style="margin: 0;">{{ operazione.data_inizio.strftime('%d/%m/%Y') if operazione.data_inizio else 'Non specificata' }}</dd>
                                </div>
                                
                                <!-- Data Fine -->
                                <div>
                                    <dt style="font-weight: bold; color: #4a5568; margin-bottom: 3px;">Data Fine</dt>
                                    <dd style="margin: 0;">
                                        {% if operazione.data_fine %}
                                            {{ operazione.data_fine.strftime('%d/%m/%Y') }}
                                            {% if operazione.data_inizio and operazione.data_fine != operazione.data_inizio %}
                                                <br><span class="text-muted" style="font-size: 0.9em;">({{ (operazione.data_fine - operazione.data_inizio).days + 1 }} giorni)</span>
                                            {% elif operazione.data_inizio and operazione.data_fine == operazione.data_inizio %}
                                                <br><span class="text-muted" style="font-size: 0.9em;">(1 giorno)</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">In corso</span>
                                        {% endif %}
                                    </dd>
                                </div>
                                
                            </div>
                        </div>
                        {% else %}
                        <!-- Se non c'è immagine, mostra tutti i campi in colonna singola -->
                        <div style="margin-bottom: 20px; display: flex; flex-direction: column; gap: 15px;">
                            
                            <!-- Nome Breve -->
                            {% if operazione.nome_breve %}
                            <div>
                                <dt style="font-weight: bold; color: #4a5568; margin-bottom: 3px;">Nome Breve</dt>
                                <dd style="margin: 0; font-size: 1.1em; font-weight: 600; color: #2d3748;">{{ operazione.nome_breve }}</dd>
                            </div>
                            {% endif %}
                            
                            <!-- Teatro Operativo -->
                            <div>
                                <dt style="font-weight: bold; color: #4a5568; margin-bottom: 3px;">Teatro Operativo</dt>
                                <dd style="margin: 0;">{{ operazione.teatro_operativo or 'N/D' }}</dd>
                            </div>
                            
                            <!-- Nazione -->
                            <div>
                                <dt style="font-weight: bold; color: #4a5568; margin-bottom: 3px;">Nazione</dt>
                                <dd style="margin: 0;">{{ operazione.nazione or 'N/D' }}</dd>
                            </div>
                            
                            <!-- Data Inizio -->
                            <div>
                                <dt style="font-weight: bold; color: #4a5568; margin-bottom: 3px;">Data Inizio</dt>
                                <dd style="margin: 0;">{{ operazione.data_inizio.strftime('%d/%m/%Y') if operazione.data_inizio else 'Non specificata' }}</dd>
                            </div>
                            
                            <!-- Data Fine -->
                            <div>
                                <dt style="font-weight: bold; color: #4a5568; margin-bottom: 3px;">Data Fine</dt>
                                <dd style="margin: 0;">
                                    {% if operazione.data_fine %}
                                        {{ operazione.data_fine.strftime('%d/%m/%Y') }}
                                        {% if operazione.data_inizio and operazione.data_fine != operazione.data_inizio %}
                                            <br><span class="text-muted" style="font-size: 0.9em;">({{ (operazione.data_fine - operazione.data_inizio).days + 1 }} giorni)</span>
                                        {% elif operazione.data_inizio and operazione.data_fine == operazione.data_inizio %}
                                            <br><span class="text-muted" style="font-size: 0.9em;">(1 giorno)</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">In corso</span>
                                    {% endif %}
                                </dd>
                            </div>
                            
                        </div>
                        {% endif %}
                        
                        <!-- Contenitore flessibile per descrizione e nota -->
                        <div style="margin-top: 15px; flex: 1; display: flex; flex-direction: column; min-height: 0;">
                            <!-- Descrizione con altezza dinamica -->
                            {% if operazione.descrizione %}
                            <div style="flex: 1; display: flex; flex-direction: column; min-height: 0;">
                                <dt style="font-weight: bold; color: #4a5568; margin-bottom: 8px;">Descrizione</dt>
                                <dd style="margin: 0; flex: 1; overflow-y: auto; padding: 15px; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8f9fa; line-height: 1.5; min-height: 80px;">{{ operazione.descrizione }}</dd>
                            </div>
                            {% endif %}
                            
                            <!-- Nota esplicativa per la mappa - sempre visibile -->
                            <div style="margin-top: 10px; padding: 6px 8px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 3px; border-left: 3px solid #ffc107; flex-shrink: 0;">
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <i class="fas fa-info-circle" style="color: #856404; font-size: 12px;"></i>
                                    <span style="font-size: 0.8em; color: #856404; font-weight: 400; line-height: 1.3;">
                                        Il cerchio rosso sulla mappa rappresenta un raggio di 50 km dalla base operativa.
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            
            <!-- Colonna destra: Mappa -->
            <div class="operazione-map-container">
                <div id="operazione-map"></div>
            </div>
            
        </div>
        
    </section>
</main>
{% endblock %}

{% block additional_js %}
<!-- Leaflet JS (locale) -->
<script src="/external/leaflet/leaflet.js"></script>
<script>
// Inizializza mappa operazione
function initOperazioneMap() {
    // Configura icona marker personalizzata rossa per operazioni
    const customIcon = L.icon({
        iconUrl: '/external/fontawesome/svgs/solid/location-dot.svg',
        iconSize: [30, 40],
        iconAnchor: [15, 40],
        popupAnchor: [0, -40],
        className: 'leaflet-marker-red'
    });
    
    // Dati dell'operazione con coordinate dirette dal backend
    const operazioneData = {
        id: {{ operazione.id }},
        nome: '{{ operazione.nome_missione|e }}',
        indirizzo: '{{ operazione.teatro_operativo|e }}, {{ operazione.nazione|e }}',
        {% if operazione.coordinate_formatted %}
        // Parse coordinate dal campo formattato "lat, lng"
        coordinate_str: '{{ operazione.coordinate_formatted }}',
        ha_coordinate: true
        {% else %}
        ha_coordinate: false
        {% endif %}
    };
    
    // Parse delle coordinate se disponibili
    if (operazioneData.ha_coordinate && operazioneData.coordinate_str) {
        const coords = operazioneData.coordinate_str.split(', ');
        if (coords.length === 2) {
            operazioneData.lat = parseFloat(coords[0]);
            operazioneData.lng = parseFloat(coords[1]);
        } else {
            operazioneData.ha_coordinate = false;
        }
    }
    
    console.log('[Mappa Operazione] Dati operazione:', operazioneData);
    
    // Caricamento immediato senza chiamata AJAX
    if (operazioneData.ha_coordinate && operazioneData.lat && operazioneData.lng) {
        // Coordinate trovate, mostra la mappa immediatamente
        showOperationMap(operazioneData);
    } else {
        console.log('[Mappa Operazione] Nessuna coordinata per operazione:', operazioneData.id);
        // Nessuna coordinata, mostra messaggio
        showNoCoordinatesMessage();
    }
}

function showOperationMap(operazione) {
    // Configura icona marker personalizzata rossa per operazioni
    const customIcon = L.icon({
        iconUrl: '/external/fontawesome/svgs/solid/location-dot.svg',
        iconSize: [30, 40],
        iconAnchor: [15, 40],
        popupAnchor: [0, -40],
        className: 'leaflet-marker-red'
    });
    
    const map = L.map('operazione-map').setView([operazione.lat, operazione.lng], 10);
    
    // Aggiungi tile layer con caricamento ottimizzato
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 18,
        loading: 'lazy',
        crossOrigin: true,
        updateWhenIdle: true,
        keepBuffer: 2
    }).addTo(map);
    
    // Aggiungi marker per l'operazione con icona personalizzata
    const marker = L.marker([operazione.lat, operazione.lng], {icon: customIcon})
        .addTo(map)
        .bindPopup(`
            <strong>${operazione.nome}</strong><br>
            ${operazione.indirizzo}<br>
            <small>Operazione militare</small>
        `)
        .openPopup();
        
    // Eventualmente aggiungi cerchio per area di operazione (50km)
    const operationCircle = L.circle([operazione.lat, operazione.lng], {
        color: '#dc3545',
        fillColor: '#dc3545',
        fillOpacity: 0.1,
        radius: 50000 // 50km radius
    }).addTo(map);
}

function showNoCoordinatesMessage() {
    document.getElementById('operazione-map').innerHTML = `
        <div class="no-coordinates">
            <div>
                <i class="fas fa-map-marker-alt" style="font-size: 2em; margin-bottom: 10px; color: #ccc;"></i><br>
                Questa operazione non è stata ancora georeferenziata.<br>
                <small>Le coordinate non sono disponibili.</small>
            </div>
        </div>
    `;
}

// Inizializza quando il DOM è pronto
document.addEventListener('DOMContentLoaded', function() {
    console.log('[Dettaglio Operazione] Pagina caricata per operazione ID: {{ operazione.id }}');
    initOperazioneMap();
});
</script>
{% endblock %}