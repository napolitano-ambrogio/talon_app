{% extends "_base.html" %}

{% block title %}Dashboard - TALON{% endblock %}

{% block content %}
<!-- Status refresh in alto a destra -->
<div id="refresh-status-top"></div>

<!-- Controlli dashboard -->
<div class="dashboard-controls">
    <button onclick="saveLayout()" class="btn btn-primary">Salva Layout</button>
    <button onclick="clearLayout()" class="btn btn-danger">Cancella Layout</button>
    <button onclick="exportLayout()" class="btn btn-secondary">Esporta</button>
    <input type="file" id="importFile" style="display:none" onchange="importLayout(event)" accept=".json">
    <button onclick="document.getElementById('importFile').click()" class="btn btn-secondary">Importa</button>
    <button onclick="refreshAllCharts()" class="btn btn-success">Aggiorna Tutti</button>
    <button onclick="cycleAutoRefresh()" class="btn btn-info" id="autoRefreshBtn">AUTO-REFRESH OFF</button>
</div>

<div id="dashboard-grid" class="dashboard-grid">
    <div class="dashboard-card add-card" onclick="addNewChart()">
        <div class="plus-icon">+</div>
    </div>
</div>

<style>
/* Reset e layout base */
body {
    overflow-x: hidden;
}

.page-wrapper {
    max-width: 100%;
    overflow-x: hidden;
}

/* Status refresh */
#refresh-status-top {
    position: fixed;
    top: 20px;
    right: 20px;
    font-size: 12px;
    color: #6c757d;
    z-index: 1000;
    background: rgba(255, 255, 255, 0.9);
    padding: 5px 10px;
    border-radius: 4px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Controlli dashboard */
.dashboard-controls {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 10px;
    margin: 20px;
    flex-wrap: wrap;
}

/* Grid container */
#dashboard-grid {
    padding: 0 20px 20px;
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    max-width: 100%;
}

/* Dashboard cards */
.dashboard-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    position: relative;
    display: inline-block;
    vertical-align: top;
    min-width: 300px;
    min-height: 200px;
}

.dashboard-card.resizable {
    max-width: calc(100vw - 100px);
    overflow: hidden;
}

/* Add card */
.dashboard-card.add-card {
    width: 200px;
    height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border: 2px dashed #ddd;
    background: #f8f9fa;
    transition: all 0.3s ease;
}

.dashboard-card.add-card:hover {
    border-color: #007bff;
    background: #e7f3ff;
}

.plus-icon {
    font-size: 48px;
    color: #6c757d;
}

/* Chart title bar */
.chart-title {
    padding: 8px 12px;
    border-bottom: 1px solid #dee2e6;
    font-weight: 600;
    font-size: 14px;
    color: #495057;
    position: relative;
    display: flex;
    align-items: center;
    height: 40px;
}

/* Close button */
.close-button {
    position: absolute;
    top: 8px;
    right: 8px;
    background: none;
    border: none;
    font-size: 18px;
    cursor: pointer;
    color: #6c757d;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s;
}

.close-button:hover {
    background: #dc3545;
    color: white;
}

/* Iframe container */
.iframe-container {
    position: relative;
    width: 100%;
    height: calc(100% - 40px);
    overflow: hidden;
}

/* Dashboard iframe */
.dashboard-iframe {
    width: 100%;
    height: 100%;
    border: none;
    display: block;
}

/* Loading overlay */
.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255,255,255,0.9);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
}

/* Notification */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 20px;
    border-radius: 6px;
    color: white;
    font-weight: 500;
    z-index: 10000;
    max-width: 400px;
    word-wrap: break-word;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* Resize handle */
.dashboard-card.resizable::after {
    content: '';
    position: absolute;
    bottom: 0;
    right: 0;
    width: 20px;
    height: 20px;
    cursor: se-resize;
    background: linear-gradient(135deg, transparent 50%, #ccc 50%);
    border-bottom-right-radius: 8px;
}

/* Button styles */
.btn-sm {
    padding: 4px 8px;
    font-size: 12px;
}

/* Media queries */
@media (max-width: 768px) {
    .dashboard-controls {
        justify-content: center;
        margin: 10px;
    }
    
    .dashboard-controls button {
        font-size: 12px;
        padding: 5px 10px;
    }
    
    #dashboard-grid {
        padding: 0 10px;
        gap: 10px;
    }
    
    .dashboard-card.resizable {
        max-width: calc(100vw - 40px);
        width: 100% !important;
    }
    
    #refresh-status-top {
        font-size: 10px;
        top: 10px;
        right: 10px;
    }
}
</style>

<script>
// ==========================================
// CONFIGURAZIONE
// ==========================================
const CONFIG = {
    STORAGE_KEY: 'talon_dashboard_layout',
    DEFAULT_WIDTH: 600,
    DEFAULT_HEIGHT: 400,
    MIN_WIDTH: 300,
    MIN_HEIGHT: 200,
    SUPERSET_BASE_URL: 'http://127.0.0.1:8088'
};

// ==========================================
// VARIABILI GLOBALI
// ==========================================
let chartCounter = 0;
let charts = [];
let autoRefreshInterval = null;
let autoRefreshState = 0;
let lastRefreshTime = null;

// ==========================================
// INIZIALIZZAZIONE
// ==========================================
document.addEventListener('DOMContentLoaded', () => {
    checkProtocol();
    loadLayout();
    initializeResizable();
    updateRefreshStatusTop();
    loadAutoRefreshSettings();
    setupWindowResize();
});

// Check HTTPS e redirect
function checkProtocol() {
    if (window.location.protocol === "https:") {
        const httpURL = `http://${window.location.hostname}${window.location.pathname}`;
        alert(`‚ö† Superset supporta solo HTTP.\nVerrai reindirizzato a: ${httpURL}`);
        window.location.href = httpURL;
    }
}

// ==========================================
// GESTIONE GRAFICI
// ==========================================
function addNewChart(chartData = null) {
    if (!chartData) {
        chartData = promptForChartData();
        if (!chartData) return;
    }

    const uniqueId = chartData.id || `chart_${Date.now()}_${chartCounter++}`;
    const dimensions = getResponsiveDimensions(chartData.width, chartData.height);
    
    const grid = document.getElementById("dashboard-grid");
    const chartCard = createChartCard(uniqueId, chartData, dimensions.width, dimensions.height);
    
    grid.insertBefore(chartCard, grid.lastElementChild);
    
    if (!chartData.id) {
        const newChartData = {
            id: uniqueId,
            ...chartData,
            width: dimensions.width,
            height: dimensions.height
        };
        charts.push(newChartData);
        saveLayout();
    }
    
    initializeResizableElement(chartCard);
}

function promptForChartData() {
    const contentType = prompt(
        "Che tipo di contenuto vuoi aggiungere?\n\n" +
        "1. Dashboard completa\n" +
        "2. Singolo grafico\n\n" +
        "Digita 1 o 2:"
    );
    
    if (!contentType || (contentType !== '1' && contentType !== '2')) {
        if (contentType) alert("Scelta non valida.");
        return null;
    }
    
    const isDashboard = contentType === '1';
    const urlExample = isDashboard 
        ? "http://127.0.0.1:8088/superset/dashboard/2/"
        : "http://127.0.0.1:8088/explore/?form_data_key=xxx&slice_id=1";
    
    const userUrl = prompt(
        `Incolla l'URL ${isDashboard ? 'della dashboard' : 'del grafico'} Superset:\n\n` +
        `Esempio: ${urlExample}`
    );
    
    if (!userUrl) return null;
    
    try {
        return parseSupsersetUrl(userUrl, isDashboard);
    } catch (e) {
        alert("URL non valido: " + e.message);
        return null;
    }
}

function parseSupsersetUrl(userUrl, isDashboard) {
    const url = new URL(userUrl);
    
    if (isDashboard) {
        const pathMatch = url.pathname.match(/\/superset\/dashboard\/(\d+)/);
        if (!pathMatch) throw new Error("URL dashboard non valido");
        
        return {
            type: 'dashboard',
            dashboardId: pathMatch[1],
            nativeFiltersKey: url.searchParams.get('native_filters_key'),
            title: `Dashboard ${pathMatch[1]}`
        };
    } else {
        const formDataKey = url.searchParams.get('form_data_key');
        const sliceId = url.searchParams.get('slice_id');
        
        if (!formDataKey || !sliceId) {
            throw new Error("URL grafico non valido");
        }
        
        return {
            type: 'chart',
            formDataKey: formDataKey,
            sliceId: sliceId,
            dashboardPageId: url.searchParams.get('dashboard_page_id'),
            title: `Chart ${sliceId}`
        };
    }
}

function createChartCard(chartId, chartData, width, height) {
    const chartCard = document.createElement("div");
    chartCard.classList.add("dashboard-card", "resizable");
    chartCard.id = chartId;
    chartCard.style.width = `${width}px`;
    chartCard.style.height = `${height}px`;

    // Title bar
    const titleDiv = document.createElement("div");
    titleDiv.className = "chart-title";
    titleDiv.style.background = chartData.type === 'dashboard' ? '#e3f2fd' : '#f8f9fa';

    // Close button
    const closeBtn = document.createElement("button");
    closeBtn.innerHTML = "&times;";
    closeBtn.className = "close-button";
    closeBtn.onclick = () => removeChart(chartId);

    // Iframe container
    const iframeContainer = document.createElement("div");
    iframeContainer.className = "iframe-container";

    // Build iframe
    const iframe = createIframe(chartData, chartId);
    const loadingOverlay = createLoadingOverlay();

    titleDiv.appendChild(closeBtn);
    iframeContainer.appendChild(iframe);
    iframeContainer.appendChild(loadingOverlay);
    chartCard.appendChild(titleDiv);
    chartCard.appendChild(iframeContainer);
    
    return chartCard;
}

function createIframe(chartData, chartId) {
    const iframe = document.createElement("iframe");
    const iframeUrl = buildIframeUrl(chartData);
    
    iframe.src = iframeUrl;
    iframe.className = "dashboard-iframe";
    iframe.loading = "lazy";
    iframe.setAttribute('data-original-url', iframeUrl);
    iframe.setAttribute('data-chart-id', chartId);
    
    iframe.onload = function() {
        const overlay = this.parentElement.querySelector('.loading-overlay');
        if (overlay) overlay.style.display = 'none';
    };
    
    iframe.onerror = function() {
        handleIframeError(this, chartData, chartId);
    };
    
    return iframe;
}

function buildIframeUrl(chartData) {
    if (chartData.type === 'dashboard') {
        let url = `${CONFIG.SUPERSET_BASE_URL}/superset/dashboard/${chartData.dashboardId}/?`;
        url += 'standalone=1&show_top_bar=0&hide_nav=1&embedded=1';
        if (chartData.nativeFiltersKey) {
            url += `&native_filters_key=${chartData.nativeFiltersKey}`;
        }
        return url;
    } else {
        let url = `${CONFIG.SUPERSET_BASE_URL}/explore/?`;
        url += `form_data_key=${chartData.formDataKey}&slice_id=${chartData.sliceId}`;
        url += '&standalone=1&show_tabs=false&embedded=1';
        if (chartData.dashboardPageId) {
            url += `&dashboard_page_id=${chartData.dashboardPageId}`;
        }
        return url;
    }
}

function createLoadingOverlay() {
    const overlay = document.createElement("div");
    overlay.className = "loading-overlay";
    overlay.innerHTML = `
        <div style="text-align: center;">
            <div style="font-size: 24px; margin-bottom: 8px;">üîÑ</div>
            <div>Caricamento...</div>
        </div>
    `;
    return overlay;
}

function handleIframeError(iframe, chartData, chartId) {
    const container = iframe.parentElement;
    const overlay = container.querySelector('.loading-overlay');
    if (overlay) overlay.style.display = 'none';
    
    container.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: center; height: 100%; 
                    color: #dc3545; flex-direction: column; padding: 20px; text-align: center;">
            <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
            <div>Errore nel caricamento</div>
            <button onclick="refreshSingleChart('${chartId}')" 
                    class="btn btn-sm btn-primary" style="margin-top: 12px;">
                Riprova
            </button>
        </div>
    `;
}

function removeChart(chartId) {
    if (confirm('Rimuovere questo elemento?')) {
        document.getElementById(chartId).remove();
        charts = charts.filter(chart => chart.id !== chartId);
        saveLayout();
        showNotification('Elemento rimosso!', 'success');
    }
}

// ==========================================
// DIMENSIONI RESPONSIVE
// ==========================================
function getResponsiveDimensions(requestedWidth, requestedHeight) {
    const maxWidth = window.innerWidth - 120;
    const maxHeight = window.innerHeight - 200;
    
    return {
        width: Math.min(requestedWidth || CONFIG.DEFAULT_WIDTH, maxWidth),
        height: Math.min(requestedHeight || CONFIG.DEFAULT_HEIGHT, maxHeight)
    };
}

function setupWindowResize() {
    let resizeTimeout;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
            adjustChartsToWindow();
        }, 250);
    });
}

function adjustChartsToWindow() {
    const maxWidth = window.innerWidth - 120;
    
    document.querySelectorAll('.dashboard-card.resizable').forEach(card => {
        const currentWidth = parseInt(card.style.width);
        if (currentWidth > maxWidth) {
            card.style.width = `${maxWidth}px`;
            
            const chart = charts.find(c => c.id === card.id);
            if (chart) {
                chart.width = maxWidth;
            }
        }
    });
    
    saveLayout();
}

// ==========================================
// INTERACT.JS RESIZE
// ==========================================
function initializeResizable() {
    document.querySelectorAll('.dashboard-card.resizable').forEach(initializeResizableElement);
}

function initializeResizableElement(element) {
    if (typeof interact === 'undefined') {
        console.warn('interact.js non caricato');
        return;
    }

    const maxWidth = window.innerWidth - 120;
    const maxHeight = window.innerHeight - 200;

    interact(element).resizable({
        edges: { left: false, right: true, bottom: true, top: false },
        listeners: {
            move(event) {
                const target = event.target;
                let x = parseFloat(target.getAttribute('data-x')) || 0;
                let y = parseFloat(target.getAttribute('data-y')) || 0;

                // Calcola nuove dimensioni
                const newWidth = Math.max(CONFIG.MIN_WIDTH, 
                    Math.min(maxWidth, event.rect.width));
                const newHeight = Math.max(CONFIG.MIN_HEIGHT, 
                    Math.min(maxHeight, event.rect.height));

                target.style.width = `${newWidth}px`;
                target.style.height = `${newHeight}px`;

                // Aggiorna dati
                const chart = charts.find(c => c.id === target.id);
                if (chart) {
                    chart.width = newWidth;
                    chart.height = newHeight;
                }
            },
            end() {
                saveLayout();
                showNotification('Dimensioni aggiornate!', 'success');
            }
        },
        modifiers: [
            interact.modifiers.restrictSize({
                min: { width: CONFIG.MIN_WIDTH, height: CONFIG.MIN_HEIGHT }
            })
        ],
        inertia: true
    });
}

// ==========================================
// STORAGE E PERSISTENZA
// ==========================================
function saveLayout() {
    try {
        localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(charts));
    } catch (e) {
        console.error('Errore salvataggio:', e);
        showNotification('Errore nel salvataggio', 'error');
    }
}

function loadLayout() {
    try {
        const saved = localStorage.getItem(CONFIG.STORAGE_KEY);
        if (saved) {
            const loadedCharts = JSON.parse(saved);
            charts = [];
            
            // Carica con dimensioni responsive
            loadedCharts.forEach(chart => {
                const dimensions = getResponsiveDimensions(chart.width, chart.height);
                chart.width = dimensions.width;
                chart.height = dimensions.height;
                addNewChart(chart);
            });
            
            if (loadedCharts.length > 0) {
                showNotification(`Caricati ${loadedCharts.length} elementi`, 'success');
            }
        }
    } catch (e) {
        console.error('Errore caricamento:', e);
        showNotification('Errore nel caricamento', 'error');
    }
}

function clearLayout() {
    if (confirm('Cancellare tutti gli elementi?')) {
        localStorage.removeItem(CONFIG.STORAGE_KEY);
        document.querySelectorAll('.dashboard-card.resizable').forEach(el => el.remove());
        charts = [];
        showNotification('Layout cancellato!', 'success');
    }
}

// ==========================================
// IMPORT/EXPORT
// ==========================================
function exportLayout() {
    try {
        const dataStr = JSON.stringify(charts, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        const fileName = `talon_dashboard_${new Date().toISOString().split('T')[0]}.json`;
        
        const link = document.createElement('a');
        link.setAttribute('href', dataUri);
        link.setAttribute('download', fileName);
        link.click();
        
        showNotification('Layout esportato!', 'success');
    } catch (e) {
        console.error('Errore esportazione:', e);
        showNotification('Errore nell\'esportazione', 'error');
    }
}

function importLayout(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const imported = JSON.parse(e.target.result);
            if (!Array.isArray(imported)) {
                throw new Error('Formato file non valido');
            }
            
            clearLayout();
            charts = [];
            imported.forEach(chart => addNewChart(chart));
            showNotification(`${imported.length} elementi importati!`, 'success');
        } catch (error) {
            console.error('Errore importazione:', error);
            showNotification('Errore importazione: ' + error.message, 'error');
        }
    };
    reader.readAsText(file);
    event.target.value = '';
}

// ==========================================
// REFRESH
// ==========================================
function refreshAllCharts() {
    const iframes = document.querySelectorAll('.dashboard-iframe');
    if (iframes.length === 0) {
        showNotification('Nessun grafico da aggiornare', 'warning');
        return;
    }
    
    showNotification(`Aggiornamento ${iframes.length} grafici...`, 'info');
    
    iframes.forEach((iframe, index) => {
        setTimeout(() => refreshIframe(iframe), index * 200);
    });
    
    lastRefreshTime = new Date();
    updateRefreshStatusTop();
}

function refreshSingleChart(chartId) {
    const chartCard = document.getElementById(chartId);
    if (!chartCard) return;
    
    const iframe = chartCard.querySelector('.dashboard-iframe');
    if (iframe) {
        refreshIframe(iframe);
        showNotification('Grafico aggiornato!', 'success');
    }
}

function refreshIframe(iframe) {
    const container = iframe.parentElement;
    const overlay = container.querySelector('.loading-overlay');
    if (overlay) overlay.style.display = 'flex';
    
    const originalUrl = iframe.getAttribute('data-original-url');
    const cacheBuster = `refresh=${Date.now()}`;
    const separator = originalUrl.includes('?') ? '&' : '?';
    
    iframe.src = originalUrl + separator + cacheBuster;
}

// ==========================================
// AUTO-REFRESH
// ==========================================
function cycleAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
    
    const states = [
        { text: 'AUTO-REFRESH OFF', minutes: 0 },
        { text: 'AUTO-REFRESH 15 MIN', minutes: 15 },
        { text: 'AUTO-REFRESH 30 MIN', minutes: 30 },
        { text: 'AUTO-REFRESH 60 MIN', minutes: 60 }
    ];
    
    autoRefreshState = (autoRefreshState + 1) % states.length;
    const currentState = states[autoRefreshState];
    
    const btn = document.getElementById('autoRefreshBtn');
    if (btn) {
        btn.textContent = currentState.text;
        btn.className = currentState.minutes > 0 ? 'btn btn-warning' : 'btn btn-info';
    }
    
    if (currentState.minutes > 0) {
        autoRefreshInterval = setInterval(refreshAllCharts, currentState.minutes * 60 * 1000);
        showNotification(`Auto-refresh: ${currentState.minutes} minuti`, 'success');
    } else {
        showNotification('Auto-refresh disattivato', 'info');
    }
    
    saveAutoRefreshSettings();
}

function saveAutoRefreshSettings() {
    localStorage.setItem('talon_autorefresh_settings', JSON.stringify({ state: autoRefreshState }));
}

function loadAutoRefreshSettings() {
    try {
        const saved = localStorage.getItem('talon_autorefresh_settings');
        if (saved) {
            const settings = JSON.parse(saved);
            autoRefreshState = settings.state || 0;
            
            // Applica stato salvato
            if (autoRefreshState > 0) {
                cycleAutoRefresh();
            }
        }
    } catch (e) {
        console.error('Errore caricamento auto-refresh:', e);
    }
}

// ==========================================
// UI FEEDBACK
// ==========================================
function showNotification(message, type = 'info') {
    document.querySelectorAll('.notification').forEach(n => n.remove());
    
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    
    const colors = {
        success: '#28a745',
        error: '#dc3545',
        warning: '#ffc107',
        info: '#17a2b8'
    };
    
    notification.style.background = colors[type] || colors.info;
    notification.style.transform = 'translateX(100%)';
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 10);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

function updateRefreshStatusTop() {
    const statusElement = document.getElementById('refresh-status-top');
    if (statusElement && lastRefreshTime) {
        statusElement.textContent = `Ultimo aggiornamento: ${lastRefreshTime.toLocaleTimeString()}`;
    }
}

// ==========================================
// ERROR HANDLING
// ==========================================
window.addEventListener('error', function(e) {
    console.error('Errore JavaScript:', e.error);
    if (e.error && e.error.message && e.error.message.includes('interact')) {
        showNotification('Libreria interact.js non caricata', 'warning');
    }
});

console.log('TALON Dashboard inizializzato');
</script>

<script src="{{ url_for('static', filename='js/libs/interact.min.js') }}"></script>
{% endblock %}