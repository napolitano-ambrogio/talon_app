{% extends "_base.html" %}

{% block title %}Dashboard - TALON{% endblock %}

{% block content %}

<!-- Controlli dashboard -->
<div class="dashboard-controls">
    <button onclick="saveLayout()" class="btn btn-primary">Salva Layout</button>
    <button onclick="clearLayout()" class="btn btn-danger">Cancella Layout</button>
    <button onclick="exportLayout()" class="btn btn-secondary">Esporta</button>
    <input type="file" id="importFile" style="display:none" onchange="importLayout(event)" accept=".json">
    <button onclick="document.getElementById('importFile').click()" class="btn btn-secondary">Importa</button>
    <button onclick="refreshAllCharts()" class="btn btn-success">Aggiorna Tutti</button>
    <button onclick="cycleAutoRefresh()" class="btn btn-info" id="autoRefreshBtn">AUTO-REFRESH OFF</button>
</div>

<!-- Status Superset (nascosto di default) -->
<div id="supersetStatus" style="position: fixed; top: 70px; right: 20px; padding: 8px 12px; 
                           background: #dc3545; color: white; border-radius: 4px; 
                           font-size: 12px; z-index: 1000; display: none;">
    Non Connesso
</div>

<div id="dashboard-grid" class="dashboard-grid">
    <div class="dashboard-card add-card" onclick="addNewChart()">
        <div class="plus-icon">+</div>
    </div>
</div>

<style>
/* Reset e layout base */
body {
    overflow-x: hidden;
}

.page-wrapper {
    max-width: 100%;
    overflow-x: hidden;
}

/* Controlli dashboard */
.dashboard-controls {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 10px;
    margin: 20px;
    flex-wrap: wrap;
}

/* Grid container */
#dashboard-grid {
    padding: 0 20px 20px;
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    max-width: 100%;
}

/* Dashboard cards */
.dashboard-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    position: relative;
    display: inline-block;
    vertical-align: top;
    min-width: 300px;
    min-height: 200px;
}

.dashboard-card.resizable {
    max-width: calc(100vw - 100px);
    overflow: hidden;
}

/* Add card */
.dashboard-card.add-card {
    width: 200px;
    height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border: 2px dashed #ddd;
    background: #f8f9fa;
    transition: all 0.3s ease;
}

.dashboard-card.add-card:hover {
    border-color: #007bff;
    background: #e7f3ff;
}

.plus-icon {
    font-size: 48px;
    color: #6c757d;
}

/* Chart title bar */
.chart-title {
    padding: 8px 12px;
    border-bottom: 1px solid #dee2e6;
    font-weight: 600;
    font-size: 14px;
    color: #495057;
    position: relative;
    display: flex;
    align-items: center;
    height: 40px;
}

/* Close button */
.close-button {
    position: absolute;
    top: 8px;
    right: 8px;
    background: none;
    border: none;
    font-size: 18px;
    cursor: pointer;
    color: #6c757d;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s;
}

.close-button:hover {
    background: #dc3545;
    color: white;
}

/* Iframe container */
.iframe-container {
    position: relative;
    width: 100%;
    height: calc(100% - 40px);
    overflow: hidden;
}

/* Dashboard iframe */
.dashboard-iframe {
    width: 100%;
    height: 100%;
    border: none;
    display: block;
}

/* Loading overlay */
.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255,255,255,0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
}

/* Notification */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 20px;
    border-radius: 6px;
    color: white;
    font-weight: 500;
    z-index: 10000;
    max-width: 400px;
    word-wrap: break-word;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* Resize handle */
.dashboard-card.resizable::after {
    content: '';
    position: absolute;
    bottom: 0;
    right: 0;
    width: 20px;
    height: 20px;
    cursor: se-resize;
    background: linear-gradient(135deg, transparent 50%, #ccc 50%);
    border-bottom-right-radius: 8px;
}

/* Button styles */
.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s;
}

.btn-primary { background: #007bff; color: white; }
.btn-primary:hover { background: #0056b3; }
.btn-danger { background: #dc3545; color: white; }
.btn-danger:hover { background: #c82333; }
.btn-secondary { background: #6c757d; color: white; }
.btn-secondary:hover { background: #545b62; }
.btn-success { background: #28a745; color: white; }
.btn-success:hover { background: #218838; }
.btn-info { background: #17a2b8; color: white; }
.btn-info:hover { background: #138496; }
.btn-warning { background: #ffc107; color: #212529; }
.btn-warning:hover { background: #e0a800; }

.btn-sm {
    padding: 4px 8px;
    font-size: 12px;
}

/* Media queries */
@media (max-width: 768px) {
    .dashboard-controls {
        justify-content: center;
        margin: 10px;
    }
    
    .dashboard-controls button {
        font-size: 12px;
        padding: 5px 10px;
    }
    
    #dashboard-grid {
        padding: 0 10px;
        gap: 10px;
    }
    
    .dashboard-card.resizable {
        max-width: calc(100vw - 40px);
        width: 100% !important;
    }
}
</style>

<script>
// ==========================================
// CONFIGURAZIONE
// ==========================================
const CONFIG = {
    STORAGE_KEY: 'talon_dashboard_layout',
    DEFAULT_WIDTH: 600,
    DEFAULT_HEIGHT: 400,
    MIN_WIDTH: 300,
    MIN_HEIGHT: 200,
    SUPERSET_BASE_URL: 'http://127.0.0.1:8088'
};

// ==========================================
// VARIABILI GLOBALI
// ==========================================
let chartCounter = 0;
let charts = [];
let autoRefreshInterval = null;
let autoRefreshState = 0;
let lastRefreshTime = null;
let supersetAuthenticated = false;
let supersetLoginWindow = null;
let pendingChartAdd = false;

// ==========================================
// INIZIALIZZAZIONE
// ==========================================
document.addEventListener('DOMContentLoaded', async () => {
    checkProtocol();
    
    // Carica il layout salvato
    const hasCharts = loadLayout();
    
    // Se ci sono grafici salvati, apri automaticamente il login di Superset
    if (hasCharts) {
        showNotification('Autenticazione Superset richiesta per i grafici', 'info');
        setTimeout(() => {
            openSupersetLogin(false);
        }, 1000);
    }
    
    initializeResizable();
    loadAutoRefreshSettings();
    setupWindowResize();
});

// Check HTTPS e redirect
function checkProtocol() {
    if (window.location.protocol === "https:") {
        const httpURL = `http://${window.location.hostname}${window.location.pathname}`;
        alert(`‚ö† Superset supporta solo HTTP.\nVerrai reindirizzato a: ${httpURL}`);
        window.location.href = httpURL;
    }
}

// Apre Superset in una nuova finestra per login
function openSupersetLogin(forNewChart = false) {
    // Se abbiamo gi√† una finestra aperta, portala in primo piano
    if (supersetLoginWindow && !supersetLoginWindow.closed) {
        supersetLoginWindow.focus();
        return;
    }
    
    pendingChartAdd = forNewChart;
    
    const width = 800;
    const height = 600;
    const left = (screen.width - width) / 2;
    const top = (screen.height - height) / 2;
    
    supersetLoginWindow = window.open(
        `${CONFIG.SUPERSET_BASE_URL}/login/`,
        'SupersetLogin',
        `width=${width},height=${height},left=${left},top=${top}`
    );
    
    if (!forNewChart) {
        showNotification('Autenticati in Superset per visualizzare i grafici', 'info');
    }
    
    // Controlla quando la finestra viene chiusa
    const checkInterval = setInterval(() => {
        if (supersetLoginWindow.closed) {
            clearInterval(checkInterval);
            supersetAuthenticated = true;
            supersetLoginWindow = null;
            
            if (pendingChartAdd) {
                // Se stavamo aggiungendo un grafico, mostra il prompt
                showNotification('Autenticato! Ora puoi aggiungere il grafico.', 'success');
                setTimeout(() => {
                    promptForChartData();
                }, 500);
                pendingChartAdd = false;
            } else {
                showNotification('Sessione Superset attiva!', 'success');
                // Refresh tutti i grafici esistenti
                setTimeout(() => {
                    refreshAllCharts();
                }, 1000);
            }
        }
    }, 1000);
}

// ==========================================
// GESTIONE GRAFICI
// ==========================================
function addNewChart(chartData = null) {
    // Se non abbiamo dati e non siamo autenticati, prima autentica
    if (!chartData && !supersetAuthenticated) {
        openSupersetLogin(true);
        return;
    }
    
    if (!chartData) {
        chartData = promptForChartData();
        if (!chartData) return;
    }

    const uniqueId = chartData.id || `chart_${Date.now()}_${chartCounter++}`;
    const dimensions = getResponsiveDimensions(chartData.width, chartData.height);
    
    const grid = document.getElementById("dashboard-grid");
    const chartCard = createChartCard(uniqueId, chartData, dimensions.width, dimensions.height);
    
    grid.insertBefore(chartCard, grid.lastElementChild);
    
    if (!chartData.id) {
        const newChartData = {
            id: uniqueId,
            ...chartData,
            width: dimensions.width,
            height: dimensions.height
        };
        charts.push(newChartData);
        saveLayout();
    }
    
    initializeResizableElement(chartCard);
}

function promptForChartData() {
    // Prima mostra un dialog per scegliere il metodo
    const choice = prompt(
        "Come vuoi aggiungere il contenuto?\n\n" +
        "1. Mostra elenco contenuti disponibili\n" +
        "2. Inserisci URL manualmente\n" +
        "3. Inserisci ID direttamente\n\n" +
        "Digita 1, 2 o 3:"
    );
    
    if (!choice) return null;
    
    if (choice === '1') {
        // Mostra elenco contenuti
        showContentSelector();
        return null; // Interrompi qui, la selezione avverr√† dal modal
    } else if (choice === '2') {
        // Inserimento URL manuale (codice esistente)
        const contentType = prompt(
            "Che tipo di contenuto vuoi aggiungere?\n\n" +
            "1. Dashboard completa\n" +
            "2. Singolo grafico\n\n" +
            "Digita 1 o 2:"
        );
        
        if (!contentType || (contentType !== '1' && contentType !== '2')) {
            if (contentType) alert("Scelta non valida.");
            return null;
        }
        
        const isDashboard = contentType === '1';
        const urlExample = isDashboard 
            ? "http://127.0.0.1:8088/superset/dashboard/2/"
            : "http://127.0.0.1:8088/explore/?form_data_key=xxx&slice_id=1";
        
        const userUrl = prompt(
            `Incolla l'URL ${isDashboard ? 'della dashboard' : 'del grafico'} Superset:\n\n` +
            `Esempio: ${urlExample}`
        );
        
        if (!userUrl) return null;
        
        try {
            return parseSupsersetUrl(userUrl, isDashboard);
        } catch (e) {
            alert("URL non valido: " + e.message);
            return null;
        }
    } else if (choice === '3') {
        // Inserimento ID diretto
        const contentType = prompt(
            "Che tipo di contenuto?\n\n" +
            "1. Dashboard\n" +
            "2. Grafico\n\n" +
            "Digita 1 o 2:"
        );
        
        if (!contentType || (contentType !== '1' && contentType !== '2')) {
            if (contentType) alert("Scelta non valida.");
            return null;
        }
        
        const isDashboard = contentType === '1';
        const id = prompt(`Inserisci l'ID della ${isDashboard ? 'dashboard' : 'grafico'}:`);
        
        if (!id) return null;
        
        return {
            type: isDashboard ? 'dashboard' : 'chart',
            dashboardId: isDashboard ? id : undefined,
            sliceId: isDashboard ? undefined : id,
            title: `${isDashboard ? 'Dashboard' : 'Grafico'} ${id}`
        };
    }
    
    return null;
}

// Funzione per mostrare il selettore di contenuti
function showContentSelector() {
    // Crea o mostra il modal
    let modal = document.getElementById('contentModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'contentModal';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        `;
        
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
            background: white;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            border-radius: 12px;
            padding: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        `;
        
        modalContent.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">Seleziona Contenuto Superset</h2>
                <button onclick="closeContentModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button onclick="loadSupersetContent('dashboards')" class="btn btn-primary">Carica Dashboard</button>
                <button onclick="loadSupersetContent('charts')" class="btn btn-primary">Carica Grafici</button>
                <button onclick="showManualEntry()" class="btn btn-secondary">Inserimento Manuale</button>
            </div>
            
            <div id="contentList" style="flex: 1; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px;">
                <p style="text-align: center; color: #666;">Clicca su "Carica Dashboard" o "Carica Grafici" per vedere i contenuti disponibili</p>
            </div>
        `;
        
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
    } else {
        modal.style.display = 'flex';
    }
}

// Funzione per caricare contenuti da Superset
async function loadSupersetContent(type) {
    const contentList = document.getElementById('contentList');
    contentList.innerHTML = '<p style="text-align: center;">Caricamento in corso...</p>';
    
    try {
        // Usa l'endpoint che gi√† abbiamo
        const endpoint = type === 'dashboards' 
            ? '/api/superset/simple/dashboards' 
            : '/api/superset/simple/charts';
            
        const response = await fetch(endpoint, {
            credentials: 'include'
        });
        
        if (!response.ok) {
            throw new Error('Errore nel caricamento');
        }
        
        const data = await response.json();
        
        if (data.success) {
            const items = type === 'dashboards' ? data.dashboards : data.charts;
            
            if (items && items.length > 0) {
                let html = `<h3>${type === 'dashboards' ? 'Dashboard' : 'Grafici'} Disponibili</h3>`;
                html += '<div style="display: grid; gap: 10px; margin-top: 10px;">';
                
                items.forEach(item => {
                    html += `
                        <div onclick="selectContent('${item.type}', ${item.id}, '${item.title}')" 
                             style="padding: 12px; border: 1px solid #ddd; border-radius: 6px; 
                                    cursor: pointer; transition: all 0.3s;"
                             onmouseover="this.style.background='#f0f0f0'" 
                             onmouseout="this.style.background='white'">
                            <strong>${item.title}</strong>
                            <span style="color: #666; font-size: 12px; margin-left: 10px;">ID: ${item.id}</span>
                        </div>
                    `;
                });
                
                html += '</div>';
                html += `
                    <p style="margin-top: 20px; padding: 10px; background: #fff3cd; border-radius: 6px; font-size: 12px;">
                        <strong>Nota:</strong> Questi sono ID di esempio (1-${items.length}). 
                        Per vedere i tuoi contenuti reali, crea prima dashboard e grafici in Superset.
                        Puoi anche usare "Inserimento Manuale" per aggiungere contenuti specifici.
                    </p>
                `;
                
                contentList.innerHTML = html;
            } else {
                contentList.innerHTML = '<p style="text-align: center; color: #666;">Nessun contenuto trovato</p>';
            }
        } else {
            throw new Error(data.error || 'Errore sconosciuto');
        }
    } catch (error) {
        console.error('Errore caricamento contenuti:', error);
        
        // Fallback: mostra contenuti di esempio
        const exampleItems = type === 'dashboards' 
            ? [1, 2, 3, 4, 5].map(i => ({id: i, title: `Dashboard ${i}`, type: 'dashboard'}))
            : [1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(i => ({id: i, title: `Grafico ${i}`, type: 'chart'}));
            
        let html = `<h3>${type === 'dashboards' ? 'Dashboard' : 'Grafici'} di Esempio</h3>`;
        html += '<div style="display: grid; gap: 10px; margin-top: 10px;">';
        
        exampleItems.forEach(item => {
            html += `
                <div onclick="selectContent('${item.type}', ${item.id}, '${item.title}')" 
                     style="padding: 12px; border: 1px solid #ddd; border-radius: 6px; 
                            cursor: pointer; transition: all 0.3s;"
                     onmouseover="this.style.background='#f0f0f0'" 
                     onmouseout="this.style.background='white'">
                    <strong>${item.title}</strong>
                    <span style="color: #666; font-size: 12px; margin-left: 10px;">ID: ${item.id}</span>
                </div>
            `;
        });
        
        html += '</div>';
        contentList.innerHTML = html;
    }
}

// Funzione per mostrare form inserimento manuale
function showManualEntry() {
    const contentList = document.getElementById('contentList');
    contentList.innerHTML = `
        <h3>Inserimento Manuale</h3>
        <div style="padding: 20px;">
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px;">Tipo:</label>
                <select id="manualType" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="dashboard">Dashboard</option>
                    <option value="chart">Grafico</option>
                </select>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px;">ID:</label>
                <input type="number" id="manualId" placeholder="Es: 1, 2, 42..." 
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px;">Titolo (opzionale):</label>
                <input type="text" id="manualTitle" placeholder="Es: Dashboard Vendite" 
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            
            <button onclick="addManualContent()" class="btn btn-primary" style="width: 100%;">Aggiungi</button>
            
            <div style="margin-top: 20px; padding: 10px; background: #e7f3ff; border-radius: 6px; font-size: 12px;">
                <strong>Come trovare l'ID:</strong><br>
                ‚Ä¢ Dashboard: Apri la dashboard in Superset, l'URL sar√† tipo /superset/dashboard/<strong>5</strong>/<br>
                ‚Ä¢ Grafico: Apri il grafico in Superset, l'URL conterr√† slice_id=<strong>42</strong>
            </div>
        </div>
    `;
}

// Funzione per aggiungere contenuto manuale dal modal
function addManualContent() {
    const type = document.getElementById('manualType').value;
    const id = document.getElementById('manualId').value;
    const title = document.getElementById('manualTitle').value || 
                  `${type === 'dashboard' ? 'Dashboard' : 'Grafico'} ${id}`;
    
    if (!id) {
        alert('Inserisci un ID valido');
        return;
    }
    
    selectContent(type, id, title);
}

// Funzione per selezionare un contenuto
function selectContent(type, id, title) {
    const chartData = {
        type: type,
        title: title
    };
    
    if (type === 'dashboard') {
        chartData.dashboardId = id;
    } else {
        chartData.sliceId = id;
    }
    
    closeContentModal();
    addNewChart(chartData);
}

// Funzione per chiudere il modal
function closeContentModal() {
    const modal = document.getElementById('contentModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

function parseSupsersetUrl(userUrl, isDashboard) {
    const url = new URL(userUrl);
    
    if (isDashboard) {
        const pathMatch = url.pathname.match(/\/superset\/dashboard\/(\d+)/);
        if (!pathMatch) throw new Error("URL dashboard non valido");
        
        return {
            type: 'dashboard',
            dashboardId: pathMatch[1],
            nativeFiltersKey: url.searchParams.get('native_filters_key'),
            title: `Dashboard ${pathMatch[1]}`
        };
    } else {
        const formDataKey = url.searchParams.get('form_data_key');
        const sliceId = url.searchParams.get('slice_id');
        
        if (!sliceId) {
            throw new Error("URL grafico non valido - slice_id mancante");
        }
        
        return {
            type: 'chart',
            formDataKey: formDataKey,
            sliceId: sliceId,
            dashboardPageId: url.searchParams.get('dashboard_page_id'),
            title: `Chart ${sliceId}`
        };
    }
}

function createChartCard(chartId, chartData, width, height) {
    const chartCard = document.createElement("div");
    chartCard.classList.add("dashboard-card", "resizable");
    chartCard.id = chartId;
    chartCard.style.width = `${width}px`;
    chartCard.style.height = `${height}px`;

    // Title bar
    const titleDiv = document.createElement("div");
    titleDiv.className = "chart-title";
    titleDiv.style.background = chartData.type === 'dashboard' ? '#e3f2fd' : '#f8f9fa';
    titleDiv.textContent = chartData.title || 'Dashboard';

    // Close button
    const closeBtn = document.createElement("button");
    closeBtn.innerHTML = "&times;";
    closeBtn.className = "close-button";
    closeBtn.onclick = () => removeChart(chartId);

    // Iframe container
    const iframeContainer = document.createElement("div");
    iframeContainer.className = "iframe-container";

    // Build iframe
    const iframe = createIframe(chartData, chartId);
    const loadingOverlay = createLoadingOverlay();

    titleDiv.appendChild(closeBtn);
    iframeContainer.appendChild(iframe);
    iframeContainer.appendChild(loadingOverlay);
    chartCard.appendChild(titleDiv);
    chartCard.appendChild(iframeContainer);
    
    return chartCard;
}

function createIframe(chartData, chartId) {
    const iframe = document.createElement("iframe");
    const iframeUrl = buildIframeUrl(chartData);
    
    iframe.src = iframeUrl;
    iframe.className = "dashboard-iframe";
    iframe.loading = "lazy";
    iframe.setAttribute('data-original-url', iframeUrl);
    iframe.setAttribute('data-chart-id', chartId);
    iframe.setAttribute('data-chart-type', chartData.type);
    iframe.setAttribute('data-dashboard-id', chartData.dashboardId || '');
    
    iframe.onload = function() {
        const overlay = this.parentElement.querySelector('.loading-overlay');
        
        // Controlla se siamo sulla pagina di login
        try {
            const iframeDoc = this.contentDocument || this.contentWindow.document;
            if (iframeDoc && iframeDoc.body.innerHTML.includes('login')) {
                console.log('Rilevata pagina login in iframe');
                
                // Se non siamo autenticati, apri la finestra di login
                if (!supersetAuthenticated) {
                    if (overlay) {
                        overlay.innerHTML = `
                            <div style="text-align: center; padding: 20px;">
                                <div style="font-size: 24px; margin-bottom: 8px;">üîê</div>
                                <div>Autenticazione richiesta</div>
                                <button onclick="openSupersetLogin(false)" class="btn btn-primary" style="margin-top: 10px;">
                                    Apri Login Superset
                                </button>
                            </div>
                        `;
                    }
                } else {
                    // Se siamo autenticati ma vediamo ancora il login, probabilmente la sessione √® scaduta
                    supersetAuthenticated = false;
                    openSupersetLogin(false);
                }
            } else {
                if (overlay) overlay.style.display = 'none';
                console.log(`Iframe ${chartId} caricato`);
            }
        } catch(e) {
            // Cross-origin, non possiamo accedere al contenuto
            if (overlay) overlay.style.display = 'none';
            console.log(`Iframe ${chartId} caricato`);
        }
    };
    
    iframe.onerror = function() {
        handleIframeError(this, chartData, chartId);
    };
    
    return iframe;
}

function buildIframeUrl(chartData) {
    let url = '';
    
    if (chartData.type === 'dashboard') {
        url = `${CONFIG.SUPERSET_BASE_URL}/superset/dashboard/${chartData.dashboardId}/?`;
        url += 'standalone=1&show_top_bar=0&hide_nav=1&embedded=1';
        if (chartData.nativeFiltersKey) {
            url += `&native_filters_key=${chartData.nativeFiltersKey}`;
        }
    } else {
        url = `${CONFIG.SUPERSET_BASE_URL}/explore/?`;
        if (chartData.formDataKey) {
            url += `form_data_key=${chartData.formDataKey}&`;
        }
        url += `slice_id=${chartData.sliceId}`;
        url += '&standalone=1&show_tabs=false&embedded=1';
        if (chartData.dashboardPageId) {
            url += `&dashboard_page_id=${chartData.dashboardPageId}`;
        }
    }
    
    return url;
}

function createLoadingOverlay() {
    const overlay = document.createElement("div");
    overlay.className = "loading-overlay";
    overlay.innerHTML = `
        <div style="text-align: center;">
            <div style="font-size: 24px; margin-bottom: 8px;">üîÑ</div>
            <div>Caricamento...</div>
        </div>
    `;
    return overlay;
}

function handleIframeError(iframe, chartData, chartId) {
    const container = iframe.parentElement;
    const overlay = container.querySelector('.loading-overlay');
    if (overlay) overlay.style.display = 'none';
    
    container.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: center; height: 100%; 
                    color: #dc3545; flex-direction: column; padding: 20px; text-align: center;">
            <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
            <div>Errore nel caricamento</div>
            <p style="font-size: 12px; color: #666; margin-top: 10px;">
                Assicurati di essere autenticato in Superset
            </p>
            <button onclick="refreshSingleChart('${chartId}')" 
                    class="btn btn-sm btn-primary" style="margin-top: 10px;">
                Riprova
            </button>
        </div>
    `;
}

function removeChart(chartId) {
    if (confirm('Rimuovere questo elemento?')) {
        document.getElementById(chartId).remove();
        charts = charts.filter(chart => chart.id !== chartId);
        saveLayout();
        showNotification('Elemento rimosso!', 'success');
    }
}

// ==========================================
// DIMENSIONI RESPONSIVE
// ==========================================
function getResponsiveDimensions(requestedWidth, requestedHeight) {
    const maxWidth = window.innerWidth - 120;
    const maxHeight = window.innerHeight - 200;
    
    return {
        width: Math.min(requestedWidth || CONFIG.DEFAULT_WIDTH, maxWidth),
        height: Math.min(requestedHeight || CONFIG.DEFAULT_HEIGHT, maxHeight)
    };
}

function setupWindowResize() {
    let resizeTimeout;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
            adjustChartsToWindow();
        }, 250);
    });
}

function adjustChartsToWindow() {
    const maxWidth = window.innerWidth - 120;
    
    document.querySelectorAll('.dashboard-card.resizable').forEach(card => {
        const currentWidth = parseInt(card.style.width);
        if (currentWidth > maxWidth) {
            card.style.width = `${maxWidth}px`;
            
            const chart = charts.find(c => c.id === card.id);
            if (chart) {
                chart.width = maxWidth;
            }
        }
    });
    
    saveLayout();
}

// ==========================================
// INTERACT.JS RESIZE
// ==========================================
function initializeResizable() {
    document.querySelectorAll('.dashboard-card.resizable').forEach(initializeResizableElement);
}

function initializeResizableElement(element) {
    if (typeof interact === 'undefined') {
        console.warn('interact.js non caricato');
        return;
    }

    const maxWidth = window.innerWidth - 120;
    const maxHeight = window.innerHeight - 200;

    interact(element).resizable({
        edges: { left: false, right: true, bottom: true, top: false },
        listeners: {
            move(event) {
                const target = event.target;
                const newWidth = Math.max(CONFIG.MIN_WIDTH, 
                    Math.min(maxWidth, event.rect.width));
                const newHeight = Math.max(CONFIG.MIN_HEIGHT, 
                    Math.min(maxHeight, event.rect.height));

                target.style.width = `${newWidth}px`;
                target.style.height = `${newHeight}px`;

                const chart = charts.find(c => c.id === target.id);
                if (chart) {
                    chart.width = newWidth;
                    chart.height = newHeight;
                }
            },
            end() {
                saveLayout();
                showNotification('Dimensioni aggiornate!', 'success');
            }
        },
        modifiers: [
            interact.modifiers.restrictSize({
                min: { width: CONFIG.MIN_WIDTH, height: CONFIG.MIN_HEIGHT }
            })
        ],
        inertia: true
    });
}

// ==========================================
// STORAGE E PERSISTENZA
// ==========================================
function saveLayout() {
    try {
        localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(charts));
    } catch (e) {
        console.error('Errore salvataggio:', e);
        showNotification('Errore nel salvataggio', 'error');
    }
}

function loadLayout() {
    try {
        const saved = localStorage.getItem(CONFIG.STORAGE_KEY);
        if (saved) {
            const loadedCharts = JSON.parse(saved);
            charts = [];
            
            loadedCharts.forEach(chart => {
                const dimensions = getResponsiveDimensions(chart.width, chart.height);
                chart.width = dimensions.width;
                chart.height = dimensions.height;
                addNewChart(chart);
            });
            
            if (loadedCharts.length > 0) {
                showNotification(`Caricati ${loadedCharts.length} elementi`, 'success');
                return true; // Ritorna true se ci sono grafici
            }
        }
        return false; // Ritorna false se non ci sono grafici
    } catch (e) {
        console.error('Errore caricamento:', e);
        showNotification('Errore nel caricamento', 'error');
        return false;
    }
}

function clearLayout() {
    if (confirm('Cancellare tutti gli elementi?')) {
        localStorage.removeItem(CONFIG.STORAGE_KEY);
        document.querySelectorAll('.dashboard-card.resizable').forEach(el => el.remove());
        charts = [];
        showNotification('Layout cancellato!', 'success');
    }
}

// ==========================================
// IMPORT/EXPORT
// ==========================================
function exportLayout() {
    try {
        const dataStr = JSON.stringify(charts, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        const fileName = `talon_dashboard_${new Date().toISOString().split('T')[0]}.json`;
        
        const link = document.createElement('a');
        link.setAttribute('href', dataUri);
        link.setAttribute('download', fileName);
        link.click();
        
        showNotification('Layout esportato!', 'success');
    } catch (e) {
        console.error('Errore esportazione:', e);
        showNotification('Errore nell\'esportazione', 'error');
    }
}

function importLayout(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const imported = JSON.parse(e.target.result);
            if (!Array.isArray(imported)) {
                throw new Error('Formato file non valido');
            }
            
            clearLayout();
            charts = [];
            imported.forEach(chart => addNewChart(chart));
            showNotification(`${imported.length} elementi importati!`, 'success');
        } catch (error) {
            console.error('Errore importazione:', error);
            showNotification('Errore importazione: ' + error.message, 'error');
        }
    };
    reader.readAsText(file);
    event.target.value = '';
}

// ==========================================
// REFRESH
// ==========================================
function refreshAllCharts() {
    const iframes = document.querySelectorAll('.dashboard-iframe');
    if (iframes.length === 0) {
        showNotification('Nessun grafico da aggiornare', 'warning');
        return;
    }
    
    showNotification(`Aggiornamento ${iframes.length} grafici...`, 'info');
    
    iframes.forEach((iframe, index) => {
        setTimeout(() => refreshIframe(iframe), index * 200);
    });
    
    lastRefreshTime = new Date();
}

function refreshSingleChart(chartId) {
    const chartCard = document.getElementById(chartId);
    if (!chartCard) return;
    
    const iframe = chartCard.querySelector('.dashboard-iframe');
    if (iframe) {
        refreshIframe(iframe);
        showNotification('Grafico aggiornato!', 'success');
    }
}

function refreshIframe(iframe) {
    const container = iframe.parentElement;
    const overlay = container.querySelector('.loading-overlay');
    if (overlay) overlay.style.display = 'flex';
    
    const originalUrl = iframe.getAttribute('data-original-url');
    const cacheBuster = `refresh=${Date.now()}`;
    const separator = originalUrl.includes('?') ? '&' : '?';
    
    iframe.src = originalUrl + separator + cacheBuster;
}

// ==========================================
// AUTO-REFRESH
// ==========================================
function cycleAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
    
    const states = [
        { text: 'AUTO-REFRESH OFF', minutes: 0 },
        { text: 'AUTO-REFRESH 15 MIN', minutes: 15 },
        { text: 'AUTO-REFRESH 30 MIN', minutes: 30 },
        { text: 'AUTO-REFRESH 60 MIN', minutes: 60 }
    ];
    
    autoRefreshState = (autoRefreshState + 1) % states.length;
    const currentState = states[autoRefreshState];
    
    const btn = document.getElementById('autoRefreshBtn');
    if (btn) {
        btn.textContent = currentState.text;
        btn.className = currentState.minutes > 0 ? 'btn btn-warning' : 'btn btn-info';
    }
    
    if (currentState.minutes > 0) {
        autoRefreshInterval = setInterval(refreshAllCharts, currentState.minutes * 60 * 1000);
        showNotification(`Auto-refresh: ${currentState.minutes} minuti`, 'success');
    } else {
        showNotification('Auto-refresh disattivato', 'info');
    }
    
    saveAutoRefreshSettings();
}

function saveAutoRefreshSettings() {
    localStorage.setItem('talon_autorefresh_settings', JSON.stringify({ state: autoRefreshState }));
}

function loadAutoRefreshSettings() {
    try {
        const saved = localStorage.getItem('talon_autorefresh_settings');
        if (saved) {
            const settings = JSON.parse(saved);
            autoRefreshState = settings.state || 0;
            
            if (autoRefreshState > 0) {
                autoRefreshState--;
                cycleAutoRefresh();
            }
        }
    } catch (e) {
        console.error('Errore caricamento auto-refresh:', e);
    }
}

// ==========================================
// UI FEEDBACK
// ==========================================
function showNotification(message, type = 'info') {
    document.querySelectorAll('.notification').forEach(n => n.remove());
    
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    
    const colors = {
        success: '#28a745',
        error: '#dc3545',
        warning: '#ffc107',
        info: '#17a2b8'
    };
    
    notification.style.background = colors[type] || colors.info;
    notification.style.transform = 'translateX(100%)';
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 10);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// ==========================================
// ERROR HANDLING
// ==========================================
window.addEventListener('error', function(e) {
    console.error('Errore JavaScript:', e.error);
    if (e.error && e.error.message && e.error.message.includes('interact')) {
        showNotification('Libreria interact.js non caricata', 'warning');
    }
});

console.log('TALON Dashboard v1.0 inizializzato');
</script>

<!-- Carica interact.js per resize -->
<script src="{{ url_for('static', filename='js/libs/interact.min.js') }}" defer></script>

{% endblock %}