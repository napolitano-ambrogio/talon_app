{% extends "_base.html" %}

{% block title %}Dashboard - TALON{% endblock %}

{% block content %}

<!-- Controlli dashboard -->
<div class="dashboard-controls">
    <button onclick="cycleAutoRefresh()" class="btn btn-info" id="autoRefreshBtn">AUTO-REFRESH OFF</button>
</div>

<!-- Status Superset (nascosto di default) -->
<div id="supersetStatus" style="position: fixed; top: 70px; right: 20px; padding: 8px 12px; 
                           background: #dc3545; color: white; border-radius: 4px; 
                           font-size: 12px; z-index: 1000; display: none;">
    Non Connesso
</div>

<div id="dashboard-grid" class="dashboard-grid">
    <div class="dashboard-card add-card" onclick="addNewChart()">
        <div class="plus-icon">+</div>
    </div>
</div>

<!-- Modal Selezione Contenuti -->
<div id="contentModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Aggiungi Elemento alla Dashboard</h2>
            <button onclick="closeContentModal()" class="modal-close">&times;</button>
        </div>
        
        <div class="primary-options">
            <div class="option-card" onclick="selectPrimaryOption('drill-down')">
                <div class="option-icon">🎯</div>
                <div class="option-title">Grafico Esplorabile delle Attività</div>
                <div class="option-description">Analisi interattiva drill-down con dati TALON</div>
            </div>
            
            <div class="option-card" onclick="selectPrimaryOption('superset')">
                <div class="option-icon">📊</div>
                <div class="option-title">Dashboard Superset</div>
                <div class="option-description">Dashboard n. 1 associata al tuo account</div>
            </div>
        </div>
    </div>
</div>

<style>
/* Reset e layout base */
body {
    overflow-x: hidden;
}
.page-wrapper { max-width: 100%; overflow-x: hidden; }

/* Controlli dashboard */
.dashboard-controls {
    display: flex; justify-content: flex-end; align-items: center;
    gap: 10px; margin: 20px; flex-wrap: wrap;
}

/* Grid container */
#dashboard-grid {
    padding: 0 20px 20px; display: flex; flex-wrap: wrap; gap: 20px; max-width: 100%;
}

/* Cards */
.dashboard-card {
    background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    position: relative; display: inline-block; vertical-align: top;
    min-width: 300px; min-height: 200px;
}
.dashboard-card.resizable { max-width: calc(100vw - 100px); overflow: hidden; }

/* Add card */
.dashboard-card.add-card {
    width: 200px; height: 200px; display: flex; align-items: center; justify-content: center;
    cursor: pointer; border: 2px dashed #ddd; background: #f8f9fa; transition: all 0.3s ease;
}
.dashboard-card.add-card:hover { border-color: #007bff; background: #e7f3ff; }
.plus-icon { font-size: 48px; color: #6c757d; }

/* Title bar */
.chart-title {
    padding: 8px 12px; border-bottom: 1px solid #dee2e6; font-weight: 600; font-size: 14px;
    color: #495057; position: relative; display: flex; align-items: center; height: 40px;
}

/* Close button */
.close-button {
    position: absolute; top: 8px; right: 8px; background: none; border: none; font-size: 18px;
    cursor: pointer; color: #6c757d; width: 24px; height: 24px; display: flex; align-items: center;
    justify-content: center; border-radius: 50%; transition: all 0.2s;
}
.close-button:hover { background: #dc3545; color: white; }

/* Iframe */
.iframe-container { position: relative; width: 100%; height: calc(100% - 40px); overflow: hidden; }
.dashboard-iframe { width: 100%; height: 100%; border: none; display: block; }

/* Loading overlay */
.loading-overlay {
    position: absolute; inset: 0; background: rgba(255,255,255,0.9);
    display: flex; align-items: center; justify-content: center; z-index: 10;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
}

/* Modal */
.modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.5);
    display: flex; align-items: center; justify-content: center; z-index: 10000;
}
.modal-content {
    background: white; width: 90%; max-width: 900px; max-height: 80vh; border-radius: 12px;
    display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
}
.modal-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 20px; border-bottom: 1px solid #e0e0e0;
}
.modal-header h2 { margin: 0; font-size: 24px; color: #333; }
.modal-close {
    background: none; border: none; font-size: 28px; cursor: pointer; color: #999; padding: 0;
    width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
    border-radius: 50%; transition: all 0.2s;
}
.modal-close:hover { background: #f0f0f0; color: #333; }

/* Primary Options */
.primary-options { 
    padding: 30px; display: flex; gap: 20px; justify-content: center; 
    flex-wrap: wrap; min-height: 200px; 
}
.option-card {
    flex: 1; max-width: 300px; min-width: 250px; padding: 25px; border: 2px solid #e0e0e0; 
    border-radius: 12px; cursor: pointer; transition: all 0.3s ease;
    background: white; text-align: center; display: flex; flex-direction: column;
    align-items: center; justify-content: center;
}
.option-card:hover {
    border-color: #007bff; background: #f8f9ff; transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(0,123,255,0.15);
}
.option-icon { 
    font-size: 48px; margin-bottom: 15px; display: block;
}
.option-title { 
    font-weight: 600; font-size: 16px; color: #333; margin-bottom: 8px; 
}
.option-description { 
    font-size: 13px; color: #666; line-height: 1.4; 
}

/* Content Grid */
.content-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; }
.content-item {
    padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s;
    background: white;
}
.content-item:hover {
    border-color: #007bff; background: #f8f9ff; transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,123,255,0.15);
}
.content-item-icon { font-size: 24px; margin-bottom: 8px; }
.content-item-title { font-weight: 600; font-size: 14px; color: #333; margin-bottom: 4px; }
.content-item-id { font-size: 11px; color: #999; }
.content-item-type {
    display: inline-block; padding: 2px 8px; background: #e7f3ff; color: #007bff;
    font-size: 10px; border-radius: 4px; margin-top: 8px; text-transform: uppercase; font-weight: 600;
}

/* Notification */
.notification {
    position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 6px; color: white;
    font-weight: 500; z-index: 10000; max-width: 400px; word-wrap: break-word; transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* Resize handle */
.dashboard-card.resizable::after {
    content: ''; position: absolute; bottom: 0; right: 0; width: 20px; height: 20px; cursor: se-resize;
    background: linear-gradient(135deg, transparent 50%, #ccc 50%); border-bottom-right-radius: 8px;
}

/* Buttons */
.btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s; }
.btn-success { background: #28a745; color: white; } .btn-success:hover { background: #218838; }
.btn-info { background: #17a2b8; color: white; } .btn-info:hover { background: #138496; }
.btn-warning { background: #ffc107; color: #212529; } .btn-warning:hover { background: #e0a800; }
.btn-sm { padding: 4px 8px; font-size: 12px; }

/* Media */
@media (max-width: 768px) {
    .dashboard-controls { justify-content: center; margin: 10px; }
    .dashboard-controls button { font-size: 12px; padding: 5px 10px; }
    #dashboard-grid { padding: 0 10px; gap: 10px; }
    .dashboard-card.resizable { max-width: calc(100vw - 40px); width: 100% !important; }
    .content-grid { grid-template-columns: 1fr; }
    .modal-content { width: 95%; max-height: 90vh; }
}

/* Stili per il pulsante X floating */
.floating-close-button {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: rgba(220, 53, 69, 0.9);
    color: white;
    border: none;
    font-size: 20px;
    line-height: 1;
    cursor: pointer;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

.floating-close-button:hover {
    background: rgba(220, 53, 69, 1);
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

/* Area sensibile per attivare il pulsante floating */
.hover-area-close {
    position: absolute;
    top: 0;
    right: 0;
    width: 100px;
    height: 100px;
    z-index: 999;
    /* Debug: rimuovi dopo il test */
    /* background: rgba(255, 0, 0, 0.1); */
}

/* Assicurati che la card abbia position relative per i figli absolute */
.dashboard-card {
    position: relative !important;
}
</style>

<script>
// ==========================================
// CONFIGURAZIONE (dal backend)
// ==========================================
const CONFIG = {
    STORAGE_KEY: 'talon_dashboard_layout',
    DEFAULT_WIDTH: 600,
    DEFAULT_HEIGHT: 400,
    MIN_WIDTH: 300,
    MIN_HEIGHT: 200,
    // Preso dal context processor di app.py
    SUPERSET_BASE_URL: '{{ SUPERSET_BASE_URL }}',
    SUPERSET_PROXY_URL: '{{ SUPERSET_PROXY_URL }}'
};
// Flag SSO esposto dal backend (potrebbe servire in futuro per SSO completo)
const SSO_ENABLED = {{ 'true' if sso_enabled else 'false' }};

// ==========================================
// CONTENUTI DISPONIBILI
// ==========================================
const AVAILABLE_CONTENT = {
    dashboards: [
        { id: 1, title: "Dashboard Operazioni", icon: "📊" },
        { id: 2, title: "Dashboard Statistiche", icon: "📈" },
        { id: 3, title: "Dashboard Risorse", icon: "💰" },
        { id: 4, title: "Dashboard Personale", icon: "👥" },
        { id: 5, title: "Dashboard Logistica", icon: "🚚" },
        { id: 6, title: "Dashboard Sicurezza", icon: "🔒" }
    ],
    charts: [
        { id: 1, title: "Operazioni per Mese", icon: "📅" },
        { id: 2, title: "Distribuzione Risorse", icon: "🎯" },
        { id: 3, title: "Trend Attività", icon: "📈" },
        { id: 4, title: "Personale per Reparto", icon: "👨‍💼" },
        { id: 5, title: "Costi Operativi", icon: "💵" },
        { id: 6, title: "KPI Principali", icon: "🎯" },
        { id: 7, title: "Mappa Operazioni", icon: "🗺️" },
        { id: 8, title: "Timeline Eventi", icon: "⏰" },
        { id: 9, title: "Analisi Prestazioni", icon: "⚡" },
        { id: 10, title: "Report Incidenti", icon: "⚠️" },
        { id: 11, title: "Stato Mezzi", icon: "🚗" },
        { id: 12, title: "Consumo Carburante", icon: "⛽" }
    ]
};

// ==========================================
// VARIABILI GLOBALI
// ==========================================
let chartCounter = 0;
let charts = [];
let autoRefreshInterval = null;
let autoRefreshState = 0;
let supersetAuthenticated = {{ 'true' if session.get('superset_authenticated') else 'false' }};
let supersetLoginWindow = null;

// ==========================================
// INIZIALIZZAZIONE
// ==========================================
document.addEventListener('DOMContentLoaded', async () => {
    // Non forziamo più HTTPS->HTTP: solo messaggio in caso di mismatch protocollo/porta
    checkEnvironmentHint();

    // Superset authentication is now handled automatically by server
    console.log('Superset authentication status:', supersetAuthenticated);
    
    // FORCE CLEAR CORRUPTED DASHBOARD DATA - Remove this after fixing
    const wasCorrupted = clearCorruptedDashboardData();
    
    if (wasCorrupted) {
        console.log('🔍 Dashboard data was corrupted and has been cleared. Check the console for detailed logs.');
        showNotification('Dashboard data cleared - check console for details', 'info');
    }
    
    // Aggiungi controllo per dashboard corrotte
    addDebugControls();
    
    // Carica layout salvato
    const hasCharts = loadLayout();
    
    // Se ci sono grafici e non siamo autenticati → chiedi login
    if (hasCharts && !supersetAuthenticated) {
        showNotification('Autenticazione Superset richiesta per i grafici', 'info');
        setTimeout(() => { openSupersetLogin(false); }, 1000);
    } else if (hasCharts && supersetAuthenticated) {
        showNotification('Sessione Superset attiva, caricamento grafici...', 'success');
        setTimeout(() => { refreshAllCharts(); }, 1500);
    }
    
    initializeResizable();
    loadAutoRefreshSettings();
    setupWindowResize();
});

// Solo suggerimento se in HTTPS ma Superset è HTTP
function checkEnvironmentHint() {
    try {
        const supersetUrl = new URL(CONFIG.SUPERSET_BASE_URL);
        if (location.protocol === 'https:' && supersetUrl.protocol === 'http:') {
            console.warn('Stai usando TALON in HTTPS mentre Superset è in HTTP. L\'iframe potrebbe essere bloccato (mixed content).');
            showNotification('Attenzione: TALON in HTTPS e Superset in HTTP potrebbero causare blocchi iframe.', 'warning');
        }
    } catch (e) {
        // ignore
    }
}

// ==========================================
// GESTIONE MODAL SELEZIONE
// ==========================================
function openContentModal() { document.getElementById('contentModal').style.display = 'flex'; }
function closeContentModal() { document.getElementById('contentModal').style.display = 'none'; }

function selectPrimaryOption(option) {
    closeContentModal();
    
    if (option === 'drill-down') {
        // Aggiungi il Grafico Esplorabile delle Attività - senza controllo Superset
        const chartData = {
            type: 'drill-down',
            title: 'Grafico Esplorabile delle Attività',
            url: '/drill-down/'
        };
        addNewChartWithData(chartData);
    } else if (option === 'superset') {
        // Reindirizza alla pagina embedded di Superset
        window.location.href = '{{ url_for("main.superset_embedded") }}';
        return;
        
        // Aggiungi la Dashboard Superset n. 1
        const chartData = {
            type: 'dashboard',
            title: 'Dashboard Superset #1',
            dashboardId: 1
        };
        addNewChartWithData(chartData);
    }
}

// ==========================================
// GESTIONE GRAFICI
// ==========================================
function addNewChart() {
    console.log('[Dashboard] addNewChart called on main dashboard');
    
    // Check user role for permissions - same logic as dashboard_admin.js
    const userRole = window.FLASK_USER_ROLE || window.userRole || 'VISUALIZZATORE';
    const userLevel = getRoleLevel(userRole);
    
    console.log(`[Dashboard] User role: ${userRole} (level: ${userLevel})`);
    
    // Role-based functionality
    if (userLevel >= 50) { // OPERATORE or ADMIN
        console.log('[Dashboard] User has sufficient permissions, checking Superset auth...');
        
        if (!supersetAuthenticated) {
            if (sessionStorage.getItem('superset_authenticated') === 'true') {
                supersetAuthenticated = true;
                openContentModal();
            } else {
                openSupersetLogin(true);
            }
            return;
        }
        openContentModal();
    } else {
        // VISUALIZZATORE - Read only
        console.log('[Dashboard] Insufficient permissions for chart creation');
        if (window.TalonApp && window.TalonApp.showToast) {
            window.TalonApp.showToast('Solo Operatori e Amministratori possono aggiungere grafici', 'warning');
        } else {
            alert('Solo Operatori e Amministratori possono aggiungere grafici');
        }
    }
}

// Helper function for role levels (same as dashboard_admin.js)
function getRoleLevel(role) {
    const roleLevels = {
        'ADMIN': 100,
        'OPERATORE': 50,
        'VISUALIZZATORE': 10,
        'GUEST': 0
    };
    return roleLevels[role] || 0;
}
// debug auth
function resetSupersetAuth() {
    sessionStorage.removeItem('superset_authenticated');
    supersetAuthenticated = false;
    showNotification('Stato autenticazione Superset resettato', 'info');
}
function addNewChartWithData(chartData) {
    try {
        // Validate chart data before creating
        if (chartData.type === 'dashboard' && chartData.dashboardId) {
            // Allow dashboard ID 1 but block other hardcoded example IDs
            if (typeof chartData.dashboardId === 'number' && chartData.dashboardId > 1 && chartData.dashboardId <= 12) {
                console.error(`🚫 REJECTED: Dashboard ID ${chartData.dashboardId} is invalid (hardcoded example)`);
                showNotification(`Dashboard ID ${chartData.dashboardId} non valida - rimuovere dai dati salvati`, 'error');
                return;
            }
        }
        
        const uniqueId = chartData.id || `chart_${Date.now()}_${chartCounter++}`;
        const dimensions = getResponsiveDimensions(chartData.width, chartData.height);
        const grid = document.getElementById("dashboard-grid");
        const chartCard = createChartCard(uniqueId, chartData, dimensions.width, dimensions.height);
        grid.insertBefore(chartCard, grid.lastElementChild);
        
        if (!chartData.id) {
            const newChartData = { id: uniqueId, ...chartData, width: dimensions.width, height: dimensions.height };
            charts.push(newChartData);
            saveLayout();
        }
        
        initializeResizableElement(chartCard);
        showNotification(`${chartData.title} aggiunto!`, 'success');
        
    } catch (error) {
        console.error('Error adding chart:', error);
        showNotification(`Errore aggiunta grafico: ${error.message}`, 'error');
    }
}
function openSupersetLogin(forNewChart = false) {
    if (supersetLoginWindow && !supersetLoginWindow.closed) {
        supersetLoginWindow.focus(); return;
    }
    const width = 800, height = 600;
    const left = (screen.width - width) / 2, top = (screen.height - height) / 2;
    supersetLoginWindow = window.open(
        `${CONFIG.SUPERSET_BASE_URL}/login/`,
        'SupersetLogin',
        `width=${width},height=${height},left=${left},top=${top}`
    );
    if (!forNewChart) showNotification('Autenticati in Superset per visualizzare i grafici', 'info');
    const checkInterval = setInterval(() => {
        if (supersetLoginWindow.closed) {
            clearInterval(checkInterval);
            supersetAuthenticated = true;
            sessionStorage.setItem('superset_authenticated', 'true');
            supersetLoginWindow = null;
            if (forNewChart) {
                showNotification('Autenticato! Ora puoi aggiungere grafici.', 'success');
                setTimeout(openContentModal, 500);
            } else {
                showNotification('Sessione Superset attiva!', 'success');
                setTimeout(refreshAllCharts, 1000);
            }
        }
    }, 1000);
}
function createChartCard(chartId, chartData, width, height) {
    const card = document.createElement("div");
    card.classList.add("dashboard-card", "resizable");
    card.id = chartId; card.style.width = `${width}px`; card.style.height = `${height}px`;
    const titleDiv = document.createElement("div");
    titleDiv.className = "chart-title";
    
    // Per drill-down non mostrare il titolo
    if (chartData.type === 'drill-down') {
        titleDiv.style.display = 'none';
    } else {
        titleDiv.style.background = chartData.type === 'dashboard' ? '#e3f2fd' : '#f8f9fa';
        let icon = '';
        if (chartData.type === 'dashboard') {
            const d = AVAILABLE_CONTENT.dashboards.find(x => x.id == chartData.dashboardId);
            icon = d ? d.icon : '📊';
        } else {
            const c = AVAILABLE_CONTENT.charts.find(x => x.id == chartData.sliceId);
            icon = c ? c.icon : '📈';
        }
        titleDiv.innerHTML = `${icon} ${chartData.title || 'Dashboard'}`;
    }
    
    const closeBtn = document.createElement("button");
    closeBtn.innerHTML = "&times;"; closeBtn.className = "close-button";
    closeBtn.onclick = () => removeChart(chartId);
    
    // Crea un pulsante X floating per l'iframe
    const floatingCloseBtn = document.createElement("button");
    floatingCloseBtn.innerHTML = "&times;";
    floatingCloseBtn.className = "floating-close-button";
    floatingCloseBtn.onclick = () => removeChart(chartId);
    floatingCloseBtn.title = "Chiudi";
    
    // Crea un'area sensibile per il hover nell'angolo in alto a destra
    const hoverArea = document.createElement("div");
    hoverArea.className = "hover-area-close";
    
    // Mostra/nascondi il pulsante floating al hover
    hoverArea.addEventListener('mouseenter', () => {
        floatingCloseBtn.style.opacity = '1';
        floatingCloseBtn.style.visibility = 'visible';
    });
    
    hoverArea.addEventListener('mouseleave', () => {
        floatingCloseBtn.style.opacity = '0';
        floatingCloseBtn.style.visibility = 'hidden';
    });
    
    floatingCloseBtn.addEventListener('mouseenter', () => {
        floatingCloseBtn.style.opacity = '1';
        floatingCloseBtn.style.visibility = 'visible';
    });
    
    const iframeContainer = document.createElement("div");
    iframeContainer.className = "iframe-container";
    
    // Per drill-down occupa tutta l'altezza (senza titolo)
    if (chartData.type === 'drill-down') {
        iframeContainer.style.height = '100%';
    }
    const iframe = createIframe(chartData, chartId);
    const loadingOverlay = createLoadingOverlay();
    titleDiv.appendChild(closeBtn);
    iframeContainer.appendChild(iframe);
    iframeContainer.appendChild(loadingOverlay);
    card.appendChild(titleDiv);
    card.appendChild(iframeContainer);
    
    // Aggiungi l'area hover e il pulsante floating
    card.appendChild(hoverArea);
    card.appendChild(floatingCloseBtn);
    return card;
}
function createIframe(chartData, chartId) {
    const iframe = document.createElement("iframe");
    
    try {
        const iframeUrl = buildIframeUrl(chartData);
        iframe.src = iframeUrl;
        iframe.setAttribute('data-original-url', iframeUrl);
    } catch (error) {
        console.error('Failed to build iframe URL:', error);
        // Create error content instead
        const errorHtml = `
            <html><body style="margin:0;padding:20px;display:flex;align-items:center;justify-content:center;height:100vh;font-family:system-ui;">
                <div style="text-align:center;color:#dc3545;">
                    <div style="font-size:48px;margin-bottom:16px;">🚫</div>
                    <div style="font-weight:bold;margin-bottom:10px;">URL Non Valida</div>
                    <p style="font-size:12px;color:#666;">${error.message}</p>
                </div>
            </body></html>
        `;
        iframe.srcdoc = errorHtml;
        iframe.setAttribute('data-original-url', 'error');
    }
    
    iframe.className = "dashboard-iframe"; 
    iframe.loading = "lazy";
    iframe.setAttribute('data-chart-id', chartId);
    iframe.setAttribute('data-chart-type', chartData.type);
    iframe.setAttribute('data-dashboard-id', chartData.dashboardId || '');
    iframe.onload = function() {
        const overlay = this.parentElement.querySelector('.loading-overlay');
        const chartType = this.getAttribute('data-chart-type');
        
        // Per il drill-down non fare controlli di autenticazione Superset
        if (chartType === 'drill-down') {
            if (overlay) overlay.style.display = 'none';
            console.log('🎯 Drill-down caricato correttamente');
            return;
        }
        
        // Solo per dashboard Superset fare i controlli di autenticazione
        try {
            const iframeDoc = this.contentDocument || this.contentWindow.document;
            if (iframeDoc && /login/i.test(iframeDoc.body.innerHTML)) {
                if (!supersetAuthenticated) {
                    sessionStorage.removeItem('superset_authenticated');
                    supersetAuthenticated = false;
                    if (overlay) {
                        overlay.innerHTML = `
                            <div style="text-align: center; padding: 20px;">
                                <div style="font-size: 24px; margin-bottom: 8px;">🔐</div>
                                <div>Autenticazione richiesta</div>
                                <button onclick="openSupersetLogin(false)" class="btn btn-primary" style="margin-top: 10px;">
                                    Apri Login Superset
                                </button>
                            </div>
                        `;
                    }
                } else {
                    sessionStorage.removeItem('superset_authenticated');
                    supersetAuthenticated = false;
                    showNotification('Sessione Superset scaduta, riautenticazione necessaria', 'warning');
                    openSupersetLogin(false);
                }
            } else {
                if (overlay) overlay.style.display = 'none';
            }
        } catch(e) {
            if (overlay) overlay.style.display = 'none';
        }
    };
    iframe.onerror = function() { handleIframeError(this, chartData, chartId); };
    return iframe;
}
function buildIframeUrl(chartData) {
    let url = '';
    
    if (chartData.type === 'drill-down') {
        // Per il Grafico Esplorabile delle Attività
        console.log('Building drill-down chart URL');
        url = chartData.url || '/components/drill-down_chart.html';
        
    } else if (chartData.type === 'dashboard') {
        // VALIDATE DASHBOARD ID BEFORE BUILDING URL
        if (chartData.dashboardId) {
            // Block hardcoded example dashboard IDs that don't exist (except ID 1 which we want to allow)
            if (typeof chartData.dashboardId === 'number' && chartData.dashboardId > 1 && chartData.dashboardId <= 12) {
                console.error(`🚫 BLOCKED: Attempt to load non-existent dashboard ID ${chartData.dashboardId}`);
                throw new Error(`Dashboard ID ${chartData.dashboardId} is a hardcoded example that doesn't exist in Superset`);
            }
        }
        
        console.log(`Building dashboard URL for ID: ${chartData.dashboardId}`);
        url = `${CONFIG.SUPERSET_BASE_URL}/superset/dashboard/${chartData.dashboardId}/?`;
        url += 'standalone=1&show_top_bar=0&hide_nav=1&embedded=1';
        if (chartData.nativeFiltersKey) url += `&native_filters_key=${chartData.nativeFiltersKey}`;
        
    } else {
        console.log(`Building chart URL for slice ID: ${chartData.sliceId}`);
        url = `${CONFIG.SUPERSET_BASE_URL}/explore/?`;
        if (chartData.formDataKey) url += `form_data_key=${chartData.formDataKey}&`;
        url += `slice_id=${chartData.sliceId}`;
        url += '&standalone=1&show_tabs=false&embedded=1';
        if (chartData.dashboardPageId) url += `&dashboard_page_id=${chartData.dashboardPageId}`;
    }
    
    console.log(`Built URL: ${url}`);
    return url;
}
function createLoadingOverlay() {
    const overlay = document.createElement("div");
    overlay.className = "loading-overlay";
    overlay.innerHTML = `
        <div style="text-align: center;">
            <div style="font-size: 24px; margin-bottom: 8px;">🔄</div>
            <div>Caricamento...</div>
        </div>
    `;
    return overlay;
}
function handleIframeError(iframe, chartData, chartId) {
    const container = iframe.parentElement;
    const overlay = container.querySelector('.loading-overlay');
    if (overlay) overlay.style.display = 'none';
    
    console.error('Iframe error for:', {
        chartId: chartId,
        title: chartData.title,
        type: chartData.type,
        dashboardId: chartData.dashboardId,
        sliceId: chartData.sliceId,
        url: iframe.src
    });
    
    // Verifica se è un errore 404 (dashboard/chart non trovata)
    const isNotFound = chartData.type === 'dashboard' && chartData.dashboardId;
    const errorTitle = isNotFound ? 'Dashboard non trovata' : 'Errore nel caricamento';
    const errorDescription = isNotFound ? 
        `Dashboard ID ${chartData.dashboardId} non esiste in Superset` : 
        'Assicurati di essere autenticato in Superset';
    
    container.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: center; height: 100%; 
                    color: #dc3545; flex-direction: column; padding: 20px; text-align: center;">
            <div style="font-size: 48px; margin-bottom: 16px;">${isNotFound ? '🚫' : '⚠️'}</div>
            <div style="font-weight: bold; margin-bottom: 10px;">${errorTitle}</div>
            <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
                ${errorDescription}
            </p>
            <div>
                <button onclick="refreshSingleChart('${chartId}')" class="btn btn-sm btn-primary me-2">
                    Riprova
                </button>
                <button onclick="removeChart('${chartId}')" class="btn btn-sm btn-outline-danger">
                    Rimuovi
                </button>
            </div>
            ${isNotFound ? `<small style="color: #888; margin-top: 10px;">ID: ${chartData.dashboardId}</small>` : ''}
        </div>
    `;
}
function removeChart(chartId) {
    if (confirm('Rimuovere questo elemento?')) {
        document.getElementById(chartId).remove();
        charts = charts.filter(chart => chart.id !== chartId);
        saveLayout();
        showNotification('Elemento rimosso!', 'success');
    }
}

// ==========================================
// DIMENSIONI RESPONSIVE
// ==========================================
function getResponsiveDimensions(requestedWidth, requestedHeight) {
    const maxWidth = window.innerWidth - 120;
    const maxHeight = window.innerHeight - 200;
    return {
        width: Math.min(requestedWidth || CONFIG.DEFAULT_WIDTH, maxWidth),
        height: Math.min(requestedHeight || CONFIG.DEFAULT_HEIGHT, maxHeight)
    };
}
function setupWindowResize() {
    let resizeTimeout;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(adjustChartsToWindow, 250);
    });
}
function adjustChartsToWindow() {
    const maxWidth = window.innerWidth - 120;
    document.querySelectorAll('.dashboard-card.resizable').forEach(card => {
        const currentWidth = parseInt(card.style.width);
        if (currentWidth > maxWidth) {
            card.style.width = `${maxWidth}px`;
            const chart = charts.find(c => c.id === card.id);
            if (chart) chart.width = maxWidth;
        }
    });
    saveLayout();
}

// ==========================================
// INTERACT.JS RESIZE
// ==========================================
function initializeResizable() {
    document.querySelectorAll('.dashboard-card.resizable').forEach(initializeResizableElement);
}
function initializeResizableElement(element) {
    if (typeof interact === 'undefined') {
        console.warn('interact.js non caricato');
        return;
    }
    const maxWidth = window.innerWidth - 120;
    const maxHeight = window.innerHeight - 200;
    interact(element).resizable({
        edges: { left: false, right: true, bottom: true, top: false },
        listeners: {
            move(event) {
                const target = event.target;
                const newWidth = Math.max(CONFIG.MIN_WIDTH, Math.min(maxWidth, event.rect.width));
                const newHeight = Math.max(CONFIG.MIN_HEIGHT, Math.min(maxHeight, event.rect.height));
                target.style.width = `${newWidth}px`;
                target.style.height = `${newHeight}px`;
                const chart = charts.find(c => c.id === target.id);
                if (chart) { chart.width = newWidth; chart.height = newHeight; }
            },
            end() {
                saveLayout();
                showNotification('Dimensioni aggiornate!', 'success');
            }
        },
        modifiers: [ interact.modifiers.restrictSize({ min: { width: CONFIG.MIN_WIDTH, height: CONFIG.MIN_HEIGHT }}) ],
        inertia: true
    });
}

// ==========================================
// STORAGE E PERSISTENZA
// ==========================================
function saveLayout() {
    try {
        localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(charts));
        console.log('Layout salvato automaticamente');
    } catch (e) {
        console.error('Errore salvataggio:', e);
        showNotification('Errore nel salvataggio automatico', 'error');
    }
}
function loadLayout() {
    try {
        const saved = localStorage.getItem(CONFIG.STORAGE_KEY);
        if (saved) {
            const loadedCharts = JSON.parse(saved);
            console.log('Loading saved charts:', loadedCharts);
            
            // Verifica se ci sono dashboard/chart che potrebbero non esistere
            const validCharts = loadedCharts.filter(chart => {
                if (chart.type === 'drill-down') {
                    console.log(`Loading drill-down chart: ${chart.title}`);
                    return true;
                }
                if (chart.type === 'dashboard' && chart.dashboardId) {
                    console.log(`Attempting to load dashboard ID: ${chart.dashboardId}`);
                    return true; // Per ora teniamo tutto, gestiamo errori nell'iframe
                }
                if (chart.type === 'chart' && chart.sliceId) {
                    console.log(`Attempting to load chart ID: ${chart.sliceId}`);
                    return true;
                }
                console.warn('Invalid chart configuration:', chart);
                return false;
            });
            
            charts = [];
            validCharts.forEach(chart => {
                const dimensions = getResponsiveDimensions(chart.width, chart.height);
                chart.width = dimensions.width; 
                chart.height = dimensions.height;
                addNewChartWithData(chart);
            });
            
            if (validCharts.length > 0) {
                showNotification(`Caricati ${validCharts.length} elementi`, 'success');
                return true;
            }
        }
        return false;
    } catch (e) {
        console.error('Errore caricamento:', e);
        showNotification('Errore nel caricamento', 'error');
        
        // In caso di errore, pulisci il localStorage corrotto
        localStorage.removeItem(CONFIG.STORAGE_KEY);
        return false;
    }
}

// ==========================================
// REFRESH
// ==========================================
function refreshAllCharts() {
    const iframes = document.querySelectorAll('.dashboard-iframe');
    if (iframes.length === 0) {
        console.log('Nessun grafico da aggiornare');
        return;
    }
    
    iframes.forEach(iframe => refreshIframe(iframe));
    showNotification(`${iframes.length} grafici aggiornati!`, 'success');
}

function refreshSingleChart(chartId) {
    const card = document.getElementById(chartId);
    if (!card) return;
    const iframe = card.querySelector('.dashboard-iframe');
    if (iframe) { refreshIframe(iframe); showNotification('Grafico aggiornato!', 'success'); }
}
function refreshIframe(iframe) {
    const container = iframe.parentElement;
    const overlay = container.querySelector('.loading-overlay');
    if (overlay) overlay.style.display = 'flex';
    const originalUrl = iframe.getAttribute('data-original-url');
    const cacheBuster = `refresh=${Date.now()}`;
    const separator = originalUrl.includes('?') ? '&' : '?';
    iframe.src = originalUrl + separator + cacheBuster;
}

// ==========================================
// AUTO-REFRESH
// ==========================================
function cycleAutoRefresh() {
    if (autoRefreshInterval) { clearInterval(autoRefreshInterval); autoRefreshInterval = null; }
    const states = [
        { text: 'AUTO-REFRESH OFF', minutes: 0 },
        { text: 'AUTO-REFRESH 15 MIN', minutes: 15 },
        { text: 'AUTO-REFRESH 30 MIN', minutes: 30 },
        { text: 'AUTO-REFRESH 60 MIN', minutes: 60 }
    ];
    autoRefreshState = (autoRefreshState + 1) % states.length;
    const currentState = states[autoRefreshState];
    const btn = document.getElementById('autoRefreshBtn');
    if (btn) {
        btn.textContent = currentState.text;
        btn.className = currentState.minutes > 0 ? 'btn btn-warning' : 'btn btn-info';
    }
    if (currentState.minutes > 0) {
        autoRefreshInterval = setInterval(refreshAllCharts, currentState.minutes * 60 * 1000);
        showNotification(`Auto-refresh: ${currentState.minutes} minuti`, 'success');
    } else {
        showNotification('Auto-refresh disattivato', 'info');
    }
    saveAutoRefreshSettings();
}
function saveAutoRefreshSettings() {
    localStorage.setItem('talon_autorefresh_settings', JSON.stringify({ state: autoRefreshState }));
}
function loadAutoRefreshSettings() {
    try {
        const saved = localStorage.getItem('talon_autorefresh_settings');
        if (saved) {
            const settings = JSON.parse(saved);
            autoRefreshState = settings.state || 0;
            if (autoRefreshState > 0) { autoRefreshState--; cycleAutoRefresh(); }
        }
    } catch (e) { console.error('Errore caricamento auto-refresh:', e); }
}

// ==========================================
// UI FEEDBACK
// ==========================================
function showNotification(message, type = 'info') {
    document.querySelectorAll('.notification').forEach(n => n.remove());
    const notification = document.createElement('div');
    notification.className = `notification ${type}`; notification.textContent = message;
    const colors = { success: '#28a745', error: '#dc3545', warning: '#ffc107', info: '#17a2b8' };
    notification.style.background = colors[type] || colors.info;
    notification.style.transform = 'translateX(100%)';
    document.body.appendChild(notification);
    setTimeout(() => { notification.style.transform = 'translateX(0)'; }, 10);
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// ==========================================
// ERROR HANDLING
// ==========================================
window.addEventListener('error', function(e) {
    console.error('Errore JavaScript:', e.error);
    if (e.error && e.error.message && e.error.message.includes('interact')) {
        showNotification('Libreria interact.js non caricata', 'warning');
    }
});
// ==========================================
// CORRUPTED DATA CLEANUP
// ==========================================
function clearCorruptedDashboardData() {
    console.log('🧹 Checking for corrupted dashboard data...');
    
    try {
        const saved = localStorage.getItem(CONFIG.STORAGE_KEY);
        if (saved) {
            const data = JSON.parse(saved);
            console.log('Found saved dashboard data:', data);
            
            // Check if data contains hardcoded dashboard IDs that don't exist
            const hasCorruptedDashboards = data.some(item => 
                item.type === 'dashboard' && 
                item.dashboardId && 
                typeof item.dashboardId === 'number' && 
                item.dashboardId <= 12  // These are the hardcoded example IDs
            );
            
            if (hasCorruptedDashboards) {
                console.warn('🚨 FOUND CORRUPTED DASHBOARD DATA - FORCING CLEANUP');
                localStorage.removeItem(CONFIG.STORAGE_KEY);
                
                // Clear any other dashboard related storage
                localStorage.removeItem('talon_dashboard_layout');
                localStorage.removeItem('talon_dashboard_data');
                
                showNotification('Dashboard corrotta rilevata e rimossa automaticamente', 'warning');
                return true;
            }
        }
        
        console.log('✅ No corrupted dashboard data found');
        return false;
    } catch (e) {
        console.error('Error checking dashboard data:', e);
        // If there's any error parsing, just clear it
        localStorage.removeItem(CONFIG.STORAGE_KEY);
        localStorage.removeItem('talon_dashboard_layout');
        localStorage.removeItem('talon_dashboard_data');
        showNotification('Dati dashboard corrotti rimossi', 'info');
        return true;
    }
}

// ==========================================
// DEBUG CONTROLS
// ==========================================
function addDebugControls() {
    // Aggiungi un pulsante per resettare la dashboard se ci sono problemi
    const toolbar = document.querySelector('.toolbar');
    if (toolbar) {
        const resetBtn = document.createElement('button');
        resetBtn.className = 'btn btn-sm btn-outline-danger';
        resetBtn.innerHTML = '<i class="fas fa-trash"></i> Reset Dashboard';
        resetBtn.title = 'Rimuovi tutti i grafici salvati e resetta la dashboard';
        resetBtn.onclick = function() {
            if (confirm('Questo rimuoverà tutti i grafici salvati. Continuare?')) {
                resetDashboard();
            }
        };
        resetBtn.style.marginLeft = '10px';
        toolbar.appendChild(resetBtn);
    }
}

function resetDashboard() {
    // Pulisci localStorage
    localStorage.removeItem(CONFIG.STORAGE_KEY);
    
    // Rimuovi tutti i grafici dalla pagina
    const grid = document.getElementById('dashboard-grid');
    if (grid) {
        // Mantieni solo il pulsante "add-card"
        const addCard = grid.querySelector('.add-card');
        grid.innerHTML = '';
        if (addCard) {
            grid.appendChild(addCard);
        }
    }
    
    // Reset array charts
    charts = [];
    chartCounter = 0;
    
    showNotification('Dashboard resettata con successo', 'success');
    
    console.log('Dashboard reset completed');
}

console.log('TALON Dashboard v2.0 - Salvataggio automatico attivo');
</script>

<!-- Carica interact.js per resize -->
<script src="/external/libs/interact.min.js" defer></script>

{% endblock %}
