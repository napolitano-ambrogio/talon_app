{% extends "_base.html" %}

{% block title %}Dashboard - TALON{% endblock %}

{% block content %}

<!-- Controlli dashboard -->
<div class="dashboard-controls">
    <button onclick="refreshAllCharts()" class="btn btn-success">Aggiorna Tutti</button>
    <button onclick="cycleAutoRefresh()" class="btn btn-info" id="autoRefreshBtn">AUTO-REFRESH OFF</button>
</div>

<!-- Status Superset (nascosto di default) -->
<div id="supersetStatus" style="position: fixed; top: 70px; right: 20px; padding: 8px 12px; 
                           background: #dc3545; color: white; border-radius: 4px; 
                           font-size: 12px; z-index: 1000; display: none;">
    Non Connesso
</div>

<div id="dashboard-grid" class="dashboard-grid">
    <div class="dashboard-card add-card" onclick="addNewChart()">
        <div class="plus-icon">+</div>
    </div>
</div>

<!-- Modal Selezione Contenuti -->
<div id="contentModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Seleziona Contenuto</h2>
            <button onclick="closeContentModal()" class="modal-close">&times;</button>
        </div>
        
        <div class="modal-tabs">
            <button class="tab-button active" onclick="showTab('dashboards')">Dashboard</button>
            <button class="tab-button" onclick="showTab('charts')">Grafici</button>
        </div>
        
        <div id="dashboardsTab" class="tab-content active">
            <div class="content-grid" id="dashboardsList">
                <!-- Dashboard verranno inserite qui -->
            </div>
        </div>
        
        <div id="chartsTab" class="tab-content" style="display: none;">
            <div class="content-grid" id="chartsList">
                <!-- Grafici verranno inseriti qui -->
            </div>
        </div>
    </div>
</div>

<style>
/* Reset e layout base */
body {
    overflow-x: hidden;
}
.page-wrapper { max-width: 100%; overflow-x: hidden; }

/* Controlli dashboard */
.dashboard-controls {
    display: flex; justify-content: flex-end; align-items: center;
    gap: 10px; margin: 20px; flex-wrap: wrap;
}

/* Grid container */
#dashboard-grid {
    padding: 0 20px 20px; display: flex; flex-wrap: wrap; gap: 20px; max-width: 100%;
}

/* Cards */
.dashboard-card {
    background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    position: relative; display: inline-block; vertical-align: top;
    min-width: 300px; min-height: 200px;
}
.dashboard-card.resizable { max-width: calc(100vw - 100px); overflow: hidden; }

/* Add card */
.dashboard-card.add-card {
    width: 200px; height: 200px; display: flex; align-items: center; justify-content: center;
    cursor: pointer; border: 2px dashed #ddd; background: #f8f9fa; transition: all 0.3s ease;
}
.dashboard-card.add-card:hover { border-color: #007bff; background: #e7f3ff; }
.plus-icon { font-size: 48px; color: #6c757d; }

/* Title bar */
.chart-title {
    padding: 8px 12px; border-bottom: 1px solid #dee2e6; font-weight: 600; font-size: 14px;
    color: #495057; position: relative; display: flex; align-items: center; height: 40px;
}

/* Close button */
.close-button {
    position: absolute; top: 8px; right: 8px; background: none; border: none; font-size: 18px;
    cursor: pointer; color: #6c757d; width: 24px; height: 24px; display: flex; align-items: center;
    justify-content: center; border-radius: 50%; transition: all 0.2s;
}
.close-button:hover { background: #dc3545; color: white; }

/* Iframe */
.iframe-container { position: relative; width: 100%; height: calc(100% - 40px); overflow: hidden; }
.dashboard-iframe { width: 100%; height: 100%; border: none; display: block; }

/* Loading overlay */
.loading-overlay {
    position: absolute; inset: 0; background: rgba(255,255,255,0.9);
    display: flex; align-items: center; justify-content: center; z-index: 10;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
}

/* Modal */
.modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.5);
    display: flex; align-items: center; justify-content: center; z-index: 10000;
}
.modal-content {
    background: white; width: 90%; max-width: 900px; max-height: 80vh; border-radius: 12px;
    display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
}
.modal-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 20px; border-bottom: 1px solid #e0e0e0;
}
.modal-header h2 { margin: 0; font-size: 24px; color: #333; }
.modal-close {
    background: none; border: none; font-size: 28px; cursor: pointer; color: #999; padding: 0;
    width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
    border-radius: 50%; transition: all 0.2s;
}
.modal-close:hover { background: #f0f0f0; color: #333; }

/* Tabs */
.modal-tabs { display: flex; padding: 0 20px; background: #f8f9fa; border-bottom: 2px solid #e0e0e0; }
.tab-button {
    padding: 12px 24px; background: none; border: none; cursor: pointer; font-size: 14px; font-weight: 500;
    color: #666; position: relative; transition: all 0.3s;
}
.tab-button:hover { color: #007bff; }
.tab-button.active { color: #007bff; }
.tab-button.active::after {
    content: ''; position: absolute; bottom: -2px; left: 0; right: 0; height: 2px; background: #007bff;
}
.tab-content { flex: 1; overflow-y: auto; padding: 20px; }

/* Content Grid */
.content-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; }
.content-item {
    padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s;
    background: white;
}
.content-item:hover {
    border-color: #007bff; background: #f8f9ff; transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,123,255,0.15);
}
.content-item-icon { font-size: 24px; margin-bottom: 8px; }
.content-item-title { font-weight: 600; font-size: 14px; color: #333; margin-bottom: 4px; }
.content-item-id { font-size: 11px; color: #999; }
.content-item-type {
    display: inline-block; padding: 2px 8px; background: #e7f3ff; color: #007bff;
    font-size: 10px; border-radius: 4px; margin-top: 8px; text-transform: uppercase; font-weight: 600;
}

/* Notification */
.notification {
    position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 6px; color: white;
    font-weight: 500; z-index: 10000; max-width: 400px; word-wrap: break-word; transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* Resize handle */
.dashboard-card.resizable::after {
    content: ''; position: absolute; bottom: 0; right: 0; width: 20px; height: 20px; cursor: se-resize;
    background: linear-gradient(135deg, transparent 50%, #ccc 50%); border-bottom-right-radius: 8px;
}

/* Buttons */
.btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s; }
.btn-success { background: #28a745; color: white; } .btn-success:hover { background: #218838; }
.btn-info { background: #17a2b8; color: white; } .btn-info:hover { background: #138496; }
.btn-warning { background: #ffc107; color: #212529; } .btn-warning:hover { background: #e0a800; }
.btn-sm { padding: 4px 8px; font-size: 12px; }

/* Media */
@media (max-width: 768px) {
    .dashboard-controls { justify-content: center; margin: 10px; }
    .dashboard-controls button { font-size: 12px; padding: 5px 10px; }
    #dashboard-grid { padding: 0 10px; gap: 10px; }
    .dashboard-card.resizable { max-width: calc(100vw - 40px); width: 100% !important; }
    .content-grid { grid-template-columns: 1fr; }
    .modal-content { width: 95%; max-height: 90vh; }
}
</style>

<script>
// ==========================================
// CONFIGURAZIONE (dal backend)
// ==========================================
const CONFIG = {
    STORAGE_KEY: 'talon_dashboard_layout',
    DEFAULT_WIDTH: 600,
    DEFAULT_HEIGHT: 400,
    MIN_WIDTH: 300,
    MIN_HEIGHT: 200,
    // Preso dal context processor di app.py
    SUPERSET_BASE_URL: '{{ SUPERSET_BASE_URL }}'
};
// Flag SSO esposto dal backend (potrebbe servire in futuro per SSO completo)
const SSO_ENABLED = {{ 'true' if sso_enabled else 'false' }};

// ==========================================
// CONTENUTI DISPONIBILI
// ==========================================
const AVAILABLE_CONTENT = {
    dashboards: [
        { id: 1, title: "Dashboard Operazioni", icon: "üìä" },
        { id: 2, title: "Dashboard Statistiche", icon: "üìà" },
        { id: 3, title: "Dashboard Risorse", icon: "üí∞" },
        { id: 4, title: "Dashboard Personale", icon: "üë•" },
        { id: 5, title: "Dashboard Logistica", icon: "üöö" },
        { id: 6, title: "Dashboard Sicurezza", icon: "üîí" }
    ],
    charts: [
        { id: 1, title: "Operazioni per Mese", icon: "üìÖ" },
        { id: 2, title: "Distribuzione Risorse", icon: "üéØ" },
        { id: 3, title: "Trend Attivit√†", icon: "üìà" },
        { id: 4, title: "Personale per Reparto", icon: "üë®‚Äçüíº" },
        { id: 5, title: "Costi Operativi", icon: "üíµ" },
        { id: 6, title: "KPI Principali", icon: "üéØ" },
        { id: 7, title: "Mappa Operazioni", icon: "üó∫Ô∏è" },
        { id: 8, title: "Timeline Eventi", icon: "‚è∞" },
        { id: 9, title: "Analisi Prestazioni", icon: "‚ö°" },
        { id: 10, title: "Report Incidenti", icon: "‚ö†Ô∏è" },
        { id: 11, title: "Stato Mezzi", icon: "üöó" },
        { id: 12, title: "Consumo Carburante", icon: "‚õΩ" }
    ]
};

// ==========================================
// VARIABILI GLOBALI
// ==========================================
let chartCounter = 0;
let charts = [];
let autoRefreshInterval = null;
let autoRefreshState = 0;
let supersetAuthenticated = false;
let supersetLoginWindow = null;

// ==========================================
// INIZIALIZZAZIONE
// ==========================================
document.addEventListener('DOMContentLoaded', async () => {
    // Non forziamo pi√π HTTPS->HTTP: solo messaggio in caso di mismatch protocollo/porta
    checkEnvironmentHint();

    // Recupera stato autenticazione dalla sessione del browser
    supersetAuthenticated = sessionStorage.getItem('superset_authenticated') === 'true';
    
    // Carica layout salvato
    const hasCharts = loadLayout();
    
    // Se ci sono grafici e non siamo autenticati ‚Üí chiedi login
    if (hasCharts && !supersetAuthenticated) {
        showNotification('Autenticazione Superset richiesta per i grafici', 'info');
        setTimeout(() => { openSupersetLogin(false); }, 1000);
    } else if (hasCharts && supersetAuthenticated) {
        showNotification('Sessione Superset attiva, caricamento grafici...', 'success');
        setTimeout(() => { refreshAllCharts(); }, 1500);
    }
    
    initializeResizable();
    loadAutoRefreshSettings();
    setupWindowResize();
    populateContentModal(); // riempi il modal
});

// Solo suggerimento se in HTTPS ma Superset √® HTTP
function checkEnvironmentHint() {
    try {
        const supersetUrl = new URL(CONFIG.SUPERSET_BASE_URL);
        if (location.protocol === 'https:' && supersetUrl.protocol === 'http:') {
            console.warn('Stai usando TALON in HTTPS mentre Superset √® in HTTP. L\'iframe potrebbe essere bloccato (mixed content).');
            showNotification('Attenzione: TALON in HTTPS e Superset in HTTP potrebbero causare blocchi iframe.', 'warning');
        }
    } catch (e) {
        // ignore
    }
}

// ==========================================
// GESTIONE MODAL SELEZIONE
// ==========================================
function populateContentModal() {
    // Dashboard
    const dashboardsList = document.getElementById('dashboardsList');
    dashboardsList.innerHTML = AVAILABLE_CONTENT.dashboards.map(d => `
        <div class="content-item" onclick="selectContent('dashboard', ${d.id}, '${d.title}')">
            <div class="content-item-icon">${d.icon}</div>
            <div class="content-item-title">${d.title}</div>
            <div class="content-item-id">ID: ${d.id}</div>
            <span class="content-item-type">Dashboard</span>
        </div>
    `).join('');
    
    // Grafici
    const chartsList = document.getElementById('chartsList');
    chartsList.innerHTML = AVAILABLE_CONTENT.charts.map(c => `
        <div class="content-item" onclick="selectContent('chart', ${c.id}, '${c.title}')">
            <div class="content-item-icon">${c.icon}</div>
            <div class="content-item-title">${c.title}</div>
            <div class="content-item-id">ID: ${c.id}</div>
            <span class="content-item-type">Grafico</span>
        </div>
    `).join('');
}
function showTab(tabName) {
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
    if (tabName === 'dashboards') {
        document.querySelector('.tab-button:first-child').classList.add('active');
        document.getElementById('dashboardsTab').style.display = 'block';
    } else {
        document.querySelector('.tab-button:last-child').classList.add('active');
        document.getElementById('chartsTab').style.display = 'block';
    }
}
function openContentModal() { document.getElementById('contentModal').style.display = 'flex'; }
function closeContentModal() { document.getElementById('contentModal').style.display = 'none'; }
function selectContent(type, id, title) {
    const chartData = { type, title };
    if (type === 'dashboard') chartData.dashboardId = id; else chartData.sliceId = id;
    closeContentModal();
    addNewChartWithData(chartData);
}

// ==========================================
// GESTIONE GRAFICI
// ==========================================
function addNewChart() {
    console.log('[Dashboard] addNewChart called on main dashboard');
    
    // Check user role for permissions - same logic as dashboard_admin.js
    const userRole = window.FLASK_USER_ROLE || window.userRole || 'VISUALIZZATORE';
    const userLevel = getRoleLevel(userRole);
    
    console.log(`[Dashboard] User role: ${userRole} (level: ${userLevel})`);
    
    // Role-based functionality
    if (userLevel >= 50) { // OPERATORE or ADMIN
        console.log('[Dashboard] User has sufficient permissions, checking Superset auth...');
        
        if (!supersetAuthenticated) {
            if (sessionStorage.getItem('superset_authenticated') === 'true') {
                supersetAuthenticated = true;
                openContentModal();
            } else {
                openSupersetLogin(true);
            }
            return;
        }
        openContentModal();
    } else {
        // VISUALIZZATORE - Read only
        console.log('[Dashboard] Insufficient permissions for chart creation');
        if (window.TalonApp && window.TalonApp.showToast) {
            window.TalonApp.showToast('Solo Operatori e Amministratori possono aggiungere grafici', 'warning');
        } else {
            alert('Solo Operatori e Amministratori possono aggiungere grafici');
        }
    }
}

// Helper function for role levels (same as dashboard_admin.js)
function getRoleLevel(role) {
    const roleLevels = {
        'ADMIN': 100,
        'OPERATORE': 50,
        'VISUALIZZATORE': 10,
        'GUEST': 0
    };
    return roleLevels[role] || 0;
}
// debug auth
function resetSupersetAuth() {
    sessionStorage.removeItem('superset_authenticated');
    supersetAuthenticated = false;
    showNotification('Stato autenticazione Superset resettato', 'info');
}
function addNewChartWithData(chartData) {
    const uniqueId = chartData.id || `chart_${Date.now()}_${chartCounter++}`;
    const dimensions = getResponsiveDimensions(chartData.width, chartData.height);
    const grid = document.getElementById("dashboard-grid");
    const chartCard = createChartCard(uniqueId, chartData, dimensions.width, dimensions.height);
    grid.insertBefore(chartCard, grid.lastElementChild);
    if (!chartData.id) {
        const newChartData = { id: uniqueId, ...chartData, width: dimensions.width, height: dimensions.height };
        charts.push(newChartData);
        saveLayout();
    }
    initializeResizableElement(chartCard);
    showNotification(`${chartData.title} aggiunto!`, 'success');
}
function openSupersetLogin(forNewChart = false) {
    if (supersetLoginWindow && !supersetLoginWindow.closed) {
        supersetLoginWindow.focus(); return;
    }
    const width = 800, height = 600;
    const left = (screen.width - width) / 2, top = (screen.height - height) / 2;
    supersetLoginWindow = window.open(
        `${CONFIG.SUPERSET_BASE_URL}/login/`,
        'SupersetLogin',
        `width=${width},height=${height},left=${left},top=${top}`
    );
    if (!forNewChart) showNotification('Autenticati in Superset per visualizzare i grafici', 'info');
    const checkInterval = setInterval(() => {
        if (supersetLoginWindow.closed) {
            clearInterval(checkInterval);
            supersetAuthenticated = true;
            sessionStorage.setItem('superset_authenticated', 'true');
            supersetLoginWindow = null;
            if (forNewChart) {
                showNotification('Autenticato! Ora puoi aggiungere grafici.', 'success');
                setTimeout(openContentModal, 500);
            } else {
                showNotification('Sessione Superset attiva!', 'success');
                setTimeout(refreshAllCharts, 1000);
            }
        }
    }, 1000);
}
function createChartCard(chartId, chartData, width, height) {
    const card = document.createElement("div");
    card.classList.add("dashboard-card", "resizable");
    card.id = chartId; card.style.width = `${width}px`; card.style.height = `${height}px`;
    const titleDiv = document.createElement("div");
    titleDiv.className = "chart-title";
    titleDiv.style.background = chartData.type === 'dashboard' ? '#e3f2fd' : '#f8f9fa';
    let icon = '';
    if (chartData.type === 'dashboard') {
        const d = AVAILABLE_CONTENT.dashboards.find(x => x.id == chartData.dashboardId);
        icon = d ? d.icon : 'üìä';
    } else {
        const c = AVAILABLE_CONTENT.charts.find(x => x.id == chartData.sliceId);
        icon = c ? c.icon : 'üìà';
    }
    titleDiv.innerHTML = `${icon} ${chartData.title || 'Dashboard'}`;
    const closeBtn = document.createElement("button");
    closeBtn.innerHTML = "&times;"; closeBtn.className = "close-button";
    closeBtn.onclick = () => removeChart(chartId);
    const iframeContainer = document.createElement("div");
    iframeContainer.className = "iframe-container";
    const iframe = createIframe(chartData, chartId);
    const loadingOverlay = createLoadingOverlay();
    titleDiv.appendChild(closeBtn);
    iframeContainer.appendChild(iframe);
    iframeContainer.appendChild(loadingOverlay);
    card.appendChild(titleDiv);
    card.appendChild(iframeContainer);
    return card;
}
function createIframe(chartData, chartId) {
    const iframe = document.createElement("iframe");
    const iframeUrl = buildIframeUrl(chartData);
    iframe.src = iframeUrl; iframe.className = "dashboard-iframe"; iframe.loading = "lazy";
    iframe.setAttribute('data-original-url', iframeUrl);
    iframe.setAttribute('data-chart-id', chartId);
    iframe.setAttribute('data-chart-type', chartData.type);
    iframe.setAttribute('data-dashboard-id', chartData.dashboardId || '');
    iframe.onload = function() {
        const overlay = this.parentElement.querySelector('.loading-overlay');
        try {
            const iframeDoc = this.contentDocument || this.contentWindow.document;
            if (iframeDoc && /login/i.test(iframeDoc.body.innerHTML)) {
                if (!supersetAuthenticated) {
                    sessionStorage.removeItem('superset_authenticated');
                    supersetAuthenticated = false;
                    if (overlay) {
                        overlay.innerHTML = `
                            <div style="text-align: center; padding: 20px;">
                                <div style="font-size: 24px; margin-bottom: 8px;">üîê</div>
                                <div>Autenticazione richiesta</div>
                                <button onclick="openSupersetLogin(false)" class="btn btn-primary" style="margin-top: 10px;">
                                    Apri Login Superset
                                </button>
                            </div>
                        `;
                    }
                } else {
                    sessionStorage.removeItem('superset_authenticated');
                    supersetAuthenticated = false;
                    showNotification('Sessione Superset scaduta, riautenticazione necessaria', 'warning');
                    openSupersetLogin(false);
                }
            } else {
                if (overlay) overlay.style.display = 'none';
                // ok
            }
        } catch(e) {
            if (overlay) overlay.style.display = 'none';
        }
    };
    iframe.onerror = function() { handleIframeError(this, chartData, chartId); };
    return iframe;
}
function buildIframeUrl(chartData) {
    let url = '';
    if (chartData.type === 'dashboard') {
        url = `${CONFIG.SUPERSET_BASE_URL}/superset/dashboard/${chartData.dashboardId}/?`;
        url += 'standalone=1&show_top_bar=0&hide_nav=1&embedded=1';
        if (chartData.nativeFiltersKey) url += `&native_filters_key=${chartData.nativeFiltersKey}`;
    } else {
        url = `${CONFIG.SUPERSET_BASE_URL}/explore/?`;
        if (chartData.formDataKey) url += `form_data_key=${chartData.formDataKey}&`;
        url += `slice_id=${chartData.sliceId}`;
        url += '&standalone=1&show_tabs=false&embedded=1';
        if (chartData.dashboardPageId) url += `&dashboard_page_id=${chartData.dashboardPageId}`;
    }
    return url;
}
function createLoadingOverlay() {
    const overlay = document.createElement("div");
    overlay.className = "loading-overlay";
    overlay.innerHTML = `
        <div style="text-align: center;">
            <div style="font-size: 24px; margin-bottom: 8px;">üîÑ</div>
            <div>Caricamento...</div>
        </div>
    `;
    return overlay;
}
function handleIframeError(iframe, chartData, chartId) {
    const container = iframe.parentElement;
    const overlay = container.querySelector('.loading-overlay');
    if (overlay) overlay.style.display = 'none';
    container.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: center; height: 100%; 
                    color: #dc3545; flex-direction: column; padding: 20px; text-align: center;">
            <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
            <div>Errore nel caricamento</div>
            <p style="font-size: 12px; color: #666; margin-top: 10px;">
                Assicurati di essere autenticato in Superset
            </p>
            <button onclick="refreshSingleChart('${chartId}')" class="btn btn-sm btn-primary" style="margin-top: 10px;">
                Riprova
            </button>
        </div>
    `;
}
function removeChart(chartId) {
    if (confirm('Rimuovere questo elemento?')) {
        document.getElementById(chartId).remove();
        charts = charts.filter(chart => chart.id !== chartId);
        saveLayout();
        showNotification('Elemento rimosso!', 'success');
    }
}

// ==========================================
// DIMENSIONI RESPONSIVE
// ==========================================
function getResponsiveDimensions(requestedWidth, requestedHeight) {
    const maxWidth = window.innerWidth - 120;
    const maxHeight = window.innerHeight - 200;
    return {
        width: Math.min(requestedWidth || CONFIG.DEFAULT_WIDTH, maxWidth),
        height: Math.min(requestedHeight || CONFIG.DEFAULT_HEIGHT, maxHeight)
    };
}
function setupWindowResize() {
    let resizeTimeout;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(adjustChartsToWindow, 250);
    });
}
function adjustChartsToWindow() {
    const maxWidth = window.innerWidth - 120;
    document.querySelectorAll('.dashboard-card.resizable').forEach(card => {
        const currentWidth = parseInt(card.style.width);
        if (currentWidth > maxWidth) {
            card.style.width = `${maxWidth}px`;
            const chart = charts.find(c => c.id === card.id);
            if (chart) chart.width = maxWidth;
        }
    });
    saveLayout();
}

// ==========================================
// INTERACT.JS RESIZE
// ==========================================
function initializeResizable() {
    document.querySelectorAll('.dashboard-card.resizable').forEach(initializeResizableElement);
}
function initializeResizableElement(element) {
    if (typeof interact === 'undefined') {
        console.warn('interact.js non caricato');
        return;
    }
    const maxWidth = window.innerWidth - 120;
    const maxHeight = window.innerHeight - 200;
    interact(element).resizable({
        edges: { left: false, right: true, bottom: true, top: false },
        listeners: {
            move(event) {
                const target = event.target;
                const newWidth = Math.max(CONFIG.MIN_WIDTH, Math.min(maxWidth, event.rect.width));
                const newHeight = Math.max(CONFIG.MIN_HEIGHT, Math.min(maxHeight, event.rect.height));
                target.style.width = `${newWidth}px`;
                target.style.height = `${newHeight}px`;
                const chart = charts.find(c => c.id === target.id);
                if (chart) { chart.width = newWidth; chart.height = newHeight; }
            },
            end() {
                saveLayout();
                showNotification('Dimensioni aggiornate!', 'success');
            }
        },
        modifiers: [ interact.modifiers.restrictSize({ min: { width: CONFIG.MIN_WIDTH, height: CONFIG.MIN_HEIGHT }}) ],
        inertia: true
    });
}

// ==========================================
// STORAGE E PERSISTENZA
// ==========================================
function saveLayout() {
    try {
        localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(charts));
        console.log('Layout salvato automaticamente');
    } catch (e) {
        console.error('Errore salvataggio:', e);
        showNotification('Errore nel salvataggio automatico', 'error');
    }
}
function loadLayout() {
    try {
        const saved = localStorage.getItem(CONFIG.STORAGE_KEY);
        if (saved) {
            const loadedCharts = JSON.parse(saved);
            charts = [];
            loadedCharts.forEach(chart => {
                const dimensions = getResponsiveDimensions(chart.width, chart.height);
                chart.width = dimensions.width; chart.height = dimensions.height;
                addNewChartWithData(chart);
            });
            if (loadedCharts.length > 0) {
                showNotification(`Caricati ${loadedCharts.length} elementi`, 'success');
                return true;
            }
        }
        return false;
    } catch (e) {
        console.error('Errore caricamento:', e);
        showNotification('Errore nel caricamento', 'error');
        return false;
    }
}

// ==========================================
// REFRESH
// ==========================================
function refreshAllCharts() {
    const iframes = document.querySelectorAll('.dashboard-iframe');
    if (iframes.length === 0) { showNotification('Nessun grafico da aggiornare', 'warning'); return; }
    showNotification(`Aggiornamento ${iframes.length} grafici...`, 'info');
    iframes.forEach((iframe, index) => { setTimeout(() => refreshIframe(iframe), index * 200); });
}
function refreshSingleChart(chartId) {
    const card = document.getElementById(chartId);
    if (!card) return;
    const iframe = card.querySelector('.dashboard-iframe');
    if (iframe) { refreshIframe(iframe); showNotification('Grafico aggiornato!', 'success'); }
}
function refreshIframe(iframe) {
    const container = iframe.parentElement;
    const overlay = container.querySelector('.loading-overlay');
    if (overlay) overlay.style.display = 'flex';
    const originalUrl = iframe.getAttribute('data-original-url');
    const cacheBuster = `refresh=${Date.now()}`;
    const separator = originalUrl.includes('?') ? '&' : '?';
    iframe.src = originalUrl + separator + cacheBuster;
}

// ==========================================
// AUTO-REFRESH
// ==========================================
function cycleAutoRefresh() {
    if (autoRefreshInterval) { clearInterval(autoRefreshInterval); autoRefreshInterval = null; }
    const states = [
        { text: 'AUTO-REFRESH OFF', minutes: 0 },
        { text: 'AUTO-REFRESH 15 MIN', minutes: 15 },
        { text: 'AUTO-REFRESH 30 MIN', minutes: 30 },
        { text: 'AUTO-REFRESH 60 MIN', minutes: 60 }
    ];
    autoRefreshState = (autoRefreshState + 1) % states.length;
    const currentState = states[autoRefreshState];
    const btn = document.getElementById('autoRefreshBtn');
    if (btn) {
        btn.textContent = currentState.text;
        btn.className = currentState.minutes > 0 ? 'btn btn-warning' : 'btn btn-info';
    }
    if (currentState.minutes > 0) {
        autoRefreshInterval = setInterval(refreshAllCharts, currentState.minutes * 60 * 1000);
        showNotification(`Auto-refresh: ${currentState.minutes} minuti`, 'success');
    } else {
        showNotification('Auto-refresh disattivato', 'info');
    }
    saveAutoRefreshSettings();
}
function saveAutoRefreshSettings() {
    localStorage.setItem('talon_autorefresh_settings', JSON.stringify({ state: autoRefreshState }));
}
function loadAutoRefreshSettings() {
    try {
        const saved = localStorage.getItem('talon_autorefresh_settings');
        if (saved) {
            const settings = JSON.parse(saved);
            autoRefreshState = settings.state || 0;
            if (autoRefreshState > 0) { autoRefreshState--; cycleAutoRefresh(); }
        }
    } catch (e) { console.error('Errore caricamento auto-refresh:', e); }
}

// ==========================================
// UI FEEDBACK
// ==========================================
function showNotification(message, type = 'info') {
    document.querySelectorAll('.notification').forEach(n => n.remove());
    const notification = document.createElement('div');
    notification.className = `notification ${type}`; notification.textContent = message;
    const colors = { success: '#28a745', error: '#dc3545', warning: '#ffc107', info: '#17a2b8' };
    notification.style.background = colors[type] || colors.info;
    notification.style.transform = 'translateX(100%)';
    document.body.appendChild(notification);
    setTimeout(() => { notification.style.transform = 'translateX(0)'; }, 10);
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// ==========================================
// ERROR HANDLING
// ==========================================
window.addEventListener('error', function(e) {
    console.error('Errore JavaScript:', e.error);
    if (e.error && e.error.message && e.error.message.includes('interact')) {
        showNotification('Libreria interact.js non caricata', 'warning');
    }
});
console.log('TALON Dashboard v2.0 - Salvataggio automatico attivo');
</script>

<!-- Carica interact.js per resize -->
<script src="/external/libs/interact.min.js" defer></script>

{% endblock %}
