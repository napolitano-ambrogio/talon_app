{% extends "_base.html" %}

{% block title %}Dettaglio Attività #{{ attivita.id }} - TALON{% endblock %}

{% block head %}
<!-- CSS specifico per visualizzazione attività -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/attivita/visualizza_attivita.css') }}?v={{ cache_buster }}">
<!-- JavaScript per decodifica vettore GETRA -->
<script src="{{ url_for('static', filename='js/attivita/vettore_decoder.js') }}?v={{ cache_buster }}"></script>
{% endblock %}

{% block content %}
<div class="detail-card">
    <div class="detail-header">
        <div>
            <h3>{{ attivita.tipologia_nome }}</h3>
            {% if attivita.data_inizio and (not attivita.data_fine or attivita.data_inizio == attivita.data_fine) %}
                {# Attività di un solo giorno #}
                {% if attivita.data_inizio < today %}
                    {% set status_text = 'CONCLUSA' %}
                    {% set status_color = '#6c757d' %}
                {% elif attivita.data_inizio > today %}
                    {% set status_text = 'PIANIFICATA' %}
                    {% set status_color = '#17a2b8' %}
                {% else %}
                    {% set status_text = 'IN CORSO' %}
                    {% set status_color = '#ffc107' %}
                {% endif %}
            {% elif attivita.data_inizio and attivita.data_fine %}
                {# Attività di più giorni #}
                {% if attivita.data_fine < today %}
                    {% set status_text = 'CONCLUSA' %}
                    {% set status_color = '#6c757d' %}
                {% elif attivita.data_inizio <= today and attivita.data_fine >= today %}
                    {% set status_text = 'ATTIVA' %}
                    {% set status_color = '#28a745' %}
                {% elif attivita.data_inizio > today %}
                    {% set status_text = 'PIANIFICATA' %}
                    {% set status_color = '#17a2b8' %}
                {% else %}
                    {% set status_text = 'ATTIVA' %}
                    {% set status_color = '#28a745' %}
                {% endif %}
            {% else %}
                {# Fallback per attività senza date chiare #}
                {% set status_text = 'ATTIVA' %}
                {% set status_color = '#28a745' %}
            {% endif %}
            <p style="color: {{ status_color }}; font-weight: bold; margin: 5px 0 0 0; font-size: 0.9em;">{{ status_text }}</p>
        </div>
        <a href="{{ url_for('attivita.lista_attivita') }}" class="cancel-link" style="font-size: 0.9em;">&larr; Torna all'Elenco</a>
    </div>

    <dl class="detail-grid">
        <div>
            <div class="detail-item">
                <dt>Ente Svolgimento</dt>
                <dd>{{ attivita.ente_nome }}</dd>
            </div>
            <div class="detail-item">
                <dt>Data Inizio</dt>
                <dd>{{ attivita.data_inizio.strftime('%d/%m/%Y') if attivita.data_inizio else 'Non specificata' }}</dd>
            </div>
            <div class="detail-item">
                <dt>Data Fine</dt>
                <dd>
                    {% if attivita.data_fine %}
                        {{ attivita.data_fine.strftime('%d/%m/%Y') }}
                        {% if attivita.data_inizio and attivita.data_fine != attivita.data_inizio %}
                            <span class="text-muted">({{ (attivita.data_fine - attivita.data_inizio).days + 1 }} giorni)</span>
                        {% elif attivita.data_inizio and attivita.data_fine == attivita.data_inizio %}
                            <span class="text-muted">(1 giorno)</span>
                        {% endif %}
                    {% elif attivita.data_inizio %}
                        {{ attivita.data_inizio.strftime('%d/%m/%Y') }}
                        <span class="text-muted">(1 giorno)</span>
                    {% else %}
                        <span class="text-muted">Non specificata</span>
                    {% endif %}
                </dd>
            </div>
            <div class="detail-item">
                <dt>Operazione</dt>
                <dd>{{ attivita.operazione_nome if attivita.operazione_nome else 'Nessuna operazione associata' }}</dd>
            </div>
        </div>
        <div>
            <div class="detail-item">
                <dt>Luogo Partenza</dt>
                <dd>{{ partenza if partenza else 'Non specificato' }}</dd>
            </div>
            <div class="detail-item">
                <dt>Luogo Destinazione</dt>
                <dd>{{ destinazione if destinazione else 'Non specificato' }}</dd>
            </div>
            <div class="detail-item">
                <dt>Descrizione</dt>
                <dd>{{ attivita.descrizione if attivita.descrizione else 'Nessuna descrizione disponibile' }}</dd>
            </div>
        </div>
    </dl>

    <hr style="margin-top: 30px; margin-bottom: 20px;">
    
    <h4 style="margin-bottom: 15px; color: #495057;">Personale Impiegato</h4>
    <dl class="detail-grid">
        <div>
            <div class="detail-item">
                <dt>Ufficiali</dt>
                <dd>{{ attivita.personale_ufficiali or 0 }}</dd>
            </div>
            <div class="detail-item">
                <dt>Sottufficiali</dt>
                <dd>{{ attivita.personale_sottufficiali or 0 }}</dd>
            </div>
        </div>
        <div>
            <div class="detail-item">
                <dt>Graduati/VFP</dt>
                <dd>{{ attivita.personale_graduati or 0 }}</dd>
            </div>
            <div class="detail-item">
                <dt>Civili</dt>
                <dd>{{ attivita.personale_civili or 0 }}</dd>
            </div>
        </div>
    </dl>

    {% if dettagli_specifici %}
    <hr style="margin-top: 30px; margin-bottom: 20px;">
    
    <h4 style="margin-bottom: 15px; color: #495057;">Dettagli Specifici</h4>
    <dl class="detail-grid">
        <div>
            {# Gestione GETRA - Vettore combinato #}
            {% if dettagli_specifici.tipo_vettore or dettagli_specifici.seriale_vettore %}
            <div class="detail-item">
                <dt>Vettore</dt>
                <dd>
                    {% if dettagli_specifici.tipo_vettore %}{{ dettagli_specifici.tipo_vettore }}{% endif %}
                    {% if dettagli_specifici.tipo_vettore and dettagli_specifici.seriale_vettore %} {% endif %}
                    {% if dettagli_specifici.seriale_vettore %}{{ dettagli_specifici.seriale_vettore }}{% endif %}
                    {% if dettagli_specifici.tipo_vettore %}
                    <div class="vettore-decoded" id="vettore-decode-{{ dettagli_specifici.tipo_vettore }}" style="font-size: 0.85em; margin-top: 5px; color: #6c757d;">
                        <span class="decode-eng"></span><br>
                        <span class="decode-ita"></span>
                    </div>
                    {% endif %}
                </dd>
            </div>
            {% endif %}

            {# Altri dettagli prima colonna #}
            {% for key, value in dettagli_specifici.items() %}
            {% if value and key != 'id' and key != 'attivita_id' and key != 'data_creazione' and key != 'creato_da' 
               and key != 'tipo_vettore' and key != 'seriale_vettore' and key != 'volume' and key != 'unita_di_misura' %}
                {% if loop.index <= ((dettagli_specifici|length) // 2) %}
                <div class="detail-item">
                    <dt>{{ key.replace('_', ' ').title() }}</dt>
                    <dd>{{ value }}</dd>
                </div>
                {% endif %}
            {% endif %}
            {% endfor %}
        </div>
        <div>
            {# Gestione GETRA - Volume combinato #}
            {% if dettagli_specifici.volume or dettagli_specifici.unita_di_misura %}
            <div class="detail-item">
                <dt>Volume</dt>
                <dd>
                    {% if dettagli_specifici.volume %}{{ dettagli_specifici.volume }}{% endif %}
                    {% if dettagli_specifici.volume and dettagli_specifici.unita_di_misura %} {% endif %}
                    {% if dettagli_specifici.unita_di_misura %}{{ dettagli_specifici.unita_di_misura }}{% endif %}
                </dd>
            </div>
            {% endif %}

            {# Altri dettagli seconda colonna #}
            {% for key, value in dettagli_specifici.items() %}
            {% if value and key != 'id' and key != 'attivita_id' and key != 'data_creazione' and key != 'creato_da' 
               and key != 'tipo_vettore' and key != 'seriale_vettore' and key != 'volume' and key != 'unita_di_misura' %}
                {% if loop.index > ((dettagli_specifici|length) // 2) %}
                <div class="detail-item">
                    <dt>{{ key.replace('_', ' ').title() }}</dt>
                    <dd>{{ value }}</dd>
                </div>
                {% endif %}
            {% endif %}
            {% endfor %}
        </div>
    </dl>
    {% endif %}

    {% if attivita.note %}
    <hr style="margin-top: 30px; margin-bottom: 20px;">
    
    <h4 style="margin-bottom: 15px; color: #495057;">Note</h4>
    <div class="detail-item">
        <dd>{{ attivita.note }}</dd>
    </div>
    {% endif %}

    <hr style="margin-top: 30px; margin-bottom: 20px;">

    <div style="display: flex; justify-content: flex-end; align-items: center; gap: 10px;">
        {% if can_edit %}
        <a href="{{ url_for('attivita.modifica_attivita_form', id=attivita.id) }}" style="background-color: #007bff; color: white; padding: 10px 20px; border-radius: 5px; text-transform: uppercase; font-weight: bold; font-size: 0.9em; text-decoration: none;">Modifica</a>
        {% endif %}
        
        {% if can_delete %}
        <form action="#" method="POST" onsubmit="return confirm('Confermare l\'eliminazione dell\'attività?');" style="margin: 0;">
            <button type="submit" style="background-color: #d9534f; color: white; padding: 10px 20px; border: none; cursor: pointer; border-radius: 5px; text-transform: uppercase; font-weight: bold; font-size: 0.9em;">Elimina</button>
        </form>
        {% endif %}
        
        <button type="button" onclick="window.print()" style="background-color: #6c757d; color: white; padding: 10px 20px; border: none; cursor: pointer; border-radius: 5px; text-transform: uppercase; font-weight: bold; font-size: 0.9em;">Stampa</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Decodifica automatica del vettore GETRA - versione inline
document.addEventListener('DOMContentLoaded', function() {
    {% if dettagli_specifici.tipo_vettore %}
    
    // Decodifiche inline per i vettori più comuni
    const vettoreDecodes = {
        'SAFOPS': {
            eng: 'Sourced - Air Force - Operations',
            ita: 'Pianificata - Aeronautica Militare - Operazioni'
        },
        'UAFOPS': {
            eng: 'Unsourced - Air Force - Operations', 
            ita: 'Non Pianificata - Aeronautica Militare - Operazioni'
        },
        'SAFEXE': {
            eng: 'Sourced - Air Force - Exercises',
            ita: 'Pianificata - Aeronautica Militare - Esercitazioni'
        },
        'SAHA': {
            eng: 'Sourced - Army - Humanitarian Aid',
            ita: 'Pianificata - Esercito - Aiuti Umanitari'
        },
        'SNOPS': {
            eng: 'Sourced - Navy - Operations',
            ita: 'Pianificata - Marina Militare - Operazioni'
        },
        'SCCOPS': {
            eng: 'Sourced - Commercial Cargo - Operations',
            ita: 'Pianificata - Cargo Commerciale - Operazioni'
        }
    };
    
    const tipoVettore = '{{ dettagli_specifici.tipo_vettore }}';
    const decoded = vettoreDecodes[tipoVettore];
    
    if (decoded) {
        const container = document.getElementById('vettore-decode-{{ dettagli_specifici.tipo_vettore }}');
        if (container) {
            const engSpan = container.querySelector('.decode-eng');
            const itaSpan = container.querySelector('.decode-ita');
            
            if (engSpan) engSpan.textContent = decoded.eng;
            if (itaSpan) itaSpan.textContent = decoded.ita;
            
            container.style.display = 'block';
        }
    } else {
        // Nascondi se non decodificabile
        const container = document.getElementById('vettore-decode-{{ dettagli_specifici.tipo_vettore }}');
        if (container) {
            container.style.display = 'none';
        }
    }
    {% endif %}
});
</script>
{% endblock %}