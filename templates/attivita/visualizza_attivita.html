{% extends "shared/_base.html" %}

{% block title %}Dettaglio {{ attivita.tipologia_nome }} - TALON{% endblock %}

{% block additional_css %}
<!-- CSS specifico per visualizzazione attività -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/attivita/visualizza_attivita.css') }}?v={{ cache_buster }}">
{% endblock %}

{% block page_title %}
Dettaglio {{ attivita.tipologia_nome }}
{# Calcolo dello status per l'header - stesso codice del body #}
{% if attivita.data_inizio and (not attivita.data_fine or attivita.data_inizio == attivita.data_fine) %}
    {# Attività di un solo giorno #}
    {% if attivita.data_inizio < today %}
        {% set header_status_text = 'CONCLUSA' %}
        {% set header_status_class = 'header-status-conclusa' %}
    {% elif attivita.data_inizio > today %}
        {% set header_status_text = 'PIANIFICATA' %}
        {% set header_status_class = 'header-status-pianificata' %}
    {% else %}
        {% set header_status_text = 'IN CORSO' %}
        {% set header_status_class = 'header-status-in-corso' %}
    {% endif %}
{% elif attivita.data_inizio and attivita.data_fine %}
    {# Attività di più giorni #}
    {% if attivita.data_fine < today %}
        {% set header_status_text = 'CONCLUSA' %}
        {% set header_status_class = 'header-status-conclusa' %}
    {% elif attivita.data_inizio <= today and attivita.data_fine >= today %}
        {% set header_status_text = 'ATTIVA' %}
        {% set header_status_class = 'header-status-attiva' %}
    {% elif attivita.data_inizio > today %}
        {% set header_status_text = 'PIANIFICATA' %}
        {% set header_status_class = 'header-status-pianificata' %}
    {% else %}
        {% set header_status_text = 'ATTIVA' %}
        {% set header_status_class = 'header-status-attiva' %}
    {% endif %}
{% else %}
    {# Fallback per attività senza date chiare #}
    {% set header_status_text = 'ATTIVA' %}
    {% set header_status_class = 'header-status-attiva' %}
{% endif %}
<span class="header-status-badge {{ header_status_class }}">{{ header_status_text }}</span>
{% endblock %}

{% block page_controls %}
{% if from_drilldown %}
<a href="{{ url_for('main.dashboard') }}#drilldown-restore" 
   class="btn btn-secondary" 
   id="back-to-drilldown-btn">
    <i class="fas fa-arrow-left"></i> Torna al Dashboard
</a>
{% else %}
<a href="{{ url_for('attivita.lista_attivita') }}" class="btn btn-secondary">
    <i class="fas fa-arrow-left"></i> Torna all'Elenco
</a>
{% endif %}
{% if can_edit %}
<a href="{{ url_for('attivita.modifica_attivita_form', id=attivita.id) }}" class="btn btn-primary">
    <i class="fas fa-edit"></i> Modifica
</a>
{% endif %}
{% if can_delete %}
<form action="{{ url_for('attivita.elimina_attivita', id=attivita.id) }}" method="POST" onsubmit="return confirm('Confermare l\'eliminazione dell\'attività?');" style="display: inline;">
    <button type="submit" class="btn btn-danger">
        <i class="fas fa-trash"></i> Elimina
    </button>
</form>
{% endif %}
{% endblock %}

{% block content %}
<main class="dashboard__content-wrapper" role="main">
    <section class="dashboard__scroll-content" aria-label="Contenuto principale dettaglio attivita">
        <div class="detail-card">

            <!-- Informazioni generali - Layout responsive a colonne -->
            <div class="info-section">
                <h3 class="section-title">
                    INFORMAZIONI GENERALI
                    <div class="badges-container">
                        {% if attivita.modalita_effettuazione == 'ordinaria' %}
                            <span class="modalita-badge modalita-badge-ordinaria">Attività ordinaria</span>
                        {% elif attivita.modalita_effettuazione == 'squadra_contatto_nazionale' %}
                            <span class="modalita-badge modalita-badge-nazionale">Squadra a Contatto su Territorio Nazionale</span>
                        {% elif attivita.modalita_effettuazione == 'squadra_contatto_teatro' %}
                            <span class="modalita-badge modalita-badge-teatro">Squadra a Contatto in Teatro Operativo</span>
                        {% endif %}
                        
                        {# Badge SAC Pianificazione - Solo per squadre a contatto #}
                        {% if attivita.modalita_effettuazione in ['squadra_contatto_nazionale', 'squadra_contatto_teatro'] %}
                            {% if attivita.sac_pianificata == true %}
                                <span class="sac-badge sac-badge-pianificata">Pianificata</span>
                            {% elif attivita.sac_pianificata == false %}
                                <span class="sac-badge sac-badge-non-pianificata">Non Pianificata</span>
                            {% endif %}
                        {% endif %}
                    </div>
                </h3>
                <div class="info-grid-container">
                    <!-- Prima riga: Ente, Descrizione, Operazione, Esercitazione -->
                    <div class="info-row info-row-first">
                        <div class="grid-item">
                            <dt>Ente Svolgimento</dt>
                            <dd>{{ attivita.ente_nome }}</dd>
                        </div>
                        <div class="grid-item grid-item-description">
                            <dt>Descrizione</dt>
                            <dd>{{ attivita.descrizione if attivita.descrizione else 'Nessuna descrizione disponibile' }}</dd>
                        </div>
                        <div class="grid-item">
                            <dt>Operazione</dt>
                            <dd>{{ attivita.operazione_nome if attivita.operazione_nome else 'NAZIONALE' }}</dd>
                        </div>
                        <div class="grid-item">
                            <dt>Esercitazione</dt>
                            <dd>{{ attivita.esercitazione_nome if attivita.esercitazione_nome else 'NON SPECIFICATA' }}</dd>
                        </div>
                    </div>
                    
                    <!-- Seconda riga: Date e Luoghi -->
                    <div class="info-row info-row-second">
                        <div class="grid-item">
                            <dt>Data Inizio</dt>
                            <dd>{{ attivita.data_inizio.strftime('%d/%m/%Y') if attivita.data_inizio else 'Non specificata' }}</dd>
                        </div>
                        <div class="grid-item">
                            <dt>Data Fine</dt>
                            <dd>
                                {% if attivita.data_fine %}
                                    {{ attivita.data_fine.strftime('%d/%m/%Y') }}
                                    {% if attivita.data_inizio and attivita.data_fine != attivita.data_inizio %}
                                        <span class="text-muted">({{ (attivita.data_fine - attivita.data_inizio).days + 1 }} giorni)</span>
                                    {% elif attivita.data_inizio and attivita.data_fine == attivita.data_inizio %}
                                        <span class="text-muted">(1 giorno)</span>
                                    {% endif %}
                                {% elif attivita.data_inizio %}
                                    {{ attivita.data_inizio.strftime('%d/%m/%Y') }}
                                    <span class="text-muted">(1 giorno)</span>
                                {% else %}
                                    <span class="text-muted">Non specificata</span>
                                {% endif %}
                            </dd>
                        </div>
                        <div class="grid-item">
                            <dt>Luogo Partenza</dt>
                            <dd>{{ (partenza if partenza else 'NON SPECIFICATO') | upper }}</dd>
                        </div>
                        <div class="grid-item">
                            <dt>Luogo Destinazione</dt>
                            <dd>{{ (destinazione if destinazione else 'NON SPECIFICATO') | upper }}</dd>
                        </div>
                    </div>
                </div>
            </div>

            {% if (attivita.personale_ufficiali and attivita.personale_ufficiali > 0) or (attivita.personale_sottufficiali and attivita.personale_sottufficiali > 0) or (attivita.personale_graduati and attivita.personale_graduati > 0) or (attivita.personale_civili and attivita.personale_civili > 0) %}
            <!-- Personale impiegato -->
            <div class="info-section">
                <h3 class="section-title">PERSONALE IMPIEGATO</h3>
                <div class="info-grid-container">
                    <div class="info-row personnel-single-row">
                        <div class="grid-item">
                            <dt>Ufficiali</dt>
                            <dd>{{ attivita.personale_ufficiali or 0 }}</dd>
                        </div>
                        <div class="grid-item">
                            <dt>Sottufficiali</dt>
                            <dd>{{ attivita.personale_sottufficiali or 0 }}</dd>
                        </div>
                        <div class="grid-item">
                            <dt>Graduati/VFP</dt>
                            <dd>{{ attivita.personale_graduati or 0 }}</dd>
                        </div>
                        <div class="grid-item">
                            <dt>Civili</dt>
                            <dd>{{ attivita.personale_civili or 0 }}</dd>
                        </div>
                        <div class="grid-item">
                            <dt>Totale Personale</dt>
                            <dd><strong>{{ (attivita.personale_ufficiali or 0) + (attivita.personale_sottufficiali or 0) + (attivita.personale_graduati or 0) + (attivita.personale_civili or 0) }}</strong></dd>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if dettagli_specifici %}
                {% set has_valid_fields = namespace(value=false) %}
                {% for key, value in dettagli_specifici.items() %}
                    {% if value and value != '' and key not in ['id', 'attivita_id', 'data_creazione', 'data_modifica', 'created_at', 'updated_at', 'deleted_at', 'creato_da', 'modificato_da', 'creato_il', 'modificato_il', 'created_by', 'updated_by', 'unita_di_misura', 'seriale_vettore'] %}
                        {% set has_valid_fields.value = true %}
                    {% endif %}
                {% endfor %}
                
                {% if has_valid_fields.value %}
                <!-- Dettagli specifici -->
                <div class="info-section">
                    <h3 class="section-title">DETTAGLI SPECIFICI</h3>
                    <div class="responsive-grid details-grid">
                            <!-- Gestione dinamica dei dettagli basata sul tipo attività -->
                            {% for key, value in dettagli_specifici.items() %}
                                {% if value and value != '' and key not in ['id', 'attivita_id', 'data_creazione', 'data_modifica', 'created_at', 'updated_at', 'deleted_at', 'creato_da', 'modificato_da', 'creato_il', 'modificato_il', 'created_by', 'updated_by', 'unita_di_misura', 'seriale_vettore'] %}
                                    <div class="grid-item {% if key in ['descrizione_esercitazione', 'descrizione', 'motivo_sgombero'] %}grid-item-wide{% endif %}">
                                        <dt>
                                            {% if key == 'tipo_vettore' %}Tipo Vettore
                                            {% elif key == 'seriale_vettore' %}Seriale Vettore
                                            {% elif key == 'numero_personale' %}Numero Personale
                                            {% elif key == 'numero_mezzi' %}Numero Mezzi
                                            {% elif key == 'volume' %}Volume
                                            {% elif key == 'nome_esercitazione' %}Nome Esercitazione
                                            {% elif key == 'tipo_esercitazione' %}Tipo Esercitazione
                                            {% elif key == 'descrizione_esercitazione' %}Descrizione
                                            {% elif key == 'nome_corso' %}Nome Corso
                                            {% elif key == 'tipo_formazione' %}Tipo Formazione
                                            {% elif key == 'tipo_training' %}Tipo Training
                                            {% elif key == 'num_interventi' %}Numero Interventi
                                            {% elif key == 'a_favore' %}A Favore di
                                            {% elif key == 'tipo_intervento' %}Tipo Intervento
                                            {% elif key == 'priorita' %}Priorità
                                            {% elif key == 'motivo_sgombero' %}Motivo Sgombero
                                            {% elif key == 'forza_armata' %}Forza Armata
                                            {% elif key == 'num_unita' %}Numero Unità
                                            {% elif key == 'grado' %}Grado
                                            {% elif key == 'ente_appartenenza' %}Ente di Appartenenza
                                            {% elif key == 'trasporto_a_cura' %}Trasporto a Cura di
                                            {% elif key == 'attivita_svolta' %}Attività Svolta
                                            {% elif key == 'piattaforma_materiale' %}Piattaforma/Materiale
                                            {% elif key == 'tipologia_rifornimento' %}Tipologia Rifornimento
                                            {% elif key == 'dettaglio_materiale' %}Dettaglio Materiale
                                            {% elif key == 'quantita' %}Quantità
                                            {% elif key == 'unita_di_misura' %}Unità di Misura
                                            {% elif key == 'tipologia_carico' %}Tipologia Carico
                                            {% elif key == 'mezzo_impiegato' %}Mezzo Impiegato
                                            {% else %}{{ key|title }}{% endif %}
                                        </dt>
                                        <dd>
                                            {% if key == 'tipo_vettore' and dettagli_specifici.seriale_vettore %}
                                                {{ value }} {{ dettagli_specifici.seriale_vettore }}
                                                <div class="vettore-decoded" id="vettore-decode-{{ value }}" style="font-size: 0.85em; margin-top: 5px; color: #6c757d;">
                                                    <span class="decode-eng"></span><br>
                                                    <span class="decode-ita"></span>
                                                </div>
                                            {% elif key == 'quantita' and dettagli_specifici.unita_di_misura %}
                                                {{ value|int }} {{ dettagli_specifici.unita_di_misura }}
                                            {% elif key == 'volume' and dettagli_specifici.unita_di_misura %}
                                                {{ value }} {{ dettagli_specifici.unita_di_misura }}
                                            {% elif key not in ['seriale_vettore', 'unita_di_misura'] %}
                                                {{ value }}
                                            {% endif %}
                                        </dd>
                                    </div>
                                {% endif %}
                            {% endfor %}
                    </div>
                </div>
                {% endif %}
            {% endif %}

            {% if attivita.note %}
            <!-- Note -->
            <div class="info-section">
                <h3 class="section-title">NOTE</h3>
                <div class="note-content">
                    {{ attivita.note }}
                </div>
            </div>
            {% endif %}
        </div>
        
    </section>
</main>
{% endblock %}

{% block additional_js %}
<!-- JavaScript per decodifica vettore GETRA -->
<script src="{{ url_for('static', filename='js/attivita/vettore_decoder.js') }}?v={{ cache_buster }}"></script>
<script>
// Decodifica automatica del vettore GETRA - versione inline
document.addEventListener('DOMContentLoaded', function() {
    {% if dettagli_specifici.tipo_vettore %}
    
    // Decodifiche inline per i vettori più comuni
    const vettoreDecodes = {
        'SAFOPS': {
            eng: 'Sourced - Air Force - Operations',
            ita: 'Pianificata - Aeronautica Militare - Operazioni'
        },
        'UAFOPS': {
            eng: 'Unsourced - Air Force - Operations', 
            ita: 'Non Pianificata - Aeronautica Militare - Operazioni'
        },
        'SAFEXE': {
            eng: 'Sourced - Air Force - Exercises',
            ita: 'Pianificata - Aeronautica Militare - Esercitazioni'
        },
        'SAHA': {
            eng: 'Sourced - Army - Humanitarian Aid',
            ita: 'Pianificata - Esercito - Aiuti Umanitari'
        },
        'SNOPS': {
            eng: 'Sourced - Navy - Operations',
            ita: 'Pianificata - Marina Militare - Operazioni'
        },
        'SCCOPS': {
            eng: 'Sourced - Commercial Cargo - Operations',
            ita: 'Pianificata - Cargo Commerciale - Operazioni'
        }
    };
    
    const tipoVettore = '{{ dettagli_specifici.tipo_vettore }}';
    const decoded = vettoreDecodes[tipoVettore];
    
    if (decoded) {
        const container = document.getElementById('vettore-decode-{{ dettagli_specifici.tipo_vettore }}');
        if (container) {
            const engSpan = container.querySelector('.decode-eng');
            const itaSpan = container.querySelector('.decode-ita');
            
            if (engSpan) engSpan.textContent = decoded.eng;
            if (itaSpan) itaSpan.textContent = decoded.ita;
            
            container.style.display = 'block';
        }
    } else {
        // Nascondi se non decodificabile
        const container = document.getElementById('vettore-decode-{{ dettagli_specifici.tipo_vettore }}');
        if (container) {
            container.style.display = 'none';
        }
    }
    {% endif %}
});

{% if from_drilldown %}
// Script per ricostruzione stato drilldown
document.getElementById('back-to-drilldown-btn').addEventListener('click', function(e) {
    e.preventDefault();
    
    // Stato drilldown incorporato direttamente nel JavaScript
    const drilldownState = {{ drilldown_state | tojson | safe }};
    
    // Salva stato nel sessionStorage per recuperarlo nella dashboard
    sessionStorage.setItem('drilldown_restore_state', JSON.stringify(drilldownState));
    
    // Naviga verso dashboard
    window.location.href = this.href;
});
{% endif %}
</script>
{% endblock %}