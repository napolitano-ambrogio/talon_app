{% extends "shared/_base.html" %}

{% block title %}Nuova Attività - TALON{% endblock %}

{% block additional_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/advanced-table.css') }}?v=1.0">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/attivita-inserisci-styles.css') }}?v={{ cache_buster }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/slim-searchable-select.css') }}?v={{ cache_buster }}">
{% endblock %}

{% block extra_css %}
<style>
/* ===== CSS PERSONALIZZAZIONI ATTIVITA TEMPLATE ===== */

/* Integrazione con form-group esistenti */
.form-group .talon-slim-select {
    margin-top: 5px;
}

/* ===== TOGGLE SLIDER MODALITÀ ===== */
.modalita-toggle-slider {
    margin-top: 10px;
    width: 100%;
    max-width: none; /* Rimuovi max-width per utilizzare tutta la larghezza del form-control */
}

.slider-track {
    position: relative;
    display: flex;
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 4px;
    height: 60px;
}

.slider-indicator {
    position: absolute;
    top: 4px;
    left: 4px;
    width: calc(33.333% - 4px);
    height: calc(100% - 8px);
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%); /* Default verde */
    border-radius: 8px;
    transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    z-index: 1;
    box-shadow: 0 2px 8px rgba(40, 167, 69, 0.4);
}

.slider-option {
    position: relative;
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: transparent;
    border: none;
    cursor: pointer;
    z-index: 2;
    transition: all 0.2s ease;
    border-radius: 8px;
    padding: 8px 12px;
}

.slider-option:hover {
    transform: scale(1.02);
}

.slider-option.active {
    color: white;
}

.slider-option:not(.active) {
    color: #6c757d;
}

.option-text {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    line-height: 1.2;
    margin-bottom: 2px;
    letter-spacing: 0.3px;
}

.option-desc {
    font-size: 9px;
    font-weight: 400;
    line-height: 1.1;
    opacity: 0.85;
}

/* Posizioni e colori indicator per le tre modalità */
.modalita-toggle-slider[data-active="ordinaria"] .slider-indicator {
    transform: translateX(0);
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%); /* Verde per Missione Ordinaria */
    box-shadow: 0 2px 8px rgba(40, 167, 69, 0.4);
}

.modalita-toggle-slider[data-active="squadra_contatto_nazionale"] .slider-indicator {
    transform: translateX(calc(100% + 4px));
    background: linear-gradient(135deg, #007bff 0%, #6610f2 100%); /* Blu per Squadra Nazionale */
    box-shadow: 0 2px 8px rgba(0, 123, 255, 0.4);
}

.modalita-toggle-slider[data-active="squadra_contatto_teatro"] .slider-indicator {
    transform: translateX(calc(200% + 8px));
    background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%); /* Rosso/Arancione per Teatro Operativo */
    box-shadow: 0 2px 8px rgba(220, 53, 69, 0.4);
}

/* Responsive */
@media (max-width: 576px) {
    .slider-track {
        height: 50px;
        border-radius: 10px;
    }
    
    .option-text {
        font-size: 10px;
    }
    
    .option-desc {
        font-size: 8px;
    }
    
    .slider-option {
        padding: 6px 8px;
    }
}

/* Accessibility */
.slider-option:focus {
    outline: 2px solid #667eea;
    outline-offset: 2px;
}

/* ===== SAC TOGGLE SLIDER - DUE POSIZIONI ===== */
.sac-toggle-slider {
    margin-top: 10px;
    width: 100%;
    max-width: none; /* Stessa larghezza del toggle modalità */
}

.sac-slider-track {
    position: relative;
    background: #e9ecef;
    border-radius: 12px;
    padding: 4px;
    display: grid;
    grid-template-columns: 1fr 1fr; /* Due colonne uguali */
    gap: 4px;
    height: 60px; /* Stessa altezza del toggle modalità */
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
}

.sac-slider-indicator {
    position: absolute;
    top: 4px;
    left: 4px;
    width: calc(50% - 6px); /* Metà larghezza meno gap */
    height: calc(100% - 8px);
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%); /* Verde per pianificata */
    border-radius: 8px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 8px rgba(40, 167, 69, 0.4);
}

.sac-slider-option {
    position: relative;
    z-index: 1;
    background: none;
    border: none;
    padding: 8px 16px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
}

.sac-slider-option .option-text {
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.5px;
    color: #6c757d;
    transition: color 0.3s ease;
    text-align: center;
}

.sac-slider-option.active .option-text {
    color: white;
}

/* Posizioni e colori indicator per le due modalità SAC */
.sac-toggle-slider[data-active="true"] .sac-slider-indicator {
    transform: translateX(0);
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%); /* Verde per pianificata */
    box-shadow: 0 2px 8px rgba(40, 167, 69, 0.4);
}

.sac-toggle-slider[data-active="false"] .sac-slider-indicator {
    transform: translateX(calc(100% + 4px));
    background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); /* Arancione per non pianificata */
    box-shadow: 0 2px 8px rgba(255, 193, 7, 0.4);
}

/* Responsive per SAC toggle */
@media (max-width: 576px) {
    .sac-slider-track {
        height: 50px;
        border-radius: 10px;
    }
    
    .sac-slider-option .option-text {
        font-size: 10px;
    }
    
    .sac-slider-option {
        padding: 6px 8px;
    }
}

/* Accessibility per SAC toggle */
.sac-slider-option:focus {
    outline: 2px solid #667eea;
    outline-offset: 2px;
}

.form-group label + .talon-slim-select {
    margin-top: 5px;
}

/* Altezza consistente con altri input del form */
.talon-slim-select .ss-main {
    min-height: 50px;
    border-radius: 6px;
}

.talon-slim-select .ss-single {
    min-height: 48px;
    font-size: 0.95rem;
}

/* Coerenza con toggle switches esistenti */
.form-group .talon-slim-select .ss-main {
    background: white;
    transition: all 0.2s ease;
}

/* Supporto per campi required */
.form-group .required + .talon-slim-select .ss-main::before {
    content: '';
    position: absolute;
    right: 35px;
    top: 12px;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #dc3545;
    z-index: 2;
}

/* Styling specifico per optgroup in tipologie */
.talon-slim-select .ss-optgroup-label {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    padding: 8px 16px;
    border-radius: 4px 4px 0 0;
    margin-bottom: 4px;
}

/* Evidenziazione opzioni add-new */
.talon-slim-select .ss-option[data-action*="new"] {
    background: linear-gradient(90deg, #e3f2fd 0%, #f3e5f5 100%);
    border-left: 3px solid #2196f3;
    font-weight: 600;
    color: #1565c0;
}

.talon-slim-select .ss-option[data-action*="new"]:hover {
    background: linear-gradient(90deg, #bbdefb 0%, #e1bee7 100%);
    transform: translateX(2px);
}

/* Styling per opzioni temporanee */
.talon-slim-select .ss-option[data-temp="true"] {
    background: linear-gradient(90deg, #fff3e0 0%, #fce4ec 100%);
    border-left: 3px solid #ff9800;
    color: #e65100;
}

/* ===== OTTIMIZZAZIONE DROPDOWN SLIM SELECT ===== */

/* Z-index per dropdown visibili sopra altri elementi */
.talon-slim-select .ss-content {
    z-index: 9999 !important;
}

/* Responsive adjustments leggeri */
@media (max-width: 768px) {
    .talon-slim-select .ss-content {
        max-height: 60vh;
    }
}

/* Loading state durante inizializzazione */
.talon-slim-select-loading {
    position: relative;
    opacity: 0.7;
}

.talon-slim-select-loading::after {
    content: '';
    position: absolute;
    top: 50%;
    right: 16px;
    transform: translateY(-50%);
    width: 16px;
    height: 16px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: translateY(-50%) rotate(0deg); }
    100% { transform: translateY(-50%) rotate(360deg); }
}

/* Focus states per accessibilità */
.talon-slim-select .ss-main:focus-within {
    outline: 2px solid #667eea;
    outline-offset: 2px;
}

/* High contrast mode */
@media (prefers-contrast: high) {
    .talon-slim-select .ss-main {
        border-width: 2px;
    }
    
    .talon-slim-select .ss-option:hover,
    .talon-slim-select .ss-option.ss-highlighted {
        border-left-width: 4px;
    }
}


/* ===== MODALITÀ EFFETTUAZIONE - RADIO BUTTON CARDS (PROTEZIONE MASSIMA) ===== */

body #form-inserimento-attivita .modalita-section[data-protected-component="modalita-effettuazione"] {
    margin-bottom: 1.5rem !important;
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    position: relative !important;
    z-index: 100 !important;
}

body #form-inserimento-attivita .modalita-section .modalita-radio-group {
    display: flex !important;
    gap: 15px !important;
    flex-wrap: wrap !important;
    margin-top: 8px !important;
    visibility: visible !important;
    opacity: 1 !important;
}

body #form-inserimento-attivita .modalita-section .modalita-option {
    flex: 1 !important;
    min-width: 220px !important;
    cursor: pointer !important;
    margin-bottom: 0 !important;
    font-weight: normal !important;
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
}

body #form-inserimento-attivita .modalita-section .modalita-option input[type="radio"] {
    display: none !important;
}

body #form-inserimento-attivita .modalita-section .modalita-card {
    border: 2px solid #dee2e6 !important;
    border-radius: 8px !important;
    padding: 15px 12px !important;
    text-align: center !important;
    transition: all 0.3s ease !important;
    background: white !important;
    height: 85px !important;
    display: flex !important;
    flex-direction: column !important;
    justify-content: center !important;
    align-items: center !important;
    position: relative !important;
    overflow: hidden !important;
    visibility: visible !important;
    opacity: 1 !important;
    pointer-events: auto !important;
}

.modalita-option:hover .modalita-card {
    border-color: #667eea;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102,126,234,0.15);
}

.modalita-option.active .modalita-card {
    border-color: #667eea;
    background: linear-gradient(135deg, rgba(102,126,234,0.08) 0%, rgba(118,75,162,0.08) 100%);
    box-shadow: 0 4px 12px rgba(102,126,234,0.2);
}

.modalita-option.active .modalita-card::before {
    content: '✓';
    position: absolute;
    top: 6px;
    right: 8px;
    color: #667eea;
    font-weight: bold;
    font-size: 14px;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: rgba(102,126,234,0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: Arial, sans-serif;
}

.modalita-card i {
    font-size: 20px;
    color: #667eea;
    margin-bottom: 6px;
    display: block;
}

.modalita-title {
    display: block;
    font-weight: 600;
    font-size: 12px;
    color: #333;
    margin-bottom: 3px;
    line-height: 1.2;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.modalita-desc {
    display: block;
    font-size: 10px;
    color: #6c757d;
    line-height: 1.1;
    font-weight: 400;
}

/* Responsive per modalità */
@media (max-width: 768px) {
    .modalita-radio-group {
        flex-direction: column;
        gap: 10px;
    }
    
    .modalita-option {
        min-width: 100%;
    }
    
    .modalita-card {
        height: 70px;
        padding: 10px;
    }
    
    .modalita-card i {
        font-size: 16px;
        margin-bottom: 4px;
    }
    
    .modalita-title {
        font-size: 11px;
        margin-bottom: 2px;
    }
    
    .modalita-desc {
        font-size: 9px;
    }
}

@media (max-width: 576px) {
    .modalita-radio-group {
        gap: 8px;
    }
    
    .modalita-card {
        height: 65px;
        padding: 8px;
    }
    
    .modalita-title {
        font-size: 10px;
    }
}

/* Print friendly */
@media print {
    .talon-slim-select .ss-content {
        display: none !important;
    }
    
    .modalita-radio-group {
        display: block !important;
    }
    
    .modalita-option {
        display: inline-block !important;
        width: auto !important;
        margin-right: 20px;
    }
    
    .modalita-card {
        border: 1px solid #000 !important;
        background: transparent !important;
        height: auto !important;
        padding: 5px !important;
    }
}
</style>
{% endblock %}

{% block page_title %}Nuova Attività{% endblock %}

{% block page_controls %}
<button type="submit" form="form-inserimento-attivita" class="btn btn-primary">
    <i class="fas fa-save"></i> Salva Attività
</button>
<button type="button" class="btn btn-secondary" onclick="window.history.back()">
    <i class="fas fa-times"></i> Annulla
</button>
{% endblock %}

{% block content %}
<main class="dashboard__content-wrapper" role="main">
    <section class="dashboard__scroll-content" aria-label="Form nuova attività">
        
        <div class="form-container">
            <form action="{{ url_for('attivita.salva_attivita') }}" method="POST" id="form-inserimento-attivita">
        
        <!-- Sezione Dati Principali -->
        <div class="form-section">
            <h4 class="section-title">DATI PRINCIPALI</h4>
            
            <div class="form-group">
                <label for="ente_svolgimento_id">Ente che svolge l'attività <span class="required">*</span></label>
                <select name="ente_svolgimento_id" id="ente_svolgimento_id" class="form-control" required aria-label="Seleziona ente che svolge l'attività" autocomplete="organization">
                    <option value="" disabled selected>-- Seleziona un ente --</option>
                    {% for ente in enti_militari %}
                        <option value="{{ ente.id }}"
                                data-codice="{{ ente.codice or '' }}"
                                data-indirizzo="{{ ente.indirizzo or '' }}"
                                data-details="{% if ente.codice %}[{{ ente.codice }}] {% endif %}{{ ente.indirizzo or '' }}">
                            {{ ente.nome }}
                        </option>
                    {% endfor %}
                </select>
            </div>


            <div class="form-group">
                <label for="tipologia_id">Tipo di Attività <span class="required">*</span></label>
                <select name="tipologia_id" id="tipologia_id" class="form-control" required aria-label="Seleziona tipologia attività" autocomplete="off">
                    <option value="" disabled selected>-- Seleziona una tipologia --</option>
                    {% for categoria, sottocategorie in tipologie.items() %}
                        <optgroup label="{{ categoria }}">
                            {% for sub in sottocategorie %}
                                <option value="{{ sub.id }}">{{ sub.nome }}</option>
                            {% endfor %}
                        </optgroup>
                    {% endfor %}
                </select>
            </div>

            <!-- MODALITÀ DI EFFETTUAZIONE - DOPO TIPO ATTIVITÀ -->
            <div class="form-group" id="modalita-effettuazione-container">
                <label>Modalità di Effettuazione <span class="required">*</span></label>
                
                <!-- Radio inputs nascosti per compatibilità form -->
                <input type="radio" name="modalita_effettuazione" value="ordinaria" id="radio_ordinaria" checked required style="display: none;">
                <input type="radio" name="modalita_effettuazione" value="squadra_contatto_nazionale" id="radio_nazionale" required style="display: none;">
                <input type="radio" name="modalita_effettuazione" value="squadra_contatto_teatro" id="radio_teatro" required style="display: none;">
                
                <!-- Toggle slider a tre posizioni -->
                <div class="modalita-toggle-slider" id="modalitaToggle">
                    <div class="slider-track">
                        <div class="slider-indicator" id="sliderIndicator"></div>
                        <button type="button" class="slider-option active" data-value="ordinaria" id="btn_ordinaria">
                            <span class="option-text">MISSIONE ORDINARIA</span>
                        </button>
                        <button type="button" class="slider-option" data-value="squadra_contatto_nazionale" id="btn_nazionale">
                            <span class="option-text">SQUADRA A CONTATTO NAZIONALE</span>
                        </button>
                        <button type="button" class="slider-option" data-value="squadra_contatto_teatro" id="btn_teatro">
                            <span class="option-text">SQUADRA A CONTATTO IN TE.OP.</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- PIANIFICAZIONE SAC - Visibile solo per squadre a contatto -->
            <div class="form-group" id="sac-pianificata-container" style="display: none;">
                <label>Pianificazione SAC</label>
                
                <!-- Radio inputs nascosti per compatibilità form -->
                <input type="radio" name="sac_pianificata" value="true" id="radio_pianificata" checked style="display: none;">
                <input type="radio" name="sac_pianificata" value="false" id="radio_non_pianificata" style="display: none;">
                
                <!-- Toggle slider a due posizioni -->
                <div class="sac-toggle-slider" id="sacToggle">
                    <div class="sac-slider-track">
                        <div class="sac-slider-indicator" id="sacSliderIndicator"></div>
                        <button type="button" class="sac-slider-option active" data-value="true" id="btn_pianificata">
                            <span class="option-text">PIANIFICATA</span>
                        </button>
                        <button type="button" class="sac-slider-option" data-value="false" id="btn_non_pianificata">
                            <span class="option-text">NON PIANIFICATA</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <div class="toggle-operazione-container">
                    <div class="toggle-operazione-wrapper">
                        <span class="toggle-operazione-label">Operazione</span>
                        <div class="toggle-operazione-switch" onclick="toggleSwitch('operazione')">
                            <input type="checkbox" id="toggle-operazione" style="display: none;">
                            <div id="operazione-slider-button" class="toggle-operazione-button"></div>
                        </div>
                    </div>
                </div>
                <div id="operazione-container" class="operazione-dropdown-container">
                    <select name="operazione_id" id="operazione_id" class="form-control" aria-label="Seleziona operazione" autocomplete="off">
                        <option value="">-- Seleziona un'operazione (opzionale) --</option>
                        <option value="new" data-action="new-operazione" class="add-new-option">
                            ➕ Aggiungi nuova operazione...
                        </option>
                        {% for op in operazioni %}
                            <option value="{{ op.id }}"
                                    data-nome-missione="{{ op.nome_missione }}"
                                    data-nome-breve="{{ op.nome_breve or '' }}"
                                    data-teatro-operativo="{{ op.teatro_operativo or '' }}"
                                    data-nazione="{{ op.nazione or '' }}"
                                    data-details="{% if op.nome_breve %}{{ op.nome_breve }} • {% endif %}{% if op.teatro_operativo %}{{ op.teatro_operativo }}{% endif %}{% if op.nazione %} • {{ op.nazione }}{% endif %}">
                                {{ op.nome_missione }}
                            </option>
                        {% endfor %}
                        {% for op_temp in operazioni_temp %}
                            <option value="temp_{{ op_temp.id }}"
                                    data-temp="true"
                                    data-nome-missione="{{ op_temp.nome_missione }}"
                                    data-nome-breve="{{ op_temp.nome_breve or '' }}"
                                    data-teatro-operativo="{{ op_temp.teatro_operativo or '' }}"
                                    data-nazione="{{ op_temp.nazione or '' }}"
                                    data-details="[NON VALIDATA] {% if op_temp.nome_breve %}{{ op_temp.nome_breve }} • {% endif %}{% if op_temp.teatro_operativo %}{{ op_temp.teatro_operativo }}{% endif %}{% if op_temp.nazione %} • {{ op_temp.nazione }}{% endif %}">
                                [TEMP] {{ op_temp.nome_missione }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-group">
                <div class="toggle-esercitazione-container">
                    <div class="toggle-esercitazione-wrapper">
                        <span class="toggle-esercitazione-label">Esercitazione</span>
                        <div class="toggle-esercitazione-switch" onclick="toggleSwitch('esercitazione')">
                            <input type="checkbox" id="toggle-esercitazione" style="display: none;">
                            <div id="esercitazione-slider-button" class="toggle-esercitazione-button"></div>
                        </div>
                    </div>
                </div>
                <div id="esercitazione-container" class="esercitazione-dropdown-container">
                    <select name="esercitazione_id" id="esercitazione_id" class="form-control" aria-label="Seleziona esercitazione" autocomplete="off">
                        <option value="">-- Seleziona un'esercitazione (opzionale) --</option>
                        <option value="new" data-action="new-esercitazione" class="add-new-option">
                            ➕ Aggiungi nuova esercitazione...
                        </option>
                        {% for eserc in esercitazioni %}
                            <option value="{{ eserc.id }}"
                                    data-nome="{{ eserc.nome }}"
                                    data-nome-breve="{{ eserc.nome_breve or '' }}"
                                    data-anno="{{ eserc.anno or '' }}"
                                    data-details="{% if eserc.nome_breve %}{{ eserc.nome_breve }} • {% endif %}{% if eserc.anno %}{{ eserc.anno }}{% endif %}">
                                {{ eserc.nome }}
                            </option>
                        {% endfor %}
                        {% for eserc_temp in esercitazioni_temp %}
                            <option value="temp_{{ eserc_temp.id }}"
                                    data-temp="true"
                                    data-nome="{{ eserc_temp.nome }}"
                                    data-nome-breve="{{ eserc_temp.nome_breve or '' }}"
                                    data-anno="{{ eserc_temp.anno or '' }}"
                                    data-details="[NON VALIDATA] {% if eserc_temp.nome_breve %}{{ eserc_temp.nome_breve }} • {% endif %}{% if eserc_temp.anno %}{{ eserc_temp.anno }}{% endif %}">
                                [TEMP] {{ eserc_temp.nome }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="data_inizio">Data Inizio <span class="required">*</span></label>
                    <input type="date" id="data_inizio" name="data_inizio" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="data_fine">Data Fine</label>
                    <input type="date" id="data_fine" name="data_fine" class="form-control">
                </div>
            </div>

            <div class="form-group">
                <label for="descrizione">Descrizione <span class="required">*</span></label>
                <textarea id="descrizione" name="descrizione" rows="3" class="form-control" required 
                          placeholder="Inserire una descrizione dell'attività"></textarea>
            </div>
        </div>

        <!-- Sezione Risorse e Note -->
        <div class="form-section">
            <h4 class="section-title">RISORSE E NOTE</h4>
            
            <div class="form-row personnel-row">
                <div class="form-group">
                    <label for="personale_ufficiali">Ufficiali</label>
                    <input type="number" id="personale_ufficiali" name="personale_ufficiali" 
                           value="0" min="0" class="form-control">
                </div>
                <div class="form-group">
                    <label for="personale_sottufficiali">Sottufficiali</label>
                    <input type="number" id="personale_sottufficiali" name="personale_sottufficiali" 
                           value="0" min="0" class="form-control">
                </div>
                <div class="form-group">
                    <label for="personale_graduati">Graduati/VFP</label>
                    <input type="number" id="personale_graduati" name="personale_graduati" 
                           value="0" min="0" class="form-control">
                </div>
                <div class="form-group">
                    <label for="personale_civili">Civili</label>
                    <input type="number" id="personale_civili" name="personale_civili" 
                           value="0" min="0" class="form-control">
                </div>
            </div>
            
            <div class="form-group">
                <label for="note">Note</label>
                <textarea id="note" name="note" rows="3" class="form-control"
                          placeholder="Eventuali annotazioni aggiuntive"></textarea>
            </div>
        </div>

        <!-- Sezione Località -->
        <div class="form-section">
            <h4 class="section-title">LOCALITÀ</h4>
            
            <div class="form-group">
                <label for="partenza_id">Luogo Partenza</label>
                <select name="partenza_id" id="partenza_id" class="form-control" aria-label="Seleziona luogo partenza" autocomplete="off">
                    <option value="">-- Seleziona (opzionale) --</option>
                    <optgroup label="ENTI MILITARI">
                        {% for ente in enti_militari %}
                            <option value="militare-{{ ente.id }}"
                                    data-tipo="militare"
                                    data-codice="{{ ente.codice or '' }}"
                                    data-indirizzo="{{ ente.indirizzo or '' }}"
                                                    data-details="{% if ente.codice %}[{{ ente.codice }}] {% endif %}{{ ente.indirizzo or '' }}">
                                {{ ente.nome }}
                            </option>
                        {% endfor %}
                    </optgroup>
                    <optgroup label="ENTI CIVILI">
                        {% for ente in enti_civili %}
                            <option value="civile-{{ ente.id }}"
                                    data-tipo="civile"
                                    data-indirizzo="{{ ente.indirizzo or '' }}"
                                                    data-nazione="{{ ente.nazione or 'ITALIA' }}"
                                    data-details="{{ ente.indirizzo or '' }}{% if ente.nazione and ente.nazione != 'ITALIA' %} - {{ ente.nazione }}{% endif %}">
                                {{ ente.nome }}
                            </option>
                        {% endfor %}
                    </optgroup>
                </select>
            </div>
            
            <div class="form-group">
                <label for="destinazione_id">Luogo Destinazione</label>
                <select name="destinazione_id" id="destinazione_id" class="form-control" aria-label="Seleziona luogo destinazione" autocomplete="off">
                    <option value="">-- Seleziona (opzionale) --</option>
                    <optgroup label="ENTI MILITARI">
                        {% for ente in enti_militari %}
                            <option value="militare-{{ ente.id }}"
                                    data-tipo="militare"
                                    data-codice="{{ ente.codice or '' }}"
                                    data-indirizzo="{{ ente.indirizzo or '' }}"
                                                    data-details="{% if ente.codice %}[{{ ente.codice }}] {% endif %}{{ ente.indirizzo or '' }}">
                                {{ ente.nome }}
                            </option>
                        {% endfor %}
                    </optgroup>
                    <optgroup label="ENTI CIVILI">
                        {% for ente in enti_civili %}
                            <option value="civile-{{ ente.id }}"
                                    data-tipo="civile"
                                    data-indirizzo="{{ ente.indirizzo or '' }}"
                                                    data-nazione="{{ ente.nazione or 'ITALIA' }}"
                                    data-details="{{ ente.indirizzo or '' }}{% if ente.nazione and ente.nazione != 'ITALIA' %} - {{ ente.nazione }}{% endif %}">
                                {{ ente.nome }}
                            </option>
                        {% endfor %}
                    </optgroup>
                </select>
            </div>
        </div>

        <!-- SEZIONI DETTAGLI SPECIFICI (include modulari) -->
        <!-- SEZIONE DETTAGLI TRASPORTI (include modulare) -->
        {% include 'attivita/includes/_dettagli_trasporti.html' %}

        <!-- SEZIONE DETTAGLI MANTENIMENTO (include modulare) -->
        {% include 'attivita/includes/_dettagli_mantenimento.html' %}

        <!-- SEZIONE DETTAGLI RIFORNIMENTI (include modulare) -->
        {% include 'attivita/includes/_dettagli_rifornimenti.html' %}
        
        <!-- SEZIONE DETTAGLI GETRA (include modulare) -->
        {% include 'attivita/includes/_dettagli_getra.html' %}

        <!-- SEZIONE DETTAGLI TRAINING ON THE JOB (include modulare) -->
        {% include 'attivita/includes/_dettagli_training.html' %}

        <!-- SEZIONE DETTAGLI FORMAZIONE (include modulare) -->
        {% include 'attivita/includes/_dettagli_formazione.html' %}

        <!-- SEZIONE DETTAGLI ESERCITAZIONE (include modulare) -->
        {% include 'attivita/includes/_dettagli_esercitazione.html' %}

        <!-- SEZIONE DETTAGLI MEDICINA CURATIVA (include modulare) -->
        {% include 'attivita/includes/_dettagli_medicina.html' %}

        <!-- SEZIONE DETTAGLI STRATEVAC (include modulare) -->
        {% include 'attivita/includes/_dettagli_stratevac.html' %}


            </form>
        </div>
        
    </section>
</main>

<!-- Modal per nuova operazione -->
<div id="modal-nuova-operazione" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Aggiungi Nuova Operazione (Temporanea)</h3>
            <span class="modal-close" onclick="closeModal('modal-nuova-operazione')">&times;</span>
        </div>
        <div class="modal-body">
            <p class="modal-notice">
                <strong>Nota:</strong> Questa operazione sarà salvata come temporanea e dovrà essere validata dall'amministratore.
            </p>
            <form id="form-nuova-operazione">
                <div class="form-group">
                    <label for="new-op-nome">Nome Missione <span class="required">*</span></label>
                    <input type="text" id="new-op-nome" class="form-control text-uppercase" required>
                </div>
                <div class="form-group">
                    <label for="new-op-nome-breve">Nome Breve</label>
                    <input type="text" id="new-op-nome-breve" class="form-control text-uppercase">
                </div>
                <div class="form-group">
                    <label for="new-op-teatro">Teatro Operativo</label>
                    <input type="text" id="new-op-teatro" class="form-control text-uppercase">
                </div>
                <div class="form-group">
                    <label for="new-op-nazione">Nazione</label>
                    <input type="text" id="new-op-nazione" class="form-control text-uppercase">
                </div>
                <div class="form-group">
                    <label for="new-op-note">Note</label>
                    <textarea id="new-op-note" class="form-control text-uppercase" rows="2"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('modal-nuova-operazione')">Annulla</button>
            <button type="button" class="btn btn-primary" onclick="salvaOperazioneTemp()">Salva Operazione</button>
        </div>
    </div>
</div>

<!-- Modal per nuova esercitazione -->
<div id="modal-nuova-esercitazione" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Aggiungi Nuova Esercitazione (Temporanea)</h3>
            <span class="modal-close" onclick="closeModal('modal-nuova-esercitazione')">&times;</span>
        </div>
        <div class="modal-body">
            <p class="modal-notice">
                <strong>Nota:</strong> Questa esercitazione sarà salvata come temporanea e dovrà essere validata dall'amministratore.
            </p>
            <form id="form-nuova-esercitazione">
                <div class="form-group">
                    <label for="new-eserc-nome">Nome Esercitazione <span class="required">*</span></label>
                    <input type="text" id="new-eserc-nome" class="form-control text-uppercase" required>
                </div>
                <div class="form-group">
                    <label for="new-eserc-nome-breve">Nome Breve</label>
                    <input type="text" id="new-eserc-nome-breve" class="form-control text-uppercase">
                </div>
                <div class="form-group">
                    <label for="new-eserc-anno">Anno</label>
                    <input type="number" id="new-eserc-anno" class="form-control" min="2020" max="2030" value="2025">
                </div>
                <div class="form-group">
                    <label for="new-eserc-note">Note</label>
                    <textarea id="new-eserc-note" class="form-control text-uppercase" rows="2"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('modal-nuova-esercitazione')">Annulla</button>
            <button type="button" class="btn btn-primary" onclick="salvaEsercitazioneTemp()">Salva Esercitazione</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- CORE DEPENDENCIES -->
<script src="{{ url_for('static', filename='js/components/advanced-table.js') }}?v={{ cache_buster }}"></script>

<!-- ATTIVITA BUNDLE - Sistema modulare con initializer dedicato -->
<script>window.ATTIVITA_CACHE_VERSION = '{{ cache_buster }}';</script>
<script src="{{ url_for('static', filename='js/components/attivita-bundle.js') }}?v={{ cache_buster }}"></script>

<!-- Fallback container fixes solo se necessario -->
<script src="{{ url_for('static', filename='js/attivita/form_container_fixes.js') }}?v={{ cache_buster }}"></script>

<script>
// NUOVO APPROCCIO SEMPLICE - Modalità Isolate  
let modalitaRetryCount = 0;
const MAX_MODALITA_RETRIES = 10;

function initializeModalitaToggle() {
    console.log('🎯 Inizializzazione toggle slider modalità...');
    
    const container = document.getElementById('modalita-effettuazione-container');
    if (!container) {
        if (modalitaRetryCount < MAX_MODALITA_RETRIES) {
            modalitaRetryCount++;
            console.warn(`⚠️ Container modalità non trovato, retry ${modalitaRetryCount}/${MAX_MODALITA_RETRIES} tra 500ms...`);
            setTimeout(() => initializeModalitaToggle(), 500);
            return;
        } else {
            console.error('❌ Container modalità non trovato dopo ' + MAX_MODALITA_RETRIES + ' tentativi');
            return;
        }
    }
    
    const toggleSlider = container.querySelector('#modalitaToggle');
    const sliderOptions = container.querySelectorAll('.slider-option');
    
    if (!toggleSlider || sliderOptions.length === 0) {
        if (modalitaRetryCount < MAX_MODALITA_RETRIES) {
            modalitaRetryCount++;
            console.warn(`⚠️ Toggle slider non trovato, retry ${modalitaRetryCount}/${MAX_MODALITA_RETRIES} tra 300ms...`);
            setTimeout(() => initializeModalitaToggle(), 300);
            return;
        } else {
            console.error('❌ Toggle slider non trovato dopo ' + MAX_MODALITA_RETRIES + ' tentativi');
            return;
        }
    }
    
    console.log('📊 Toggle slider trovato con', sliderOptions.length, 'opzioni');
    
    // Reset retry count quando trova gli elementi
    modalitaRetryCount = 0;
    
    // Imposta stato iniziale
    toggleSlider.setAttribute('data-active', 'ordinaria');
    
    // Aggiungi event listeners per ogni opzione del toggle
    sliderOptions.forEach(option => {
        option.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const selectedValue = this.getAttribute('data-value');
            console.log('🎯 Opzione toggle cliccata:', selectedValue);
            
            // Aggiorna stato visuale
            sliderOptions.forEach(opt => opt.classList.remove('active'));
            this.classList.add('active');
            
            // Aggiorna posizione indicator
            toggleSlider.setAttribute('data-active', selectedValue);
            
            // Aggiorna radio button corrispondente
            const radioElement = container.querySelector(`input[value="${selectedValue}"]`);
            if (radioElement) {
                radioElement.checked = true;
                console.log('✅ Radio button aggiornato:', selectedValue);
            }
            
            // Event personalizzato per notificare il cambiamento
            const changeEvent = new CustomEvent('modalitaChanged', {
                detail: { selectedValue: selectedValue }
            });
            container.dispatchEvent(changeEvent);
        });
    });
    
    console.log('✅ Toggle slider modalità inizializzato con successo');
    
    // Aggiungi listener per mostrare/nascondere SAC toggle
    container.addEventListener('modalitaChanged', function(e) {
        const sacContainer = document.getElementById('sac-pianificata-container');
        if (sacContainer) {
            if (e.detail.selectedValue === 'squadra_contatto_nazionale' || 
                e.detail.selectedValue === 'squadra_contatto_teatro') {
                sacContainer.style.display = 'block';
                initializeSacToggle();
            } else {
                sacContainer.style.display = 'none';
            }
        }
    });
}

function initializeSacToggle() {
    console.log('🎯 Inizializzazione toggle slider SAC...');
    
    const sacContainer = document.getElementById('sac-pianificata-container');
    if (!sacContainer) {
        console.warn('⚠️ Container SAC non trovato');
        return;
    }
    
    const sacToggle = sacContainer.querySelector('#sacToggle');
    const sacOptions = sacContainer.querySelectorAll('.sac-slider-option');
    
    if (!sacToggle || sacOptions.length === 0) {
        console.warn('⚠️ Toggle SAC o opzioni non trovate');
        return;
    }
    
    console.log('📊 Toggle SAC trovato con', sacOptions.length, 'opzioni');
    
    // Imposta stato iniziale (pianificata = true)
    sacToggle.setAttribute('data-active', 'true');
    
    // Aggiungi event listeners per ogni opzione del toggle SAC
    sacOptions.forEach(option => {
        option.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const selectedValue = this.getAttribute('data-value');
            console.log('🎯 Opzione SAC cliccata:', selectedValue);
            
            // Aggiorna stato visuale
            sacOptions.forEach(opt => opt.classList.remove('active'));
            this.classList.add('active');
            
            // Aggiorna posizione indicator
            sacToggle.setAttribute('data-active', selectedValue);
            
            // Aggiorna radio button corrispondente
            const radioElement = sacContainer.querySelector(`input[value="${selectedValue}"]`);
            if (radioElement) {
                radioElement.checked = true;
                console.log('✅ Radio button SAC aggiornato:', selectedValue);
            }
        });
    });
    
    console.log('✅ Toggle slider SAC inizializzato con successo');
}

/**
 * ATTIVITA TEMPLATE - JavaScript essenziale
 * La maggior parte della logica è ora gestita dai componenti modulari nel bundle
 */
document.addEventListener('DOMContentLoaded', function() {
    
    // Inizializzazione toggle slider modalità
    console.log('✨ Inizializzazione toggle slider modalità');
    initializeModalitaToggle();
    
    // Ascolta quando i componenti bundle sono pronti
    window.addEventListener('attivitaBundle:ready', function(e) {
        console.log('📦 Bundle pronto - re-inizializzazione toggle modalità');
        // Re-inizializza dopo il bundle
        setTimeout(() => initializeModalitaToggle(), 200);
        
        // Debug dei selettori vettore dopo il caricamento
        setTimeout(() => debugVettoreSelectors(), 1000);
    });
    
    // Fallback per compatibilità legacy se bundle fallisce
    setTimeout(function() {
        if (!window.TalonAttivitaFormManager) {
            console.warn('⚠️ Bundle non caricato, inizializzazione fallback...');
            initializeLegacyFallback();
        }
        // Re-controlla toggle modalità
        initializeModalitaToggle();
    }, 2000);
});

function initializeTemplateSpecificFeatures() {
    // Slim Select è gestito dal componente dedicato attivita-slim-select-initializer.js
    // Caricato dal bundle attività
    
    // Re-inizializza toggle modalità
    initializeModalitaToggle();
}

// Funzione di debug per verificare l'inizializzazione dei selettori vettore
function debugVettoreSelectors() {
    console.log('🔍 DEBUG: Verifica inizializzazione selettori vettore');
    
    // Verifica tipo_vettore
    const tipoVettore = document.getElementById('tipo_vettore');
    if (tipoVettore) {
        console.log('✅ Elemento tipo_vettore trovato:', tipoVettore);
        console.log('📄 Opzioni disponibili:', tipoVettore.options.length);
        
        if (window.TalonAttivitaSlimSelect) {
            const instance = window.TalonAttivitaSlimSelect.getInstance('tipo_vettore');
            console.log('🎯 SlimSelect instance per tipo_vettore:', instance ? 'TROVATA' : 'NON TROVATA');
        }
    } else {
        console.warn('⚠️ Elemento tipo_vettore NON trovato');
    }
    
    // Verifica tipo_vettore_stratevac
    const tipoVettoreStratevac = document.getElementById('tipo_vettore_stratevac');
    if (tipoVettoreStratevac) {
        console.log('✅ Elemento tipo_vettore_stratevac trovato:', tipoVettoreStratevac);
        console.log('📄 Opzioni disponibili:', tipoVettoreStratevac.options.length);
        
        if (window.TalonAttivitaSlimSelect) {
            const instance = window.TalonAttivitaSlimSelect.getInstance('tipo_vettore_stratevac');
            console.log('🎯 SlimSelect instance per tipo_vettore_stratevac:', instance ? 'TROVATA' : 'NON TROVATA');
        }
    } else {
        console.log('ℹ️ Elemento tipo_vettore_stratevac non trovato (normale se sezione non visibile)');
    }
    
    // Verifica VettoreDecoder
    if (window.VettoreDecoder) {
        console.log('✅ VettoreDecoder disponibile');
        const testDecode = window.VettoreDecoder.decode('SAFOPS');
        console.log('🧪 Test decodifica SAFOPS:', testDecode);
    } else {
        console.warn('⚠️ VettoreDecoder NON disponibile');
    }
    
    // Verifica stato SlimSelect
    if (window.TalonAttivitaSlimSelect) {
        const status = window.TalonAttivitaSlimSelect.getInstancesStatus();
        console.log('📊 Stato SlimSelect:', status);
    }
}

function initializeLegacyFallback() {
    // Fallback minimo per funzionalità critiche
    console.log('🔄 Modalità compatibilità attivata');
    
    // Solo le funzioni assolutamente essenziali
    setupBasicUppercase();
    setupBasicToggleSwitches();
}

function setupBasicUppercase() {
    const textInputs = document.querySelectorAll('input[type="text"], textarea');
    textInputs.forEach(input => {
        if (input.type === 'number' || input.type === 'date') return;
        
        input.style.textTransform = 'uppercase';
        input.addEventListener('input', function() {
            const start = this.selectionStart;
            const end = this.selectionEnd;
            this.value = this.value.toUpperCase();
            this.setSelectionRange(start, end);
        });
    });
}

function setupBasicToggleSwitches() {
    // Versione base dei toggle switch se bundle non disponibile
    window.toggleSwitch = window.toggleSwitch || function(type) {
        const checkbox = document.getElementById('toggle-' + type);
        const container = document.getElementById(type + '-container');
        if (checkbox && container) {
            checkbox.checked = !checkbox.checked;
            container.style.display = checkbox.checked ? 'block' : 'none';
        }
    };
}
</script>
{% endblock %}