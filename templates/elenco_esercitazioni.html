{% extends "_base.html" %}

{% block title %}Elenco Esercitazioni - TALON{% endblock %}

{% block head %}
<!-- CSS specifico per lista esercitazioni -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/attivita/lista_attivita.css') }}?v={{ cache_buster }}">
{% endblock %}

{% block content %}
<div class="attivita-container" id="esercitazioni-container">
    <div class="detail-header">
        <h3>Elenco Esercitazioni</h3>
        <a href="{{ url_for('esercitazioni.inserisci_esercitazione_form') }}" 
           class="btn-modifica">Nuova Esercitazione</a>
    </div>

    <div class="list-container">
        <!-- Barra di ricerca -->
        <div class="search-bar">
            <input type="search" 
                   id="searchInput" 
                   class="form-control search-input" 
                   placeholder="CERCA PER NOME O ANNO..."
                   aria-label="Cerca esercitazioni">
        </div>

        <!-- Tabella esercitazioni -->
        <div class="table-responsive">
            <table class="styled-table" id="esercitazioniTable">
                <thead>
                    <tr>
                        <th class="sortable" data-column="0" data-sort-type="text">
                            <span class="th-label">Nome</span>
                            <span class="th-arrow" data-arrow="">▲▼</span>
                        </th>
                        <th class="sortable" data-column="1" data-sort-type="text">
                            <span class="th-label">Nome Breve</span>
                            <span class="th-arrow" data-arrow="">▲▼</span>
                        </th>
                        <th class="sortable" data-column="2" data-sort-type="number">
                            <span class="th-label">Anno</span>
                            <span class="th-arrow" data-arrow="">▲▼</span>
                        </th>
                    </tr>
                </thead>
                <tbody id="esercitazioniTableBody" class="attivita-tbody">
                    {% for esercitazione in esercitazioni_list %}
                    <tr class="clickable-row" 
                        data-href="{{ url_for('esercitazioni.visualizza_esercitazione', id=esercitazione.id) }}"
                        data-esercitazione-id="{{ esercitazione.id }}"
                        >
                        <td>{{ esercitazione.nome }}</td>
                        <td>{{ esercitazione.nome_breve or '-' }}</td>
                        <td>{{ esercitazione.anno or '-' }}</td>
                    </tr>
                    {% else %}
                    <tr class="no-data-row">
                        <td colspan="3" style="text-align: center;">Nessuna esercitazione inserita.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Inizializzazione specifica per vista lista esercitazioni
document.addEventListener('DOMContentLoaded', function() {
    // Gestione ricerca
    const searchInput = document.getElementById('searchInput');
    const table = document.getElementById('esercitazioniTable');
    const tbody = document.getElementById('esercitazioniTableBody');
    
    if (searchInput && table) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const rows = tbody.querySelectorAll('tr:not(.no-data-row)');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const text = Array.from(cells).map(cell => cell.textContent.toLowerCase()).join(' ');
                
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Gestione messaggio "nessun risultato"
            let noResultsRow = tbody.querySelector('.no-results-row');
            if (visibleCount === 0 && rows.length > 0) {
                if (!noResultsRow) {
                    noResultsRow = document.createElement('tr');
                    noResultsRow.className = 'no-results-row';
                    noResultsRow.innerHTML = '<td colspan="3" style="text-align: center;">Nessun risultato trovato.</td>';
                    tbody.appendChild(noResultsRow);
                }
                noResultsRow.style.display = '';
            } else if (noResultsRow) {
                noResultsRow.style.display = 'none';
            }
        });
    }
    
    // Gestione click sulle righe
    const clickableRows = document.querySelectorAll('.clickable-row');
    clickableRows.forEach(row => {
        row.addEventListener('click', function() {
            const href = this.dataset.href;
            if (href) {
                window.location.href = href;
            }
        });
    });
    
    // Gestione ordinamento
    const sortableHeaders = document.querySelectorAll('.sortable');
    sortableHeaders.forEach(header => {
        header.addEventListener('click', function() {
            const column = parseInt(this.dataset.column);
            const sortType = this.dataset.sortType;
            sortTable(column, sortType, this);
        });
    });
});

function sortTable(column, sortType, headerElement) {
    const table = document.getElementById('esercitazioniTable');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr:not(.no-data-row):not(.no-results-row)'));
    
    const isAscending = !headerElement.classList.contains('sort-asc');
    
    // Rimuovi classe di ordinamento da tutti gli header
    document.querySelectorAll('.sortable').forEach(h => {
        h.classList.remove('sort-asc', 'sort-desc');
    });
    
    // Aggiungi classe appropriata
    headerElement.classList.add(isAscending ? 'sort-asc' : 'sort-desc');
    
    rows.sort((a, b) => {
        const aVal = a.children[column].textContent.trim();
        const bVal = b.children[column].textContent.trim();
        
        let comparison = 0;
        
        if (sortType === 'number') {
            const aNum = parseInt(aVal) || 0;
            const bNum = parseInt(bVal) || 0;
            comparison = aNum - bNum;
        } else {
            comparison = aVal.localeCompare(bVal);
        }
        
        return isAscending ? comparison : -comparison;
    });
    
    // Riordina le righe
    rows.forEach(row => tbody.appendChild(row));
}
</script>
{% endblock %}