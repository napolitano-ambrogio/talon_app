{% extends "shared/_base.html" %}

{% block title %}Dettaglio {{ ente.nome }} - TALON{% endblock %}

{% block additional_css %}
<!-- CSS specifico per visualizzazione enti militari -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/attivita/visualizza_attivita.css') }}?v={{ cache_buster }}">
<!-- CSS Advanced Table Component per i badge -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/advanced-table.css') }}?v={{ cache_buster }}">
<!-- Leaflet CSS (locale) -->
<link rel="stylesheet" href="/external/leaflet/leaflet.css" />
{% endblock %}

{% block page_title %}
{{ ente.nome }}
{% endblock %}

{% block page_controls %}
<a href="{{ url_for('enti_militari.organigramma', view=return_view if return_view else none, search=return_search if return_search else none) }}" class="btn btn-secondary">
    <i class="fas fa-arrow-left"></i> Torna all'Organigramma
</a>
{% if user_role in ['ADMIN', 'OPERATORE'] %}
<a href="{{ url_for('enti_militari.modifica_militare_form', id=ente.id, view=return_view if return_view else none, search=return_search if return_search else none) }}" class="btn btn-primary">
    <i class="fas fa-edit"></i> Modifica
</a>
{% endif %}
{% if user_role == 'ADMIN' %}
<form action="{{ url_for('enti_militari.elimina_militare', id=ente.id, view=return_view if return_view else none, search=return_search if return_search else none) }}" method="POST" onsubmit="return confirm('Confermare l\'eliminazione dell\'ente militare?');" style="display: inline;">
    <button type="submit" class="btn btn-danger">
        <i class="fas fa-trash"></i> Elimina
    </button>
</form>
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
/* Layout a due colonne per enti militari */
.ente-layout {
    display: flex;
    gap: 0;
    height: calc(100vh - 200px);
    min-height: 500px;
}

.ente-details {
    overflow-y: auto;
}

.ente-map-container {
    flex: 0 0 80%;
    border: 1px solid #ddd;
    border-radius: 8px;
    overflow: hidden;
    background: #f8f9fa;
}

#ente-map {
    width: 100%;
    height: 100%;
    min-height: 500px;
}

.no-coordinates {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    background: #f8f9fa;
    color: #6c757d;
    text-align: center;
    font-style: italic;
}

.leaflet-marker-red {
    filter: invert(19%) sepia(99%) saturate(7404%) hue-rotate(4deg) brightness(102%) contrast(97%);
}

/* Responsive per schermi piccoli */
@media (max-width: 1024px) {
    .ente-layout {
        flex-direction: column;
        height: auto;
        min-height: auto;
    }
    
    .ente-details {
        flex: none;
    }
    
    .ente-map-container {
        height: 400px;
        flex: none;
    }
    
    #ente-map {
        min-height: 400px;
    }
}

@media (max-width: 768px) {
    .ente-map-container {
        height: 300px;
    }
    
    #ente-map {
        min-height: 300px;
    }
}
</style>
{% endblock %}

{% block content %}
<main class="dashboard__content-wrapper" role="main">
    <section class="dashboard__scroll-content" aria-label="Contenuto principale dettaglio ente militare">
        
        <!-- Layout a due colonne: dati + mappa -->
        <div class="ente-layout">
            
            <!-- Colonna sinistra: Dati ente -->
            <div class="ente-details" style="height: 100%; display: flex; flex-direction: column; flex: 0 0 20%;">
                <div class="detail-card" style="flex: 1; height: 100%;">

                    <!-- Informazioni generali -->
                    <div class="info-section" style="height: 100%; display: flex; flex-direction: column; padding: 20px;">
                        
                        <!-- Dati organizzati in colonna singola -->
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <!-- Indirizzo -->
                            <div>
                                <dt style="font-weight: bold; color: #4a5568; margin-bottom: 3px;">Indirizzo</dt>
                                <dd style="margin: 0; line-height: 1.4;">{{ ente.indirizzo or 'Indirizzo non specificato' }}</dd>
                            </div>
                            
                            <!-- Telefono -->
                            <div>
                                <dt style="font-weight: bold; color: #4a5568; margin-bottom: 3px;">Telefono</dt>
                                <dd style="margin: 0;">{{ ente.telefono or 'N/D' }}</dd>
                            </div>
                            
                            <!-- Email -->
                            <div>
                                <dt style="font-weight: bold; color: #4a5568; margin-bottom: 3px;">Email</dt>
                                <dd style="margin: 0; word-break: break-word;">{{ ente.email or 'N/D' }}</dd>
                            </div>
                            
                            <!-- Codice AdHoc -->
                            <div>
                                <dt style="font-weight: bold; color: #4a5568; margin-bottom: 3px;">Codice AdHoc</dt>
                                <dd style="margin: 0; line-height: 1.4;">{{ ente.codice or 'N/D' }}</dd>
                            </div>
                            
                            <!-- Dipendenza (Catena Gerarchica Completa) -->
                            <div>
                                <dt style="font-weight: bold; color: #4a5568; margin-bottom: 3px;">Dipendenza</dt>
                                <dd style="margin: 0; line-height: 1.4; padding: 8px; background: #f8f9fa; border-radius: 4px; border: 1px solid #e2e8f0;">
                                    {% if hierarchy_chain %}
                                        {% for parent in hierarchy_chain %}
                                            <div style="margin-bottom: 5px; font-size: 0.85em;">
                                                {{ loop.index }}. {{ parent.nome }}
                                            </div>
                                        {% endfor %}
                                    {% else %}
                                        <div style="font-style: italic; color: #6c757d; font-size: 0.85em;">Nessuna dipendenza (Ente al Vertice)</div>
                                    {% endif %}
                                </dd>
                            </div>
                        </div>
                        
                        
                        <!-- Nota esplicativa per la mappa - sempre visibile -->
                        <div style="margin-top: 20px; padding: 8px 10px; background: #fce4ec; border: 1px solid #f8bbd9; border-radius: 4px; border-left: 3px solid #e91e63; flex-shrink: 0;">
                            <div style="display: flex; align-items: flex-start; gap: 8px;">
                                <i class="fas fa-info-circle" style="color: #880e4f; font-size: 13px; margin-top: 1px;"></i>
                                <span style="font-size: 0.8em; color: #880e4f; font-weight: 400; line-height: 1.4;">
                                    La mappa mostra la posizione geografica di questo ente militare.
                                </span>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            
            <!-- Colonna destra: Mappa -->
            <div class="ente-map-container">
                <div id="ente-map"></div>
            </div>
            
        </div>
        
    </section>
</main>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS (locale) -->
<script src="/external/leaflet/leaflet.js"></script>
<script>
// Inizializza mappa ente militare
function initEnteMap() {
    // Configura icona marker personalizzata rossa per enti militari
    const customIcon = L.icon({
        iconUrl: '/external/fontawesome/svgs/solid/location-dot.svg',
        iconSize: [30, 40],
        iconAnchor: [15, 40],
        popupAnchor: [0, -40],
        className: 'leaflet-marker-red'
    });
    
    // Dati dell'ente con coordinate dirette dal backend
    const enteData = {
        id: {{ ente.id }},
        nome: '{{ ente.nome|e }}',
        indirizzo: '{{ ente.indirizzo|e }}',
        {% if ente.coordinate_formatted %}
        // Parse coordinate dal campo formattato "lat, lng"
        coordinate_str: '{{ ente.coordinate_formatted }}',
        ha_coordinate: true
        {% else %}
        ha_coordinate: false
        {% endif %}
    };
    
    // Parse delle coordinate se disponibili
    if (enteData.ha_coordinate && enteData.coordinate_str) {
        const coords = enteData.coordinate_str.split(', ');
        if (coords.length === 2) {
            enteData.lat = parseFloat(coords[0]);
            enteData.lng = parseFloat(coords[1]);
        } else {
            enteData.ha_coordinate = false;
        }
    }
    
    console.log('[Mappa Ente Militare] Dati ente:', enteData);
    
    // Caricamento immediato senza chiamata AJAX
    if (enteData.ha_coordinate && enteData.lat && enteData.lng) {
        // Coordinate trovate, mostra la mappa immediatamente
        showEnteMap(enteData);
    } else {
        console.log('[Mappa Ente Militare] Nessuna coordinata per ente:', enteData.id);
        // Nessuna coordinata, mostra messaggio
        showNoCoordinatesMessage();
    }
}

function showEnteMap(ente) {
    // Configura icona marker personalizzata rossa per enti militari
    const customIcon = L.icon({
        iconUrl: '/external/fontawesome/svgs/solid/location-dot.svg',
        iconSize: [30, 40],
        iconAnchor: [15, 40],
        popupAnchor: [0, -40],
        className: 'leaflet-marker-red'
    });
    
    const map = L.map('ente-map').setView([ente.lat, ente.lng], 15);
    
    // Aggiungi tile layer con caricamento ottimizzato
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 18,
        loading: 'lazy',
        crossOrigin: true,
        updateWhenIdle: true,
        keepBuffer: 2
    }).addTo(map);
    
    // Aggiungi marker per l'ente con icona personalizzata
    const marker = L.marker([ente.lat, ente.lng], {icon: customIcon})
        .addTo(map)
        .bindPopup(`
            <strong>${ente.nome}</strong><br>
            ${ente.indirizzo}<br>
            <small>Ente militare</small>
        `)
        .openPopup();
}

function showNoCoordinatesMessage() {
    document.getElementById('ente-map').innerHTML = `
        <div class="no-coordinates">
            <div>
                <i class="fas fa-map-marker-alt" style="font-size: 2em; margin-bottom: 10px; color: #ccc;"></i><br>
                Questo ente non è stato ancora georeferenziato.<br>
                <small>Le coordinate non sono disponibili.</small>
            </div>
        </div>
    `;
}

function showErrorMessage(message) {
    document.getElementById('ente-map').innerHTML = `
        <div class="no-coordinates">
            <div>
                <i class="fas fa-exclamation-triangle" style="font-size: 2em; margin-bottom: 10px; color: #dc3545;"></i><br>
                ${message}<br>
                <small>Impossibile caricare la mappa.</small>
            </div>
        </div>
    `;
}

// Inizializza quando il DOM è pronto
document.addEventListener('DOMContentLoaded', function() {
    console.log('[Dettaglio Ente Militare] Pagina caricata per ente ID: {{ ente.id }}');
    initEnteMap();
});
</script>
{% endblock %}
