{% extends "layouts/_base.html" %}

{% block title %}Nuova Attività - TALON{% endblock %}

{% block content %}
<div class="form-container">
    <h1>Nuova Attività</h1>
    
    <form action="{{ url_for('attivita.salva_attivita') }}" method="POST">
        
        <h3>Dati Principali</h3>
        <div class="form-group">
            <label for="ente_svolgimento_id">Ente che svolge l'attività:</label>
            <div class="searchable-select" data-select-id="ente_svolgimento_id"></div>
            <select name="ente_svolgimento_id" id="ente_svolgimento_id" style="display: none;" required>
                <option value="" disabled selected>-- Seleziona un ente --</option>
                {% for ente in enti_militari %}
                    <option value="{{ ente.id }}">{{ ente.nome }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="tipologia_id">Tipo di Attività:</label>
            <div class="searchable-select" data-select-id="tipologia_id"></div>
            <select name="tipologia_id" id="tipologia_id" style="display: none;" required>
                <option value="" disabled selected>-- Seleziona una tipologia --</option>
                {% for categoria, sottocategorie in tipologie.items() %}
                    <optgroup label="{{ categoria }}">
                        {% for sub in sottocategorie %}
                            <option value="{{ sub.id }}">{{ sub.nome }}</option>
                        {% endfor %}
                    </optgroup>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="operazione_id">Operazione:</label>
            <div class="searchable-select" data-select-id="operazione_id"></div>
            <select name="operazione_id" id="operazione_id" style="display: none;">
                <option value="">-- Seleziona un'operazione (se applicabile) --</option>
                {% for op in operazioni %}
                    <option value="{{ op.id }}" data-details="{{ op.nome_breve }} {{ op.teatro_operativo }}">{{ op.nome_missione }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="data_inizio">Data Inizio / Data Unica:</label>
            <input type="date" id="data_inizio" name="data_inizio" required>
        </div>
        <div class="form-group">
            <label for="data_fine">Data Fine (opzionale):</label>
            <input type="date" id="data_fine" name="data_fine">
        </div>
        <div class="form-group">
            <label for="descrizione">Descrizione Generica:</label>
            <textarea id="descrizione" name="descrizione" rows="3"></textarea>
        </div>

        <!-- SEZIONE DETTAGLI TRASPORTI (nascosta di default) -->
        <div id="dettagli-trasporti" style="display: none;">
            <hr>
            <h3>Dettagli Movimenti e Trasporti</h3>
            <div class="form-group">
                <label for="tipologia_carico">Tipologia di Carico:</label>
                <input type="text" id="tipologia_carico" name="tipologia_carico">
            </div>
            <div class="form-group" style="display: flex; gap: 10px;">
                <div style="flex-grow: 1;">
                    <label for="quantita">Quantità:</label>
                    <input type="number" step="any" id="quantita" name="quantita">
                </div>
                <div>
                    <label for="unita_di_misura">Unità di Misura:</label>
                    <select id="unita_di_misura" name="unita_di_misura">
                        <option value="">-- Seleziona --</option>
                        <option value="unità">unità</option>
                        <option value="litri">litri</option>
                        <option value="kg">kg</option>
                        <option value="m3">m³</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="mezzo_impiegato">Mezzo Impiegato (Targa/Matricola):</label>
                <input type="text" id="mezzo_impiegato" name="mezzo_impiegato">
            </div>
        </div>

        <!-- NUOVA SEZIONE DETTAGLI MANTENIMENTO (nascosta di default) -->
        <div id="dettagli-mantenimento" style="display: none;">
            <hr>
            <h3>Dettagli Mantenimento e Squadre a Contatto</h3>
            <div class="form-group">
                <label for="tipo_intervento">Tipo Intervento:</label>
                <select id="tipo_intervento" name="tipo_intervento">
                    <option value="">-- Seleziona --</option>
                    <option value="INTERVENTO PRESSO LA FASCIA LOGISTICA DEL SOSTEGNO">INTERVENTO PRESSO LA FASCIA LOGISTICA DEL SOSTEGNO</option>
                    <option value="SQUADRA A CONTATTO SUL TERRITORIO NAZIONALE">SQUADRA A CONTATTO SUL TERRITORIO NAZIONALE</option>
                    <option value="SQUADRA A CONTATTO IN TE.OP.">SQUADRA A CONTATTO IN TE.OP.</option>
                </select>
            </div>
            <div class="form-group">
                <label for="attivita_svolta">Attività Svolta:</label>
                <select id="attivita_svolta" name="attivita_svolta">
                    <option value="">-- Seleziona --</option>
                    <option value="CONTROLLI E VERIFICHE TECNICHE">CONTROLLI E VERIFICHE TECNICHE</option>
                    <option value="MANUTENZIONE PREVENTIVA">MANUTENZIONE PREVENTIVA</option>
                    <option value="MANUTENZIONE CORRETTIVA">MANUTENZIONE CORRETTIVA</option>
                </select>
            </div>
            <div class="form-group">
                <label for="piattaforma_materiale">Piattaforma/Sistema/Materiale su cui si è intervenuti:</label>
                <input type="text" id="piattaforma_materiale" name="piattaforma_materiale">
            </div>
        </div>

        <!-- NUOVA SEZIONE DETTAGLI RIFORNIMENTI (nascosta di default) -->
        <div id="dettagli-rifornimenti" style="display: none;">
            <hr>
            <h3>Dettagli Rifornimenti</h3>
            <div class="form-group">
                <label for="tipologia_rifornimento">Tipologia di Rifornimento:</label>
                <select id="tipologia_rifornimento" name="tipologia_rifornimento">
                    <option value="">-- Seleziona --</option>
                    <option value="CARBURANTE">CARBURANTE</option>
                    <option value="ASSEGNAZIONE MEZZI">ASSEGNAZIONE MEZZI</option>
                    <option value="ASSEGNAZIONE MATERIALE">ASSEGNAZIONE MATERIALE</option>
                    <option value="RAZIONI VIVERI DA COMBATTIMENTO">RAZIONI VIVERI DA COMBATTIMENTO</option>
                    <option value="ALTRO">ALTRO</option>
                </select>
            </div>
            <div class="form-group">
                <label for="dettaglio_materiale">Dettaglio (Tipo carburante, mezzo, materiale, altro):</label>
                <input type="text" id="dettaglio_materiale" name="dettaglio_materiale">
            </div>
            <div class="form-group" style="display: flex; gap: 10px;">
                <div style="flex-grow: 1;">
                    <label for="quantita_rifornimento">Quantità:</label>
                    <input type="number" step="any" id="quantita_rifornimento" name="quantita_rifornimento">
                </div>
                <div>
                    <label for="unita_di_misura_rifornimento">Unità di Misura:</label>
                    <select id="unita_di_misura_rifornimento" name="unita_di_misura_rifornimento">
                        <option value="">-- Seleziona --</option>
                        <option value="unità">unità</option>
                        <option value="litri">litri</option>
                        <option value="kg">kg</option>
                        <option value="m3">m³</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- DETTAGLI GETRA -->
        <div id="dettagli-getra" style="display:none;">
            <hr>
            <h3>Dettagli Gestione Transito (GETRA)</h3>

            <div class="form-group">
                <label for="tipo_vettore">Tipo vettore:</label>
                <select id="tipo_vettore" name="tipo_vettore">
                    <option value="">-- Seleziona --</option>
                    <option value="SAFOPS">SAFOPS - Descrizione (da inserire)</option>
                    <option value="SCPOPS">SCPOSP - Descrizione (da inserire)</option>
                    <option value="SCSOPS">SCSOPS - Descrizione (da inserire)</option>
                    <option value="SCTOPS">SCTOPS - Descrizione (da inserire)</option>
                    <option value="SCPTROPS">SCPTROPS - Descrizione (da inserire)</option>
                    <option value="SCPEXE">SCPEXE - Descrizione (da inserire)</option>
                    <option value="SAFMEDE">SAFMEDE - Descrizione (da inserire)</option>
                    <option value="SNOPS">SNOPS - Descrizione (da inserire)</option>
                    <option value="UAFMEDE">UAFMEDE - Descrizione (da inserire)</option>
                    <option value="UCPEXE">UCPEXE - Descrizione (da inserire)</option>
                    <option value="ULAFOPS">ULAFOPS - Descrizione (da inserire)</option>
                    <!-- altro ... -->
                </select>
            </div>

            <div class="form-group">
                <label for="seriale_vettore">Seriale / targa / nominativo:</label>
                <input type="text" id="seriale_vettore" name="seriale_vettore">
            </div>

            <!-- Riga GETRA a 4 colonne perfettamente allineata -->
            <div class="form-group getra-row" style="display:flex; gap:10px; flex-wrap:wrap;">

                <!-- Personale movimentato -->
                <div style="flex:1">
                    <label for="numero_personale">Personale<br>movimentato:</label>
                    <input type="number" id="numero_personale" name="numero_personale"
                        min="0" class="form-control">
                </div>

                <!-- Mezzi movimentati -->
                <div style="flex:1">
                    <label for="numero_mezzi">Mezzi<br>movimentati:</label>
                    <input type="number" id="numero_mezzi" name="numero_mezzi"
                        min="0" class="form-control">
                </div>

                <!-- Quantità -->
                <div style="flex:1">
                    <label for="volume">Quantità o<br>volume:</label>
                    <input type="number" id="volume" name="volume"
                        min="0" step="any" class="form-control">
                </div>

                <!-- Unità di misura -->
                <div style="flex:1">
                    <label for="unita_di_misura_getra">Unità di<br>misura:</label>
                    <select id="unita_di_misura_getra" name="unita_di_misura_getra"
                            class="form-select">
                        <option value="">--</option>
                        <option value="KG">Kg</option>
                        <option value="M_LIN">Metri lineari</option>
                        <option value="M3">Metri cubi</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Sezioni Località, Risorse e Note (invariate) -->
        <hr><h3>Località</h3>
        <div class="form-group">
            <label for="partenza_id">Luogo Partenza:</label>
            <div class="searchable-select" data-select-id="partenza_id"></div>
            <select name="partenza_id" id="partenza_id" style="display: none;">
                <option value="">-- Seleziona (se applicabile) --</option>
                <optgroup label="ENTI MILITARI">
                    {% for ente in enti_militari %}
                        <option value="militare-{{ ente.id }}" data-details="{{ ente.indirizzo or '' }} {{ ente.civico or '' }}, {{ ente.cap or '' }} {{ ente.citta or '' }} ({{ ente.provincia or '' }})">{{ ente.nome }}</option>
                    {% endfor %}
                </optgroup>
                <optgroup label="ENTI CIVILI">
                    {% for ente in enti_civili %}
                        <option value="civile-{{ ente.id }}" data-details="{{ ente.indirizzo or '' }} {{ ente.civico or '' }}, {{ ente.cap or '' }} {{ ente.citta or '' }} ({{ ente.provincia or '' }}) - {{ ente.nazione or '' }}">{{ ente.nome }}</option>
                    {% endfor %}
                </optgroup>
            </select>
        </div>
        <div class="form-group">
            <label for="destinazione_id">Luogo Destinazione:</label>
            <div class="searchable-select" data-select-id="destinazione_id"></div>
            <select name="destinazione_id" id="destinazione_id" style="display: none;">
                <option value="">-- Seleziona (se applicabile) --</option>
                <optgroup label="ENTI MILITARI">
                    {% for ente in enti_militari %}
                        <option value="militare-{{ ente.id }}" data-details="{{ ente.indirizzo or '' }} {{ ente.civico or '' }}, {{ ente.cap or '' }} {{ ente.citta or '' }} ({{ ente.provincia or '' }})">{{ ente.nome }}</option>
                    {% endfor %}
                </optgroup>
                <optgroup label="ENTI CIVILI">
                    {% for ente in enti_civili %}
                        <option value="civile-{{ ente.id }}" data-details="{{ ente.indirizzo or '' }} {{ ente.civico or '' }}, {{ ente.cap or '' }} {{ ente.citta or '' }} ({{ ente.provincia or '' }}) - {{ ente.nazione or '' }}">{{ ente.nome }}</option>
                    {% endfor %}
                </optgroup>
            </select>
        </div>
        <hr><h3>Risorse e Note</h3>
        <div class="form-group" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
            <div><label for="personale_ufficiali">Ufficiali:</label><input type="number" id="personale_ufficiali" name="personale_ufficiali" value="0" min="0"></div>
            <div><label for="personale_sottufficiali">Sottufficiali:</label><input type="number" id="personale_sottufficiali" name="personale_sottufficiali" value="0" min="0"></div>
            <div><label for="personale_graduati">Graduati/VFP:</label><input type="number" id="personale_graduati" name="personale_graduati" value="0" min="0"></div>
            <div><label for="personale_civili">Civili:</label><input type="number" id="personale_civili" name="personale_civili" value="0" min="0"></div>
        </div>
        <div class="form-group"><label for="note">Note:</label><textarea id="note" name="note" rows="3"></textarea></div>

        <button type="submit">Salva Attività</button>
    </form>
    <br>
    <a href="{{ url_for('attivita.lista_attivita') }}" class="cancel-link">Annulla</a>
</div>

<script>
    // Logica specifica di questa pagina
    document.getElementById('tipologia_id').addEventListener('change', function() {
        const select = document.getElementById('tipologia_id');
        const selectedText = select.options[select.selectedIndex].text.trim().toUpperCase();
        
        const dettagliTrasportiDiv = document.getElementById('dettagli-trasporti');
        const dettagliMantenimentoDiv = document.getElementById('dettagli-mantenimento');
        const dettagliRifornimentiDiv = document.getElementById('dettagli-rifornimenti');
        const dettagliGetraDiv        = document.getElementById('dettagli-getra');

        // Nascondi tutte le sezioni di dettaglio per iniziare
        [dettagliTrasportiDiv,
         dettagliMantenimentoDiv,
         dettagliRifornimentiDiv,
         dettagliGetraDiv].forEach(div => div.style.display = 'none');

        // Mostra la sezione corretta in base alla selezione
        if (selectedText === 'MOVIMENTI E TRASPORTI') {
            dettagliTrasportiDiv.style.display = 'block';
        } else if (selectedText === 'MANTENIMENTO E SQUADRE A CONTATTO') {
            dettagliMantenimentoDiv.style.display = 'block';
        } else if (selectedText === 'RIFORNIMENTI') {
            dettagliRifornimentiDiv.style.display = 'block';
        } else if (selectedText === 'GESTIONE TRANSITO') {
            dettagliGetraDiv.style.display = 'block';
        }
    });
</script>
{% endblock %}
