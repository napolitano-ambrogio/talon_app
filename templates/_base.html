<!-- _base.html - TALON Application Template -->
<!DOCTYPE html>
<html lang="it" class="h-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <meta name="user-role" content="{{ session.get('ruolo_nome', 'GUEST') }}">
    <meta name="user-name" content="{{ session.get('username', 'Utente') }}">
    
    <!-- FORZA NO CACHE PER RISOLVERE PROBLEMA F5 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <title>{% block title %}{{ app_name or 'TALON System' }}{% endblock %}</title>

    <!-- Librerie Offline - Tutte le risorse sono locali per funzionamento su chiavetta USB -->
    
    <!-- Bootstrap CSS (locale) -->
    <link href="/external/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- FontAwesome CSS (locale) -->
    <link href="/external/fontawesome/css/all.min.css" rel="stylesheet">

    <!-- CSS Sistema con cache busting FORZATO -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v={{ cache_buster }}&t={{ moment().unix() if moment else range(999999) | random }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/sidebar.css') }}?v={{ cache_buster }}&t={{ moment().unix() if moment else range(999999) | random }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/sidebar-roles.css') }}?v={{ cache_buster }}&t={{ moment().unix() if moment else range(999999) | random }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/searchable_select.css') }}?v={{ cache_buster }}&t={{ moment().unix() if moment else range(999999) | random }}">
    
    <!-- CSS Application Styles -->
    <style>
        /* Header TALON con animazione neural network */
        .talon-header {
            position: relative;
            background: #ffffff;
            padding: 20px 30px;
            overflow: hidden;
            border-bottom: 1px solid #e5e7eb !important;
        }
        
        .header-neural-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.5;
            pointer-events: none;
        }
        
        .header-content {
            position: relative;
            z-index: 2;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .talon-title-container {
            color: #1e3c72;
        }
        
        .talon-title {
            font-size: 2rem;
            font-weight: 700;  /* Grassetto forte */
            margin: 0;
            letter-spacing: 3px;
            color: #0D1B2A;  /* Stesso colore della sidebar */
        }
        
        .talon-subtitle {
            font-size: 0.9rem;
            margin: 0;
            margin-top: 5px;
            color: #6b7280;
            letter-spacing: 1px;
            font-weight: 300;
        }
        
        .talon-header .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .talon-header .btn-light {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            color: #374151;
        }
        
        .talon-header .btn-light:hover {
            background: #f9fafb;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* Responsive header */
        @media (max-width: 768px) {
            .talon-header {
                padding: 15px 20px;
            }
            
            .talon-title {
                font-size: 1.5rem;
            }
            
            .talon-subtitle {
                font-size: 0.8rem;
            }
            
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
        }
        
        /* Application Loader Styles - Rope Animation */
        .app-loader {
            position: fixed !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            display: none !important;
            z-index: 9997 !important;
            text-align: center !important;
        }
        
        .app-loader.active {
            display: block !important;
        }
        
        /* Knot Loader - Lines that form and dissolve like a real knot */
        .rope-spinner {
            width: 60px;
            aspect-ratio: 1;
            margin: 20px auto;
            --c: no-repeat linear-gradient(#0D1B2A 0 0);
            background: var(--c), var(--c), var(--c), var(--c);
            animation: 
                l9-1 1.5s infinite,
                l9-2 1.5s infinite;
        }
        
        @keyframes l9-1 {
            0%   { background-size: 0    4px, 4px 0; }
            25%  { background-size: 40px 4px, 4px 0; }
            45%,
            55%  { background-size: 40px 4px, 4px 42px; }
            75%  { background-size: 0    4px, 4px 42px; }
            100% { background-size: 0    4px, 4px 0; }
        }
        
        @keyframes l9-2 {
            0%, 49.9% { 
                background-position: 0 38px, 18px 18px, 100% 18px, right 18px bottom 18px; 
            }
            50%, 100% { 
                background-position: right 20px bottom 18px, 18px 100%, 20px 18px, right 18px top 0; 
            }
        }
        
        .loader-text {
            margin-top: 20px;
            color: #333 !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8) !important;
        }
        
        /* Overlay di sfondo per il loader */
        .spa-loader-overlay {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            background: rgba(0, 0, 0, 0.3) !important;
            backdrop-filter: blur(3px) !important;
            display: none !important;
            z-index: 9996 !important;
        }
        
        .spa-loader-overlay.active {
            display: block !important;
        }
        
        /* Transizioni contenuto SPA - DISABILITATE per risolvere problema visibilità */
        .main-content {
            /* transition: opacity 0.3s ease; */
            opacity: 1 !important;
            display: block !important;
            visibility: visible !important;
        }
        
        .main-content.loading {
            /* opacity: 0.3; */
            opacity: 1 !important;
        }
        
        /* Indicatore navigazione SPA */
        .spa-navigation-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #007bff 0%, #0056b3 50%, #007bff 100%);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
            z-index: 10001;
        }
        
        .spa-navigation-indicator.active {
            transform: scaleX(1);
            animation: spa-loading 1s ease-in-out infinite;
        }
        
        @keyframes spa-loading {
            0% { transform: scaleX(0); transform-origin: left; }
            50% { transform: scaleX(1); transform-origin: left; }
            51% { transform-origin: right; }
            100% { transform: scaleX(0); transform-origin: right; }
        }
    </style>
    
    <!-- Blocco per CSS aggiuntivi specifici per pagina -->
    {% block additional_css %}{% endblock %}
    
    <!-- Blocco legacy per compatibilità -->
    {% block extra_css %}{% endblock %}
    
    <!-- Preload fonts per performance -->
    <link rel="preload" href="/external/fontawesome/webfonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/external/fontawesome/webfonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
</head>
<body class="h-100 {% if session.get('ruolo_nome') %}role-{{ session.get('ruolo_nome').lower() }}{% endif %}"
      data-user-role="{{ session.get('ruolo_nome', 'GUEST') }}"
      data-user-name="{{ session.get('username', 'Utente') }}"
      data-page="{{ request.endpoint }}"


    <!-- Variabili globali JS dal backend -->
    <script>
        // Configurazione Sistema
        window.TALON_CONFIG = {
            // Dati utente
            user: {
                id: {{ session.get('user_id', 'null') }},
                role: "{{ session.get('ruolo_nome', 'GUEST') }}",
                username: "{{ session.get('username', 'Utente') }}",
                fullName: "{{ (session.get('nome','') ~ ' ' ~ session.get('cognome','')).strip() or session.get('username','Utente') }}",
                email: "{{ session.get('email', '') }}",
                isLoggedIn: {{ 'true' if session.get('logged_in') else 'false' }},
                permissions: {{ session.get('permissions', [])|tojson|safe }}
            },
            // Info applicazione
            app: {
                name: "{{ app_name or 'TALON System' }}",
                version: "{{ app_version or '2.0.0' }}",
                year: {{ current_year or 2025 }},
                ssoEnabled: {{ 'true' if sso_enabled else 'false' }},
                offlineMode: true,
                spaEnabled: true,
                cacheBuster: "{{ cache_buster }}"
            },
            // Flag debug
            debug: {
                enabled: {{ 'true' if debug_mode else 'false' }},
                isDebug: {{ 'true' if is_debug else 'false' }}
            },
            // URLs API e Routes
            api: {
                baseUrl: "{{ url_for('main.dashboard', _external=False) }}".replace('/dashboard', ''),
                csrfToken: "{{ csrf_token() }}"
            },
        };
        
        // Retrocompatibilità con vecchie variabili
        window.FLASK_USER_ROLE = window.TALON_CONFIG.user.role;
        window.FLASK_USER_NAME = window.TALON_CONFIG.user.username;
        window.FLASK_USER_FULL_NAME = window.TALON_CONFIG.user.fullName;
        window.FLASK_IS_LOGGED_IN = window.TALON_CONFIG.user.isLoggedIn;
        window.FLASK_DEBUG = window.TALON_CONFIG.debug.enabled;
        window.FLASK_IS_DEBUG = window.TALON_CONFIG.debug.isDebug;
        window.TALON_APP = window.TALON_CONFIG.app;
    </script>

    <!-- Hidden per compatibilità -->
    <input type="hidden" id="hidden-user-role" value="{{ session.get('ruolo_nome', 'GUEST') }}">



    <div class="d-flex h-100">
        {% if session.get('logged_in') %}
            {% include 'components/sidebar.html' %}
        {% endif %}

        <main class="flex-grow-1 d-flex flex-column {% if not session.get('logged_in') %}mx-auto{% endif %} page-wrapper" id="main-wrapper">
            {% if session.get('logged_in') %}
            <header class="talon-header border-bottom page-header" id="page-header">
                <canvas id="header-neural-canvas" class="header-neural-background"></canvas>
                <div class="header-content">
                    <div class="talon-title-container">
                        <h1 class="talon-title">TALON</h1>
                        <p class="talon-subtitle">Task Analysis & Logistics Operations Node</p>
                    </div>
                    
                    <!-- Quick Actions nella header -->
                    <div class="header-actions">
                        <button class="btn btn-sm btn-light me-2" id="fullscreen-btn" title="Schermo intero">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                </div>
            </header>
            {% endif %}


            <!-- Flash messages iniziali (solo primo caricamento) -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                <div class="flash-messages p-3" id="initial-flash-messages">
                    {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show shadow-sm" role="alert">
                        <i class="fas fa-{{ 'exclamation-circle' if category == 'error' else 'info-circle' if category == 'info' else 'check-circle' if category == 'success' else 'exclamation-triangle' }}"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Chiudi"></button>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            {% endwith %}

            <!-- Container per toast notifications -->
            <div id="toast-container" class="position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>

            <!-- Main Content Area -->
            <div class="flex-grow-1 p-3 main-content" id="main-content">
                {% block content %}
                <div class="text-center text-muted">
                    <p>Contenuto non disponibile</p>
                </div>
                {% endblock %}
            </div>

            <footer class="bg-light border-top py-2 px-3 mt-auto" id="page-footer">
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        {{ app_name or 'TALON System' }} v{{ app_version or '2.0.0' }}
                        {% if debug_mode or is_debug %}
                        <span class="badge bg-warning text-dark ms-2">
                            <i class="fas fa-bug"></i> DEBUG MODE
                        </span>
                        {% endif %}
                    </small>

                    {% if session.get('logged_in') %}
                    <small class="text-muted">
                        <span id="user-role-status" class="text-success">
                            <i class="fas fa-shield-alt"></i> {{ session.get('ruolo_nome', 'GUEST') }} (Online)
                        </span>
                        <span class="mx-2">|</span>
                        <i class="fas fa-clock"></i> Sessione:
                        <span id="session-timer">00:00</span>
                    </small>
                    {% endif %}
                </div>
            </footer>
        </main>
    </div>

    <!-- JavaScript Libraries - Tutte locali per funzionamento offline -->
    
    <!-- jQuery (locale) -->
    <script src="/external/jquery/jquery-3.7.1.min.js"></script>
    
    <!-- Bootstrap Bundle JS (locale) -->
    <script src="/external/bootstrap/js/bootstrap.bundle.min.js"></script>
    
    <!-- FontAwesome JS (locale) -->
    <script src="/external/fontawesome/js/all.min.js"></script>
    
    <!-- Chart.js (locale) - per grafici -->
    <script src="/external/chartjs/chart.umd.min.js"></script>

    <!-- ============================== -->
    <!-- CORE SPA APPLICATION -->
    <!-- ============================== -->
    
    <!-- Core Script (sempre caricato) -->
    <script src="{{ url_for('static', filename='js/script.js') }}?v={{ cache_buster }}&t={{ moment().unix() if moment else range(999999) | random }}"></script>
    
    <!-- Login Script (solo se non loggato) -->
    {% if not session.get('logged_in') %}
    <script src="{{ url_for('static', filename='js/neural-network.js') }}?v={{ cache_buster }}"></script>
    <script src="{{ url_for('static', filename='js/login.js') }}?v={{ cache_buster }}"></script>
    {% endif %}
    
    <!-- Scripts Sistema (caricati solo se loggato) -->
    {% if session.get('logged_in') %}
    
    <!-- UI Components -->
    <script src="{{ url_for('static', filename='js/fullscreen-manager.js') }}?v={{ cache_buster }}"></script>
    
    
    <!-- Sistema Components -->
    <script src="{{ url_for('static', filename='js/sidebar.js') }}?v={{ cache_buster }}"></script>
    <script src="{{ url_for('static', filename='js/sidebar-role-manager.js') }}?v={{ cache_buster }}"></script>
    <script src="{{ url_for('static', filename='js/searchable_select.js') }}?v={{ cache_buster }}"></script>
    
    <!-- Moduli Dashboard -->
    <script src="{{ url_for('static', filename='js/dashboard.js') }}?v={{ cache_buster }}"></script>
    {% if session.get('ruolo_nome') == 'ADMIN' %}
    <script src="{{ url_for('static', filename='js/dashboard_admin.js') }}?v={{ cache_buster }}"></script>
    {% endif %}
    
    <!-- Moduli Principali -->
    <script src="{{ url_for('static', filename='js/organigramma.js') }}?v={{ cache_buster }}"></script>
    <script src="{{ url_for('static', filename='js/enti-militari.js') }}?v={{ cache_buster }}"></script>
    <script src="{{ url_for('static', filename='js/enti-civili.js') }}?v={{ cache_buster }}"></script>
    <script src="{{ url_for('static', filename='js/operazioni.js') }}?v={{ cache_buster }}"></script>
    
    <!-- Modulo Attività con tutti i suoi componenti -->
    <script src="{{ url_for('static', filename='js/attivita/attivita_utils.js') }}?v={{ cache_buster }}"></script>
    <script src="{{ url_for('static', filename='js/attivita/attivita_forms.js') }}?v={{ cache_buster }}"></script>
    <script src="{{ url_for('static', filename='js/attivita/attivita.js') }}?v={{ cache_buster }}"></script>
    <script src="{{ url_for('static', filename='js/attivita/inserimento_attivita.js') }}?v={{ cache_buster }}"></script>
    <script src="{{ url_for('static', filename='js/attivita/modifica_attivita.js') }}?v={{ cache_buster }}"></script>
    
    {% endif %}

    <!-- Script Inizializzazione Sistema -->
    <script>
        
        // ============================
        // SISTEMA PERMESSI
        // ============================
        
        (function () {
            const config = window.TALON_CONFIG;
            const role = config.user.role.toUpperCase();
            
            window.TalonPermissions = {
                userRole: role || 'GUEST',
                canEdit: ['ADMIN', 'OPERATORE'].includes(role),
                canDelete: role === 'ADMIN',
                canCreate: ['ADMIN', 'OPERATORE'].includes(role),
                canViewReports: ['ADMIN', 'OPERATORE', 'VISUALIZZATORE'].includes(role),
                isAdmin: role === 'ADMIN',
                isOperatore: role === 'OPERATORE',
                isVisualizzatore: role === 'VISUALIZZATORE',
                isLoggedIn: config.user.isLoggedIn
            };
        })();

        document.addEventListener('DOMContentLoaded', function() {
            
            // Gestione fullscreen con gestione errori e compatibilità browser
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            if (fullscreenBtn) {
                fullscreenBtn.addEventListener('click', function(event) {
                    // Assicurati che sia un click utente reale
                    if (!event.isTrusted) {
                        console.warn('Fullscreen richiede un gesto utente autentico');
                        return;
                    }
                    
                    const button = this;
                    
                    if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement) {
                        // Entra in modalità fullscreen
                        const element = document.documentElement;
                        
                        if (element.requestFullscreen) {
                            element.requestFullscreen()
                                .then(() => {
                                    button.innerHTML = '<i class="fas fa-compress"></i>';
                                    button.title = 'Esci da schermo intero';
                                })
                                .catch(err => {
                                    console.error('Errore entrando in fullscreen:', err.message);
                                });
                        } else if (element.webkitRequestFullscreen) { // Safari
                            element.webkitRequestFullscreen();
                            button.innerHTML = '<i class="fas fa-compress"></i>';
                            button.title = 'Esci da schermo intero';
                        } else if (element.msRequestFullscreen) { // IE11
                            element.msRequestFullscreen();
                            button.innerHTML = '<i class="fas fa-compress"></i>';
                            button.title = 'Esci da schermo intero';
                        }
                    } else {
                        // Esci dalla modalità fullscreen
                        if (document.exitFullscreen) {
                            document.exitFullscreen()
                                .then(() => {
                                    button.innerHTML = '<i class="fas fa-expand"></i>';
                                    button.title = 'Schermo intero';
                                })
                                .catch(err => {
                                    console.error('Errore uscendo da fullscreen:', err.message);
                                });
                        } else if (document.webkitExitFullscreen) { // Safari
                            document.webkitExitFullscreen();
                            button.innerHTML = '<i class="fas fa-expand"></i>';
                            button.title = 'Schermo intero';
                        } else if (document.msExitFullscreen) { // IE11
                            document.msExitFullscreen();
                            button.innerHTML = '<i class="fas fa-expand"></i>';
                            button.title = 'Schermo intero';
                        }
                    }
                });
                
                // Ascolta i cambiamenti di stato fullscreen
                function handleFullscreenChange() {
                    const isFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement);
                    
                    if (isFullscreen) {
                        fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
                        fullscreenBtn.title = 'Esci da schermo intero';
                    } else {
                        fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
                        fullscreenBtn.title = 'Schermo intero';
                    }
                }
                
                // Aggiungi listener per tutti i browser
                document.addEventListener('fullscreenchange', handleFullscreenChange);
                document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
                document.addEventListener('msfullscreenchange', handleFullscreenChange);
            }
            
            // ============================
            // GESTIONE STATO CONNESSIONE
            // ============================
            
            function updateConnectionStatus() {
                const userRoleStatus = document.getElementById('user-role-status');
                const userRole = window.TALON_CONFIG ? window.TALON_CONFIG.user.role : 'GUEST';
                
                if (!navigator.onLine) {
                    if (userRoleStatus) {
                        userRoleStatus.innerHTML = `<i class="fas fa-shield-alt"></i> ${userRole} (Offline)`;
                        userRoleStatus.className = 'text-danger';
                    }
                    if (window.TalonApp && window.TalonApp.showToast) {
                        TalonApp.showToast('Modalità offline attiva', 'warning');
                    }
                } else {
                    if (userRoleStatus) {
                        userRoleStatus.innerHTML = `<i class="fas fa-shield-alt"></i> ${userRole} (Online)`;
                        userRoleStatus.className = 'text-success';
                    }
                }
            }
            
            window.addEventListener('online', updateConnectionStatus);
            window.addEventListener('offline', updateConnectionStatus);
            
            // Initial update with a small delay to ensure DOM is ready
            setTimeout(() => {
                updateConnectionStatus();
            }, 100);
            
            // ============================
            // SESSION KEEP-ALIVE
            // ============================
            
            function setupSessionKeepAlive() {
                if (!window.TALON_CONFIG || !window.TALON_CONFIG.user.isLoggedIn) {
                    return;
                }
                
                // Ping della sessione ogni 5 minuti per mantenerla attiva
                const KEEP_ALIVE_INTERVAL = 5 * 60 * 1000; // 5 minuti
                
                function pingSession() {
                    fetch('/api/ping-session', {
                        method: 'GET',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        credentials: 'same-origin'
                    })
                    .then(response => {
                        if (!response.ok) {
                            if (response.status === 401) {
                                // Sessione scaduta, reindirizza al login
                                window.location.href = '/login?expired=true';
                            }
                        }
                    })
                    .catch(error => {
                        // Silent error handling
                    });
                }
                
                // Ping iniziale dopo 5 minuti
                setTimeout(pingSession, KEEP_ALIVE_INTERVAL);
                
                // Poi ogni 5 minuti
                setInterval(pingSession, KEEP_ALIVE_INTERVAL);
                
                // Ping anche quando l'utente interagisce con la pagina
                let lastActivity = Date.now();
                const ACTIVITY_THRESHOLD = 60 * 1000; // 1 minuto
                
                function handleUserActivity() {
                    const now = Date.now();
                    if (now - lastActivity > ACTIVITY_THRESHOLD) {
                        lastActivity = now;
                        pingSession();
                    }
                }
                
                // Monitora attività utente
                document.addEventListener('click', handleUserActivity);
                document.addEventListener('keypress', handleUserActivity);
                document.addEventListener('scroll', handleUserActivity);
            }
            
            // Inizializza keep-alive
            setupSessionKeepAlive();
            
            // ============================
            // TIMER SESSIONE
            // ============================
            
            if (window.TALON_CONFIG.user.isLoggedIn) {
                // Usa il tempo di caricamento della pagina come fallback se login_time non è disponibile
                const loginTime = "{{ session.get('login_time', '') }}" || new Date().toISOString();
                let sessionStartTime = null;
                
                // Prova a parsare il tempo di login dal backend
                try {
                    sessionStartTime = new Date(loginTime);
                    // Se la data non è valida, usa il tempo corrente
                    if (isNaN(sessionStartTime.getTime())) {
                        sessionStartTime = new Date();
                    }
                } catch (e) {
                    // Se il parsing fallisce, usa il tempo corrente
                    sessionStartTime = new Date();
                }
                
                function updateSessionTimer() {
                    const timerEl = document.getElementById('session-timer');
                    if (!timerEl) return;
                    
                    const now = new Date();
                    const diff = Math.floor((now - sessionStartTime) / 1000);
                    
                    const hours = Math.floor(diff / 3600);
                    const minutes = Math.floor((diff % 3600) / 60);
                    const seconds = diff % 60;
                    
                    // Mostra ore:minuti:secondi se la sessione è più di 1 ora, altrimenti minuti:secondi
                    if (hours > 0) {
                        timerEl.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                    } else {
                        timerEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                    }
                }
                
                // Aggiorna immediatamente e poi ogni secondo
                updateSessionTimer();
                setInterval(updateSessionTimer, 1000); // Aggiorna ogni secondo
            }
            
            // ============================
            // NEURAL NETWORK HEADER ANIMATION
            // ============================
            
            function initHeaderNeuralNetwork() {
                const canvas = document.getElementById('header-neural-canvas');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                let animationId;
                let nodes = [];
                
                // Configurazione
                const config = {
                    nodeCount: 50,
                    nodeSize: 2,
                    nodeColor: 'rgba(13, 27, 42, 0.6)',  // Nodi più visibili
                    connectionColor: 'rgba(13, 27, 42, 0.3)',  // Connessioni più visibili
                    connectionDistance: 100,
                    speed: 0.3
                };
                
                // Ridimensiona canvas
                function resizeCanvas() {
                    const header = canvas.parentElement;
                    canvas.width = header.offsetWidth;
                    canvas.height = header.offsetHeight;
                }
                
                // Inizializza nodi
                function initNodes() {
                    nodes = [];
                    for (let i = 0; i < config.nodeCount; i++) {
                        nodes.push({
                            x: Math.random() * canvas.width,
                            y: Math.random() * canvas.height,
                            vx: (Math.random() - 0.5) * config.speed,
                            vy: (Math.random() - 0.5) * config.speed,
                            size: Math.random() * config.nodeSize + 0.5
                        });
                    }
                }
                
                // Anima nodi
                function animate() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    // Aggiorna posizioni
                    nodes.forEach(node => {
                        node.x += node.vx;
                        node.y += node.vy;
                        
                        // Rimbalza ai bordi
                        if (node.x < 0 || node.x > canvas.width) node.vx *= -1;
                        if (node.y < 0 || node.y > canvas.height) node.vy *= -1;
                        
                        // Mantieni nei limiti
                        node.x = Math.max(0, Math.min(canvas.width, node.x));
                        node.y = Math.max(0, Math.min(canvas.height, node.y));
                    });
                    
                    // Disegna connessioni
                    ctx.strokeStyle = config.connectionColor;
                    ctx.lineWidth = 0.5;
                    
                    for (let i = 0; i < nodes.length; i++) {
                        for (let j = i + 1; j < nodes.length; j++) {
                            const dx = nodes[i].x - nodes[j].x;
                            const dy = nodes[i].y - nodes[j].y;
                            const distance = Math.sqrt(dx * dx + dy * dy);
                            
                            if (distance < config.connectionDistance) {
                                ctx.beginPath();
                                ctx.moveTo(nodes[i].x, nodes[i].y);
                                ctx.lineTo(nodes[j].x, nodes[j].y);
                                ctx.globalAlpha = 1 - (distance / config.connectionDistance);
                                ctx.stroke();
                            }
                        }
                    }
                    
                    // Disegna nodi
                    ctx.fillStyle = config.nodeColor;
                    ctx.globalAlpha = 1;
                    
                    nodes.forEach(node => {
                        ctx.beginPath();
                        ctx.arc(node.x, node.y, node.size, 0, Math.PI * 2);
                        ctx.fill();
                    });
                    
                    animationId = requestAnimationFrame(animate);
                }
                
                // Inizializza
                resizeCanvas();
                initNodes();
                animate();
                
                // Gestione resize
                window.addEventListener('resize', () => {
                    resizeCanvas();
                    initNodes();
                });
                
                // Cleanup
                return () => {
                    if (animationId) {
                        cancelAnimationFrame(animationId);
                    }
                };
            }
            
            // ============================
            // INIZIALIZZAZIONE COMPONENTI
            // ============================
            
            function initializePageComponents() {
                // Inizializza neural network nell'header
                if (window.TALON_CONFIG && window.TALON_CONFIG.user.isLoggedIn) {
                    initHeaderNeuralNetwork();
                }
                // Reinizializza tooltip Bootstrap
                const tooltipTriggerList = [].slice.call(
                    document.querySelectorAll('[data-bs-toggle="tooltip"]')
                );
                tooltipTriggerList.map(function(tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
                
                // Reinizializza popover Bootstrap
                const popoverTriggerList = [].slice.call(
                    document.querySelectorAll('[data-bs-toggle="popover"]')
                );
                popoverTriggerList.map(function(popoverTriggerEl) {
                    return new bootstrap.Popover(popoverTriggerEl);
                });
                
                // Reinizializza searchable select se presente
                if (window.initializeSearchableSelects) {
                    window.initializeSearchableSelects();
                }
                
                // Components initialized silently
            }
            
            // Inizializza componenti al primo caricamento
            initializePageComponents();
            
            // Auto-hide flash messages iniziali
            setTimeout(function() {
                const flashMessages = document.getElementById('initial-flash-messages');
                if (flashMessages) {
                    flashMessages.style.transition = 'opacity 0.5s';
                    flashMessages.style.opacity = '0';
                    setTimeout(() => flashMessages.remove(), 500);
                }
            }, 5000);
        });

        // ============================
        // SETUP AJAX GLOBALE
        // ============================
        
        (function () {
            const csrfToken = window.TALON_CONFIG.api.csrfToken;
            if (csrfToken && window.jQuery) {
                $.ajaxSetup({
                    beforeSend: function(xhr, settings) {
                        if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                            xhr.setRequestHeader("X-CSRFToken", csrfToken);
                        }
                    }
                });
            }
        })();

        // Debug info removed for production
    </script>

    <!-- Blocco per JavaScript aggiuntivi specifici per pagina -->
    {% block additional_js %}{% endblock %}
    
    <!-- Blocco legacy per compatibilità -->
    {% block extra_js %}{% endblock %}
</body>
</html>