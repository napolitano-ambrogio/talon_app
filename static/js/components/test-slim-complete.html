<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test TALON Slim Select - Versione Completa</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Slim Select CSS -->
    <link rel="stylesheet" href="https://unpkg.com/slim-select@latest/dist/slimselect.css">
    
    <!-- TALON Slim Select CSS -->
    <link rel="stylesheet" href="../css/components/slim-searchable-select.css">
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .test-container { max-width: 800px; margin: 2rem auto; padding: 2rem; }
        .test-section { margin-bottom: 2rem; padding: 1.5rem; border: 1px solid #dee2e6; border-radius: 0.5rem; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #b6d4da; }
    </style>
</head>
<body>
    <div class="container">
        <div class="test-container">
            <h1 class="text-center mb-4">üß™ Test TALON Slim Select - Versione Completa</h1>
            <div class="alert alert-info">
                <strong>Questo test verifica:</strong>
                <ul class="mb-0 mt-2">
                    <li>‚úÖ Wrapper TALON applicato correttamente</li>
                    <li>üîç Search funzionale (nome, codice, indirizzo)</li>
                    <li>üìú Scrollbar personalizzata</li>
                    <li>üé® Aesthetics TALON-style</li>
                    <li>üìä Display dettagli enti</li>
                </ul>
            </div>
            
            <!-- Test Enti Militari -->
            <div class="test-section">
                <h3>üèõÔ∏è Test Enti Militari con Dettagli</h3>
                <div class="form-group">
                    <label for="test-enti">Seleziona Ente Militare:</label>
                    <select id="test-enti" style="display: none;">
                        <option value="" disabled selected>-- Seleziona ente militare --</option>
                        <option value="ei_001" data-codice="EI001" data-indirizzo="Roma - Via Po, 14" data-details="[EI001] Roma - Via Po, 14">
                            COMANDO GENERALE ESERCITO ITALIANO
                        </option>
                        <option value="ei_002" data-codice="EI002" data-indirizzo="Milano - Corso Buenos Aires, 12" data-details="[EI002] Milano - Corso Buenos Aires, 12">
                            COMANDO MILITARE LOMBARDIA
                        </option>
                        <option value="am_001" data-codice="AM001" data-indirizzo="Roma - Viale dell'Universit√†, 4" data-details="[AM001] Roma - Viale dell'Universit√†, 4">
                            STATO MAGGIORE AERONAUTICA
                        </option>
                        <option value="am_002" data-codice="AM002" data-indirizzo="Napoli - Via Marina, 82" data-details="[AM002] Napoli - Via Marina, 82">
                            COMANDO AERONAUTICA SUD
                        </option>
                        <option value="mm_001" data-codice="MM001" data-indirizzo="La Spezia - Viale Amendola, 1" data-details="[MM001] La Spezia - Viale Amendola, 1">
                            COMANDO MARITTIMO NORD
                        </option>
                        <option value="mm_002" data-codice="MM002" data-indirizzo="Taranto - Via Anfiteatro, 4" data-details="[MM002] Taranto - Via Anfiteatro, 4">
                            COMANDO MARITTIMO SUD
                        </option>
                        <option value="cc_001" data-codice="CC001" data-indirizzo="Roma - Viale Romania, 45" data-details="[CC001] Roma - Viale Romania, 45">
                            COMANDO GENERALE ARMA CARABINIERI
                        </option>
                        <option value="gdf_001" data-codice="GDF001" data-indirizzo="Roma - Viale XXI Aprile, 55" data-details="[GDF001] Roma - Viale XXI Aprile, 55">
                            COMANDO GENERALE GUARDIA DI FINANZA
                        </option>
                        <!-- Aggiungi pi√π opzioni per testare scrollbar -->
                        <option value="test_01" data-codice="T001" data-indirizzo="Bologna - Via Test 1" data-details="[T001] Bologna - Via Test 1">TEST ENTE 01</option>
                        <option value="test_02" data-codice="T002" data-indirizzo="Firenze - Via Test 2" data-details="[T002] Firenze - Via Test 2">TEST ENTE 02</option>
                        <option value="test_03" data-codice="T003" data-indirizzo="Venezia - Via Test 3" data-details="[T003] Venezia - Via Test 3">TEST ENTE 03</option>
                        <option value="test_04" data-codice="T004" data-indirizzo="Genova - Via Test 4" data-details="[T004] Genova - Via Test 4">TEST ENTE 04</option>
                        <option value="test_05" data-codice="T005" data-indirizzo="Torino - Via Test 5" data-details="[T005] Torino - Via Test 5">TEST ENTE 05</option>
                    </select>
                </div>
                
                <div class="mt-3">
                    <button class="btn btn-primary" onclick="testValue()">üîç Ottieni Valore</button>
                    <button class="btn btn-info" onclick="testSearch()">üîç Test Search</button>
                    <button class="btn btn-warning" onclick="refreshSelect()">üîÑ Refresh</button>
                </div>
                
                <div id="result" class="mt-3"></div>
            </div>
            
            <!-- Status Area -->
            <div class="test-section">
                <h3>üìä Status Test</h3>
                <div id="status-area">
                    <div class="status info">‚è≥ In attesa di inizializzazione...</div>
                </div>
            </div>
            
            <!-- Console Log -->
            <div class="test-section">
                <h3>üìù Console Log</h3>
                <div id="console-log" style="background: #212529; color: #fff; padding: 1rem; border-radius: 4px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.85rem;"></div>
                <button class="btn btn-secondary btn-sm mt-2" onclick="clearLog()">üóëÔ∏è Pulisci Log</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/slim-select@latest/dist/slimselect.min.js"></script>

    <script>
        let slimInstance = null;
        const logElement = document.getElementById('console-log');
        const statusElement = document.getElementById('status-area');
        
        // Override console.log
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            const message = args.join(' ');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        };
        
        // Override console.error
        const originalError = console.error;
        console.error = function(...args) {
            originalError.apply(console, args);
            const message = args.join(' ');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `<div style="color: #ff6b6b;">[ERROR ${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        };
        
        function updateStatus(message, type = 'info') {
            const statusDiv = document.createElement('div');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = message;
            statusElement.appendChild(statusDiv);
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== INIZIALIZZAZIONE TEST TALON SLIM SELECT ===');
            updateStatus('üöÄ Inizializzazione in corso...', 'info');
            
            setTimeout(() => {
                const selectElement = document.getElementById('test-enti');
                
                if (!selectElement) {
                    console.error('‚ùå Elemento select non trovato!');
                    updateStatus('‚ùå Elemento select non trovato!', 'error');
                    return;
                }
                
                try {
                    // Rendi visibile il select
                    selectElement.style.display = 'block';
                    selectElement.style.visibility = 'visible';
                    
                    console.log('üìù Configurazione Slim Select...');
                    
                    // Inizializza Slim Select con configurazione TALON
                    slimInstance = new SlimSelect({
                        select: selectElement,
                        settings: {
                            // Search configuration
                            showSearch: true,
                            searchPlaceholder: 'Cerca ente militare...',
                            searchText: 'Nessun ente trovato',
                            searchingText: 'Ricerca in corso...',
                            searchHighlight: true,
                            
                            // Display configuration
                            placeholderText: 'Seleziona ente militare...',
                            closeOnSelect: true,
                            allowDeselect: false,
                            showOptionTooltips: true,
                            
                            // Performance settings
                            maxValuesShown: 200,
                            timeoutDelay: 150,
                            
                            // Position settings
                            openPosition: 'auto',
                            contentPosition: 'absolute'
                        },
                        events: {
                            afterChange: (newVal) => {
                                console.log('üéØ Ente selezionato:', newVal);
                                updateStatus(`‚úÖ Ente selezionato: ${JSON.stringify(newVal)}`, 'success');
                            },
                            searchFilter: (option, search) => {
                                // Custom search che include text, codice, e indirizzo
                                const searchLower = search.toLowerCase();
                                const text = option.text.toLowerCase();
                                const codice = option.data?.codice?.toLowerCase() || '';
                                const indirizzo = option.data?.indirizzo?.toLowerCase() || '';
                                
                                const match = text.includes(searchLower) || 
                                            codice.includes(searchLower) || 
                                            indirizzo.includes(searchLower);
                                
                                if (search.length > 2) {
                                    console.log(`üîç Search '${search}': ${option.text} ‚Üí ${match ? '‚úÖ' : '‚ùå'}`);
                                }
                                
                                return match;
                            }
                        }
                    });
                    
                    console.log('‚úÖ Slim Select inizializzato!');
                    
                    // Applica wrapper TALON
                    setTimeout(() => {
                        const slimContainer = selectElement.nextElementSibling;
                        if (slimContainer && slimContainer.classList.contains('ss-main')) {
                            // Crea wrapper TALON
                            const wrapper = document.createElement('div');
                            wrapper.className = 'talon-slim-select';
                            wrapper.style.width = '100%';
                            
                            // Inserisci wrapper
                            slimContainer.parentNode.insertBefore(wrapper, slimContainer);
                            wrapper.appendChild(slimContainer);
                            
                            // Aggiungi HTML strutturato per nome + indirizzo
                            const options = selectElement.querySelectorAll('option[data-indirizzo]');
                            options.forEach(option => {
                                const nomeEnte = option.textContent.trim();
                                const indirizzo = option.getAttribute('data-indirizzo');
                                
                                if (indirizzo && indirizzo.trim()) {
                                    const htmlContent = `
                                        <div class="option-main-text">${nomeEnte}</div>
                                        <div class="option-address">${indirizzo}</div>
                                    `;
                                    option.setAttribute('data-html', htmlContent);
                                }
                            });
                            
                            console.log('üé® Wrapper TALON applicato!');
                            console.log('üìç HTML strutturato per indirizzi applicato!');
                            updateStatus('üé® Wrapper TALON + indirizzi applicati!', 'success');
                            
                            // Test finale
                            setTimeout(() => {
                                testInitialization();
                            }, 100);
                            
                        } else {
                            console.error('‚ùå Container Slim Select non trovato!');
                            updateStatus('‚ùå Container Slim Select non trovato!', 'error');
                        }
                    }, 200);
                    
                } catch (error) {
                    console.error('‚ùå Errore inizializzazione:', error);
                    updateStatus(`‚ùå Errore: ${error.message}`, 'error');
                }
            }, 300);
        });
        
        function testInitialization() {
            console.log('üß™ Esecuzione test di inizializzazione...');
            
            const tests = [
                {
                    name: 'Wrapper TALON',
                    test: () => document.querySelector('.talon-slim-select') !== null,
                    description: 'Verifica presenza wrapper con classe talon-slim-select'
                },
                {
                    name: 'Container Slim Select',
                    test: () => document.querySelector('.ss-main') !== null,
                    description: 'Verifica presenza container principale Slim Select'
                },
                {
                    name: 'Search Input',
                    test: () => document.querySelector('.ss-search input') !== null,
                    description: 'Verifica presenza input di ricerca'
                },
                {
                    name: 'Options List',
                    test: () => document.querySelector('.ss-list') !== null,
                    description: 'Verifica presenza lista opzioni'
                },
                {
                    name: 'Custom Scrollbar CSS',
                    test: () => {
                        const list = document.querySelector('.talon-slim-select .ss-list');
                        if (!list) return false;
                        const styles = window.getComputedStyle(list);
                        return styles.scrollbarWidth === 'thin' || styles.overflowY === 'auto';
                    },
                    description: 'Verifica CSS scrollbar personalizzata'
                }
            ];
            
            let passed = 0;
            tests.forEach(test => {
                const result = test.test();
                console.log(`${result ? '‚úÖ' : '‚ùå'} ${test.name}: ${test.description}`);
                if (result) passed++;
            });
            
            const percentage = Math.round((passed / tests.length) * 100);
            const status = percentage === 100 ? 'success' : percentage >= 80 ? 'info' : 'error';
            const emoji = percentage === 100 ? 'üéâ' : percentage >= 80 ? '‚ö†Ô∏è' : '‚ùå';
            
            updateStatus(`${emoji} Test completato: ${passed}/${tests.length} (${percentage}%)`, status);
            console.log(`üèÅ Test completato: ${passed}/${tests.length} test passati (${percentage}%)`);
        }
        
        function testValue() {
            if (slimInstance) {
                const value = slimInstance.selected();
                console.log('üìä Valore corrente:', value);
                document.getElementById('result').innerHTML = `
                    <div class="alert alert-info">
                        <strong>Valore selezionato:</strong><br>
                        <pre>${JSON.stringify(value, null, 2)}</pre>
                    </div>
                `;
            }
        }
        
        function testSearch() {
            const searches = ['COMANDO', 'Roma', 'EI001', 'AM', 'Marina'];
            console.log('üîç Test ricerche automatiche...');
            
            searches.forEach((search, index) => {
                setTimeout(() => {
                    const searchInput = document.querySelector('.ss-search input');
                    if (searchInput) {
                        searchInput.value = search;
                        searchInput.dispatchEvent(new Event('input'));
                        console.log(`üîç Test search ${index + 1}: "${search}"`);
                        
                        // Pulisci dopo 2 secondi
                        setTimeout(() => {
                            searchInput.value = '';
                            searchInput.dispatchEvent(new Event('input'));
                        }, 2000);
                    }
                }, index * 3000);
            });
        }
        
        function refreshSelect() {
            if (slimInstance && slimInstance.render) {
                slimInstance.render();
                console.log('üîÑ Select refreshed');
                updateStatus('üîÑ Select refreshed', 'info');
            }
        }
        
        function clearLog() {
            document.getElementById('console-log').innerHTML = '';
            console.log('üóëÔ∏è Log pulito');
        }
    </script>
</body>
</html>