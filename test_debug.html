<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Debug - SlimSelect Persistenza</title>
    <link rel="stylesheet" href="https://unpkg.com/slim-select@latest/dist/slimselect.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .test-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        select {
            width: 100%;
            min-height: 50px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Test Debug - SlimSelect Persistenza Dati</h1>
        <p>Questo test verifica se i valori selezionati rimangono persistenti dopo l'inizializzazione di SlimSelect.</p>
        
        <div class="form-group">
            <label for="test-select">Select di Test (Valore preselezionato: "opzione2")</label>
            <select id="test-select">
                <option value="">-- Seleziona --</option>
                <option value="opzione1">Opzione 1</option>
                <option value="opzione2" selected>Opzione 2 (PRESELEZIONATA)</option>
                <option value="opzione3">Opzione 3</option>
            </select>
        </div>
        
        <div id="status" class="status">
            Caricamento test in corso...
        </div>
        
        <button onclick="checkValue()">Verifica Valore Corrente</button>
        <button onclick="reinitialize()">Re-inizializza SlimSelect</button>
    </div>

    <script src="https://unpkg.com/slim-select@latest/dist/slimselect.min.js"></script>
    <script>
        let slimInstance = null;
        let statusDiv = document.getElementById('status');
        
        function updateStatus(message, type = 'success') {
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }
        
        function initSlimSelect() {
            try {
                // Distruggi istanza precedente se esiste
                if (slimInstance) {
                    slimInstance.destroy();
                }
                
                // Crea nuova istanza SENZA reset della selezione
                slimInstance = new SlimSelect({
                    select: '#test-select',
                    settings: {
                        showSearch: true,
                        searchPlaceholder: 'Cerca...',
                        searchText: 'Nessun elemento trovato',
                        placeholderText: 'Seleziona...'
                    }
                });
                
                // NON facciamo slimInstance.setSelected([]) - questa era la causa del problema!
                
                setTimeout(() => {
                    checkValue();
                }, 100);
                
            } catch (error) {
                updateStatus('Errore durante l\'inizializzazione: ' + error.message, 'error');
            }
        }
        
        function checkValue() {
            const selectElement = document.getElementById('test-select');
            const currentValue = selectElement.value;
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            
            if (currentValue === 'opzione2') {
                updateStatus(`✅ SUCCESS: Valore persistente mantenuto! Valore: "${currentValue}" - Testo: "${selectedOption.text}"`, 'success');
            } else if (currentValue === '') {
                updateStatus(`❌ FAIL: Valore resettato! Il valore preselezionato "opzione2" è stato perso.`, 'error');
            } else {
                updateStatus(`⚠️ UNEXPECTED: Valore diverso dal previsto: "${currentValue}" - Testo: "${selectedOption.text}"`, 'error');
            }
        }
        
        function reinitialize() {
            updateStatus('Re-inizializzazione in corso...', 'success');
            initSlimSelect();
        }
        
        // Inizializza al caricamento della pagina
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('DOM caricato, inizializzazione SlimSelect...', 'success');
            setTimeout(initSlimSelect, 100);
        });
    </script>
</body>
</html>